package com.htrfid.financeapp.service.impl;

import java.io.IOException;
import java.text.DecimalFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletResponse;

import org.apache.poi.hssf.usermodel.HSSFCellStyle;
import org.apache.poi.hssf.util.HSSFColor;
import org.apache.poi.ss.usermodel.CellStyle;
import org.apache.poi.ss.util.CellRangeAddress;
import org.apache.poi.xssf.usermodel.XSSFCell;
import org.apache.poi.xssf.usermodel.XSSFFont;
import org.apache.poi.xssf.usermodel.XSSFRow;
import org.apache.poi.xssf.usermodel.XSSFSheet;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.htrfid.finance.entity.WmCategoryEntity;
import com.htrfid.finance.vo.CashierJournalResultVO;
import com.htrfid.finance.vo.DetailAccountVo;
import com.htrfid.finance.vo.WmTaxRateEntryFilterVo;
import com.htrfid.finance.vo.WmTaxRateEntryResp;
import com.htrfid.financeapp.common.Constant;
import com.htrfid.financeapp.remote.WmEmployeeIncomeTaxRemoteService;
import com.htrfid.financeapp.service.CommonService;
import com.htrfid.financeapp.service.WmCategoryService;
import com.htrfid.financeapp.service.WmEmployeeIncomeTaxService;
import com.htrfid.financeapp.service.WmIncomeItemService;
import com.htrfid.financeapp.service.WmItemsService;
import com.htrfid.financeapp.service.WmPersonalTaxInitService;
import com.htrfid.financeapp.service.WmTaxRateService;
import com.htrfid.shiro.utils.UserUtils;
import com.htrfid.sysmanager.entity.SysUser;
import com.htrfid.util.JsonUtil;
import com.htrfid.util.Result;

@Service
public class WmEmployeeIncomeTaxServiceImpl implements WmEmployeeIncomeTaxService {
	
	private static final Logger logger = LoggerFactory.getLogger(WmEmployeeIncomeTaxServiceImpl.class);
	
	
	@Autowired
	private CommonService commonService;
	
	@Autowired
	private WmIncomeItemService wmIncomeItemService;
	@Autowired
	private WmTaxRateService wmTaxRateService;
	@Autowired
	private WmPersonalTaxInitService wmPersonalTaxInitService;
    @Autowired
    private WmCategoryService wmCategoryService;
    @Autowired
    private WmItemsService wmItemsService;
    @Autowired
    private WmEmployeeIncomeTaxRemoteService wmEmployeeIncomeTaxRemoteService;
    
    
	/**
	 * 
	 * @Title: initPage   
	 * @Description: 页面初始化
	 * @author: zhengfei
	 * @Email: 936864724@qq.com
	 * @date: 2018年12月11日 上午9:00:04
	 * @return  
	 * @throws
	 */
	@Override
	public Result initPage(Long categoryId,Integer dataType){
		Long sobId = UserUtils.getCurrentUser().getUserCurrentOrganId();
		Map<String, Object> initMap = new HashMap<>(10);
		if(categoryId==null||categoryId.longValue() == 0) {
			//获取组织列表
			Map<String, Object> orgEntity = commonService.getOrgEntity();
			List<Map<String, Object>> orgList = new ArrayList<>();
			orgList.add(orgEntity);
			initMap.put("org", orgList);
			//获取默认工资类别和工资类别列表
			List<WmCategoryEntity> list = wmCategoryService.list(sobId);
			initMap.put("categoryList", list);
			for (WmCategoryEntity wmCategoryEntity : list) {
				if(wmCategoryEntity.getSysDefault().intValue() == 1) {
					categoryId = wmCategoryEntity.getId();
					break;
				}
			}
			
			initMap.put("defCategoryId", categoryId);
			
			//获取会计年度会计期间 
			Map<String, Integer> yearAndPeriod = commonService.getWmCurYearAndPeriod(sobId);
			initMap.put("yearAndPeriod", yearAndPeriod);
			
		}
		
		Map<String, Object> map = wmEmployeeIncomeTaxRemoteService.initPage(sobId,categoryId);
		initMap.put("incomeItemList", map.get("incomeItemList"));
		initMap.put("taxRateList", map.get("taxRateList"));
		initMap.put("taxinitList", map.get("taxinitList"));
		initMap.put("currencyTypeList", map.get("currencyTypeList"));
		
		
		/*//获取所得项计算列表
		WmIncomeItemEntity itemEntity = new WmIncomeItemEntity();
		itemEntity.setSobId(sobId);
		itemEntity.setCategoryId(categoryId);
		Result incomeItemResult = wmIncomeItemService.listIncomeItem(itemEntity);
		initMap.put("incomeItemList", incomeItemResult.getData());
		//获取税率列表
		WmTaxRateEntity taxRateEntity = new WmTaxRateEntity();
		taxRateEntity.setCategoryId(categoryId);
		taxRateEntity.setSobId(sobId);
		Result taxRateListResult = wmTaxRateService.listTaxRate(taxRateEntity);
		initMap.put("taxRateList", taxRateListResult.getData());
		//获取个人所得税初始设置
		WmPersonalTaxEntity personalTaxEntity = new WmPersonalTaxEntity();
		personalTaxEntity.setCategoryId(categoryId);
		personalTaxEntity.setSobId(sobId);
		Result taxInitListResult = wmPersonalTaxInitService.listInitTax(personalTaxEntity);
		initMap.put("taxinitList", taxInitListResult.getData());*/
		
		
		/*//获取所有的货币类型
		WmItemsEntity wmItemsEntity = new WmItemsEntity();
		wmItemsEntity.setCategoryId(categoryId);
		wmItemsEntity.setSobId(sobId);
		wmItemsEntity.setDataType(Constant.WM_DATA_TYPE_CURRENCY);
		List<WmItemsEntity> wmItemsList = wmItemsService.list(wmItemsEntity);
		initMap.put("currencyTypeList", wmItemsList);*/
		
		//发请求，设置为默认 工资类别
		wmCategoryService.select(categoryId, sobId);
		
		return Result.ok(initMap);
	}

	
	@Override
	public Result listTaxRateEntry(WmTaxRateEntryFilterVo filterVo) {
		//获取会计年度会计期间 
		/*Map<String, Integer> yearAndPeriod = commonService.getWmCurYearAndPeriod(filterVo.getSobId());
		filterVo.setYear(yearAndPeriod.get("curYear"));
		filterVo.setPeriod(yearAndPeriod.get("curPeriod"));*/
		return wmEmployeeIncomeTaxRemoteService.listTaxRateEntry(filterVo);
	}


	/**
	 * 
	 * @Title: saveCliTaxRate   
	 * @Description: 保存页面录入的数据
	 * @author: zhengfei
	 * @Email: 936864724@qq.com
	 * @date: 2018年12月13日 下午5:21:10
	 * @param list
	 * @return          
	 * @throws
	 */
	@Override
	public Result saveCliTaxRate(List<WmTaxRateEntryResp> list) {
		SysUser currentUser = UserUtils.getCurrentUser();
		for (WmTaxRateEntryResp wmTaxRateEntryResp : list) {
			wmTaxRateEntryResp.setUpdateId(currentUser.getId());
			wmTaxRateEntryResp.setUpdateName(currentUser.getUsername());
			wmTaxRateEntryResp.setUpdateTime(new Date());
		}
		return wmEmployeeIncomeTaxRemoteService.saveCliTaxRate(list);
	}

	/**
	 * 
	 * @Title: cliTaxRate   
	 * @Description: 计算工资数据或计算税率
	 * @author: zhengfei
	 * @Email: 936864724@qq.com
	 * @date: 2018年12月13日 下午2:23:26
	 * @param respList
	 * @return          
	 * @throws
	 */
	@Override
	public Result cliTaxRate(List<WmTaxRateEntryResp> respList) {
		return wmEmployeeIncomeTaxRemoteService.cliTaxRate(respList);
	}


	/**
	 * 
	 * @Title: exportExcel   
	 * @Description: 导出
	 * @author: zhengfei
	 * @Email: 936864724@qq.com
	 * @date: 2018年12月25日 下午2:34:46
	 * @param filterVo
	 * @param response  
	 * @throws
	 */
	@Override
	public void exportExcel(WmTaxRateEntryFilterVo filterVo, HttpServletResponse response) {

        listTaxRateEntry(filterVo);
        

        String[] arrayTitle = new String[]{"日期", "当日序号", "凭证字号", "凭证期间", "凭证审核", "过账标志", "摘要", "对方科目", "借方金额", "贷方金额", "余额", "经手人", "制单人", "数据来源", "备注"};

        //生成Excel文件
        XSSFWorkbook workbook = new XSSFWorkbook();
        XSSFSheet sheet = workbook.createSheet("个人所得税");
        for (int i = 0; i < arrayTitle.length; i++) {
            //每一列的宽度
            sheet.setColumnWidth(i, 20 * 180);
        }


        CellStyle cellStyle = workbook.createCellStyle();
        cellStyle.setWrapText(true);//强制使用POI样式
        cellStyle.setAlignment(CellStyle.ALIGN_CENTER);// 居中
        //字体大小
        XSSFFont font = workbook.createFont();
        font.setFontName("宋体");
        font.setFontHeightInPoints((short) 14);
        font.setBold(true); //是否加粗
        cellStyle.setFont(font);
        //创建行 （第1行）
        XSSFRow row = sheet.createRow(0);
        row.setHeightInPoints(20);
        XSSFCell cell = row.createCell(0);
        cell.setCellValue("个人所得税");
        cell.setCellStyle(cellStyle);

        for (int i = 0; i < arrayTitle.length; i++) {
            cell = row.createCell(i);
            cell.setCellValue(arrayTitle[i]);
            font = workbook.createFont();
            font.setBold(true); //是否加粗
            font.setFontName("Courier New");
            font.setFontHeightInPoints((short) 12);
            cellStyle.setFont(font);
            cell.setCellStyle(cellStyle);
        }

        Map<String, Object> map = detailAccount(reqVo);
        Map<String, Object> entity = (Map<String, Object>) map.get("entity");
//        List<DetailAccountVo> dataList = (List<DetailAccountVo>) map.get("list");
        List<DetailAccountVo> dataList = JsonUtil.jsonToList(map.get("list").toString(), DetailAccountVo.class);
        DecimalFormat df = new DecimalFormat("0.00");
        for (int j = 0;j<dataList.size();j++){
            row = sheet.createRow(j+3);

            if(reqVo.getCurrency().intValue() == -2|| isStandard){
                //综合本位币/本位币
                row.createCell((short) 0).setCellValue(entity.get("subjectName").toString());
                row.createCell((short) 1).setCellValue(dataList.get(j).getPeriodDate());
                row.createCell((short) 2).setCellValue(dataList.get(j).getVoucherNumber());
                row.createCell((short) 3).setCellValue(dataList.get(j).getSummary());
                row.createCell((short) 4).setCellValue(df.format(dataList.get(j).getDebitMoney()));
                row.createCell((short) 5).setCellValue(df.format(dataList.get(j).getCreditMoney()));
                if("1".equals(dataList.get(j).getDirection())){
                    row.createCell((short) 6).setCellValue("借");
                }else if("2".equals(dataList.get(j).getDirection())){
                    row.createCell((short) 6).setCellValue("贷");
                }else{
                    row.createCell((short) 6).setCellValue("平");
                }
                row.createCell((short) 7).setCellValue(df.format(dataList.get(j).getBalance()));
            }else if(reqVo.getCurrency().intValue() == -1){
                //所有币别
                row.createCell((short) 0).setCellValue(entity.get("subjectName").toString());
                row.createCell((short) 1).setCellValue(dataList.get(j).getPeriodDate());
                row.createCell((short) 2).setCellValue(dataList.get(j).getVoucherNumber());
                row.createCell((short) 3).setCellValue(dataList.get(j).getSummary());
                row.createCell((short) 4).setCellValue(dataList.get(j).getCurrencyNameValue());

                row.createCell((short) 5).setCellValue(df.format(dataList.get(j).getDebitAmountFor()));
                row.createCell((short) 6).setCellValue(df.format(dataList.get(j).getDebitMoney()));
                row.createCell((short) 7).setCellValue(df.format(dataList.get(j).getCreditAmountFor()));
                row.createCell((short) 8).setCellValue(df.format(dataList.get(j).getCreditMoney()));
                if("1".equals(dataList.get(j).getDirection())){
                    row.createCell((short) 9).setCellValue("借");
                }else if("2".equals(dataList.get(j).getDirection())){
                    row.createCell((short) 9).setCellValue("贷");
                }else{
                    row.createCell((short) 9).setCellValue("平");
                }
                row.createCell((short) 10).setCellValue(df.format(dataList.get(j).getBalance()));

            }else{
                //外币
                //所有币别
                row.createCell((short) 0).setCellValue(entity.get("subjectName").toString());
                row.createCell((short) 1).setCellValue(dataList.get(j).getPeriodDate());
                row.createCell((short) 2).setCellValue(dataList.get(j).getVoucherNumber());
                row.createCell((short) 3).setCellValue(dataList.get(j).getSummary());
                row.createCell((short) 4).setCellValue(dataList.get(j).getCurrencyNameValue());

                row.createCell((short) 5).setCellValue(df.format(dataList.get(j).getDebitAmountFor()));
                row.createCell((short) 6).setCellValue(df.format(dataList.get(j).getDebitMoney()));
                row.createCell((short) 7).setCellValue(df.format(dataList.get(j).getCreditAmountFor()));
                row.createCell((short) 8).setCellValue(df.format(dataList.get(j).getCreditMoney()));
                if("1".equals(dataList.get(j).getDirection())){
                    row.createCell((short) 9).setCellValue("借");
                }else if("2".equals(dataList.get(j).getDirection())){
                    row.createCell((short) 9).setCellValue("贷");
                }else{
                    row.createCell((short) 9).setCellValue("平");
                }
                row.createCell((short) 10).setCellValue(df.format(dataList.get(j).getBalanceFor()));
                row.createCell((short) 11).setCellValue(df.format(dataList.get(j).getBalance()));

            }

        }
        

        try {
            String name = "现金日记账_" + map.get("queryPeriod");
            response.setContentType("application/vnd.ms-excel;charset=UTF-8");
            response.setHeader("Content-Disposition", "attachment; filename=" +
                    new String(name.getBytes("GBK"), "ISO8859-1") + ".xlsx");
            workbook.write(response.getOutputStream());
        } catch (Exception e) {
            logger.error(e.getMessage());
        } finally {
            if (workbook != null) {
                try {
                    workbook.close();
                } catch (IOException ioe) {
                    ioe.printStackTrace();
                }
            }
        }
		
	}



}
