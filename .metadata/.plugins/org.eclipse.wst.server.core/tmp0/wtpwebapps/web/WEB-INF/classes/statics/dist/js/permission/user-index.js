"use strict";var ztree,organTree,_slicedToArray=function(e,r){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,r){var t=[],n=!0,a=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done)&&(t.push(o.value),!r||t.length!==r);n=!0);}catch(e){a=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(a)throw i}}return t}(e,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")},setting={data:{simpleData:{enable:!0,idKey:"id",pIdKey:"parentId",rootPId:0,type:"type"},key:{url:"nourl"}},check:{enable:!0},view:{fontCss:{color:"blue","font-family":"微软雅黑","font-size":"16px"}}},organSetting={data:{simpleData:{enable:!0,idKey:"id",pIdKey:"parentId",rootPId:0,type:"type"},key:{name:"orgName"}},check:{enable:!0},view:{fontCss:{color:"blue","font-family":"微软雅黑","font-size":"16px"}}},UserVM=new Vue({el:"#user-index",data:{isShow:!1,isEdit:!1,reload:!1,selectRole:[],selected:[],radioData:"",Constant:{SUCCESS_CODE:"100100"},organList:[],body:{username:"",loginName:"",email:"",empCode:""},addUser:{id:"",username:"",loginName:"",password:"",phone:"",email:"",status:null,empCode:"",photo:null,userCode:"",roleList:"",organId:"",userOrganList:""},data_user_list:{url:contextPath+"/user/list",colNames:["操作","账号","用户名","员工编号","邮箱账号","状态"],colModel:[{name:"id",index:"id",width:200,align:"center"},{name:"loginName",index:"loginName",width:200,align:"center"},{name:"username",index:"username",width:200,align:"center"},{name:"userCode",index:"userCode",width:200,align:"center"},{name:"email",index:"email",width:200,align:"center"},{name:"status",index:"status",width:200,align:"center",formatter:function(e,r,t,n){return 1==e?"正常":"禁用"}}]}},methods:{cancel:function(){this.isShow=!1,this.selected=[],this.initAddBody()},search:function(){this.reload=!this.reload},add:function(){this.isShow=!0,this.initAddBody(),this.initRoleTree(),this.queryAllOrgan(),this.initOrganTree()},initAddBody:function(){this.addUser={username:"",loginName:"",password:"",phone:"",email:"",status:null,empCode:"",photo:null,userCode:"",organId:"",roleList:"",userOrganList:""},this.selected=[]},queryAllOrgan:function(){$.ajax({type:"POST",url:contextPath+"/user/queryAllOrgan",data:"",dataType:"json",success:function(e){e.code===UserVM.Constant.SUCCESS_CODE&&(UserVM.organList=e.data,UserVM.initOrganTree())},error:function(){}})},initOrganTree:function(){organTree=$.fn.zTree.init($("#organTree"),organSetting,this.organList)},initRoleTree:function(){$.get(contextPath+"/role/queryRoleTree?type=2",function(e){ztree=$.fn.zTree.init($("#roleTree"),setting,e.data)})},save:function(){if($("form").valid()){var e=this.getCheckRoles(),r=this.getCheckOrgans(),t=this.addUser;t.roleList=e,t.userOrganList=r;var n=t.id;$.isEmptyObject(String(n))||void 0===n?this.saveUser(t):this.updateUser(t)}},getCheckRoles:function(){var e=new Array,r=ztree.getCheckedNodes(),t=new Map;for(var n in r){(l=r[n]).id;"2"===l.type&&t.set(l.id,l)}e=new Array;var a=!0,i=!1,o=void 0;try{for(var s,d=t[Symbol.iterator]();!(a=(s=d.next()).done);a=!0){var l,u=s.value,c=_slicedToArray(u,2),h=(c[0],c[1]),f={};"2"===(l=h).type&&(f.id=l.id,f.name=l.name,f.code=l.code,f.status="0",e.push(f))}}catch(e){i=!0,o=e}finally{try{!a&&d.return&&d.return()}finally{if(i)throw o}}return e},getCheckOrgans:function(){var e=new Array,r=organTree.getCheckedNodes();for(var t in r){var n=r[t],a={};a.organId=n.id,e.push(a)}return e},updateUser:function(e){$.ajax({type:"POST",url:contextPath+"/user/updateUser",data:JSON.stringify(e),dataType:"json",contentType:"application/json;charset=utf-8",success:function(e){e.code===UserVM.Constant.SUCCESS_CODE?(layer.alert("修改用户成功"),UserVM.cancel(),UserVM.reload=!UserVM.reload):layer.alert(e.msg)},error:function(e){console.log("服务器出错")}})},saveUser:function(e){$.ajax({type:"POST",url:contextPath+"/user/save",data:JSON.stringify(e),dataType:"json",contentType:"application/json;charset=utf-8",success:function(e){e.code===UserVM.Constant.SUCCESS_CODE?(layer.alert("添加用户成功"),UserVM.cancel(),UserVM.reload=!UserVM.reload):layer.alert(e.msg)},error:function(e){console.log("服务器出错")}})},modify:function(){if(0===this.selected.length)return layer.alert("请选择一条记录进行修改"),!1;if(1<this.selected.length)return layer.alert("只能选择一条记录进行修改"),!1;var e=this.selected[0];$.isEmptyObject(String(e))||(UserVM.isShow=!0,UserVM.queryAllOrgan(),this.modifyInfo(e))},modifyInfo:function(e){$.ajax({type:"POST",url:contextPath+"/user/getUserRoleInfo/"+e,data:"",dataType:"json",success:function(e){if(console.log("执行了"),e.code===UserVM.Constant.SUCCESS_CODE){var r=e.data,t=(UserVM.addUser=r).roleList;UserVM.initUserRoleTree(t),UserVM.addUser.organId=r.organId;var n=r.userOrganList;UserVM.setOrganChecked(n)}else layer.alert(e.msg)},error:function(e){}})},setRoleChecked:function(e){var r=ztree.getNodes(),t=ztree.transformToArray(r);for(var n in e){var a=e[n].id;for(var i in t){var o=t[i],s=o.id;String(s)===String(a)&&ztree.checkNode(o,!0,!1)}}},setOrganChecked:function(e){var r=organTree.getNodes(),t=organTree.transformToArray(r);for(var n in e){var a=e[n].id;for(var i in t){var o=t[i],s=o.id;String(s)===String(a)&&organTree.checkNode(o,!0,!1)}}},view:function(){if(0===this.selected.length)return layer.alert("请选择一条记录进行查看"),!1;if(1<this.selected.length)return layer.alert("只能选择一条记录进行查看"),!1;var e=this.selected[0];$.isEmptyObject(e)||void 0===e||this.viewInfo(e)},viewInfo:function(e){$.ajax({type:"POST",url:contextPath+"/user/getUserRoleInfo/"+e,data:"",dataType:"json",success:function(e){if(console.log(e),e.code===UserVM.Constant.SUCCESS_CODE){var r=e.data;UserVM.addUser=r,UserVM.isShow=!0;var t=r.roleList;UserVM.initUserRoleTree(t)}else layer.alert(e.msg)},error:function(e){}})},initUserRoleTree:function(r){$.get(contextPath+"/role/queryRoleTree?type=2",function(e){ztree=$.fn.zTree.init($("#roleTree"),setting,e.data),UserVM.processSelectRole(r)})},processSelectRole:function(e){var r=ztree.getNodes(),t=ztree.transformToArray(r);for(var n in e){var a=e[n].id;for(var i in t){var o=t[i],s=o.id;String(a)===s&&ztree.checkNode(o,!0,!0)}}},del:function(){if(!ht.util.hasValue(this.selected,"array"))return layer.alert("请选择一条记录!"),!1;$.ajax({type:"POST",url:contextPath+"/user/delete",contentType:"application/json",data:JSON.stringify(UserVM.selected),dataType:"",success:function(e){e.code===UserVM.Constant.SUCCESS_CODE?(layer.alert("删除用户成功"),UserVM.cancel(),UserVM.reload=!UserVM.reload):layer.alert(e.msg)},error:function(e){}})},initFormValidate:function(){var e={onfocusout:function(e){$(e).valid()},onkeyup:!1,rules:{loginName:{maxlength:20,minlength:6},username:{required:!0,isChar:!0},password:{required:!0,minlength:5},repassword:{required:!0,minlength:5,equalTo:"#password"},empCode:{required:!0,isempCode:!0},yname:{required:!0,iscode:!0},phone:{required:!0,isphone:!0},email:{email:!0,maxlength:100}},messages:{loginName:{maxlength:"登录名最多50个字符",minlength:"登录名最少6个字符"},username:{required:"请输入账号",maxlength:"姓名不能超过50个字符"},password:{required:"请输入密码",minlength:"密码长度不能小于 5 个字母"},repassword:{required:"请输入确认密码",minlength:"密码长度不能小于 5 个字母",equalTo:"两次密码输入不一致"},empCode:{required:"请输入员工编号"},yname:{required:"请输入姓名"},phone:{required:"请输入手机号",minlength:"确认手机不能小于11个字符"},email:{email:"请输入正确的邮箱",maxlength:"邮箱长度不能超过50 个字符"}}};$("#form").validate(e)}},mounted:function(){this.initFormValidate(),jQuery.validator.addMethod("isChar",function(e,r){return/^\w{2,10}$/.test(e)},"只允许英文字母、数字和下画线，长度为2-10位!"),jQuery.validator.addMethod("iscode",function(e,r){return/^[\u4e00-\u9fa5]+$/.test(e)},"只允许使用中文"),jQuery.validator.addMethod("isempCode",function(e,r){return/^[a-zA-Z0-9]+$/.test(e)},"请使用英文和数字"),jQuery.validator.addMethod("isphone",function(e,r){return/^[1][3,4,5,7,8][0-9]{9}$/.test(e)},"请使用正确的手机号码"),this.initAddBody()}});