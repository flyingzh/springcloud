"use strict";var vm=new Vue({el:"#cash-flow-item",data:function(){var n=this;return{isShow:!1,isSearchHide:!0,reload:!1,isLook:!1,isUpdate:!1,isSave:!0,openTime:"",selectedNodes:[],selected:[],nodeData:[],banks:[],setting1:{data:{simpleData:{enable:!0,idKey:"id",pIdKey:"parentId",rootPId:-1}},callback:{onClick:this.clickEvent}},body:{id:0,code:"",status:"",grade:0,fullname:"",parentId:0,createName:"",createTime:"",createId:0,updateId:0,updateUser:"",updateTime:""},searchBody:{fullname:"",code:"",status:""},addBody:{id:0,parentId:0,grade:0,name:"",code:"",parentCode:"",fullname:"",status:"1",createTime:"0000",createName:"tom"},tmpUnit:"",tmpCashItem:"",state:[{value:"1",label:"有效"},{value:"0",label:"无效"},{value:"",label:"所有"}],data_config:{url:contextPath+"/tbasecashflow/list",colNames:["代码","名称","全名","有效状态"],colModel:[{name:"code",index:"code",width:90,align:"left",formatter:function(e,t,a,o){var d=(e=e||"").replace(".","");return d=d.replace(".",""),$(document).off("click",".detail"+e).on("click",".detail"+d,function(){n.detailClick({value:e,grid:t,rows:a,state:o})}),'<a class="detail'+d+'">'+e+"</a>"}},{name:"name",index:"name",width:220,align:"left"},{name:"fullname",index:"fullname",width:520,align:"left"},{name:"status",index:"status",width:80,align:"left",formatter:function(e){return 1==e?"有效":"无效"}}]},status:[{value:"1",label:"有效"},{value:"0",label:"无效"}]}},created:function(){},methods:{clickEvent:function(e,t,a){console.log(a),vm.body.code=a.code,vm.addBody.parentId=a.id,vm.selectedNodes=$.fn.zTree.getZTreeObj("tree").getSelectedNodes(),1==vm.selectedNodes[0].grade&&(vm.body.code=""),this.search()},search:function(){this.reload=!this.reload},cancel:function(){this.isShow=!1,this.addBody.id=0,this.addBody.name="",this.addBody.code="",this.addBody.fullname="",this.isLook=!1,vm.isUpdate=!1,$("form").validate().resetForm()},clear:function(){this.body.code="",this.body.fullname="",this.body.status="",this.search()},add:function(){return 0===vm.selectedNodes.length?(layer.alert("请选择项目"),!1):3!=vm.selectedNodes[0].grade?(layer.alert("只能对三级项目进行操作"),!1):(vm.addBody.parentCode=vm.selectedNodes[0].code+".",vm.addBody.createTime=(new Date).Format("yyyy-MM-dd hh:mm:ss"),vm.addBody.createName=layui.data("user").username,void(this.isShow=!0))},del:function(){console.log(this.selected),0!=this.selected.length?$.ajax({type:"POST",url:contextPath+"/tbasecashflow/queryGrade",contentType:"application/json",dataType:"json",data:JSON.stringify(vm.selected),success:function(e){console.log(e),e.data.length===vm.selected.length?layer.confirm("当前数据有可能被引用，会影响数据准确性，确认是否删除？",{btn:["确认","取消"],btn1:function(){$.ajax({type:"POST",url:contextPath+"/tbasecashflow/delete",contentType:"application/json",data:JSON.stringify(vm.selected),dataType:"json",success:function(e){"100100"==e.code?(layer.alert(e.data,{icon:1}),vm.selected=[],vm.search()):layer.alert(e.msg,{icon:0})},error:function(e){layer.alert("服务器出错",{icon:0})}})}}):layer.alert("只能对三级项目进行删除")},error:function(e){console.log("服务器出错")}}):layer.alert("请选择要删除的行!")},modify:function(){1===this.selected.length?$.ajax({type:"POST",url:contextPath+"/tbasecashflow/queryGrade",contentType:"application/json",dataType:"json",data:JSON.stringify(vm.selected),success:function(e){e.data.length===vm.selected.length?vm.info(e.data[0].id):layer.alert("只能对三级项目进行修改")},error:function(e){console.log("服务器出错")}}):layer.alert("修改只能对单条数据进行操作")},exit:function(){window.parent.closeCurrentTab({exit:!0,openTime:this.openTime})},detailClick:function(e){var t=e.rows.id;t&&(vm.isLook=!0,this.info(t))},info:function(e){e&&$.ajax({type:"POST",url:contextPath+"/tbasecashflow/info/"+e,contentType:"application/json",dataType:"json",async:!1,success:function(e){if("100100"!==e.code)return layer.alert(e.message?e.message:e.msg),!1;vm.addBody=e.data;var t=e.data.code.split(".");vm.addBody.parentCode=t[0].concat(".",t[1],"."),vm.addBody.code=t[2],vm.isUpdate=!0,vm.isShow=!0},error:function(e){console.log("服务器出错")}})},save:function(){var e=contextPath+"/tbasecashflow/save";this.addBody.id&&(e=contextPath+"/tbasecashflow/update"),vm.addBody.grade=4,vm.addBody.code=vm.addBody.parentCode+vm.addBody.code;$("#addForm").valid()?(this.isSave=!1,$.ajax({type:"POST",url:e,contentType:"application/json",data:JSON.stringify(this.addBody),dataType:"json",success:function(e){console.log(e),"100100"===e.code?layer.alert(e.msg,{icon:1,end:function(){vm.cancel(),vm.search()}}):(vm.codeSplit(),layer.alert(e.msg,{icon:0})),vm.isSave=!0},error:function(e){vm.codeSplit(),layer.alert("服务器出错",{icon:0})}})):(vm.codeSplit(),layer.alert("请输入完整信息"))},codeSplit:function(){var e=vm.addBody.code.split(".");vm.addBody.code=e[2]},hideSearch:function(){this.isHide=!this.isHide,this.isSearchHide=!this.isSearchHide,$(".chevron").css("top","")},initFormValidate:function(){var e={onfocusout:function(e){$(e).valid()},onkeyup:!1,rules:{code:{isChar:!0,required:!0,maxlength:100,remote:{url:contextPath+"/tbasecashflow/queryForValidate",type:"post",dataType:"json",data:{id:function(){return vm.addBody.id},parentCode:function(){return vm.addBody.parentCode}},dataFilter:function(e,t){return console.log(e),"100100"===JSON.parse(e).code}}},fullname:{remote:{url:contextPath+"/tbasecashflow/queryForValidate",type:"post",dataType:"json",data:{id:function(){return vm.addBody.id}},dataFilter:function(e,t){return"100100"===JSON.parse(e).code}}}},messages:{code:{required:"请填写编码!",remote:"该编码已存在!",maxlength:"编码最大长度为100！"},fullname:{remote:"该全名已存在!"}}};$("#addForm").validate(e)}},mounted:function(){var n=this;$.ajax({url:contextPath+"/tbasecashflow/listAll",type:"POST",datatype:"json",success:function(e){console.log(e);for(var t=e.data,a=[],o=0,d=0;d<t.length;d++)t[d].grade<4&&(a[o]=t[d],o++);n.banks=a,n.$refs.my_tree.nodeData=n.banks,n.$refs.my_tree.loadData()}}),this.initFormValidate(),jQuery.validator.addMethod("isChar",function(e,t){return/^([a-zA-Z0-9]+)$/.test(e)},"编码格式错误!"),this.openTime=window.parent.params.openTime}});