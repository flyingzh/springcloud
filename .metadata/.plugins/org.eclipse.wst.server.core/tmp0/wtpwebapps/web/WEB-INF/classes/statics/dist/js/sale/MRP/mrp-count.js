"use strict";var mrpcount=new Vue({el:"#mrp-count",data:function(){return{actionShow:!1,countNo:"",countSucceed:!0,countTime:"",openTime:"",reload:!1,selected:[],userTabId:"userTabId",data_user_list:{url:contextPath+"/RMPCountController/intoMRPCountPage",colNames:["下单日期","业务类型","单据编号","行号","商品编码","商品名称","单位","数量","交货日期","commodityId","orderGoodsId"],colModel:[{name:"orderDate",index:"orderDate",width:110,align:"center",formatter:function(t,e,o,n){return new Date(t).format("yyyy-MM-dd")}},{name:"businessType",index:"businessType",width:110,align:"center",formatter:function(t,e,o,n){return"S_CUST_ORDER_01"===t?"普通销售":"S_CUST_ORDER_02"===t?"受托加工销售":t}},{name:"orderNo",index:"orderNo",width:220,align:"center",formatter:function(t,e,o,n){return $(document).off("click",".detail"+t).on("click",".detail"+t,function(){mrpcount.orderClick({value:t,grid:e,rows:o,state:n})}),'<a class="detail'+t+'">'+t+"</a>"}},{name:"no",index:"no",width:220,align:"center"},{name:"goodsCode",index:"goodsCode",width:80,align:"center",formatter:function(t,e,o,n){var r=".detail"+t;return $(document).off("click",r).on("click",r,function(){mrpcount.goodsClick({value:t,grid:e,rows:o,state:n})}),'<a class="detail'+t+'">'+t+"</a>"}},{name:"goodsName",index:"goodsName",width:150,align:"center"},{name:"countingUnit",index:"countingUnit",width:60,align:"center"},{name:"num",index:"num",width:60,align:"center"},{name:"deliveryDate",index:"deliveryDate",width:150,align:"center",formatter:function(t,e,o,n){return new Date(t).format("yyyy-MM-dd")}},{name:"commodityId",index:"commodityId",width:10,align:"center",hidden:!0},{name:"orderGoodsId",index:"orderGoodsId",width:10,align:"center",hidden:!0}]},tabId:"tabId",config:{url:contextPath+"/MRPCountSet/warehouseInfoList",colNames:["仓库代码","仓库名称","ID"],colModel:[{name:"codes",index:"codes",width:130,align:"center"},{name:"name",index:"name",width:150,align:"left"},{name:"id",index:"id",width:10,align:"center",hidden:!0}]},storeReload:!1,storeSelected:[],mrpOrderGoodsInfoVoList:[],mrpCountRecordEntity:{countWarehouseId:"",countNo:"",countTime:""},percent:0,Num:100,infoShow:!0,countTime1:0}},methods:{orderClick:function(t){var e=t.rows.orderNo;window.parent.activeEvent({name:"客户订单 - 查看",url:contextPath+"/sale/customer-order/customer-order-add.html",params:{type:"view",saleOrderNo:e}})},goodsClick:function(t){var e=t.rows.commodityId;window.parent.activeEvent({name:"商品",url:contextPath+"/base-data/commodity/commodity-info.html",params:{type:"skip",id:e}})},updateDetail:function(){},detail:function(){},exit:function(){window.parent.closeCurrentTab({exit:!0,openTime:this.openTime})},backMRPCount:function(){window.location.reload()},toMRPCountResult:function(){window.location.reload(),window.parent.activeEvent({name:"MRP运算结果-查询",url:contextPath+"/sale/MRP/mrp-count-result.html",params:{countNo:this.countNo,type:"query"}})},startCount:function(){var o=this;this.countTime1=150*this.selected.length;var n=[];if(this.storeSelected.map(function(t){var e=$("#"+o.tabId).jqGrid("getRowData",t);n.push(e.id)}),this.mrpCountRecordEntity.countWarehouseId=n.join(","),this.mrpCountRecordEntity.countNo=this.countNo,this.mrpCountRecordEntity.countTime=this.countTime,0!=n.length){var r=[];if(this.selected.map(function(t){var e=$("#"+o.userTabId).jqGrid("getRowData",t);e.goodsCode=e.goodsCode.replace(/<.*?>+/g,""),e.orderNo=e.orderNo.replace(/<.*?>+/g,""),r.push(e)}),0!=(this.mrpOrderGoodsInfoVoList=r).length){new Date;$.ajax({type:"POST",url:contextPath+"/RMPCountController/proceedMRPCount",contentType:"application/json;charset=utf-8",dataType:"json",data:JSON.stringify({mrpCountRecordEntity:this.mrpCountRecordEntity,mrpOrderGoodsInfoVoList:this.mrpOrderGoodsInfoVoList}),success:function(t){new Date;t.code<0?(mrpcount.countSucceed=!1,mrpcount.percent=0,mrpcount.$Modal.error({content:"计算失败！"+t.msg,okText:"确定",onOk:function(){window.location.reload()}})):mrpcount.percent=100}}),this.actionShow=!0;var t=setInterval(function(){mrpcount.percent<100&&1==mrpcount.countSucceed?mrpcount.percent++:clearInterval(t)},30)}else this.$Modal.info({content:"请选择参与计算的订单"})}else this.$Modal.info({content:"请选择参与计算的仓库"})}},mounted:function(){this.openTime=window.parent.params.openTime,$.ajax({type:"POST",url:contextPath+"/RMPCountController/mrpCountRecordPage",success:function(t){mrpcount.countNo=t.data.countNo,mrpcount.countTime=new Date(t.data.countTime).format("yyyy-MM-dd")}})},watch:{percent:function(){100<=this.percent&&(this.infoShow=!1)},actionShow:function(){0==this.actionShow&&(mrpcount.infoShow=!0,mrpcount.percent=0)}}});