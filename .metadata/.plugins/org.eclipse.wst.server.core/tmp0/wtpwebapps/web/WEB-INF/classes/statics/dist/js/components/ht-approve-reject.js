"use strict";Vue.component("ht-approve-reject",{props:{trigger:Boolean,modalType:String,receiptId:String,receiptStatus:String,stepList:Array,urlInitApprove:String,urlCheck:String,urlApprove:String,statusMap:{require:!1,type:Object,default:function(){return{tmp_save:"1",await_check:"2",checking:"3",auditing:"4",reject:"5"}}},urlTableData:{require:!1,type:String,default:function(){return""}},tableData:{require:!1,type:Array,default:function(){return[]}},canRejectWhenAudit:{require:!1,type:Boolean,default:function(){return!1}}},data:function(){return{isVisible:!1,dataInfo:{},currentStep:"",nextStep:"",stepsMap:{0:"开始",1:"一级审核",2:"二级审核",3:"三级审核",4:"四级审核",5:"五级审核",6:"六级审核",7:"结束"},showApprove:!1,showReject:!1}},template:'<div v-clock>\n    <modal\n    title="审核"\n    v-model="showApprove"\n    :closable="false"\n    @on-ok="getApproveInfo"\n    @on-cancel="isVisible = false"\n    >\n        <div>\n        <p class="mg-bm-md">\n        <span>当前节点：{{currentStep}}</span>\n        <span class="mg-lf-sbg">下级节点：{{nextStep}}</span>\n        </p>\n        <span>审核意见</span>\n        <i-input type="textarea" :rows="4" v-model="dataInfo.approvalInfo" placeholder="请输入审核意见"></i-input>\n        </div>\n    </modal>\n    <modal\n    title="驳回"\n    v-model="showReject"\n    :closable="false"\n    @on-ok="getRejectInfo"\n    @on-cancel="isVisible = false">\n        <div>\n        <radio-group v-model="dataInfo.approvalResult" class="mg-bm-md" >\n        <radio label="0">驳回上一级</radio>\n        <radio label="-1" class="mg-lf-sbg">驳回到开始级次</radio>\n        </radio-group>\n        <p style="font-weight: 600" class="mg-bm-md">驳回意见</p>\n        <i-input  type="textarea" :rows="4" v-model="dataInfo.approvalInfo" placeholder="请输入驳回意见"></i-input>\n        </div>\n    </modal>\n    </div>',methods:{checkRight:function(){var t=this;console.log("receiptStatus:"+t.receiptStatus);var e=t.statusMap.auditing;if(t.receiptStatus==e&&!1===t.canRejectWhenAudit)return t.$Modal.warning({title:"提示",content:"reject"==t.modalType?"已审核的单据不能驳回!":"单据已审核"}),!1;if(t.receiptStatus==e&&"approve"==t.modalType&&!0===t.canRejectWhenAudit)return t.$Modal.warning({title:"提示",content:"单据已审核"}),!1;var a=t.statusMap.tmp_save;if(!t.receiptId||t.receiptStatus==a)return t.$Modal.warning({title:"提示",content:"请先提交单据!"}),!1;$.ajax({type:"POST",url:t.urlCheck,contentType:"application/json",data:JSON.stringify({receiptsId:t.receiptId}),dataType:"json",success:function(e){"approve"==t.modalType&&t.approvalHandler(e),"reject"==t.modalType&&t.rejectHandler(e)},error:function(e){t.$Modal.error({title:"提示",content:"服务器出错"})}})},rejectHandler:function(e){var t=this;"100515"===e.code&&t.$emit("on-auto-approve",{result:e}),"100514"===e.code&&(t.isVisible=!1,t.$Modal.error({title:"提示",content:0===e.data?"该单据已被驳回到申请人，待申请人提交!":"您没有【"+t.stepsMap[e.data]+"】的驳回权限"})),"100100"===e.code&&(t.initApproval(),t.isVisible=!0),"-1"===e.code&&t.$Modal.error({title:"出错",content:e.msg})},approvalHandler:function(e){var t=this;"100515"===e.code&&(t.$Modal.success({title:"提示",content:"审核成功"}),t.$emit("on-auto-approve",{result:e})),"100514"===e.code&&(t.isVisible=!1,t.$Modal.error({title:"提示",content:0===e.data?"该单据已被驳回到申请人，待申请人提交!":"您没有【"+t.stepsMap[e.data]+"】的审核权限"})),"100100"===e.code&&(t.initApproval(),t.isVisible=!0),"-1"===e.code&&t.$Modal.error({title:"出错",content:e.msg})},initApproval:function(){var l=this,e=l.urlInitApprove+"?receiptsId="+l.receiptId;$.ajax({type:"post",url:e,data:JSON.stringify({receiptsId:l.receiptId}),dataType:"json",contentType:"application/json",success:function(e){if($.isEmptyObject(e.data))return!1;for(var t=e.data.list,a=l.stepsMap,n=0;n<t.length;n++){var i=t[n].processLevel;t[n].processLevel=a[i]}t.unshift({processLevel:"开始"}),t.push({processLevel:"结束"}),l.stepList=t,l.$emit("update:stepList",t);var r=t[1].currentLevel,o=r===e.data.levelLength,p=e.data.levelLength;if(o){for(var s=0;s<t.length;s++)t[s].currentLevel=t.length-1;l.$emit("update:stepList",t)}else l.currentStep=l.stepsMap[r+1],l.nextStep=r+1==p?l.stepsMap[7]:l.stepsMap[r+2]},error:function(){alert("服务器出错啦")}})},getApproveInfo:function(){var a=this;window.top.home.loading("show",{text:"审核中，请稍后!"}),a.dataInfo.receiptsId=a.receiptId,a.dataInfo.approvalResult="1",$.ajax({type:"POST",url:this.urlApprove,contentType:"application/json",data:JSON.stringify(a.dataInfo),dataType:"json",success:function(e){var t=$.trim(e.msg)||"";"100100"===e.code?(a.$Modal.success({title:"提示",content:""!=t?t:"审核成功!"}),setTimeout(function(){a.initValue()},0)):a.$Modal.warning({title:"提示",content:""!=t?t:"审核失败!"}),window.top.home.loading("hide"),a.isVisible=!1,a.$emit("on-approve",{action:"approve",result:e})},error:function(e){window.top.home.loading("hide"),a.$Modal.warning({title:"提示",content:"服务器出错!"})}})},getRejectInfo:function(){var a=this;window.top.home.loading("show",{text:"审核中，请稍后!"}),a.dataInfo.receiptsId=a.receiptId,$.ajax({type:"POST",url:this.urlApprove,contentType:"application/json",data:JSON.stringify(a.dataInfo),dataType:"json",success:function(e){var t=$.trim(e.msg)||"";"100100"===e.code?(a.$Modal.success({title:"提示",content:""!=t?t:"驳回成功!"}),setTimeout(function(){a.initValue()},0)):a.$Modal.warning({title:"提示",content:""!=t?t:"驳回失败!"}),a.isVisible=!1,a.$emit("on-reject",{action:"reject",result:e}),window.top.home.loading("hide")},error:function(e){window.top.home.loading("hide"),a.$Modal.warning({title:"提示",content:"服务器出错!"})}})},loadTableData:function(){var a=this,n=a.stepsMap;if(!a.urlTableData)return!1;$.ajax({type:"POST",url:this.urlTableData,data:{receiptsId:a.receiptId},dataType:"json",success:function(e){if("100100"===e.code&&0<e.data.length){var t=e.data.map(function(e){return Object.assign({},{approvalResult:1===e.approvalResult?"审核":"驳回",currentLevel:n[e.currentLevel],nextLevel:n[e.nextLevel],createName:e.createName,approvalInfo:e.approvalInfo,createTime:e.createTime})});a.$emit("update:tableData",t)}},error:function(e){}})},initValue:function(){this.initApproval(),this.loadTableData()},reloadApprovalData:function(){var d=this;$.when($.ajax({type:"POST",url:d.urlTableData,data:{receiptsId:d.receiptId},dataType:"json"}),$.ajax({type:"POST",url:d.urlInitApprove,data:JSON.stringify({receiptsId:d.receiptId}),dataType:"json",contentType:"application/json"})).done(function(e,t){if($.isEmptyObject(t.data))return!1;for(var a=t.data.list,n=d.stepsMap,i=0;i<a.length;i++){var r=a[i].processLevel;a[i].processLevel=n[r]}a.unshift({processLevel:"开始"}),a.push({processLevel:"结束"}),d.stepList=a,d.$emit("update:stepList",a),d.$parent.$forceUpdate();var o=a[1].currentLevel,p=o===t.data.levelLength,s=t.data.levelLength;if(p){for(var l=0;l<a.length;l++)a[l].currentLevel=a.length-1;d.$emit("update:stepList",a),d.$parent.$forceUpdate()}else d.currentStep=d.stepsMap[o+1],d.nextStep=o+1==s?d.stepsMap[7]:d.stepsMap[o+2];if("100100"==e.code&&0<e.data.length){var c=e.data.map(function(e){return Object.assign({},{approvalResult:1===e.approvalResult?"审核":"驳回",currentLevel:n[e.currentLevel],nextLevel:n[e.nextLevel],createName:e.createName,approvalInfo:e.approvalInfo,createTime:e.createTime})});d.$emit("update:tableData",c),d.$parent.$forceUpdate()}})}},computed:{},watch:{trigger:function(){this.checkRight(),"approve"==this.modalType&&(this.dataInfo.approvalInfo=""),"reject"==this.modalType&&(this.dataInfo.approvalInfo="",this.dataInfo.approvalResult="0")},isVisible:function(){"approve"==this.modalType?this.showApprove="approve"==this.modalType&&1==this.isVisible:this.showApprove=!1,"reject"==this.modalType?this.showReject="reject"==this.modalType&&1==this.isVisible:this.showReject=!1},receiptId:function(){var e=this;console.log(e.receiptId,e.receiptStatus);var t=0==e.stepList.length,a=e.statusMap.await_check,n=e.statusMap.checking,i=e.statusMap.auditing,r=e.statusMap.reject,o=e.statusMap.tmp_save;e.receiptId&&e.receiptStatus==a&&(setTimeout(function(){e.initApproval()},1e3),e.loadTableData()),e.receiptId&&(e.receiptStatus==n||e.receiptStatus==i||e.receiptStatus==r||e.receiptStatus==o)&&t&&(e.initApproval(),e.loadTableData())},receiptStatus:function(){var e=this;console.log(e.receiptId,e.receiptStatus);var t=e.statusMap.await_check;e.receiptId&&e.receiptStatus==t&&(setTimeout(function(){e.initApproval()},1e3),e.loadTableData())}},mounted:function(){}});