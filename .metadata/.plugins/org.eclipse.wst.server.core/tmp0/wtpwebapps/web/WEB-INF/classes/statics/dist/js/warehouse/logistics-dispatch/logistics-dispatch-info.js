"use strict";var vm=new Vue({el:"#app",data:{openTime:"",isShow:!1,reload:!1,isSearchHide:!0,isTabulationHide:!0,businessType:"",isOpened:!1,approvalTableData:[],isStampShow:!1,inspect:"",inspectType:"",saveStruts:!1,organizanizationName:"",isDisabled:!1,generaterDisabled:!1,selectedIndex:null,deliveryType:[],custList:[],supplierList:[],custId:null,supplierId:null,loading1:!1,options1:[],loading2:!1,options2:[],disabledCustomSelect:!0,disabledSupplierSelect:!0,modalType:"",modalTrigger:!1,keepPrice:[{value:1,name:"是"},{value:0,name:"否"}],selectLogisticsCompany:[],stepList:[],selectBusinessType:[{value:"S_OUT_STOCK",label:"销售送货"},{value:"P_APPLY_DELIVER",label:"采购送料"},{value:"P_RETURN_STOCK",label:"采购退库"},{value:"W_CMATERIAL_OUT_01",label:"受托加工送料"},{value:"W_CMATERIAL_OUT_02",label:"受托加工退料"},{value:"P_CREDENTIAL_OUT",label:"证书制作"}],saveData:{id:null,documentNo:null,documentStatus:1,businessType:"",custId:null,custCode:null,supplierId:null,supplierCode:null,logisticsMode:null,documentTime:null,logisticsCost:null,sendSomeone:null,organizationId:"",isInsurancePrice:"",merchandiseCost:null,receiptName:"",phone:"",coverageForce:"",receivingAddress:"",isDel:1,createName:"",updateName:"",createTime:"",updateTime:"",examineVerifyName:"",examineVerifyTime:"",logisticsDispatchingDetailList:[{id:null,logisticsDocumentNo:null,logisticsCompany:null,logisticsBillNo:null,logisticsCost:"",logisticsPrice:"",logisticsAmountAmount:"",firstPrice:"",firstAmountAmount:"",secondPrice:"",secondAmountAmount:"",isDel:1}],logisticsDispatchingSourceList:[{sourceNo:"",sourceType:null,documentNo:null}]},data_config1:{url:contextPath+"/js/warehouse/logistics-dispatch/logistics-dispatch-info1.json",datatype:"json",colNames:["操作类型","开始级次","目的级次","审批人","审批意见","审批时间"],colModel:[{name:"a1",width:150,align:"left"},{name:"a2",width:150,align:"left"},{name:"a3",width:150,align:"left"},{name:"a4",align:"left",width:150},{name:"a5",align:"left",width:250},{name:"a6",align:"left",width:180}],rowNum:5,rowList:[10,20,30],mtype:"post",viewrecords:!0}},methods:{changeSelected:function(e){console.log(e,"uuuuuuu")},isEdit:function(e){eventHub.$emit("isEdit",e)},saveAccess:function(e,t){eventHub.$emit("saveFile",e,t)},getAccess:function(e,t){eventHub.$emit("queryFile",e,t)},add:function(){window.parent.activeEvent({name:"新增物流配送单",url:contextPath+"/warehouse/logistics-dispatch/logistics-dispatch-info.html",params:{data:"Y",type:"add"}})},exit:function(){window.parent.closeCurrentTab({name:"新增物流配送单",openTime:this.openTime,exit:!0})},list:function(){window.parent.activeEvent({name:"物流配送单列表",url:contextPath+"/warehouse/logistics-dispatch/logistics-dispatch-list.html"})},save:function(){var t=this;t.saveStruts?t.$Modal.warning({title:"提示信息",content:"单据已经保存！"}):(!t.saveData.custId&&t.saveData.custCode&&(t.saveData.custId=t.custId),!t.saveData.supplierId&&t.saveData.supplierCode&&(t.saveData.supplierId=t.supplierId),null==t.saveData.id?url=contextPath+"/logisticsdispatching/save":url=contextPath+"/logisticsdispatching/update",window.top.home.loading("show"),this.getCodeAndName(),$.ajax({url:url,type:"post",data:JSON.stringify(t.saveData),dataType:"json",contentType:"application/json",success:function(e){window.top.home.loading("hide"),"100100"===e.code&&(t.$Modal.success({title:"提示信息",content:e.msg}),t.saveData=e.data,t.saveAccess(t.saveData.documentNo,"W_LOGISTICS"),t.getAccess(t.saveData.documentNo,"W_LOGISTICS"),t.isEdit("Y")),"100101"===e.code&&t.$Modal.warning({title:"提示信息",content:e.msg})},error:function(e){window.top.home.loading("hide"),alert("服务器出错啦")}}))},rowClick:function(e){if("add"===e)this.saveData.logisticsDispatchingDetailList.push({}),this.tabValid=!0;else if("copy"===e)if(null===this.selectedIndex)this.$Modal.warning({title:"提示信息",content:"请选择一条数据！"});else{var t=Object.assign({},this.saveData.logisticsDispatchingDetailList[this.selectedIndex]);t.id=null,this.saveData.logisticsDispatchingDetailList.push(t),this.$forceUpdate(),this.selectedIndex=null,this.tabValid=!0}},action2:function(){null===this.selectedIndex?this.$Modal.warning({title:"提示信息",content:"请选择一条数据！"}):(this.saveData.logisticsDispatchingDetailList.splice(this.selectedIndex,1),this.$forceUpdate(),this.selectedIndex=null)},action1:function(e){this.selectedIndex=e},search:function(){},tableValidate:function(){return htValidateRow(this.saveData.logisticsDispatchingDetailList,{logisticsCompany:{name:"物流公司",type:"string"},logisticsBillNo:{name:"物流单号",type:"string"},logisticsCost:{name:"物流费用",type:"number",floor:2}})},submit:function(){if(!$("form").valid()||this.tableValidate())return!1;var t=this;1==t.saveData.documentStatus?(window.top.home.loading("show"),t.getCodeAndName(),t.saveData.documentStatus=2,$.ajax({url:contextPath+"/logisticsdispatching/updateApproval",type:"POST",data:JSON.stringify(t.saveData),contentType:"application/json;charset=utf-8",dataType:"json"}).done(function(e){return window.top.home.loading("hide"),"100100"===e.code?(t.isEdit("N"),t.saveData=e.data,1!=t.saveData.documentStatus&&(t.isDisabled=!0,t.generaterDisabled=!0,t.disabledSupplierSelect=!0,t.disabledCustomSelect=!0),$(".is-disabled-add").css("pointer-events","none").css({color:"#bbbec4"}),$(".is-disabled-submit").css("pointer-events","none").css({color:"#bbbec4"}),void t.$Modal.success({title:"提示信息",content:e.msg})):"-1"!==e.code?"100101"===e.code?(t.saveData.documentStatus=1,void t.$Modal.warning({title:"提示信息",content:e.msg})):void 0:void t.$Modal.error({title:"提示信息",content:"服务器出错啦!"})}).fail(function(e){window.top.home.loading("hide"),alert("服务器出错啦")})):t.$Modal.warning({title:"提示信息",content:"物流配送单已提交!"})},htprint:function(){htPrint()},getLogisticMode:function(e){this.deliveryType=getCodeList("jxc_jxc_wlfs"),this.saveData.logisticsMode=e},getCompany:function(){this.selectLogisticsCompany=getCodeList("jxc_jxc_wlgs"),this.saveData.logisticsDispatchingDetailList.logisticsCompany="sfsy"},getOrgan:function(){var t=this;window.top.home.loading("show"),$.ajax({type:"post",url:contextPath+"/entrustOut/getOrgName",dataType:"json",success:function(e){if(console.log(e),window.top.home.loading("hide"),"100100"===e.code)t.saveData.organizanizationId=e.data.id,t.organizanizationName=e.data.name;else if("-1"===e.code)return void t.$Modal.warning({title:"提示信息",content:"服务器出错啦!"});if("100101"===e.code)return t.saveData.documentStatus=1,void t.$Modal.warning({title:"提示信息",content:e.msg})},error:function(){window.top.home.loading("hide"),alert("服务器出错啦")}})},getOrganName:function(e){window.top.home.loading("show");var t=this;$.ajax({type:"post",url:contextPath+"/logisticsdispatching/queryOrgByOrganId",dataType:"json",data:{orgId:e},success:function(e){window.top.home.loading("hide"),"100100"===e.code&&(t.organizanizationName=e.data.orgName),"-1"!==e.code?"100101"!==e.code||t.$Modal.warning({title:"提示信息",content:e.msg}):t.$Modal.warning({title:"提示信息",content:"服务器出错啦!"})},error:function(){window.top.home.loading("hide"),alert("服务器出错啦")}})},getUpdateData:function(e,t){var a,s=this;"update"===t?(this.isDisabled=!1,this.generaterDisabled=!1,a=JSON.stringify({id:e})):"query"===t&&($(".is-disabled").css("pointer-events","none").css({color:"#bbbec4"}),this.isDisabled=!0,this.generaterDisabled=!0,this.disabledSupplierSelect=!0,this.disabledCustomSelect=!0,a=JSON.stringify({documentNo:e}),this.getAccess(e,"W_LOGISTICS")),window.top.home.loading("show"),$.ajax({url:contextPath+"/logisticsdispatching/queryDocumentNo",type:"post",data:a,dataType:"json",contentType:"application/json",success:function(e){if(window.top.home.loading("hide"),"100100"===e.code)s.saveData=e.data[0],s.getOrganName(s.saveData.organizationId),s.isDisabledInput(t),"update"==t&&(s.getAccess(s.saveData.documentNo,"W_LOGISTICS"),s.isEdit("Y")),0<s.saveData.logisticsDispatchingSourceList.length&&(s.generaterDisabled=!0,s.disabledSupplierSelect=!0,s.disabledCustomSelect=!0),1!=s.saveData.documentStatus&&(s.isDisabled=!0,s.generaterDisabled=!0,s.disabledSupplierSelect=!0,s.disabledCustomSelect=!0),4==s.saveData.documentStatus&&(s.isStampShow=!0);else if("-1"===e.code)return void s.$Modal.warning({title:"提示信息",content:"服务器出错啦!"});"100101"===e.code&&s.$Modal.warning({title:"提示信息",content:"数据显示失败!"})},error:function(e){window.top.home.loading("hide"),alert("服务器出错啦")}})},approval:function(){var e=this;if(1===e.saveData.documentStatus||!e.saveData.documentNo)return e.$Modal.error({title:"警告!",content:"请先提交单据!"}),!1;e.modalType="approve",e.modalTrigger=!e.modalTrigger},reject:function(){var e=this;if(1===e.saveData.documentStatus||!e.saveData.documentNo)return e.$Modal.error({title:"警告!",content:"请先提交单据!"}),!1;e.modalType="reject",e.modalTrigger=!e.modalTrigger},approvalOrRejectCallBack:function(e){var t=this;"100100"==e.result.code&&(t.saveData.documentStatus=e.result.data,1==t.saveData.documentStatus?(0<t.saveData.logisticsDispatchingSourceList.length?(t.generaterDisabled=!0,t.isDisabled=!1,t.disabledSupplierSelect=!0,t.disabledCustomSelect=!0,t.isOpened=!1):(t.isStampShow=!1,t.isDisabled=!1,t.generaterDisabled=!1,t.isOpened=!1,"S_OUT_STOCK"===t.saveData.businessType?(t.disabledSupplierSelect=!0,t.disabledCustomSelect=!1):"S_OUT_STOCK"!==t.saveData.businessType&&(t.disabledSupplierSelect=!1,t.disabledCustomSelect=!0),"W_CMATERIAL_OUT_01"===t.saveData.businessType?(t.disabledSupplierSelect=!1,t.disabledCustomSelect=!1):"W_CMATERIAL_OUT_02"===t.saveData.businessType&&(t.disabledSupplierSelect=!1,t.disabledCustomSelect=!1)),t.isEdit("Y"),t.saveData.examineVerifyName="",t.saveData.examineVerifyTime="",$(".is-disabled-submit").css({"pointer-events":"auto "}).css({color:"#495060"}),$(".is-disabled-add").css({"pointer-events":"auto "}).css({color:"#495060"})):2==t.saveData.documentStatus?(t.isStampShow=!1,t.isDisabled=!0,t.generaterDisabled=!0,t.disabledSupplierSelect=!0,t.disabledCustomSelect=!0,t.isOpened=!0):4==t.saveData.documentStatus?(t.isStampShow=!0,t.saveStruts=!0,t.saveData.examineVerifyName=layui.data("user").username,t.saveData.examineVerifyTime=(new Date).format("yyyy-MM-dd HH:mm:ss")||""):5==t.saveData.documentStatus&&(t.isStampShow=!1,t.saveData.examineVerifyName="",t.saveData.examineVerifyTime=""))},autoApproveOrReject:function(e){var t=this;$.ajax({url:contextPath+"/logisticsdispatching/submitapproval?submitType=1",method:"post",contentType:"application/json;charset=utf-8",data:JSON.stringify({receiptsId:t.saveData.documentNo,approvalResult:"reject"==t.modalType?1:0}),success:function(e){"100100"===e.code?(t.saveData.documentStatus=parseInt(e.data),1==t.saveData.documentStatus?(0<t.saveData.logisticsDispatchingSourceList.length?(t.generaterDisabled=!0,t.isDisabled=!1,t.disabledSupplierSelect=!0,t.disabledCustomSelect=!0,t.isOpened=!1):(t.isStampShow=!1,t.isDisabled=!1,t.generaterDisabled=!1,t.isOpened=!1,"S_OUT_STOCK"===t.saveData.businessType?(t.disabledSupplierSelect=!0,t.disabledCustomSelect=!1):"S_OUT_STOCK"!==t.saveData.businessType&&(t.disabledSupplierSelect=!1,t.disabledCustomSelect=!0)),t.isEdit("Y"),t.saveData.examineVerifyName="",t.saveData.examineVerifyTime=""):4==t.saveData.documentStatus&&(t.isStampShow=!0,t.saveStruts=!0,t.saveData.examineVerifyName=layui.data("user").username,t.saveData.examineVerifyTime=(new Date).format("yyyy-MM-dd HH:mm:ss")||"")):t.$Modal.warning({content:e.msg})}})},getSupplier:function(){var t=this;$.ajax({type:"post",url:contextPath+"/entrustOut/querySuppliers",contentType:"application/json",dataType:"json",success:function(e){"100100"===e.code&&(t.supplierList=e.data)},error:function(){alert("服务器出错啦")}})},getCust:function(){var t=this;$.ajax({type:"post",url:contextPath+"/entrustOut/queryAllCustomer",contentType:"application/json",dataType:"json",success:function(e){"100100"===e.code&&(t.custList=e.data)},error:function(){alert("服务器出错啦")}})},getCodeAndName:function(){var e=this;if(e.saveData.supplierId)for(var t in e.supplierList)if(e.supplierList[t].id===e.saveData.supplierId){e.saveData.supplierCode=e.supplierList[t].supplierName;break}if(e.saveData.custId)for(var a in e.custList)if(e.custList[a].id===e.saveData.custId){e.saveData.custCode=e.custList[a].name;break}},isDisabledInput:function(e){if("query"!=e)return"W_CMATERIAL_OUT_01"===this.saveData.businessType?(this.disabledSupplierSelect=!1,void(this.disabledCustomSelect=!1)):"W_CMATERIAL_OUT_02"===this.saveData.businessType?(this.disabledSupplierSelect=!1,void(this.disabledCustomSelect=!1)):void(""===this.saveData.businessType?(this.disabledSupplierSelect=!0,this.disabledCustomSelect=!0):"S_OUT_STOCK"===this.saveData.businessType?(this.disabledSupplierSelect=!0,this.disabledCustomSelect=!1,this.saveData.supplierCode=null,this.saveData.supplierId=null):"S_OUT_STOCK"!==this.saveData.businessType&&(this.disabledSupplierSelect=!1,this.disabledCustomSelect=!0,this.saveData.custCode=null,this.saveData.custId=null))},clearNoNumber:function(e,t,a){return htInputNumber(e,t,a)}},mounted:function(){var e=this;this.getCompany(),this.getSupplier(),this.getCust(),this.getLogisticMode(""),$("form").validate(),this.param=window.parent.params.params,this.openTime=window.parent.params.openTime;var t=window.parent.params.params;if("generater"===t.type){this.isOpened=!0,this.isEdit("Y"),this.generaterDisabled=!0,this.$nextTick(function(){e.saveData.documentTime=new Date,e.getLogisticMode(t.data[0].logisticsMode),e.saveData.custId=t.data[0].custId,e.saveData.custCode=t.data[0].custName,e.saveData.supplierId=t.data[0].supplierId,e.saveData.supplierCode=t.data[0].supplierName,e.saveData.organizationId=t.data[0].organizationId,"W_EMATERIAL_OUT"==t.data[0].docCode?e.saveData.businessType=t.data[0].businessType:e.saveData.businessType=t.data[0].docCode,e.getOrganName(e.saveData.organizationId)}),this.$forceUpdate(),"W_EMATERIAL_OUT"==this.saveData.businessType&&(this.saveData.businessType=t.data[0].businessType);for(var a=0;a<t.data.length;a++)this.saveData.logisticsDispatchingSourceList[a]={sourceNo:"",sourceType:null,documentNo:null},this.saveData.logisticsDispatchingSourceList[a].sourceType=t.data[a].docCode,this.saveData.logisticsDispatchingSourceList[a].sourceNo=t.data[a].docNo}else"update"===t.type||"query"===t.type?this.getUpdateData(t.data,t.type):(this.isEdit("Y"),this.saveData.logisticsDispatchingSourceList=[],this.getOrgan(),this.saveData.documentTime=new Date)}});