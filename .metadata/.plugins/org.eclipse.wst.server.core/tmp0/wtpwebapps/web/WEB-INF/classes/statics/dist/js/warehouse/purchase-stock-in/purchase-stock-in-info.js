"use strict";var vm=new Vue({el:"#app",data:{codesUsed:{},showRows:!0,goodsListTotalWeight:0,totalDetailPurchaseCost:0,totalDetailMarketCost:0,totalPurPriceCost:0,totalSalePrice:0,showTemp:!0,one:!0,isShow:!1,reload:!1,isSearchHide:!0,isTabulationHide:!0,isClearable:!0,businessType:"",stepList:[],psiDocTypes:[{label:"采购入库",value:"W_PURCHASE_STOCK_IN_01"},{label:"供应商退料入库",value:"W_PURCHASE_STOCK_IN_02"}],currOrgName:"",psiForm:{businessType:"",stockNo:"",purDepartmentId:"",purDepartmentName:"",recMaterialDepartmentId:"",recMaterialDepartmentName:"",buyerId:"",buyerName:"",stockTime:new Date,stockKeeperId:"",stockKeeper:"",custName:"",custCode:"",custId:"",supplierName:"",supplierCode:"",supplierId:"",sourceDocType:"",id:"",goodsTypeId:"",goodsTypeName:"",dataSource:"",docStatus:1},purchaseStockDetails:[],delPurchaseStockDetails:[],goodList:[],categoryType:[],goodsTypes:[],treeSetting:{},showDepartment:!1,customers:[],suppliers:[],isSelectAll:"",goodsTypesArr:[],selectedIndex:"",units:[],currentTab:"purchaseDetail",warehouses:[],warehousePositions:[],modalTrigger:!1,modalType:"",goldColors:[],certifiTypes:[],approvalTableData:[],detailSelectedIdx:"",productDetailModal:{showModal:!1,ids:{goodsId:"",commodityId:"",documentType:"W_STOCK_IN"}},goldDetailModal:{showModal:!1,ids:{goodsId:"",commodityId:"",documentType:"W_STOCK_IN_GOLD"}},importExcelType:"",excelFile:"",documentType:"W_PURCHASE_STOCK_IN",excelParam:"",specialAttr:{},submitValid:!0,canBeEdited:!0,openTime:"",isHideDivided:!1,employees:[],openType:"",rawOptionData:[]},created:function(){this.specialAttr={stone:[{name:"条码号",code:"stoneNo",edit:!0,test:!1},{name:"进价",code:"inPrice",edit:!0},{name:"单价",code:"price",edit:!0}],gold:[],part:[{name:"进价",code:"inPrice",edit:!0},{name:"单价",code:"price",edit:!0}]},this.loadCategories(),this.treeSetting={callback:{onClick:this.treeClickCallBack,beforeClick:this.treeBeforeClick},check:{enable:!0,chkStyle:"radio",radioType:"all"}},this.loadCustomers(),this.loadSuppliers(),this.loadUnits(),this.loadWarehouses(),this.ajaxGetWareHousePositions(),this.loadEmployees(),this.goldColors=getCodeList("base_Condition"),this.certifiTypes=getCodeList("base_certificate_type"),this.openTime=window.parent.params.openTime},methods:{updateCodesUsed:function(e,t){var o,i=this,a={},s={},r=i.goodList||[];void 0!==e&&void 0!==t&&8!=String(e).length&&(r[t].goodsBarcode=""),$.each(i.purchaseStockDetails,function(e,t){$.isArray(t.goodList)&&0<t.goodList.length&&$.each(t.goodList,function(e,t){a[Number(t.goodsBarcode)]=""})}),$.isArray(r)&&0<r.length&&$.each(r,function(e,t){s[Number(t.goodsBarcode)]=""}),o=$.extend(!0,{},a,s),i.codesUsed=o},getRawOptionData:function(e){var t=this;$.post(contextPath+"/tbasecommodity/findByType",{categoryCustomCode:e,field:"",limit:""},function(e){"100100"===e.code&&(t.rawOptionData=e.data||[])},"json")},loadEmployees:function(){var t=this;$.ajax({url:contextPath+"/purchasestock/queryStockKeepers",method:"post",data:{},success:function(e){"100100"===e.code?t.employees=e.data:t.$Modal.warning({content:e.msg})}})},getSelect:function(e,t){return repositionDropdownOnSroll(e,t)},fillColumn:function(){return this.getAmount(this.detailSelectedIdx)},getAmount:function(e){var t=this;if(0<=e){var o=document.getElementById("totalWeight"+e).value,i=document.getElementById("purchaseGoldPrice"+e).value,a=document.getElementById("goldPrice"+e).value,s=document.getElementById("goldPurchase"+e).value,r=document.getElementById("purchaseLaborCharge"+e).value,n=document.getElementById("processingFee"+e).value,c=document.getElementById("purCertificateFee"+e).value,d=document.getElementById("certificateFee"+e).value,l=document.getElementById("marketCost"+e).value,u=document.getElementById("saleRate"+e).value;this.$nextTick(function(){t.goodList.map(function(e){e.totalWeight=o,e.marketCost=l,e.purchaseGoldPrice=i,e.goldPrice=a,e.goldPurchase=s,e.purchaseLaborCharge=r,e.processingFee=n,e.purCertificateFee=c,e.certificateFee=d,e.saleRate=u})})}},hideDivided:function(){var e=this;0!==e.purchaseStockDetails.length&&(e.showRows=!e.showRows)},exit:function(){window.parent.closeCurrentTab({name:"采购入库列表",openTime:this.openTime,exit:!0})},salePriceAction:function(e){if(this.detailSelectedIdx===e&&this.goodList[this.detailSelectedIdx].saleRate&&this.goodList[this.detailSelectedIdx].purPriceCost){var t=Number(this.goodList[this.detailSelectedIdx].saleRate)*Number(this.goodList[this.detailSelectedIdx].purPriceCost);this.goodList[this.detailSelectedIdx].salePrice=t.toFixed(2),this.$forceUpdate()}},clearNoNumber:function(e,t,o){return htInputNumber(e,t,o)},tableValidate:function(){if("W_PURCHASE_STOCK_IN_02"===this.psiForm.businessType){return goodsValidateRow(this.purchaseStockDetails,{goodsBarcode:{name:"条码号",type:"string"},certificateType:{name:"证书类型",type:"string"},certificateNo:{name:"证书编号",type:"string"},totalWeight:{name:"总件重",type:"number",floor:3},netGoldWeight:{name:"净金重",type:"number",floor:3},mainStoneWeight:{name:"主石重",type:"number",floor:3},purchaseGoldLose:{name:"进货金耗",type:"number",floor:2},goldPurchase:{name:"金耗",type:"number",floor:2},purchaseLaborCharge:{name:"进货工费",type:"number",floor:2},processingFee:{name:"销售工费",type:"number",floor:2},purchaseCost:{name:"进货成本",type:"number",floor:2},marketCost:{name:"市场成本",type:"number",floor:2},purPriceCost:{name:"销售成本",type:"number",floor:2},saleRate:{name:"销售倍率",type:"number",floor:2}},!0,"商品明细")}return goodsValidateRow(this.purchaseStockDetails,{certificateType:{name:"证书类型",type:"string"},certificateNo:{name:"证书编号",type:"string"},totalWeight:{name:"总件重",type:"number",floor:3},netGoldWeight:{name:"净金重",type:"number",floor:3},mainStoneWeight:{name:"主石重",type:"number",floor:3},purchaseGoldLose:{name:"进货金耗",type:"number",floor:2},goldPurchase:{name:"金耗",type:"number",floor:2},purchaseCost:{name:"进货成本",type:"number",floor:2},marketCost:{name:"市场成本",type:"number",floor:2},purPriceCost:{name:"销售成本",type:"number",floor:2},saleRate:{name:"销售倍率",type:"number",floor:2}},!0,"商品明细")},goBackList:function(){window.parent.activeEvent({name:"采购入库列表",url:contextPath+"/warehouse/purchase-stock-in/purchase-stock-in-list.html",params:{}})},approval:function(){var e=this;if(1===e.docStatus||!this.psiForm.stockNo)return e.$Modal.error({title:"警告!",content:"请先提交入库单!"}),!1;e.modalType="approve",e.modalTrigger=!e.modalTrigger},reject:function(){var e=this;if(1===e.docStatus||!this.psiForm.stockNo)return e.$Modal.error({title:"警告!",content:"请先提交入库单!"}),!1;e.modalType="reject",e.modalTrigger=!e.modalTrigger},approvalOrRejectCallBack:function(e){"100100"===e.result.code&&(this.psiForm.docStatus=parseInt(e.result.data))},autoSubmitOrReject:function(e){var t=this;$.ajax({url:contextPath+"/purchasestock/submitapproval?submitType=1",method:"post",contentType:"application/json;charset=utf-8",data:JSON.stringify({receiptsId:t.psiForm.stockNo,approvalResult:"reject"===t.modalType?1:0}),success:function(e){"100100"===e.code?t.psiForm.docStatus=parseInt(e.data):t.$Modal.warning({content:e.msg})}})},ajaxUpdateDocStatusById:function(e,t){var o=this;$.ajax({url:contextPath+"/purchasestock/updateDocStatusById",method:"POST",dataType:"json",data:{id:e,docStatus:t},success:function(e){"100100"===e.code&&(o.psiForm.docStatus=t)}})},ajaxGetWareHousePositions:function(){var t=this;$.ajax({url:contextPath+"/purchasestock/queryAllReposition",method:"POST",dataType:"json",data:{},success:function(e){t.warehousePositions=[],"100100"===e.code&&(t.warehousePositions=e.data.map(function(e){return Object.assign({},{value:e.id,label:e.code})}))}})},clickPurchaseDetail:function(e){var t=this,o=t.selectedIndex,i=t.goodList.every(function(e){return e.totalWeight});"goodsDetail"===t.currentTab&&t.purchaseStockDetails[o]&&(t.purchaseStockDetails[o].divisionStatus=i?"1":"0",t.purchaseStockDetails[o].goodList=JSON.parse(JSON.stringify(t.goodList))),t.currentTab=e,t.$nextTick(function(){t.getSelect("table-responsive","goods")})},openGoodsTab:function(r){var n=this;if(""===n.selectedIndex)return!1;if(""===n.psiForm.businessType)return n.$Modal.error({title:"警告!",content:"请先填写单据类型!"}),!1;if("attr_ranges_gold"===r.goodsMainType)return!1;if(!r.goodsNo)return n.$Modal.error({title:"警告!",content:"请先填写商品编码!"}),!1;if(r.goodsMainType&&"attr_ranges_gold"!==r.goodsMainType&&!r.actualRecNum)return n.$Modal.error({title:"警告!",content:"请先填写实收数量!"}),!1;n.showTemp||(n.goodList=n.purchaseStockDetails[n.selectedIndex].goodList),this.one=!1;var c=Object.assign({},{batchNum:r.batchNum,certificateFee:"",certificateNo:"",certificateType:"NGTC",totalStonePurchasePrice:0,totalStonePrice:0,commodityId:r.commodityId,countingUnitId:r.countingUnitId,countingUnitName:r.countingUnit,custId:n.psiForm.custId||"",custStyleCode:r.custStyleCode,custStyleType:r.custStyleType,goldColor:"",goldPrice:"",goldPurchase:"",goldWeight:"",goodsBarcode:"",goodsName:r.goodsName,goodsNo:r.goodsNo,goodsNorm:r.goodsNorm,goodsType:"",goodsTypeId:"",groupPath:"",id:"",isDel:1,labCgeMode:"",mainStoneWeight:"",marketCost:"",nature:"",netGoldWeight:"",occupiedStatus:"",otherFee:"",otherFeeMode:"",otherFeeName:"",processingFee:"",purCertificateFee:"",purLabCgeMode:"",purOtherFee:"",purPriceCost:"",purchaseCost:"",purchaseGoldLose:"",purchaseGoldPrice:"",purchaseLaborCharge:"",remark:"",warehouseId:r.warehouseId,salePrice:"",saleRate:"",soldStatus:"",standardCertType:"",stockInNo:"",stockType:"",stoneClarity:"",stoneColor:"",stoneSection:"",supplierId:n.psiForm.supplierId,totalWeight:"",viceStoneWeight:"",weight:"",weightUnitId:r.weightUnitId,weightUnitName:r.weightUnit,goodsMainType:r.goodsMainType,goldColors:this.goldColors.map(function(e){return Object.assign({},{name:e.name,value:e.value})}),certifiTypes:this.certifiTypes.map(function(e){return Object.assign({},{name:e.name,value:e.value})})});n.$nextTick(function(){if(0===n.purchaseStockDetails[n.selectedIndex].goodList.length){for(var e=[],t=0;t<parseInt(r.actualRecNum);t++)e.push($.extend(!0,{},c));n.goodList=e}else{var o=[];console.log(Number(r.actualRecNum));var i=n.purchaseStockDetails[n.selectedIndex].goodList.length;if(Number(r.actualRecNum)>i){for(var a=Number(r.actualRecNum)-n.goodList.length,s=0;s<a;s++)o.push($.extend(!0,{},c));1===n.psiForm.docStatus?n.goodList=n.purchaseStockDetails[n.selectedIndex].goodList.concat(o):n.goodList=n.purchaseStockDetails[n.selectedIndex].goodList}else Number(r.actualRecNum)===i?n.goodList=n.purchaseStockDetails[n.selectedIndex].goodList:(n.purchaseStockDetails[n.selectedIndex].delGoodList=n.purchaseStockDetails[n.selectedIndex].goodList.filter(function(e,t){return t>=Number(r.actualRecNum)&&e.id}),n.goodList=n.purchaseStockDetails[n.selectedIndex].goodList.filter(function(e,t){return t<Number(r.actualRecNum)}));n.$forceUpdate()}n.currentTab="goodsDetail",setTimeout(function(){n.getSelect("table-responsive","goods-child")},3e3)})},delDetailRow:function(){var t=this;if(0===t.purchaseStockDetails.length)return!1;var o=t.selectedIndex;t.$Modal.confirm({title:"提示",content:"确定删除选中的分录行吗?",onOk:function(){t.purchaseStockDetails[o].isDel=0;var e=t.purchaseStockDetails.filter(function(e){return 0==e.isDel&&e.id});t.delPurchaseStockDetails=t.delPurchaseStockDetails.concat(e),t.purchaseStockDetails.splice(o,1)}}),this.updateCodesUsed()},addDetailRow:function(){var e=this;if(!e.psiForm.goodsTypePath)return e.$Modal.warning({content:"请先选择商品类型",title:"警告"}),!1;var t=Object.assign({},{isCheck:"",sourceDocType:"",sourceDocNo:"",batchNum:"",pictureUrl:"",goodsNo:"",goodsName:"",divisionStatus:"0",goodsNorm:"",countingUnitId:"",certificateTypeId:"",receivableNum:"",actualRecNum:"",weightUnitId:"",receivableWeight:"",actualRecWeight:"",purchaseCost:"",marketCost:"",saleCost:"",totalSaleAmount:"",warehouseId:"",reservoirPositionId:"",remark:"",isDel:1,custId:"",supplierId:"",goodList:[],delGoodList:[],goldColors:getCodeList("base_Condition"),warehousePositions:e.warehousePositions.map(function(e){return $.extend(!0,{},{value:e.id,label:e.code})}),options:e.rawOptionData});e.purchaseStockDetails.push($.extend(!0,{},t)),e.$nextTick(function(){e.getSelect("table-responsive","goods")})},copyDetailRow:function(){var e=this;if(0===e.purchaseStockDetails.length)return!1;if(!e.psiForm.goodsTypePath)return e.$Modal.warning({content:"请先选择商品类型",title:"警告"}),!1;var t=e.selectedIndex;e.submitValid=!0;var o=$.extend(!0,{},e.purchaseStockDetails[t]);o.goodList=[],e.purchaseStockDetails.push(o),e.$nextTick(function(){e.getSelect("table-responsive","goods")})},selectProductDetail:function(e){this.selectedIndex=e},treeClickCallBack:function(e,t,o){this.psiForm.recMaterialDepartmentName=o.name,this.psiForm.recMaterialDepartmentId=o.id,this.showDepartment=!1},treeBeforeClick:function(e,t,o){return!t.isParent},showDepartmentTree:function(e){this.showDepartment?this.showDepartment=!1:this.canBeEdited?this.showDepartment=e:this.showDepartment=!1},docTypeChange:function(e){var t=this;if(e&&0<t.purchaseStockDetails.length){t.purchaseStockDetails.forEach(function(e){e.isDel=0,e.goodList&&0<e.goodList.length&&(e.goodList.forEach(function(e){e.isDel=0}),e.delGoodList=e.goodList.filter(function(e){return 0==e.isDel&&e.id}))});var o=t.purchaseStockDetails.filter(function(e){return 0==e.isDel&&e.id});t.delPurchaseStockDetails=t.delPurchaseStockDetails.concat(o),t.purchaseStockDetails=[],t.goodList=[],t.$forceUpdate()}},changeEmp:function(o){var i=this,e=i.employees;$.each(e,function(e,t){if(t.id===o)return i.psiForm.stockKeeper=t.empName,!1})},changeGoodsType:function(e,t){var o=this;o.psiForm.goodsTypeId&&o.psiForm.goodsTypeName&&o.psiForm.goodsTypePath&&o.$Modal.confirm({content:"修改后原有的明细信息会清空,你确定要修改当前的商品类型吗？",title:"提示",onOk:function(){o.purchaseStockDetails=[]}}),o.psiForm.goodsTypeId=t[t.length-1].value,o.psiForm.goodsTypeName=t[t.length-1].label,o.psiForm.goodsTypePath="0."+e.join(".")+".",o.getRawOptionData(o.psiForm.goodsTypePath)},validateProduct:function(){var o=!0,i=this;return 0<i.goodList.length&&$.each(i.goodList,function(e,t){if(console.log(t,e),t.id)return!0;if("attr_ranges_goods"===t.goodsMainType){if(!t.tBaseBomEntity)return o=!1,i.$Modal.error({content:"第"+(e+1)+"行商品明细未选择，请先选择商品明细！"}),!1}else if("attr_ranges_gold"!==t.goodsMainType&&!t.assistAttrs)return o=!1,i.$Modal.error({content:"第"+(e+1)+"行商品明细未选择，请先选择商品明细！"}),!1}),o},supplierChange:function(o){var i=this,e=i.suppliers;$.each(e,function(e,t){if(t.value===o)return i.psiForm.supplierCode=t.code,i.psiForm.supplierName=t.label,!1})},customerChange:function(o){var i=this,e=i.customers;$.each(e,function(e,t){if(t.value===o)return i.psiForm.custCode=t.code,i.psiForm.custName=t.label,!1})},loadSuppliers:function(){var t=this;$.ajax({url:contextPath+"/purchasestock/querySuppliers",method:"POST",dataType:"json",data:{},success:function(e){t.suppliers=[],"100100"===e.code&&0<e.data.length&&(t.suppliers=e.data.map(function(e){return{label:e.siShortName,value:e.id,code:e.supplierCode}}))}})},loadWarehouses:function(){var t=this;$.ajax({type:"post",url:contextPath+"/purchasestock/queryWarehouses",dataType:"json",success:function(e){t.warehouses=[],"100100"===e.code&&0<e.data.length&&(t.warehouses=e.data.map(function(e){return Object.assign({},{value:e.id,label:e.name})}))},error:function(e){}})},reloadWarehousePosition:function(e){var t=this,o=t.selectedIndex;$.ajax({type:"post",url:contextPath+"/purchasestock/queryWareHouseRepositionById",data:{id:e},dataType:"json",success:function(e){t.purchaseStockDetails[o].warehousePositions=[],"100100"===e.code&&0<e.data.length&&(t.purchaseStockDetails[o].warehousePositions=e.data.map(function(e){return $.extend(!0,{},{value:e.id,label:e.name})}),t.$forceUpdate())},error:function(e){}})},loadUnits:function(){var t=this;$.ajax({type:"post",url:contextPath+"/tbaseunit/list",contentType:"application/json",dataType:"json",success:function(e){"100100"===e.code&&(t.units=e.data)},error:function(e){}})},loadCategories:function(){var t=this;$.ajax({type:"post",url:contextPath+"/purchasestock/queryCategories",data:{parentId:0},dataType:"json",success:function(e){"100100"===e.code&&(t.categoryType=t.initGoodCategory(e.data.cateLists))},error:function(){}})},loadCustomers:function(){var t=this;$.ajax({type:"post",url:contextPath+"/purchasestock/queryCustomers",data:{},dataType:"json",success:function(e){t.customers=[],"100100"===e.code&&0<e.data.length&&e.data.forEach(function(e){t.customers.push(Object.assign({},{label:e.name,value:e.id,code:e.code}))})},error:function(){}})},initGoodCategory:function(e){var a=this,s=[];return e.forEach(function(e){var t=e.id,o=e.name,i=e.cateLists;i&&(i=a.initGoodCategory(i)),s.push({value:t,label:o,children:i})}),s.forEach(function(e){e.children||delete e.children}),s},changeDate:function(e){this.psiForm.stockTime=e.replace(/\//g,"-")+" 00:00:00"},changeWarehouse:function(e){this.reloadWarehousePosition(e)},save:function(e){var t=this,o=$("form").valid();return""!==t.selectedIndex&&"attr_ranges_gold"!==t.purchaseStockDetails[t.selectedIndex].goodsMainType&&(t.purchaseStockDetails[t.selectedIndex].goodList=t.goodList),!(!o||t.validatePurchaseStockDetail()||t.tableValidate())&&(t.psiForm.stockNo&&2===t.psiForm.docStatus&&"submit"===e?(t.$Modal.warning({content:"单据已提交!",title:"警告"}),!1):(t.psiForm.docStatus="tmp_save"===e?1:2,void t.ajaxSave(e)))},ajaxSave:function(t){var o=this,e=Object.assign({},{purchaseStock:o.psiForm,purchaseStockDetails:0<o.purchaseStockDetails.length?o.formatData2Sumbit():[],delPurchaseStockDetails:o.delPurchaseStockDetails});window.top.home.loading("show",{text:"保存中，请稍后!"}),$.ajax({url:contextPath+"/purchasestock/saveStockIn",method:"post",dataType:"json",contentType:"application/json;charset=utf-8",data:JSON.stringify(e),success:function(e){"100100"===e.code?(o.psiForm=$.extend(!0,{},e.data.purchaseStock),e.data.purchaseStockDetails&&0<e.data.purchaseStockDetails.length?(o.purchaseStockDetails=e.data.purchaseStockDetails.map(function(e){var t,o={goldColors:getCodeList("base_Condition"),certifiTypes:getCodeList("base_certificate_type")};return $.extend({},o,{id:e.id,purStockInNo:e.purStockInNo,commodityId:e.commodityId,sourceDocType:e.sourceDocType||"",sourceDocNo:e.sourceDocNo||"",batchNum:e.batchNum||"",pictureUrl:e.pictureUrl||"",goodsNo:e.goodsNo||"",goodsName:e.goodsName||"",divisionStatus:e.divisionStatus.toString()||"0",goodsNorm:e.goodsNorm||"",countingUnitId:e.countingUnitId||"",certificateTypeId:e.certificateTypeId||"",receivableNum:e.receivableNum||0,actualRecNum:e.actualRecNum||0,weightUnitId:e.weightUnitId||0,receivableWeight:e.receivableWeight||0,actualRecWeight:e.actualRecWeight||0,purchaseCost:e.purchaseCost||0,marketCost:e.marketCost||0,saleCost:e.saleCost||0,goodsMainType:e.goodsMainType,totalSaleAmount:e.totalSaleAmount||0,warehouseId:e.warehouseId,reservoirPositionId:e.reservoirPositionId,remark:e.remark||"",isDel:e.isDel,custId:e.custId,goldColor:e.goldColor,supplierId:e.supplierId,goodList:(t=e.goodList,t?t.map(function(e){var t={goldColors:getCodeList("base_Condition"),certifiTypes:getCodeList("base_certificate_type")};return $.extend({},t,e)}):[])})}),""!==o.selectedIndex&&"attr_ranges_gold"!==o.purchaseStockDetails[o.selectedIndex].goodsMainType&&(o.goodList=o.purchaseStockDetails[o.selectedIndex].goodList)):o.purchaseStockDetails=[],o.$Modal.success({content:"tmp_save"===t?"保存成功!":"提交成功!",title:"提示"}),window.top.home.loading("hide"),o.saveAccess(e.data.purchaseStock.stockNo,o.documentType)):(o.$Modal.warning({content:e.msg,title:"警告!"}),window.top.home.loading("hide"))},error:function(e){window.top.home.loading("hide")}})},getSelectedItem:function(e,o){var i=this;$.ajax({type:"post",url:contextPath+"/tbasecommodity/info/"+e.id,dataType:"json",success:function(e){var t=e.data;i.$set(i.purchaseStockDetails,o,Object.assign(i.purchaseStockDetails[o],{goodsNo:t.code,goodsName:t.name,commodityId:t.id,pictureUrl:t.frontPic&&t.frontPic.fdUrl,goodsTypeName:t.categoryName,goodsNorm:t.specification,custStyleCode:t.styleCustomCode,custStyleType:t.styleName,countingUnitId:t.countUnitId,countingUnit:t.countUnitId?i.units[i.units.map(function(e){return e.id}).indexOf(t.countUnitId)].name:"",weightUnitId:t.weightUnitId,weightUnit:t.weightUnitId?i.units[i.units.map(function(e){return e.id}).indexOf(t.weightUnitId)].name:"",goodsMainType:t.mainType,goldColor:"attr_ranges_gold"===t.mainType?t.certificateType:""}))},error:function(){}})},getInputValue:function(e,t){var o=this,i={categoryCustomCode:o.psiForm.goodsTypePath,field:e,limit:""};$.ajax({type:"post",url:contextPath+"/tbasecommodity/findByType",data:i,dataType:"json",success:function(e){"100100"===e.code&&(Object.assign(o.purchaseStockDetails[t],{options:e.data}),o.$forceUpdate())},error:function(){}})},exportExcel:function(){location.href=contextPath+"/purchasestock/exportExcelModel?modelName=采购入库单条码明细导入模板.xls"},importGoodsDetail:function(){var o=this;if(!o.importExcelType)return o.$Modal.warning({content:"请选择导入类型!",title:"警告!"}),!1;var i=[];o.purchaseStockDetails.map(function(e,t){0===t?i.push(Object.assign({},{lineNo:t+1,goodsNo:e.goodsNo,goldColors:o.goldColors,actualRecNum:e.actualRecNum,commodityId:e.commodityId})):i.push(Object.assign({},{lineNo:t+1,goodsNo:e.goodsNo,actualRecNum:e.actualRecNum,commodityId:e.commodityId}))}),o.excelParam=Object.assign({},{excelParam:JSON.stringify(i)}),o.$refs.upload.$refs.input.click()},handleBeforeUpload:function(e){},loadExcelData:function(r){var n=this;if(0===r.length)return!1;"1"===n.importExcelType&&(n.purchaseStockDetails.forEach(function(e,o){e.goodList.forEach(function(e){e.isDel=0});for(var t=[],i=r.filter(function(e,t){return e.lineNo===(o+1).toString()}),a=0;a<parseInt(e.actualRecNum);a++){var s=i[a];t.push($.extend(!0,{},{goodsName:e.goodsName,goodsNo:e.goodsNo,goodsType:n.psiForm.goodsTypeName,goodsTypeId:n.psiForm.goodsTypeId,groupPath:n.psiForm.goodsTypePath,id:"",isDel:1,labCgeMode:"",commodityId:e.commodityId,countingUnitId:e.countingUnitId,countingUnitName:e.countingUnit,custId:n.psiForm.custId||"",custStyleCode:e.custStyleCode,custStyleType:e.custStyleType,goodsBarcode:"",certificateType:"NGTC",batchNum:e.batchNum,nature:"",occupiedStatus:"",otherFeeMode:"",purLabCgeMode:"",reservoirPositionId:e.reservoirPositionId,soldStatus:"",standardCertType:"",stockInNo:"",stockType:"",stoneClarity:"",stoneColor:"",stoneSection:"",supplierId:n.psiForm.supplierId,viceStoneWeight:"",warehouseId:e.warehouseId,weight:"",weightUnitId:e.weightUnitId,weightUnitName:e.weightUnit,goodsMainType:e.goodsMainType,goldColor:s.goldColor?s.goldColor:"",goldColors:getCodeList("base_Condition"),certifiTypes:getCodeList("base_certificate_type"),goldPrice:s.goldPrice?Number(s.goldPrice):0,netGoldWeight:s.netGoldWeight?Number(s.netGoldWeight):0,purchaseGoldLose:s.purchaseGoldLose?Number(s.purchaseGoldLose):0,purchaseCost:s.purchaseCost?Number(s.purchaseCost):0,otherFee:s.otherFee?Number(s.otherFee):0,purchaseGoldPrice:s.purchaseGoldPrice?Number(s.purchaseGoldPrice):0,certificateFee:s.certificateFee?Number(s.certificateFee).toFixed(2):0,purPriceCost:s.certificateFee?Number(s.purPriceCost):0,processingFee:s.processingFee?Number(s.processingFee):0,goldPurchase:s.goldPurchase?Number(s.goldPurchase):0,saleRate:s.saleRate?Number(s.saleRate):0,purOtherFee:s.purOtherFee?Number(s.purOtherFee):0,marketCost:s.marketCost?Number(s.marketCost):0,purCertificateFee:s.purCertificateFee?Number(s.purCertificateFee):0,salePrice:s.salePrice?Number(s.salePrice).toFixed(2):0,purchaseLaborCharge:s.purchaseLaborCharge?Number(s.purchaseLaborCharge):0,totalWeight:s.totalWeight?Number(s.totalWeight):0,mainStoneWeight:s.mainStoneWeight?Number(s.mainStoneWeight):0,certificateNo:s.certificateNo?s.certificateNo:"",otherFeeName:s.otherFeeName?s.otherFeeName:"",goodsNorm:s.goodsNorm?s.goodsNorm:"",remark:s.remark?s.remark:"",isImport:!0,importData:Object.assign({},{tBaseBomEntity:s.tBaseBomEntity||{},goldParts:s.goldParts||[],stonesParts:s.stoneParts||[],partParts:s.partParts||[]})}))}e.delGoodList=e.goodList,e.goodList=t}),n.goodList=n.purchaseStockDetails[n.selectedIndex].goodList,n.$forceUpdate()),"2"===n.importExcelType&&(n.purchaseStockDetails.forEach(function(e,o){for(var t=[],i=r.filter(function(e,t){return e.lineNo===(o+1).toString()}),a=0;a<parseInt(e.actualRecNum);a++){var s=i[a];t.push($.extend(!0,{},{goodsName:e.goodsName,goodsNo:e.goodsNo,goodsType:n.psiForm.goodsTypeName,goodsTypeId:n.psiForm.goodsTypeId,groupPath:n.psiForm.goodsTypePath,id:e.id||"",isDel:1,labCgeMode:"",commodityId:e.commodityId,countingUnitId:e.countingUnitId,countingUnitName:e.countingUnit,custId:n.psiForm.custId||"",custStyleCode:e.custStyleCode,custStyleType:e.custStyleType,goodsBarcode:"",certificateType:"NGTC",batchNum:e.batchNum,nature:"",occupiedStatus:"",otherFeeMode:"",purLabCgeMode:"",reservoirPositionId:"",soldStatus:"",standardCertType:"",stockInNo:"",stockType:"",stoneClarity:"",stoneColor:"",stoneSection:"",supplierId:n.psiForm.supplierId,viceStoneWeight:"",warehouseId:e.warehouseId,weight:"",weightUnitId:e.weightUnitId,weightUnitName:e.weightUnit,goodsMainType:e.goodsMainType,goldColor:s.goldColor?s.goldColor:"",goldColors:getCodeList("base_Condition"),certifiTypes:getCodeList("base_certificate_type"),goldPrice:e.goldPrice?e.goldPrice:s.goldPrice?Number(s.goldPrice):0,netGoldWeight:e.netGoldWeight?e.netGoldWeight:s.netGoldWeight?Number(s.netGoldWeight):0,purchaseGoldLose:e.purchaseGoldLose?e.purchaseGoldLose:s.purchaseGoldLose?Number(s.purchaseGoldLose):0,purchaseCost:e.purchaseCost?e.purchaseCost:s.purchaseCost?Number(s.purchaseCost):0,otherFee:e.otherFee?e.otherFee:s.otherFee?Number(s.otherFee):0,purchaseGoldPrice:e.purchaseGoldPrice?e.purchaseGoldPrice:s.purchaseGoldPrice?Number(s.purchaseGoldPrice):0,certificateFee:e.certificateFee?e.certificateFee:s.certificateFee?Number(s.certificateFee).toFixed(2):0,purPriceCost:e.purPriceCost?e.purPriceCost:s.certificateFee?Number(s.purPriceCost):0,processingFee:e.processingFee?e.processingFee:s.processingFee?Number(s.processingFee):0,goldPurchase:e.goldPurchase?e.goldPurchase:s.goldPurchase?Number(s.goldPurchase):0,saleRate:e.saleRate?e.saleRate:s.saleRate?Number(s.saleRate):0,purOtherFee:e.purOtherFee?e.purOtherFee:s.purOtherFee?Number(s.purOtherFee):0,marketCost:e.marketCost?e.marketCost:s.marketCost?Number(s.marketCost):0,purCertificateFee:e.purCertificateFee?e.purCertificateFee:s.purCertificateFee?Number(s.purCertificateFee):0,salePrice:e.salePrice?e.salePrice:s.salePrice?Number(s.salePrice).toFixed(2):0,purchaseLaborCharge:e.purchaseLaborCharge?e.purchaseLaborCharge:s.purchaseLaborCharge?Number(s.purchaseLaborCharge):0,totalWeight:e.totalWeight?e.totalWeight:s.totalWeight?Number(s.totalWeight):0,mainStoneWeight:e.mainStoneWeight?e.mainStoneWeight:s.mainStoneWeight?Number(s.mainStoneWeight):0,certificateNo:e.certificateNo?e.certificateNo:s.certificateNo?s.certificateNo:"",otherFeeName:e.otherFeeName?e.otherFeeName:s.otherFeeName?s.otherFeeName:"",goodsNorm:e.goodsNorm?e.goodsNorm:s.goodsNorm?s.goodsNorm:"",remark:e.remark?e.remark:s.remark?s.remark:"",isImport:!0,importData:Object.assign({},{tBaseBomEntity:s.tBaseBomEntity||{},goldParts:s.goldParts||[],stonesParts:s.stoneParts||[],partParts:s.partParts||[]})}))}e.goodList=t}),n.goodList=n.purchaseStockDetails[n.selectedIndex].goodList,n.$forceUpdate()),window.top.home.loading("hide")},handleProcessing:function(){window.top.home.loading("show",{text:"处理数据中，请稍等!"})},handleSuccess:function(e,t){if("100100"===e.code)try{this.loadExcelData(e.data)}catch(e){window.top.home.loading("hide")}else window.top.home.loading("hide"),this.$Modal.error({content:"<div style='height: 300px;overflow-y: scroll'>"+e.msg.replace(/;/g,"<br/>")+"</div>",title:"警告",scrollable:!0,height:"520px"})},getGoodsItem:function(e,o){var i=this,t={id:e.id};$.ajax({type:"post",url:contextPath+"/goodsController/queryGoodsDetail",data:JSON.stringify(t),contentType:"application/json",dataType:"json",success:function(e){if("100100"===e.code){Object.assign(e.data[0],{goodsId:e.data[0].id,id:""});var t=$.extend(!0,{},e.data[0],{options:i.goodList[o].options});i.goodList.splice(o,1,t),i.updateCodesUsed()}},error:function(){layer.alert("服务器出错啦")}})},getGoodsBarcodeValue:function(t,o){var i=this,e={goodsBarcode:t,commodityId:i.goodList[o].commodityId,isInStock:0,nature:0,stockInNo:"",limit:""};$.ajax({type:"post",url:contextPath+"/goodsController/queryGoodsDetail",data:JSON.stringify(e),contentType:"application/json",dataType:"json",success:function(e){"100100"===e.code&&(i.goodList[o].options=e.data.map(function(e){return $.extend(!0,{},{code:e.goodsBarcode,name:e.goodsName,id:e.id})}),i.$forceUpdate(),i.updateCodesUsed(t,o))},error:function(){layer.alert("服务器出错啦")}})},handleFormatError:function(e){this.$Modal.warning({content:"请选择excel格式的文件!",title:"警告!"})},handleMaxSize:function(e){this.$Notice.warning({title:"文件大小超出限制!",desc:"【"+e.name+"】的大小超过2M"})},isEdit:function(e,t){eventHub.$emit("isEdit",e)},saveAccess:function(e,t,o){eventHub.$emit("saveFile",e,t)},getAccess:function(e,t,o){eventHub.$emit("queryFile",e,t)},sum:function(e,o){return e.reduce(function(e,t){return""===t[o]||null===t[o]||void 0===t[o]?math.add(0,e):math.add(parseFloat(t[o]),e)},0)},selectGoodsDetail:function(e){this.detailSelectedIdx=e},getInputNumber:function(e){Number(document.getElementById("purchaseGoldPrice"+e).value);var t=Number(document.getElementById("goldPrice"+e).value),o=Number(document.getElementById("purchaseLaborCharge"+e).value),i=Number(document.getElementById("purOtherFee"+e).value),a=Number(document.getElementById("purCertificateFee"+e).value),s=Number(document.getElementById("goldPurchase"+e).value),r=0,n=0;if(this.goodList[this.detailSelectedIdx].netGoldWeight&&this.goodList[this.detailSelectedIdx].purchaseGoldLose&&this.goodList[this.detailSelectedIdx].purchaseGoldPrice){var c=Number(this.goodList[this.detailSelectedIdx].netGoldWeight*(1+this.goodList[this.detailSelectedIdx].purchaseGoldLose/100))*Number(this.goodList[this.detailSelectedIdx].purchaseGoldPrice);r=Number(c.toFixed(2))}else r=0;if(this.goodList[this.detailSelectedIdx].netGoldWeight&&s&&t){var d=Number(this.goodList[this.detailSelectedIdx].netGoldWeight*(1+s/100))*t;n=Number(d.toFixed(2))}else n=0;o||(o=0),a||(a=0),i||(i=0),this.detailSelectedIdx===e&&(this.goodList[this.detailSelectedIdx].purchaseCost=Number(this.goodList[this.detailSelectedIdx].totalStonePurchasePrice+r+a+i+o).toFixed(2),this.goodList[this.detailSelectedIdx].purPriceCost=Number(this.goodList[this.detailSelectedIdx].totalStonePrice+n+a+i+o).toFixed(2),this.goodList[this.detailSelectedIdx].marketCost=Number(this.goodList[this.detailSelectedIdx].totalStonePrice+n+a+i+o).toFixed(2))},productDetailModalClick:function(e){var t=this;if("attr_ranges_goods"===this.goodList[this.detailSelectedIdx].goodsMainType){Object.assign(this.goodList[this.detailSelectedIdx],{tBaseBomEntity:e,assistAttrs:null,overEdit:!0});var o=0,i=0,a=0,s=0;this.goodList.forEach(function(e){e.tBaseBomEntity&&(e.tBaseBomEntity.goldBoms.forEach(function(e){e.checked&&(e.weight?t.goodList[t.detailSelectedIdx].netGoldWeight=Number(e.weight):t.goodList[t.detailSelectedIdx].netGoldWeight=0,t.goodList[t.detailSelectedIdx].purchaseGoldLose=Number(e.lose))}),e.tBaseBomEntity.stonesBoms.forEach(function(e){"1"===e.partName?(e.weight?t.goodList[t.detailSelectedIdx].mainStoneWeight=e.weight:t.goodList[t.detailSelectedIdx].mainStoneWeight=0,e.weight&&e.inPrice?o+=Number(e.weight)*Number(e.inPrice):o=0,a=e.weight&&e.price?Number(e.weight*e.price):0):(e.weight&&e.inPrice?i+=Number(e.weight)*Number(e.inPrice):i=0,s=e.weight&&e.price?Number(e.weight*e.price):0)}))}),this.$nextTick(function(){return t.goodList[t.detailSelectedIdx].totalStonePurchasePrice=Number(o+i),t.goodList[t.detailSelectedIdx].totalStonePrice=Number(a+s),t.getInputNumber(t.selectedIndex)})}else Object.assign(this.goodList[this.detailSelectedIdx],{assistAttrs:e,tBaseBomEntity:null,overEdit:!0})},modalSure:function(e){this.productDetailModalClick(e),this.productDetailModal.showModal=!1},modalCancel:function(e){this.productDetailModal.showModal=!1},goldDetailModalClick:function(e){"attr_ranges_goods"===this.purchaseStockDetails[this.selectedIndex].goodsMainType?Object.assign(this.purchaseStockDetails[this.selectedIndex],{tBaseBomEntity:e,assistAttrs:null,overEdit:!0}):Object.assign(this.purchaseStockDetails[this.selectedIndex],{assistAttrs:e,tBaseBomEntity:null,overEdit:!0})},goldModalSure:function(e){this.goldDetailModalClick(e),this.goldDetailModal.showModal=!1},goldModalCancel:function(e){this.goldDetailModal.showModal=!1},formatData2Sumbit:function(){for(var e=this,t={stonesParts:[],materialParts:[],partParts:[],goldParts:[]},i=[],o=function(o){e.purchaseStockDetails[o].lineNo=o+1,i[o]=JSON.parse(JSON.stringify(e.purchaseStockDetails[o])),i[o].goodList=[JSON.parse(JSON.stringify(t))],handlerProductDetail(e.purchaseStockDetails[o].goodList,i[o],t),e.purchaseStockDetails[o].goodList.map(function(e,t){i[o].goodList[t]||(i[o].goodList[t]={}),Object.assign(i[o].goodList[t],{batchNum:e.batchNum,certificateFee:e.certificateFee,certificateNo:e.certificateNo,certificateType:e.certificateType,commodityId:e.commodityId,countingUnitId:e.countingUnitId,countingUnitName:e.countingUnitName,custId:e.custId,custStyleCode:e.custStyleCode,custStyleType:e.custStyleType,goldColor:e.goldColor,goldPrice:e.goldPrice,goldPurchase:e.goldPurchase,goldWeight:e.goldWeight,goodsBarcode:e.goodsBarcode,goodsName:e.goodsName,goodsNo:e.goodsNo,goodsNorm:e.goodsNorm,goodsType:e.goodsType,goodsTypeId:e.goodsTypeId,groupPath:e.groupPath,id:e.id,isDel:1,labCgeMode:e.labCgeMode,mainStoneWeight:e.mainStoneWeight,marketCost:e.marketCost,nature:e.nature,netGoldWeight:e.netGoldWeight,occupiedStatus:e.occupiedStatus,otherFee:e.otherFee,otherFeeMode:e.otherFeeMode,otherFeeName:e.otherFeeName,processingFee:e.processingFee,purCertificateFee:e.purCertificateFee,purLabCgeMode:e.purLabCgeMode,purOtherFee:e.purOtherFee,purPriceCost:e.purPriceCost,purchaseCost:e.purchaseCost,purchaseGoldLose:e.purchaseGoldLose,purchaseGoldPrice:e.purchaseLaborCharge,purchaseLaborCharge:e.purchaseLaborCharge,remark:e.remark,reservoirPositionId:e.reservoirPositionId,salePrice:e.salePrice,saleRate:e.saleRate,soldStatus:e.soldStatus,standardCertType:e.standardCertType,stockInNo:e.stockInNo,stockType:e.stockType,stoneClarity:e.stoneClarity,stoneColor:e.stoneColor,stoneSection:e.stoneSection,supplierId:e.supplierId,totalWeight:e.totalWeight,viceStoneWeight:e.viceStoneWeight,warehouseId:e.warehouseId,weight:e.weight,weightUnitId:e.weightUnitId,weightUnitName:e.weightUnitName})})},a=0;a<e.purchaseStockDetails.length;a++)o(a);if(i.some(function(e){return"attr_ranges_gold"===e.goodsMainType})){var s={stonesParts:[],materialParts:[],partParts:[],goldParts:[]},r={applyOrganizationId:null,bomType:"",countingUnit:"",documentType:"",goldColor:null,goldLoss:null,commodityId:"",goodsCode:"",goodsId:"",id:"",inPrice:null,limit:null,name:"",num:"",partAttrs:[],price:null,pricingMethod:null,stoneClarity:null,stoneCoffeeColor:null,stoneColor:null,stoneCut:null,stoneFluorescent:null,stoneLoss:null,stoneMilkColor:null,stoneName:null,stoneNo:null,stoneSection:null,stoneShape:null,stoneWeight:null,weight:null,weightUnit:null};i.map(function(e,t){if("attr_ranges_gold"===e.goodsMainType)if(e.assistAttrs){var o=JSON.parse(JSON.stringify(r));Object.assign(o,{bomType:"BOM-MATERIAL"}),e.assistAttrs.assistAttrs.map(function(e){"string"==typeof e.attr?o.partAttrs.push(e):(e.attr||[]).map(function(e){o.partAttrs.push({attr:e.name,attrValue:e.model})})}),i[t].materialParts||(i[t].materialParts=[]),i[t].materialParts.push(o)}else Object.assign(e,s)})}return i},showGoldDetail:function(e){var t=this;if(t.selectedIndex=e,!t.purchaseStockDetails[e].commodityId)return this.$Modal.error({content:"还未选择商品，请先选择商品，再选择明细！"}),!1;if("attr_ranges_gold"!==t.purchaseStockDetails[e].goodsMainType)return!1;var o={goodsId:t.purchaseStockDetails[e].id,commodityId:t.purchaseStockDetails[e].commodityId,documentType:"W_STOCK_IN_GOLD"};Object.assign(t.goldDetailModal,{showModal:!0,ids:o}),t.$nextTick(function(){t.$refs.goldRef.getProductDetail()})},showProductDetail:function(e){var t=this;if(t.detailSelectedIdx=e,!t.goodList[e].commodityId)return this.$Modal.error({content:"还未选择商品，请先选择商品，再选择明细！"}),!1;var o={goodsId:t.goodList[e].id,commodityId:t.goodList[e].commodityId,documentType:"W_STOCK_IN"};Object.assign(t.productDetailModal,{showModal:!0,ids:o}),t.$nextTick(function(){t.$refs.modalRef.getProductDetail()})},validatePurchaseStockDetail:function(){return validateRow(this.purchaseStockDetails,{actualRecWeight:{name:"实收重量",type:"number",floor:3},actualRecNum:{name:"实收数量",type:"number",floor:3,empty:!0},warehouseId:{name:"仓库",type:"string"}},!0)},queryLoadData:function(e){var i=this;if(!e)return i.$Message.warning({content:"数据异常"}),!1;$.ajax({url:contextPath+"/purchasestock/getDetail",method:"POST",dataType:"json",data:{stockNo:e},success:function(e){var t;"100100"===e.code?(i.psiForm=$.extend(!0,{},{businessType:e.data.businessType,stockNo:e.data.stockNo,purDepartmentId:e.data.purDepartmentId,purDepartmentName:e.data.purDepartmentName,recMaterialDepartmentId:e.data.recMaterialDepartmentId,recMaterialDepartmentName:e.data.recMaterialDepartmentName,buyerId:"",buyerName:"",stockTime:e.data.stockTime,stockKeeperId:e.data.stockKeeperId,stockKeeper:e.data.stockKeeper,custName:e.data.custName,custCode:e.data.custCode,custId:e.data.custId,supplierName:e.data.supplierName,supplierCode:e.data.supplierCode,supplierId:e.data.supplierId,sourceDocType:"",id:e.data.id,goodsTypeId:e.data.goodsTypeId,goodsTypeName:e.data.goodsTypeName,docStatus:e.data.docStatus,dataSource:e.data.dataSource,createTime:e.data.createTime,createName:e.data.createName,updateTime:e.data.updateTime,updateName:e.data.updateName,auditorName:e.data.auditorName,auditTime:e.data.auditTime}),i.goodsTypes=(t=e.data.goodsTypePath)?-1!==t.indexOf("0.")?(t=t.substr(2).substr(0,t.length-1)).split(".").map(function(e){return parseInt(e)}):void 0:[],e.data.purchaseStockDetails&&0<e.data.purchaseStockDetails.length?(i.purchaseStockDetails=e.data.purchaseStockDetails.map(function(e){var t,o={goldColors:getCodeList("base_Condition"),certifiTypes:getCodeList("base_certificate_type"),warehousePositions:i.warehousePositions.map(function(e){return Object.assign({},{value:e.value,label:e.label})})};return $.extend({},o,{id:e.id,purStockInNo:e.purStockInNo,sourceDocType:e.sourceDocType||"",sourceDocNo:e.sourceDocNo||"",batchNum:e.batchNum||"",pictureUrl:e.pictureUrl||null,goodsNo:e.goodsNo||"",goodsName:e.goodsName||"",divisionStatus:e.divisionStatus?e.divisionStatus.toString():"0",goodsNorm:e.goodsNorm||"",countingUnitId:e.countingUnitId||"",countingUnit:e.countingUnit||"",commodityId:e.commodityId,weightUnit:e.weightUnit||"",certificateTypeId:e.certificateTypeId||"",receivableNum:e.receivableNum||0,actualRecNum:e.actualRecNum||0,weightUnitId:e.weightUnitId||0,receivableWeight:e.receivableWeight||0,actualRecWeight:e.actualRecWeight||0,purchaseCost:e.purchaseCost||0,marketCost:e.marketCost||0,saleCost:e.saleCost||0,totalSaleAmount:e.totalSaleAmount||0,warehouseId:e.warehouseId,goodsMainType:e.goodsMainType,reservoirPositionId:e.reservoirPositionId,remark:e.remark||"",isDel:e.isDel,custId:e.custId,supplierId:e.supplierId,goldColor:e.goldColor,goldColors:getCodeList("base_Condition"),delGoodList:[],goodList:(t=e.goodList,t?t.map(function(e){var t={goldColors:getCodeList("base_Condition"),certifiTypes:getCodeList("base_certificate_type")};return $.extend({},t,e)}):[])})}),console.log(i.purchaseStockDetails),console.log(i.selectedIndex)):i.purchaseStockDetails=[]):i.$Message.warning({content:e.msg})}})},loadCurrentOrg:function(){var t=this;$.post(contextPath+"/purchasestock/getCurrentOrg",{},function(e){"100100"===e.code&&(t.currOrgName=e.data.orgName)},"json")},queryLoadSourceData:function(e){var i=this;if(!e)return!1;$.ajax({url:contextPath+"/purchasestock/queryStockInByIds",method:"POST",dataType:"json",contentType:"application/json;charset=utf-8",data:e,success:function(e){if("100100"===e.code&&0<e.data.length){i.psiForm=Object.assign({},{businessType:e.data[0].businessType,stockNo:"",purDepartmentId:"",purDepartmentName:"",recMaterialDepartmentId:"",recMaterialDepartmentName:"",buyerId:"",buyerName:"",stockTime:"",stockKeeperId:"",stockKeeper:"",custName:"",custCode:"",custId:e.data[0].customerId,supplierName:i.suppliers[i.suppliers.map(function(e){return e.value}).indexOf(e.data[0].supplierId)].label,supplierCode:e.data[0].supplierCode,supplierId:e.data[0].supplierId,sourceDocType:e.data[0].sourceDocType,id:"",goodsTypeId:"",goodsTypeName:e.data[0].goodsTypeName,goodsTypePath:e.data[0].goodsTypePath,dataSource:0,docStatus:1}),i.goodsTypes=(o=e.data[0].goodsTypePath)?-1!==o.indexOf("0.")?(o=o.substr(2).substr(0,o.length-1)).split(".").map(function(e){return parseInt(e)}):void 0:[];var t=[];e.data.forEach(function(e){e.purchaseStockDetails&&0<e.purchaseStockDetails.length&&(t=t.concat(e.purchaseStockDetails))}),0<t.length?i.purchaseStockDetails=t.map(function(e){var t,o={goldColors:getCodeList("base_Condition"),certifiTypes:getCodeList("base_certificate_type"),warehousePositions:i.warehousePositions.map(function(e){return Object.assign({},{value:e.value,label:e.label})})};return $.extend({},o,{sourceDocType:e.sourceDocType||"",sourceDocNo:e.sourceDocNo||"",batchNum:e.batchNum||"",pictureUrl:e.pictureUrl||null,goodsMainType:e.goodsMainType,goodsNo:e.goodsNo||"",goodsName:e.goodsName||"",divisionStatus:"0",goodsNorm:e.goodsNorm||"",countingUnitId:e.countingUnitId||"",countingUnit:e.countingUnit||"",commodityId:e.commodityId,weightUnit:e.weightUnit||"",certificateTypeId:e.certificateTypeId||"",receivableNum:e.receivableNum||0,actualRecNum:Number(e.qualifiedNumber)+Number(e.releaseNumber),weightUnitId:e.weightUnitId||0,receivableWeight:e.receivableWeight||0,actualRecWeight:e.actualRecWeight||0,purchaseCost:e.purchaseCost||0,marketCost:e.marketCost||0,saleCost:e.saleCost||0,totalSaleAmount:e.totalSaleAmount||0,warehouseId:"",reservoirPositionId:"",remark:e.remark||"",isDel:1,custId:e.custId||"",supplierId:e.supplierId||"",resourceType:e.resourceType||"",documentType:e.documentType||"",streamId:e.streamId,goodsLineNo:e.goodsLineNo,custStyleType:e.custStyleType,goldColor:e.goldColor,goldColors:getCodeList("base_Condition"),productFlag:e.productFlag,delGoodList:[],goodList:(t=e.goodList,t?t.map(function(e){var t={goldColors:getCodeList("base_Condition"),certifiTypes:getCodeList("base_certificate_type")};return $.extend({},t,e)}):[])})}):i.purchaseStockDetails=[],i.$forceUpdate()}var o}})},goToAddPage:function(){window.parent.activeEvent({name:"新增采购入库单",url:contextPath+"/warehouse/purchase-stock-in/purchase-stock-in-info.html",params:{type:"add"}})}},watch:{goodList:{handler:function(e){var t=this,o=0,i=0,a=0,s=0,r=0;e.map(function(e){e.totalWeight&&!isNaN(e.totalWeight)&&(o=math.eval(Number(o)+Number(e.totalWeight))),e.purchaseCost&&!isNaN(e.purchaseCost)&&(i=math.eval(Number(i)+Number(e.purchaseCost))),e.marketCost&&!isNaN(e.marketCost)&&(a=math.eval(Number(a)+Number(e.marketCost))),e.purPriceCost&&!isNaN(e.purPriceCost)&&(s=math.eval(Number(s)+Number(e.purPriceCost))),e.salePrice&&!isNaN(e.salePrice)&&(r=math.eval(Number(r)+Number(e.salePrice))),""!==t.selectedIndex&&t.purchaseStockDetails&&t.purchaseStockDetails[t.selectedIndex]&&("attr_ranges_gold"!==t.purchaseStockDetails[t.selectedIndex].goodsMainType?(t.purchaseStockDetails[t.selectedIndex].actualRecWeight=o.toFixed(3),t.purchaseStockDetails[t.selectedIndex].purchaseCost=i.toFixed(2),t.purchaseStockDetails[t.selectedIndex].marketCost=a.toFixed(2),t.purchaseStockDetails[t.selectedIndex].saleCost=s.toFixed(2),t.purchaseStockDetails[t.selectedIndex].totalSaleAmount=r.toFixed(2)):t.purchaseStockDetails[t.selectedIndex].actualRecWeight=document.getElementById("actualRecWeight"+t.selectedIndex).value),t.goodsListTotalWeight=o.toFixed(3),t.totalDetailPurchaseCost=i.toFixed(2),t.totalDetailMarketCost=a.toFixed(2),t.totalPurPriceCost=s.toFixed(2),t.totalSalePrice=r.toFixed(2)})},deep:!0}},filters:{sourceDocTypeFormatter:function(e){switch(e){case"P_RECEIPT_01":return"收货单一客户送料";case"P_RECEIPT_02":return"收货单一标准采购收货";case"P_RECEIPT_03":return"收货单一受托加工收货";case"P_RECEIPT_04":return"收货单一供应商退料";default:return""}}},computed:{totalReceivableNum:function(){return 0===this.purchaseStockDetails.length?0:this.sum(this.purchaseStockDetails,"receivableNum")},totalActualRecNum:function(){return 0===this.purchaseStockDetails.length?0:this.sum(this.purchaseStockDetails,"actualRecNum")},totalReceivableWeight:function(){return 0===this.purchaseStockDetails.length?0:this.sum(this.purchaseStockDetails,"receivableWeight").toFixed(3)},totalActualRecWeight:function(){return 0===this.purchaseStockDetails.length?0:this.sum(this.purchaseStockDetails,"actualRecWeight").toFixed(3)},totalPurchaseCost:function(){return 0===this.purchaseStockDetails.length?0:this.sum(this.purchaseStockDetails,"purchaseCost").toFixed(2)},totalMarketCost:function(){return 0===this.purchaseStockDetails.length?0:this.sum(this.purchaseStockDetails,"marketCost").toFixed(2)},totalSaleCost:function(){return 0===this.purchaseStockDetails.length?0:this.sum(this.purchaseStockDetails,"saleCost").toFixed(2)},overAllSaleAmount:function(){return 0===this.purchaseStockDetails.length?0:this.sum(this.purchaseStockDetails,"totalSaleAmount").toFixed(2)},totalNetGoldWeight:function(){return 0===this.goodList.length?0:this.sum(this.goodList,"netGoldWeight").toFixed(3)},totalMainStoneWeight:function(){return 0===this.goodList.length?0:this.sum(this.goodList,"mainStoneWeight").toFixed(3)},totalPurchaseGoldPrice:function(){return 0===this.goodList.length?0:this.sum(this.goodList,"purchaseGoldPrice").toFixed(2)},totalGoldPrice:function(){return 0===this.goodList.length?0:this.sum(this.goodList,"goldPrice").toFixed(2)},totalPurchaseLaborCharge:function(){return 0===this.goodList.length?0:this.sum(this.goodList,"purchaseLaborCharge").toFixed(2)},totalProcessingFee:function(){return 0===this.goodList.length?0:this.sum(this.goodList,"processingFee").toFixed(2)},totalPurCertificateFee:function(){return 0===this.goodList.length?0:this.sum(this.goodList,"purCertificateFee").toFixed(2)},totalCertificateFee:function(){return 0===this.goodList.length?0:this.sum(this.goodList,"certificateFee").toFixed(2)},totalPurOtherFee:function(){return 0===this.goodList.length?0:this.sum(this.goodList,"purOtherFee").toFixed(2)},totalOtherFee:function(){return 0===this.goodList.length?0:this.sum(this.goodList,"otherFee").toFixed(2)},supplierDisabled:function(){return 1!==this.psiForm.dataSource||1!==this.psiForm.docStatus||this.psiForm.businessType&&"W_PURCHASE_STOCK_IN_03"===this.psiForm.businessType},customerDisabled:function(){var e=this;return 1!==e.psiForm.dataSource||1!==e.psiForm.docStatus||e.psiForm.businessType&&("W_PURCHASE_STOCK_IN_02"===e.psiForm.businessType||"W_PURCHASE_STOCK_IN_01"===e.psiForm.businessType)},showProduct:function(){return!this.canBeEdited||"W_PURCHASE_STOCK_IN_02"!==this.psiForm.businessType}},mounted:function(){this.getSelect("table-responsive","goods");var e=this;e.loadCurrentOrg(),e.isEdit("Y"),$("form").validate({onfocusout:!0});var t=window.parent.params.params;e.openType=t.type,"update"===t.type?(e.isEdit("Y"),console.log(t),e.canBeEdited=!0,e.isClearable=!0,e.showTemp=!1,e.queryLoadData(t.stockNo)):"query"===t.type?(e.isEdit("N"),console.log(t),e.canBeEdited=!1,e.isClearable=!1,e.showTemp=!1,e.queryLoadData(t.stockNo)):"add"===t.type?(e.isEdit("Y"),e.psiForm.docStatus=1,e.psiForm.dataSource=1,e.canBeEdited=!0,e.isClearable=!1):"sAdd"===t.type&&(e.isEdit("Y"),e.psiForm.dataSource=0,e.canBeEdited=!0,e.queryLoadSourceData(t.ids))}});function handlerProductDetail(e,a,s,r){var n={applyOrganizationId:null,bomType:"",countingUnit:"",documentType:"",goldColor:null,goldLoss:null,goodsCode:"",goodsId:"",id:"",inPrice:null,limit:null,name:"",num:"",partAttrs:[],price:null,pricingMethod:null,stoneClarity:null,stoneCoffeeColor:null,stoneColor:null,stoneCut:null,stoneFluorescent:null,stoneLoss:null,stoneMilkColor:null,stoneName:null,stoneNo:null,stoneSection:null,stoneShape:null,stoneWeight:null,weight:null,weightUnit:null};return e.map(function(o,i){if(o.tBaseBomEntity||o.assistAttrs||r)if(o.tBaseBomEntity||o.assistAttrs||!r)if("attr_ranges_goods"===o.goodsMainType)o.tBaseBomEntity.goldBoms.map(function(e){if(e.checked){var t=JSON.parse(JSON.stringify(n));Object.assign(t,{bomType:"BOM-GOLD",weightUnit:e.weightUnitId,weight:e.weight,goodsCode:e.commodityCode,name:e.commodityName,goldLoss:e.lose,goldColor:e.condition}),"array"===$.type(e.attr)&&0<e.attr.length&&e.attr.map(function(e){e.name&&e.model&&t.partAttrs.push({attr:e.name,attrValue:e.model})}),a.goodList[i]||(a.goodList[i]=JSON.parse(JSON.stringify(s))),a.goodList[i].goldParts.push(t),Object.assign(a.goodList[i],{pictureUrl:o.pictureUrl,goodsName:o.goodsName,goodsMainType:o.goodsMainType,goodsSpecifications:o.goodsSpecifications,countingUnit:o.countingUnit,applyCount:o.applyCount,weightUnit:o.weightUnit,applyWeight:o.applyWeight,pricingMethod:o.pricingMethod,price:o.price,amount:o.amount})}}),o.tBaseBomEntity.stonesBoms.map(function(e){var t=JSON.parse(JSON.stringify(n));Object.assign(t,{bomType:"BOM-STONE",countingUnit:e.countUnitId,weightUnit:e.weightUnitId,num:e.count,weight:e.weight,goodsCode:e.commodityCode,name:e.commodityName,stoneName:e.partName,stoneLoss:e.lose,stoneNo:e.stoneNo,price:e.price,inPrice:e.inPrice}),"array"===$.type(e.attr)&&0<e.attr.length&&e.attr.map(function(e){e.name&&e.model&&t.partAttrs.push({attr:e.name,attrValue:e.model})}),a.goodList[i]||(a.goodList[i]=JSON.parse(JSON.stringify(s))),a.goodList[i].stonesParts.push(t),Object.assign(a.goodList[i],{pictureUrl:o.pictureUrl,goodsName:o.goodsName,goodsMainType:o.goodsMainType,goodsSpecifications:o.goodsSpecifications,countingUnit:o.countingUnit,applyCount:o.applyCount,weightUnit:o.weightUnit,applyWeight:o.applyWeight,pricingMethod:o.pricingMethod,price:o.price,amount:o.amount})}),o.tBaseBomEntity.partBoms.map(function(e,t){var o=JSON.parse(JSON.stringify(n));Object.assign(o,{bomType:"BOM-PART",countingUnit:e.countUnitId,weightUnit:e.weightUnitId,num:e.count,weight:e.weightReference,goodsCode:e.commodityCode,name:e.commodityName,price:e.price,inPrice:e.inPrice}),"array"===$.type(e.attr)&&0<e.attr.length&&e.attr.map(function(e){e.name&&e.model&&o.partAttrs.push({attr:e.name,attrValue:e.model})}),a.goodList[i]||(a.goodList[i]=JSON.parse(JSON.stringify(s))),a.goodList[i].partParts.push(o)});else{var t=JSON.parse(JSON.stringify(n));Object.assign(t,{bomType:"BOM-MATERIAL"}),o.assistAttrs.assistAttrs.map(function(e){"array"===$.type(e.attr)&&0<e.attr.length&&e.attr.map(function(e){e.name&&e.model&&t.partAttrs.push({attr:e.name,attrValue:e.model})})}),a.goodList[i]||(a.goodList[i]=JSON.parse(JSON.stringify(s))),a.goodList[i].materialParts.push(t)}else Object.assign(o,{stonesParts:o.materialParts,goldParts:o.goldParts,partParts:o.stonesParts,materialParts:o.partParts});else Object.assign(o,{stonesParts:[],goldParts:[],partParts:[],materialParts:[]})}),e}function validateRow(e,a){var s=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:"分录行";return e.some(function(e,t){for(var o in a)if(a.hasOwnProperty(o)){if("goldColor"!==o&&"string"===a[o].type&&(void 0===e[o]||""===e[o]||null===e[o]))return s&&layer.alert(r+"第"+(t+1)+"行"+a[o].name+"必填"),!0;if("number"===a[o].type&&("attr_ranges_gold"!==e.goodsMainType||!0!==a[o].empty)){var i=0===a[o].floor?"^\\+?[1-9][0-9]*$":"^[0-9]+(.[0-9]{0,"+a[o].floor+"})?$";if(!new RegExp(i).test(e[o]))return s&&layer.alert(r+"第"+(t+1)+"行"+a[o].name+"不符合要求"),!0;if(a[o].floor&&e[o]&&e[o].toString()==="0."+new Array(a[o].floor+1).join("0"))return s&&layer.alert(r+"第"+(t+1)+"行"+a[o].name+"不符合要求"),!0}}return e.goodsMainType&&"attr_ranges_gold"===e.goodsMainType&&!e.assistAttrs?(s&&layer.alert("请填写"+r+"第"+(t+1)+"行的商品明细!"),!0):!e.goodsMainType||"attr_ranges_gold"===e.goodsMainType||e.goodList&&0!==e.goodList.length?void 0:(s&&layer.alert("请填写"+r+"第"+(t+1)+"行的条码明细!"),!0)})}function goodsValidateRow(e,r){var n=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],c=3<arguments.length&&void 0!==arguments[3]?arguments[3]:"分录行";if(e&&(!e||0!==e.length)){var d=["purchaseGoldLose","goldPurchase","netGoldWeight","purchaseGoldPrice","goldPrice","mainStoneWeight"];return e.some(function(a,s){if("attr_ranges_gold"!==a.goodsMainType)return a.goodList.some(function(e,t){for(var o in r)if(r.hasOwnProperty(o)){if("attr_ranges_goods"!==a.goodsMainType&&d.includes(o))continue;if("string"===r[o].type&&(void 0===e[o]||""===e[o]||null===e[o])){if("mainStoneWeight"===o&&"attr_ranges_goods"===a.goodsMainType&&a.tBaseBomEntity&&Array.isArray(a.stonesBoms)&&0===a.stonesBoms.length)continue;return n&&layer.alert("第"+(s+1)+"行"+c+"的第"+(t+1)+"行"+r[o].name+"必填"),!0}if("number"===r[o].type&&("attr_ranges_gold"!==e.goodsMainType||!0!==r[o].empty)){var i=0===r[o].floor?"^\\+?[1-9][0-9]*$":"^[0-9]+(.[0-9]{0,"+r[o].floor+"})?$";if(!new RegExp(i).test(e[o]))return n&&layer.alert("第"+(s+1)+"行"+c+"的第"+(t+1)+"行"+r[o].name+"不符合要求"),!0;if(r[o].floor&&e[o]&&e[o].toString()==="0."+new Array(r[o].floor+1).join("0"))return n&&layer.alert("第"+(s+1)+"行"+c+"的第"+(t+1)+"行"+r[o].name+"不符合要求"),!0}}if("attr_ranges_goods"===e.goodsMainType){if(!e.id&&!e.tBaseBomEntity)return layer.alert("第"+(s+1)+"行"+c+"的第"+(t+1)+"行商品明细未选择!"),!0}else if("attr_ranges_gold"!==e.goodsMainType&&!e.id&&!e.assistAttrs)return layer.alert("第"+(s+1)+"行"+c+"的第"+(t+1)+"行商品明细未选择!"),!0})})}}