"use strict";var _extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(t[s]=i[s])}return t},returnReport=new Vue({el:"#returnReport",data:function(){return{showSupplierModal:!1,showSourceModal:!1,openTime:"",isSearchHide:!0,isTabulationHide:!0,selectedIndex:0,isHide:!0,dataValue:[],categoryType:[],employees:{},logisticsModes:[],organizationName:"",modalTrigger:!1,modalType:"",steplist:[],approvalTableData:[],isDisabled:!1,isDisabledApproval:!0,isDisabledReject:!0,isDisabledAddRow:!0,isDisabledDelRow:!0,isDisabledSourceNo:!0,isDisabledBusinessType:!0,isDisabledGoodsType:!0,isDisabledCerOutNumber:!0,cerOutEntity:{id:null,orderNo:"",orderStatus:"",dataSource:"",supplie:"",supplierId:"",goodsTypeName:"",goodsTypePath:"",goodsMainType:"",businessType:"",certificateType:"",certificateNumber:null,certificateCost:null,deliverGoodsNumber:null,deliverWeight:null,deliveryDate:null,logisticsMode:"",salesmanName:"",salesmanId:"",organizationId:"",createName:"",createTime:"",updateName:"",updateTime:"",auditorName:"",auditTime:"",remark:""},detEntityList:[],checkListData:{certificateCount:{name:"证书数量",type:"number",floor:0},certificateCost:{name:"证书费用",type:"number",floor:2,plus:!0}},errorMsg:{businessType:"业务类型必选",organizationId:"所属组织必选",supplier:"供应商必选",logisticsMode:"物流方式必选",salesmanId:"业务员必选",certificateType:"证书类型必选",deliveryDate:"下单日期必填"},totalMsg:{certificateNumber:"证书数量总数必须大于0",deliverWeight:"发货重量总数必须大于0",certificateCost:"证书费用总数必须大于0"}}},methods:{changeDate:function(t){var e=t[0].replace(/\//g,"-"),i=t[1].replace(/\//g,"-");null!=e&&""!=e&&null!=i&&""!=i&&(this.coustomer.startTime=e+" 00:00:00",this.coustomer.endTime=i+" 23:59:59")},handleClear:function(){this.coustomer.startTime=null,this.coustomer.endTime=null},hideSearch:function(){this.isHide=!this.isHide,this.isSearchHide=!this.isSearchHide,$(".chevron").css("top","")},hidTabulation:function(){this.isHide=!this.isHide,this.isTabulationHide=!this.isTabulationHide,this.isTabulationHide?$(".chevron").css("top",""):$(".chevron").css("top","83%")},changeEmp:function(t){null!=t&&(this.cerOutEntity.salesmanId=t.value,this.cerOutEntity.salesmanName=t.label.substr(t.label.lastIndexOf("-")+1,t.label.length))},loadData:function(){var e=this;$.ajax({type:"post",url:contextPath+"/tpurchasecollectgoods/data",dataType:"json",success:function(t){e.employees=t.data.employees},error:function(){console.log("服务器出错啦")}})},getLogisticsModes:function(){this.logisticsModes=getCodeList("jxc_jxc_wlfs")},loadProductType:function(){var e=this;$.ajax({type:"post",url:contextPath+"/documentController/getCategory?parentId=0",dataType:"json",success:function(t){e.categoryType=e.initGoodCategory(t.data.cateLists)},error:function(){alert("服务器出错啦")}})},initGoodCategory:function(t){var r=this,o=[];return t.forEach(function(t){var e=t.customCode,i=t.name,s=t.cateLists,a=t.code;s&&(s=r.initGoodCategory(s)),o.push({value:e,label:i,children:s,code:a})}),o.forEach(function(t){t.children||delete t.children}),o},changeProductType:function(t,e){var i=e[e.length-1];this.cerOutEntity.goodsTypeName=i.label,this.cerOutEntity.goodsTypePath=i.value},calculateTotal:function(t,i,e){var s=this;htInputNumber(t,i,e),this.$nextTick(function(){var e={certificateCount:"certificateNumber",deliverCount:"deliverGoodsNumber",deliverWeight:"deliverWeight",certificateCost:"certificateCost"};s.cerOutEntity[e[i]]=0,s.detEntityList.map(function(t){s.cerOutEntity[e[i]]+=1e3*Number(t[i])||0}),s.cerOutEntity[e[i]]=s.cerOutEntity[e[i]]/1e3,s.$forceUpdate()})},errorMsgTip:function(){for(var t in this.errorMsg)if(!this.cerOutEntity[t])return this.$Modal.error({content:this.errorMsg[t]}),!0},totalTip:function(){if(0===this.detEntityList.length)return this.$Modal.error({content:"至少需要有一条分录行"}),!0;for(var t in this.totalMsg)if(!this.cerOutEntity[t])return this.$Modal.error({content:this.totalMsg[t]}),!0},saveClick:function(t){1<this.cerOutEntity.orderStatus?alert("该单据已经提交，不能更新！"):(this.cerOutEntity.orderStatus=1,this.saveOrUpdate())},submit:function(){!0!==this.errorMsgTip()&&(0!==this.typeValue.length?htValidateRow(this.detEntityList,this.checkListData)||!0!==this.totalTip()&&(1<this.cerOutEntity.orderStatus?alert("该单据已经提交！不能再重复提交！"):(this.cerOutEntity.orderStatus=2,this.saveOrUpdate())):this.$Modal.error({content:"商品类型必选"}))},saveOrUpdate:function(){var i=this,t={cerOutEntity:this.cerOutEntity,detEntityList:this.detEntityList};$.ajax({type:"post",url:contextPath+"/certificateOutbreaks/saveOrUpdate",dataType:"json",contentType:"application/json",data:JSON.stringify(t),success:function(t){if("100100"===t.code){if(1==$.isPlainObject(t.data)){if(null==i.cerOutEntity.id){var e=t.data.cerOutEntity;i.cerOutEntity.id=e.id,i.cerOutEntity.orderNo=e.orderNo,i.cerOutEntity.createName=e.createName,i.cerOutEntity.createTime=e.createTime,i.detEntityList=t.data.detEntityList}else i.cerOutEntity.updateName=t.data.updateName,i.cerOutEntity.updateTime=t.data.updateTime;console.log(i.cerOutEntity)}2==i.cerOutEntity.orderStatus&&(i.isDisabled=!0,i.isDisabledBusinessType=!0,i.isDisabledGoodsType=!0,i.isDisabledApproval=!1,i.isDisabledReject=!1,i.isDisabledAddRow=!0,i.isDisabledDelRow=!0,i.isDisabledCerOutNumber=!0,i.isEdit("N")),i.$Modal.success({content:t.msg})}else i.cerOutEntity.orderStatus,i.$Modal.error({content:t.msg})},error:function(){i.cerOutEntity.orderStatus,i.$Modal.error({content:"服务器出错，请联系技术人员！"})}})},approval:function(t){this.modalType="approve",this.modalTrigger=!this.modalTrigger},reject:function(t){this.modalType="reject",this.modalTrigger=!this.modalTrigger},approvalOrRejectCallBack:function(t){var e=this;if("100515"==t.result.code&&("approve"==e.modalType&&e.updateOrderStatus(4,e.cerOutEntity.id),"reject"==e.modalType&&e.updateOrderStatus(1,e.cerOutEntity.id)),"100100"==t.result.code){var i=t.result.data.approvalStatus;if(0==i)e.cerOutEntity.orderStatus=3;else if(1==i)e.cerOutEntity.orderStatus=4,e.isDisabledApproval=!0,e.isDisabledReject=!0,e.cerOutEntity.auditorName=t.result.data.auditorName,e.cerOutEntity.auditTime=t.result.data.auditTime;else if(-1==i)e.cerOutEntity.orderStatus=5;else{if(-2!=i)return e.$Modal.warning({content:"审核异常!",title:"警告"}),!1;e.cerOutEntity.orderStatus=1,e.isDisabled=!1,e.isDisabledApproval=!0,e.isDisabledReject=!0,e.isEdit("Y"),1==e.cerOutEntity.dataSource?(null==e.cerOutEntity.sourceType&&(e.isDisabledAddRow=!1),e.isDisabledDelRow=!1,e.isDisabledBusinessType=!1,e.isDisabledGoodsType=!1,e.isDisabledCerOutNumber=!1):1<e.detEntityList.length&&(e.isDisabledDelRow=!1)}}},updateOrderStatus:function(t,e){var i=this;http.post(contextPath+"/certificateOutbreaks/updateOrderStatus",JSON.stringify({orderStatus:t,id:e})).then(function(t){"100100"===t.code?i.$Message.info({content:json.msg,duration:3}):i.$Message.info({content:"更新单据状态失败，请重试！",duration:3})},function(t){})},selectedOne:function(t){this.selectedIndex=t},addOrDel:function(t){var e=this;if("add"===t)1==this.cerOutEntity.dataSource&&1==this.cerOutEntity.orderStatus?(this.detEntityList.push({}),this.isDisabledSourceNo=!0,this.isDisabledDelRow=!1):alert("只有手动新增的单据，且状态是“暂存”才可以新增行");else{if(1==this.detEntityList.length&&2==this.cerOutEntity.dataSource)return void alert("上游携带的数据，至少要保留一行！");this.detEntityList.splice(this.selectedIndex,1),0==this.detEntityList.length&&1==this.cerOutEntity.dataSource&&(this.isDisabledSourceNo=!1,this.isDisabledDelRow=!0,this.isDisabledAddRow=!1),1==this.detEntityList.length&&2==this.cerOutEntity.dataSource&&(this.isDisabledDelRow=!0),0==this.detEntityList.length?(this.cerOutEntity.certificateNumber=0,this.cerOutEntity.deliverGoodsNumber=0,this.cerOutEntity.deliverWeight=0,this.cerOutEntity.certificateCost=0):this.detEntityList.map(function(t){e.calculateTotal(t,"certificateCount",0),e.calculateTotal(t,"deliverCount",2),e.calculateTotal(t,"deliverWeight",2),e.calculateTotal(t,"certificateCost",2)})}},handlerUnDeliverData:function(){var e=this;return this.detEntityList.map(function(t){Object.assign(t,{sourceType:"P_RECEIPT",sourceNumber:t.orderNo,certificateCount:t.qualifiedCount,deliverCount:t.qualifiedCount,deliverWeight:t.takeDeliveryWeight}),e.calculateTotal(t,"certificateCount",0),e.calculateTotal(t,"deliverCount",2),e.calculateTotal(t,"deliverWeight",2),e.calculateTotal(t,"certificateCost",2)}),this.detEntityList},closeSupplierModal:function(){this.showSupplierModal=!1},rcv:function(t,e,i){console.log(t,e,i),this.cerOutEntity.supplierId=t,this.cerOutEntity.supplier=i},selectSupplier:function(){this.isDisabled||(this.showSupplierModal=!this.showSupplierModal)},closeSourceModal:function(t,e){var i=this;e?(this.cerOutEntity.dataSource=1,this.detEntityList=t,this.detEntityList.map(function(t){Object.assign(t,{sourceType:"S_CUST_ORDER",sourceNumber:t.saleOrderNo,certificateCount:t.goodsNum,deliverCount:t.goodsNum,deliverWeight:t.totalWeight}),i.calculateTotal(t,"certificateCount",0),i.calculateTotal(t,"deliverCount",2),i.calculateTotal(t,"deliverWeight",2),i.calculateTotal(t,"certificateCost",2)}),this.showSourceModal=!1,this.isDisabledAddRow=!0,this.isDisabledDelRow=!1):this.showSourceModal=!1},doSelectSource:function(){this.isDisabledSourceNo||(this.showSourceModal=!0)},closeTab:function(){window.parent.closeCurrentTab({openTime:this.openTime,exit:!0})},isEdit:function(t){eventHub.$emit("isEdit",t)},saveAccess:function(t,e){eventHub.$emit("saveFile",t,e)},getAccess:function(t,e){eventHub.$emit("queryFile",t,e)},getTime:function(){var t=new Date,e=t.getFullYear(),i=t.getMonth(),s=t.getDate();(i+=1)<10&&(i="0"+i),s<10&&(s="0"+s);return e+"-"+i+"-"+s},getInitData:function(){var i=this,t=window.parent.params.params;if("undo"===t.type)i.detEntityList=JSON.parse(JSON.stringify(t.data)),1<i.detEntityList.length&&(i.isDisabledDelRow=!1),i.cerOutEntity.dataSource=2,i.cerOutEntity.orderStatus=1,i.cerOutEntity.businessType="P_CREDENTIAL_OUT_01",i.cerOutEntity.goodsTypePath=this.detEntityList[0].goodsTypePath,i.cerOutEntity.goodsTypeName=this.detEntityList[0].goodsTypeName,this.cerOutEntity.deliveryDate=(new Date).toLocaleDateString(),i.handlerUnDeliverData();else if("id"===t.type){var e=t.id;$.ajax({type:"post",url:contextPath+"/certificateOutbreaks/getCerAndDetById/"+e,dataType:"json",success:function(t){Object.assign(i.cerOutEntity,_extends({},t.data.cerOutEntity)),i.detEntityList=t.data.detEntityList||[];var e=i.cerOutEntity.orderStatus;1!=e&&(i.isDisabled=!0,i.isEdit("N")),2!=e&&3!=e&&5!=e||(i.isDisabledApproval=!1,i.isDisabledReject=!1),1==e&&1==i.cerOutEntity.dataSource&&(0<i.detEntityList.length&&(i.isDisabledDelRow=!1,null==i.detEntityList[0].sourceType&&(i.isDisabledAddRow=!1)),0==i.detEntityList.length&&(i.isDisabledAddRow=!1,i.isDisabledSourceNo=!1),i.isDisabledBusinessType=!1,i.isDisabledGoodsType=!1,i.isDisabledCerOutNumber=!1,i.isEdit("Y")),2==i.cerOutEntity.dataSource&&1==e&&1<i.detEntityList.length&&(i.isDisabledDelRow=!1)},error:function(){alert("服务器出错啦")}})}else this.cerOutEntity.dataSource=1,this.cerOutEntity.orderStatus=1,this.cerOutEntity.deliveryDate=(new Date).toLocaleDateString(),this.isDisabledAddRow=!1,this.isDisabledBusinessType=!1,this.isDisabledGoodsType=!1,this.isDisabledSourceNo=!1,this.isDisabledCerOutNumber=!1;var s=layui.data("user");this.cerOutEntity.organizationId=s.userCurrentOrganId,this.organizationName=s.currentOrganization.orgName,console.log("当前用户组织id是:===="+s.userCurrentOrganId)},typeInit:function(t,e,i){for(var s=0;s<t.length;s++){if(t[s].value==i)return e.push(t[s].value),!0;if(t[s].children&&0<t[s].children.length&&this.typeInit(t[s].children,e,i))return e.push(t[s].value),!0}}},computed:{typeValue:function(){var t=this.cerOutEntity.goodsTypePath,e=[];return this.typeInit(this.categoryType,e,t),e.reverse()}},watch:{},created:function(){this.getInitData(),this.loadData(),this.loadProductType(),this.getLogisticsModes()},mounted:function(){this.openTime=window.parent.params.openTime,this.isEdit("Y")}});