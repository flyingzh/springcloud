"use strict";var vm=new Vue({el:"#returnGoodsInfo",data:{codesUsed:{},openTime:"",params:{},isShow:!1,reload:!1,isSearchHide:!0,isTabulationHide:!0,isEditTable:!1,isStampShow:!1,isMenu:!0,isEditInput:!1,isClearable:!0,isUpdate:!1,isEditCust:!1,isOpened:!1,showProduct:!1,productId:"",boeType:"W_RETURN",returnGoodsInfo:{createId:"",updateId:"",createName:"",updateName:"",createTime:"",updateTime:"",organizationId:"",organizationName:"",id:"",documentNo:"",documentStatus:1,businessType:"",custId:"",custCode:"",custName:"",documentTime:new Date,returnReason:"",goodsType:"",goodsPath:"",salesmanId:"",salesmanName:"",examineVerifyId:"",examineVerifyName:"",examineVerifyTime:"",isDel:1,goodList:[]},selectedIndex:"",productDetailList:[],productDetailModal:{showModal:!1,ids:{goodsId:"",commodityId:"",documentType:"W_REFUND_GOODS"}},categoryType:[],salesmanList:[],custList:[],warehouseList:[],reservoirPositionList:[],certifiTypes:[],modalTrigger:!1,modalType:"",stepList:[],approvalTableData:[],selectBusinessType:[{value:"W_RETURN_01",label:"普通销售退货"},{value:"W_RETURN_02",label:"受托加工销售退货"}]},methods:{updateCodesUsed:function(t,o){var e,n={},i=this.productDetailList||[];void 0!==t&&void 0!==o&&8!=String(t).length&&(i[o].goodsBarcode=""),$.isArray(i)&&0<i.length&&$.each(i,function(t,o){n[Number(o.goodsBarcode)]=""}),e=$.extend(!0,{},{},n),this.codesUsed=e},getSelect:function(){return repositionDropdownOnSroll("table-responsive","goods")},clearNoNumber:function(t,o,e){return htInputNumber(t,o,e)},modalSure:function(t){this.productDetailModalClick(t)},modalCancel:function(t){this.productDetailModal.showModal=!1},productDetailModalClick:function(t){"attr_ranges_goods"===this.productDetailList[this.selectedIndex].goodsMainType?Object.assign(this.productDetailList[this.selectedIndex],{tBaseBomEntity:t,assistAttrs:null,overEdit:!0}):Object.assign(this.productDetailList[this.selectedIndex],{assistAttrs:t,tBaseBomEntity:null,overEdit:!0}),this.productDetailModal.showModal=!1},showProductDetail:function(t){console.log("当前下标：",t);var o=this;if(this.selectedIndex=t,console.log(o.productDetailList),o.productDetailList[t].commodityId){var e={goodsId:this.productDetailList[t].id,commodityId:this.productDetailList[t].commodityId,documentType:"W_REFUND_GOODS"};o.productDetailList[t].sourceNo&&!o.returnGoodsInfo.documentNo&&(e.goodsId=o.productDetailList[t].goodsId,e.documentType="W_STOCK_IN",e.commodityId=o.productDetailList[t].commodityId,console.log("源单处理")),Object.assign(this.productDetailModal,{showModal:!0,ids:e}),this.$nextTick(function(){o.$refs.modalRef.getProductDetail()})}else o.$Modal.warning({title:"提示信息",content:"请先选择商品"})},handlerDataToPost:function(){var t=this,o={id:"",goodsBarcode:"",pictureUrl:"",commodityId:"",goodsNo:"",goodsName:"",goodsNorm:"",goodsMainType:"",goodsLineNo:"",batchNum:"",countingUnit:"",num:"",weightUnit:"",weight:"",goldWeight:"",mainStoneWeight:"",viceStoneWeight:"",certificateType:"",certificateNo:"",warehouseId:"",reservoirPositionId:"",price:"",amount:"",sourceType:"",sourceNo:"",refunedGoodsId:"",documentType:"",isDel:1,stonesParts:[],materialParts:[],partParts:[],goldParts:[]},e=t.returnGoodsInfo;if(console.log("处理前的数据结构:",e),console.log(t.productDetailList),ht.util.hasValue(t.productDetailList,"array")){e.goodList=[JSON.parse(JSON.stringify(o))];var n=htHandlerProductDetail(t.productDetailList,e,o);return console.log("经过处理后的数据结构为：",n),this.productDetailList.map(function(t,o){e.goodList[o]||(e.goodList[o]={}),Object.assign(e.goodList[o],{id:t.id,goodsBarcode:t.goodsBarcode,pictureUrl:t.pictureUrl,commodityId:t.commodityId,goodsNo:t.goodsNo,goodsMainType:t.goodsMainType,goodsLineNo:t.goodsLineNo,goodsName:t.goodsName,goodsNorm:t.goodsNorm,batchNum:t.batchNum,countingUnit:t.countingUnit,num:t.num,weightUnit:t.weightUnit,weight:t.weight,goldWeight:t.goldWeight,mainStoneWeight:t.mainStoneWeight,viceStoneWeight:t.viceStoneWeight,certificateType:t.certificateType,certificateNo:t.certificateNo,warehouseId:t.warehouseId,reservoirPositionId:t.reservoirPositionId,price:t.price,amount:t.amount,sourceType:t.sourceType,sourceNo:t.sourceNo,refunedGoodsId:t.refunedGoodsId,documentType:t.documentType,isDel:t.isDel})}),e}},rowClick:function(t){var o=this;if("add"===t&&this.validateProduct()){if(!this.returnGoodsInfo.goodsPath)return this.$Modal.warning({title:"提示",content:"请选择商品类型"}),!1;var e=Object.assign({},{id:"",goodsBarcode:"",pictureUrl:"",commodityId:"",goodsNo:"",goodsMainType:"",goodsLineNo:"",goodsName:"",goodsNorm:"",batchNum:"",countingUnit:"",num:"",weightUnit:"",weight:"",goldWeight:"",mainStoneWeight:"",viceStoneWeight:"",certificateType:"",certificateNo:"",warehouseId:"",reservoirPositionId:"",price:"",amount:"",sourceType:"",sourceNo:"",refunedGoodsId:"",documentType:"",isDel:1});this.productDetailList.push(e),this.updateCodesUsed(),this.$nextTick(function(){o.getSelect("table-responsive","goods")})}else if("copy"===t){if(null===this.selectedIndex)this.$Message.warning({title:"提示信息",content:"请选择一条数据！"});else{var n=Object.assign({},this.productDetailList[this.selectedIndex]);for(var i in console.log(n),n)n.id="";console.log(n),console.log(this.productDetailList),this.$nextTick(function(){o.productDetailList.push(n)}),this.selectedIndex=null}this.$nextTick(function(){o.getSelect("table-responsive","goods")})}this.getGoodsBarcodeValue("",this.productDetailList.length-1,1)},validateProduct:function(){var e=!0,n=this;return n.productDetailList=n.productDetailList.filter(function(t){return 1===t.isDel}),$.each(n.productDetailList,function(t,o){if(o.id)return!0;if("attr_ranges_goods"==o.goodsMainType){if(!o.tBaseBomEntity)return e=!1,n.$Modal.error({content:"第"+(t+1)+"行商品明细未选择，请先选择商品明细！"}),!1}else if(!o.assistAttrs)return e=!1,n.$Modal.error({content:"第"+(t+1)+"行商品明细未选择，请先选择商品明细！"}),!1}),e},isEdit:function(t,o){eventHub.$emit("isEdit",t)},saveAccess:function(t,o,e){eventHub.$emit("saveFile",t,o)},getAccess:function(t,o,e){eventHub.$emit("queryFile",t,o)},loadProductType:function(){var o=this;$.ajax({type:"post",url:contextPath+"/entrustMaterialInController/queryStyleCategory",dataType:"json",success:function(t){o.categoryType=o.initGoodCategory(t.data.cateLists)},error:function(){o.$Message.error("服务器出错啦")}})},changeproductTypeName:function(t,o){var e=this;t&&(e.returnGoodsInfo.goodsPath="0."+t.join(".")+"."),ht.util.hasValue(o,"array")&&(e.returnGoodsInfo.goodsType=o[o.length-1].label),ht.util.hasValue(e.productId,"array")&&e.$Modal.confirm({content:"修改商品类型会清空商品简述和商品明细列表的所有数据，是否确定修改？",onOk:function(){e.productDetailList.forEach(function(t){return t.isDel=0}),e.productDetailList=e.productDetailList.filter(function(t){return t.id})}})},initGoodCategory:function(t){var i=this,a=[];return t.forEach(function(t){var o=t.id,e=t.name,n=t.cateLists;n&&(n=i.initGoodCategory(n)),a.push({value:o,label:e,children:n})}),a.forEach(function(t){t.children||delete t.children}),a},getSalesman:function(){var o=this;$.ajax({type:"post",url:contextPath+"/entrustMaterialInController/queryAllEmpByOrganId",contentType:"application/json",dataType:"json",success:function(t){console.log("业务员",t),o.salesmanList=t.data},error:function(){o.$Message.error("服务器出错啦")}})},getCust:function(){var o=this;$.ajax({type:"post",url:contextPath+"/entrustMaterialInController/queryAllCustomer",contentType:"application/json",dataType:"json",success:function(t){console.log("客户",t),o.custList=t.data},error:function(){o.$Message.error("服务器出错啦")}})},action1:function(t){this.selectedIndex=t},action2:function(){""===this.selectedIndex?this.$Message.warning("请选择一条数据！"):(this.productDetailList[this.selectedIndex].id?this.productDetailList[this.selectedIndex].isDel=0:this.productDetailList.splice(this.selectedIndex,1),this.$forceUpdate(),this.updateCodesUsed(),this.selectedIndex="")},monitorWareHouseByBarcode:function(t,o){this.getGoodsBarcodeValue("",o,0)},getGoodsBarcodeValue:function(o,e,t){var n=this;if(1===t)return!1;if(!n.productDetailList[e].warehouseId)return n.$Modal.warning({content:"请选择仓库!",title:"提示"}),!1;console.log(o,e);var i={goodsBarcode:o,isInStock:0,isRefund:0,nature:1,warehouseId:n.productDetailList[e].warehouseId};$.ajax({type:"post",url:contextPath+"/goodsController/queryGoodsDetail",data:JSON.stringify(i),contentType:"application/json",dataType:"json",success:function(t){"100100"===t.code&&(console.log(t.data),$.extend(!0,n.productDetailList[e],{options:t.data.map(function(t){return $.extend(!0,{},{code:t.goodsBarcode,name:t.goodsName,id:t.id})})}),n.$forceUpdate(),n.updateCodesUsed(o,e))},error:function(){layer.alert("服务器出错啦")}})},getGoodsItem:function(t,e){var n=this,o={id:t.id};$.ajax({type:"post",url:contextPath+"/goodsController/queryGoodsDetail",data:JSON.stringify(o),contentType:"application/json",dataType:"json",error:function(){layer.alert("服务器出错啦")}}).then(function(t){if("100100"===t.code&&t.data){var o=t.data[0];return $.extend(!0,n.productDetailList[e],$.extend(!0,{},{goodsMainType:o.goodsMainType,goodsBarcode:o.goodsBarcode,commodityId:o.commodityId,goodsNo:o.goodsNo,goodsName:o.goodsName,goodsNorm:o.goodsNorm,batchNum:o.batchNum,countingUnit:o.countingUnitName,weightUnit:o.weightUnitName})),n.updateCodesUsed(),$.ajax({type:"post",url:contextPath+"/tbasecommodity/info/"+o.commodityId,dataType:"json",error:function(){layer.alert("服务器出错啦")}})}}).then(function(t){if("100100"===t.code&&t.data){var o=t.data;o.frontPic?n.productDetailList[e].pictureUrl=o.frontPic.fdUrl:n.productDetailList[e].pictureUrl="",n.$forceUpdate()}})},getWareHouseGroup:function(){var o=this;$.ajax({type:"post",url:contextPath+"/wareHouse/listByTypeAndOrganizationId",data:{type:1},dataType:"json",success:function(t){"100100"===t.code&&(console.log("仓库组",t.data),o.warehouseList=t.data,o.getRepertoryPositionGroup(1))},error:function(){layer.alert("服务器出错啦")}})},getRepertoryPositionGroup:function(t){var o=this;$.ajax({type:"post",url:contextPath+"/tbaserepertoryposition/listbygroup/"+t,dataType:"json",success:function(t){"100100"===t.code&&(console.log("库位组",t.data),o.reservoirPositionList=t.data)},error:function(){layer.alert("服务器出错啦")}})},getAttrToName:function(){var o=this;this.salesmanList&&this.salesmanList.forEach(function(t){t.id==o.returnGoodsInfo.salesmanId&&(o.returnGoodsInfo.salesmanName=t.empName)}),this.custList&&this.custList.forEach(function(t){t.id==o.returnGoodsInfo.custId&&(o.returnGoodsInfo.custName=t.name,o.returnGoodsInfo.custCode=t.code)})},add:function(){window.parent.activeEvent({name:"新增销售退货单",url:contextPath+"/warehouse/return-goods/return-goods-info.html",params:{type:0}})},save:function(){var o=this;o.getAttrToName();var t=o.handlerDataToPost();if(console.log("要传入后台的数据结构：",t),2===o.returnGoodsInfo.documentStatus||4===o.returnGoodsInfo.documentStatus||3===o.returnGoodsInfo.documentStatus)return o.$Modal.warning({content:"销售退库单已提交!",title:"提示"}),!1;o.returnGoodsInfo.documentStatus=1;var e="";e=o.returnGoodsInfo.documentNo?contextPath+"/refundGoodsController/updateToExistCode":contextPath+"/refundGoodsController/saveToExistCode",window.top.home.loading("show"),$.ajax({type:"POST",url:e,contentType:"application/json;charset=utf-8",data:JSON.stringify(o.returnGoodsInfo),dataType:"json",success:function(t){if("100100"===t.code&&t.data)return o.returnGoodsInfo.documentNo=t.data.documentNo,o.saveAccess(t.data.documentNo,o.boeType),o.getReturnGoodsInfo(),o.$Modal.info({content:"保存成功!",title:"提示"}),window.top.home.loading("hide"),!1;o.$Modal.warning({content:"保存失败!",title:"提示"}),window.top.home.loading("hide")},error:function(t){window.top.home.loading("hide"),o.$Message.error("服务器出错")}})},submit:function(){var o=this;if(!$("form").valid())return!1;if(!o.productDetailList)return o.$Modal.error({title:"提示",content:"请添加商品简述信息!"}),!1;if(o.tableValidate()||!o.validateProduct())return!1;o.getAttrToName();var t=o.handlerDataToPost();if(console.log("要传入后台的数据结构：",t),2===o.returnGoodsInfo.documentStatus||4===o.returnGoodsInfo.documentStatus||3===o.returnGoodsInfo.documentStatus)return o.$Modal.warning({content:"销售退库单已提交!",title:"提示"}),!1;window.top.home.loading("show");var e=[];if(o.returnGoodsInfo.goodList&&o.returnGoodsInfo.goodList.filter(function(t){return t.refunedGoodsId}).forEach(function(t){e.push(t.refunedGoodsId)}),ht.util.hasValue(e,"array")){$.ajax({type:"post",url:contextPath+"/refundGoodsController/queryStorageStatus",data:JSON.stringify(e),contentType:"application/json",dataType:"json",error:function(){o.$Message.error("服务器出错啦")}}).then(function(t){"100100"===t.code&&(0===t.data?o.submitHandler():o.$Modal.info({content:"商品已提交，请勿重复提交!",title:"提示"}),window.top.home.loading("hide"))});return!1}o.submitHandler()},submitHandler:function(){var o=this,t="";o.returnGoodsInfo.documentStatus=2,t=o.returnGoodsInfo.documentNo?contextPath+"/refundGoodsController/updateToExistCode":contextPath+"/refundGoodsController/saveToExistCode",$.ajax({type:"POST",url:t,contentType:"application/json;charset=utf-8",data:JSON.stringify(o.returnGoodsInfo),dataType:"json",success:function(t){if("100100"===t.code&&t.data)return o.returnGoodsInfo.documentNo=t.data.documentNo,o.saveAccess(t.data.documentNo,o.boeType),o.getReturnGoodsInfo(),o.$Modal.info({content:"提交成功!",title:"提示"}),window.top.home.loading("hide"),!1;o.$Modal.warning({content:"提交失败!",title:"提示"}),window.top.home.loading("hide")},error:function(t){window.top.home.loading("hide"),o.$Message.error("服务器出错")}})},tableValidate:function(){return htValidateRow(this.productDetailList,{goodsNo:{name:"商品编码",type:"string"},num:{name:"数量",type:"number"},weight:{name:"总量",type:"number",floor:3},warehouseId:{name:"仓库",type:"number"}})},approval:function(t){this.modalType="approve",this.modalTrigger=!this.modalTrigger},reject:function(t){this.modalType="reject",this.modalTrigger=!this.modalTrigger},approvalOrRejectCallBack:function(t){"100100"==t.result.code&&(this.returnGoodsInfo.documentStatus=parseInt(t.result.data),this.getReturnGoodsInfo())},autoSubmitOrReject:function(){var o=this;$.ajax({url:contextPath+"/refundGoodsController/submitApproval?submitType=1",method:"post",contentType:"application/json;charset=utf-8",data:JSON.stringify({receiptsId:o.returnGoodsInfo.documentNo,approvalResult:"reject"===o.modalType?1:0}),success:function(t){"100100"===t.code?o.returnGoodsInfo.documentStatus=parseInt(t.data):o.$Modal.warning({content:t.msg}),o.getReturnGoodsInfo()}})},updateStatus:function(t,o){var e=this;$.ajax({type:"post",url:contextPath+"/refundGoodsController/update",contentType:"application/json;charset=utf-8",data:JSON.stringify({id:t,documentStatus:o,documentNo:e.returnGoodsInfo.documentNo}),dataType:"json",success:function(t){"100100"===t.code&&(e.returnGoodsInfo.documentStatus=o,e.getReturnGoodsInfo(),console.log("修改成功"))},error:function(){e.$Message.error("服务器出错啦")}})},getOrgan:function(){var o=this;window.top.home.loading("show"),$.ajax({type:"post",url:contextPath+"/entrustMaterialInController/getOrgName",dataType:"json",success:function(t){if(window.top.home.loading("hide"),"100100"===t.code)o.returnGoodsInfo.organizationName=t.data.name,o.returnGoodsInfo.organizationId=t.data.id,o.$forceUpdate();else if("-1"===t.code)return o.$Modal.warning({title:"提示信息",content:"服务器出错啦!"}),!1},error:function(){window.top.home.loading("hide"),alert("服务器出错啦")}})},getReturnGoodsInfo:function(){var e=this,n=e.params,t={};if(!$.isEmptyObject(n)){if(0===n.params.type){if(0!==n.params.type||!e.returnGoodsInfo.documentNo)return e.getOrgan(),e.isEdit("Y"),!1;t={documentNo:e.returnGoodsInfo.documentNo}}if(1===n.params.type&&(t={id:n.params.data}),2===n.params.type&&(t={documentNo:n.params.data}),3===n.params.type&&!e.returnGoodsInfo.documentNo)return e.getPendingReturnGoodsList(n.params.data),e.isEdit("Y"),!1;3===n.params.type&&e.returnGoodsInfo.documentNo&&(t={documentNo:e.returnGoodsInfo.documentNo})}$.ajax({type:"POST",url:contextPath+"/refundGoodsController/getRefundGoods",contentType:"application/json;charset=utf-8",data:JSON.stringify(t),dataType:"json",success:function(t){if("100100"===t.code&&(console.log(t.data),t.data&&(t.data.goodList||(t.data.goodList=[]),e.returnGoodsInfo=t.data,e.getOrgan(),t.data.goodList&&(e.productDetailList=t.data.goodList),e.getAccess(t.data.documentNo,e.boeType),e.isEdit("Y"),t.data.organizationId===window.parent.userInfo.organId&&(e.returnGoodsInfo.organizationName=window.parent.userInfo.orgName,e.returnGoodsInfo.organizationId=window.parent.userInfo.organId),1===t.data.documentStatus&&(e.isMenu=!0,e.isEditInput=!1,e.isClearable=!0,e.isUpdate=!1,e.isOpened=!1,e.isEditCust=!1,e.isClearable=!0,e.isEditTable=!1,e.showProduct=!1,e.isEdit("Y"),$(".is-disabled:gt(0):lt(2)").css("pointer-events","auto").css({color:"#495060"})),1===t.data.documentStatus&&2!==n.params.type||(e.isMenu=!1,e.isEditInput=!0,e.isClearable=!1,e.isUpdate=!0,e.isOpened=!0,e.isEditCust=!0,e.isClearable=!1,e.isEditTable=!0,e.showProduct=!0,e.isEdit("N"),$(".is-disabled:gt(0):lt(2)").css("pointer-events","none").css({color:"#bbbec4"})),2===n.params.type&&$(".is-disabled").css("pointer-events","none").css({color:"#bbbec4"}),4===t.data.documentStatus?e.isStampShow=!0:e.isStampShow=!1,t.data.goodList&&0<t.data.goodList.length&&t.data.goodList[0].sourceNo&&(e.isMenu=!1,e.isUpdate=!0,e.isEditCust=!0,e.showProduct=!0),t.data.goodsPath))){var o=t.data.goodsPath.substr(2).replace(/.$/gi,"").split(".");e.productId=o.map(function(t){return parseInt(t)})}}})},getPendingReturnGoodsList:function(t){var a=this;$.ajax({type:"POST",url:contextPath+"/refundGoodsController/getSalePendingGoods",contentType:"application/json;charset=utf-8",data:JSON.stringify(t),dataType:"json",success:function(t){if("100100"===t.code&&(console.log(t.data),t.data)){var o=t.data[0],e=[];t.data.forEach(function(t){t.goodList.forEach(function(t){e.push(t)})});var n=$.extend(!0,a.returnGoodsInfo,{documentStatus:1,custId:o.customerId,custCode:o.custNo,returnReason:o.reason,goodsType:o.goodsType,goodsPath:o.goodsType,salesmanId:o.businessManId,salesmanName:o.businessManName,isDel:1,goodList:e.map(function(t){return $.extend(!0,{},{refunedGoodsId:t.id,goodsId:t.goodsId,sourceNo:t.returnNoticeNo,sourceType:"S_RETURN",commodityId:t.commodityId,goodsNo:t.goodsCode,goodsBarcode:t.goodsBarcode,goodsName:t.goodsName,goodsMainType:t.goodsMainType,goodsLineNo:t.goodsLineNo,pictureUrl:t.pictureUrl,batchNum:t.batchNum,countingUnit:t.countingUnit,num:t.num,weightUnit:t.weightUnit,weight:t.weight,documentType:t.documentType,isDel:1})})});if(console.log(n),o.goodsType){a.returnGoodsInfo.goodsType=o.goodsType;var i=o.goodsType.substr(2).replace(/.$/gi,"").split(".");a.productId=i.map(function(t){return parseInt(t)})}a.returnGoodsInfo=n,a.getOrgan(),n.goodList&&(a.productDetailList=n.goodList),a.isMenu=!1,a.isUpdate=!0,a.isEditCust=!0,a.showProduct=!0}}})},list:function(){window.parent.activeEvent({name:"销售退货单",url:contextPath+"/warehouse/return-goods/return-goods-list.html"})},exit:function(){var t=this;$.isEmptyObject(t.params)||(0!==t.params.params.type&&3!==t.params.params.type||window.parent.closeCurrentTab({name:"新增销售退货单",exit:!0,openTime:this.openTime}),1===t.params.params.type&&window.parent.closeCurrentTab({name:"修改销售退货单",exit:!0,openTime:this.openTime}),2===t.params.params.type&&window.parent.closeCurrentTab({name:"查看销售退货单",exit:!0,openTime:this.openTime}))},htPrint:function(t){function o(){return t.apply(this,arguments)}return o.toString=function(){return t.toString()},o}(function(){htPrint()})},mounted:function(){this.getSelect("table-responsive","goods"),this.loadProductType(),this.getCust(),this.getSalesman(),this.getWareHouseGroup(),this.certifiTypes=getCodeList("base_certificate_type"),this.getReturnGoodsInfo(),this.openTime=window.parent.params.openTime,$("form").validate()},created:function(){var t=window.parent.params;this.params=t}});