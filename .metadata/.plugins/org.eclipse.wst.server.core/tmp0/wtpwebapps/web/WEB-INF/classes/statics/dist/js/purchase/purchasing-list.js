"use strict";function _defineProperty(t,e,o){return e in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}var vm=new Vue({el:"#purchasingList",data:function(){var t;return _defineProperty(t={newCustomCode:[],productType:[],openTime:"",isSearchHide:!0,isTabulationHide:!0,isShow:!1,isHide:!0,currentTab:"tab1",buyerOptions:[],commodityCategoty:[],showSupplier:!1,showDetail:!1,showPurcahseDetail:!1,supplierNameMap:{},buyerMap:{},categoryType:[],suppliers:[],dateArr:[],colour:[],body:{goodsGroupPath:"",custStyleCode:"",supplierId:"",startTime:"",endTime:"",goldColor:"",goodsName:"",limit:10,page:1},columnData:[{type:"selection",width:60,align:"center"},{title:"商品编码",key:"goodsCode"},{title:"金料详情",key:"goldMessage",width:250},{title:"石料详情",key:"stoneMessage",width:250},{title:"备注",key:"remark"},{title:"待采购数量",key:"totalNum"},{title:"待采购重量",key:"totalWeight"}],supplierData:[],orderType:"",orderGenre:"",generalList:[],detailDataList:[],isCheckedAll:!1,selectedIndex:"",outIndex:[],outData:[],tmpData:[],innerData:[{}],postData:[],selectedSupplier:"",currentGeneral:null,totalGeneral:null},"generalList",[]),_defineProperty(t,"isCheckall",!1),_defineProperty(t,"oData",[]),_defineProperty(t,"oIndex",[]),_defineProperty(t,"iData",[{}]),_defineProperty(t,"totalPurchase",null),_defineProperty(t,"currentPurchase",null),t},methods:{hideSearch:function(){this.isHide=!this.isHide,this.isSearchHide=!this.isSearchHide,$(".chevron").css("top","")},getOutData:function(t,e){if(console.log(t,e),"general"===t){if(-1<this.outIndex.indexOf(e)){var o=this.outIndex.indexOf(e);this.outIndex.splice(o,1),this.outData.splice(o,1)}else this.outIndex.push(e),this.outData.push(this.generalList[e]);this.outIndex.length===this.generalList.length?this.isCheckedAll=!0:this.isCheckedAll=!1}else if("purchase"===t){if(-1<this.oIndex.indexOf(e)){var a=this.oIndex.indexOf(e);this.oIndex.splice(a,1),this.oData.splice(a,1)}else this.oIndex.push(e),this.oData.push(this.purchasingList[e]);this.oIndex.length===this.purchasingList.length?this.isCheckall=!0:this.isCheckall=!1}},getAll:function(t){var o=this;"general"===t?(this.isCheckedAll?(this.outIndex=[],this.outData=[]):(this.outIndex=[],this.outData=[],this.generalList.forEach(function(t,e){o.outIndex.push(e),o.outData.push(t)})),console.log(this.outIndex,this.outData)):"purchase"===t&&(this.isCheckall?(this.oIndex=[],this.oData=[]):(this.outIndex=[],this.outData=[],this.purchasingList.forEach(function(t,e){o.oIndex.push(e),o.oData.push(t)})),console.log(this.oIndex,this.oData))},getOneRow:function(t,e){console.log(t,e),this.tmpData=[],this.tmpData=JSON.parse(JSON.stringify(t))},getAllRow:function(t){console.log(t),this.tmpData=[],this.tmpData=JSON.parse(JSON.stringify(t))},cancelOneRow:function(t){console.log(t),this.tmpData=[],this.tmpData=JSON.parse(JSON.stringify(t))},oneRow:function(t,e){console.log(t,e),this.tmpData=[],this.tmpData=JSON.parse(JSON.stringify(t))},allRow:function(t){console.log(t),this.tmpData=[],this.tmpData=JSON.parse(JSON.stringify(t))},changeRow:function(t){console.log(t),this.tmpData=[],this.tmpData=JSON.parse(JSON.stringify(t))},changePages:function(t){console.log(t),this.body.page=t,this.loadGeneralList()},changePageSize:function(t){console.log(t),this.body.limit=t,this.loadGeneralList()},switchPages:function(t){this.body.page=t,this.loadPurchasingList()},switchPageSize:function(t){this.body.limit=t,this.loadPurchasingList()},handleListData:function(t){var i=this,e=t;return t&&e.forEach(function(e){var o=0,a=0;e.details.forEach(function(t){t.totalNum&&(o+=parseFloat(t.totalNum)),t.totalWeight&&(a+=parseFloat(100*t.totalWeight))}),e.totalAmount=o,e.totalWeight=(a/100).toFixed(2),e.supplierShortName=[],e.supplierId&&(e.supplierId=JSON.parse(e.supplierId).map(Number),e.supplierId.forEach(function(t){vm.supplierNameMap[t]&&e.supplierShortName.push(vm.supplierNameMap[t])})),3<=e.supplierShortName.length&&(e.supplierShortName=e.supplierShortName.slice(0,3)),e.supplierShortName=e.supplierShortName.join("、"),i.$set(e,"buyerInfo",[]),e.buyer&&(e.buyer=JSON.parse(e.buyer).map(Number),e.buyer.forEach(function(t){vm.buyerMap[t]&&e.buyerInfo.push({id:t,emp_Name:vm.buyerMap[t]})}))}),console.log(e),e},loadGeneralList:function(){var e=this;$.ajax({type:"post",url:contextPath+"/tpurchaselist/generalList ",contentType:"application/json",data:JSON.stringify(e.body),dataType:"json",success:function(t){console.log("普通",t.data.list),e.generalList=e.handleListData(t.data.list),e.totalGeneral=t.data.totalCount,e.currentGeneral=t.data.currPage},error:function(t){console.log("服务器出错")}})},loadPurchasingList:function(){var e=this;$.ajax({type:"post",url:contextPath+"/tpurchaselist/purchaseList ",contentType:"application/json",data:JSON.stringify(e.body),dataType:"json",success:function(t){console.log("受托：",t.data.list),e.purchasingList=e.handleListData(t.data.list),e.totalPurchase=t.data.totalCount,e.currentPurchase=t.data.currPage},error:function(t){console.log("服务器出错")}})},getSupplierInfo:function(t){for(var e=0;e<vm.suppliers.length;e++)if(vm.suppliers[e].id===t)return[vm.suppliers[e].siShortName,vm.suppliers[e].supplierCode]},showDetailList:function(t,e){"general"===t?(this.showDetail=!0,this.detailDataList=this.generalList[e].details,this.selectedIndex=e):"purchase"===t&&(this.showPurcahseDetail=!0,this.detailDataList=this.purchasingList[e].details,this.selectedIndex=e)},loadBuyer:function(){var e=this;$.ajax({type:"post",url:contextPath+"/tpurchasecollectgoods/data",dataType:"json",success:function(t){t.data.employees.map(function(t){e.buyerMap[t.id]=t.empName})},error:function(){console.log("服务器出错啦")}})},loadSuppliers:function(){var e=this;$.ajax({type:"post",url:contextPath+"/tpurchasecollectgoods/findSupplierByOrgId",dataType:"json",success:function(t){e.suppliers=t.data,t.data.map(function(t){e.supplierNameMap[t.id]=t.siShortName})},error:function(){console.log("服务器出错啦")}})},loadSytleCategory:function(){var e=this;$.ajax({url:contextPath+"/tbasestylecategory/listByAll?customCode=0.",type:"POST",dataType:"json",success:function(t){e.productType=e.initGoodStyle(t.data.styles)},error:function(){layer.alert("网络异常，请重试！",{icon:0})}})},initGoodStyle:function(t){var i=this,s=[];return t.forEach(function(t){var e=t.customCode,o=t.styleName,a=t.styles;a&&(a=i.initGoodStyle(a)),s.push({value:e,label:o,children:a})}),s.forEach(function(t){t.children||delete t.children}),s},loadColour:function(){var r=this;$.ajax({type:"post",url:contextPath+"/tpurchaselist/queryColour",dataType:"json",success:function(t){console.log("成色:"+t.data);var e=!0,o=!(r.colour=[]),a=void 0;try{for(var i,s=t.data[Symbol.iterator]();!(e=(i=s.next()).done);e=!0){var n=i.value;r.colour.push(n)}}catch(t){o=!0,a=t}finally{try{!e&&s.return&&s.return()}finally{if(o)throw a}}},error:function(){layer.alert("服务器出错啦")}})},loadProductType:function(){var e=this;$.ajax({type:"post",url:contextPath+"/documentController/getCategory?parentId=0",contentType:"application/json",dataType:"json",success:function(t){e.categoryType=e.initGoodCategory(t.data.cateLists)},error:function(t){console.log("服务器出错")}})},initGoodCategory:function(t){var i=this,s=[];return t.forEach(function(t){var e=t.customCode,o=t.name,a=t.cateLists;a&&(a=i.initGoodCategory(a)),s.push({value:e,label:o,children:a})}),s.forEach(function(t){t.children||delete t.children}),s},intersect:function(t){for(var e=[],o={},a=0;a<t.length;a++)for(var i=0;i<t[a].length;i++){var s=t[a][i];o[s]?(o[s]++,o[s]==t.length&&e.push(s)):o[s]=1}return e},isAllEqual:function(o){return!(0<o.length)||!o.some(function(t,e){return t!==o[0]})},getData:function(t,e,o){this.selectedSupplier=t,console.log(e,o,this.selectedSupplier),this.showSupplier=!1,"general"===e?("out"===o?(this.changeData(this.outData),this.postData=this.outData):"inner"===o&&(this.changeData(this.innerData),this.postData=this.innerData),console.log(this.postData),$.ajax({type:"post",contentType:"application/json;charset=UTF-8",data:JSON.stringify(vm.postData),dataType:"json",url:contextPath+"/tpurchaselist/submitPurchaseOrder?type=1",success:function(t){console.log(t),"100100"===t.code?(vm.$Modal.success({content:"下单申请成功，请填写采购订单页面！",onOk:function(){window.location.reload(!0)}}),window.parent.activeEvent({name:"新增采购订单",url:contextPath+"/purchase/purchase-order/purchase-order.html",params:{basicInfo:t.data,type:"sAdd"}})):vm.$Modal.warning({title:"提示信息",content:"下单申请失败，请重新下单！",onOk:function(){window.location.reload(!0)}})},error:function(){layer.alert("服务器出错啦")}})):"purchase"===e&&("out"===o?(this.changeData(this.oData),this.postData=this.oData):"inner"===o&&(this.changeData(this.iData),this.postData=this.iData),console.log(this.postData),$.ajax({type:"post",contentType:"application/json;charset=UTF-8",data:JSON.stringify(vm.postData),dataType:"json",url:contextPath+"/tpurchaselist/submitPurchaseOrder?type=0",success:function(t){console.log(t),"100100"===t.code?(vm.$Modal.success({content:"采购下单成功！",onOk:function(){window.location.reload(!0)}}),window.parent.activeEvent({name:"新增采购订单",url:contextPath+"/purchase/purchase-order/purchase-order.html",params:{basicInfo:t.data,type:"sAdd"}})):vm.$Modal.warning({title:"提示信息",content:"采购下单失败，请重新下单",onOk:function(){window.location.reload(!0)}})},error:function(){layer.alert("服务器出错啦")}}))},changeData:function(t){var e=this;return t.forEach(function(t){t.supplierId=e.selectedSupplier}),t},getBuyerName:function(t,e){console.log(t,e),e.buyerName=t.label},getSupplierId:function(t){var e=[];return t.forEach(function(t){e.push(t.supplierId)}),e},showModal:function(t){console.log(t);var e=[];if(0<t.length){for(var o=0;o<t.length;o++)e.push({supplierId:t[o],siShortName:vm.getSupplierInfo(t[o])[0],supplierCode:vm.getSupplierInfo(t[o])[1]});console.log(e),this.supplierData=e,this.showSupplier=!0}else this.$Modal.warning({title:"提示信息",content:"供应商没有交集，请重新选择！"})},handleOutData:function(t){if(0!==t.length){var e=t;console.log(e);for(var o=0;o<e.length;o++)if(!e[o].buyer)return void this.$Modal.warning({content:"所选数据行业务员为必选项，请重新选择！"});var a=[],i=[];if(e.forEach(function(t){a.push(t.goodsType),i.push(t.buyer)}),this.isAllEqual(a))if(console.log(i),this.isAllEqual(i)){console.log(e);var s=this.getSupplierId(e);if(console.log(s),1<s.length){var n=this.intersect(s);console.log(n),this.showModal(n)}else this.showModal(s[0])}else this.$Modal.warning({title:"提示信息",content:"业务员必须是同一人，请重新选择！"});else this.$Modal.warning({title:"提示信息",content:"商品类型不一致，请重新选择！"})}else this.$Modal.warning({title:"提示信息",content:"您没有选择任何数据，不能下单，请重新选择！"})},handleInnerData:function(t,e){Object.assign(e[0],{pictureUrl:t[this.selectedIndex].pictureUrl,goodsType:t[this.selectedIndex].goodsType,goodsGroupPath:t[this.selectedIndex].goodsGroupPath,countdown:t[this.selectedIndex].countdown,goodsCode:t[this.selectedIndex].goodsCode,goodsName:t[this.selectedIndex].goodsName,supplierId:t[this.selectedIndex].supplierId,buyer:t[this.selectedIndex].buyer,buyerName:t[this.selectedIndex].buyerName,demandDate:t[this.selectedIndex].demandDate}),e[0].details=this.tmpData,console.log(e),this.tmpData.length<1?this.$Modal.warning({content:"请至少选择一条明细数据！"}):e[0].buyer?this.showModal(e[0].supplierId):this.$Modal.warning({content:"所选数据行业务员为必选项，请重新选择！"})},order:function(t,e){console.log(t,e),this.orderType=t,this.orderGenre=e,"general"===t&&"out"===e?this.handleOutData(this.outData):"general"===t&&"inner"===e?this.handleInnerData(this.generalList,this.innerData):"purchase"===t&&"out"===e?this.handleOutData(this.oData):"purchase"===t&&"inner"===e&&this.handleInnerData(this.purchasingList,this.iData)},cancel:function(t){"general"===t?this.$refs.selection.selectAll(!1):this.$refs.selectContent.selectAll(!1)},switchTab:function(){"tab1"===this.currentTab?this.currentTab="tab2":this.currentTab="tab1"},search:function(){console.log(this.body),0<this.commodityCategoty.length?this.body.goodsGroupPath=this.commodityCategoty[this.commodityCategoty.length-1]:this.body.goodsGroupPath="",0<this.newCustomCode.length?this.body.custStyleCode=this.newCustomCode[this.newCustomCode.length-1]:this.body.custStyleCode="",0<this.dateArr.length&&this.dateArr[0]&&this.dateArr[1]?(this.body.startTime=this.dateArr[0].format("yyyy-MM-dd")+" 00:00:00",this.body.endTime=this.dateArr[1].format("yyyy-MM-dd")+" 23:00:00"):(this.body.startTime="",this.body.endTime=""),"tab1"===this.currentTab?this.loadGeneralList():"tab2"===this.currentTab&&this.loadPurchasingList()},clear:function(){this.$refs.supplierName.reset(),this.body.goodsGroupPath="",this.body.custStyleCode="",this.body.supplierId="",this.dateArr=[],this.commodityCategoty=[],this.newCustomCode=[],this.body.startTime="",this.body.endTime="",this.body.goldColor="",this.body.goodsName=""},refresh:function(){window.location.reload(!0)},exit:function(){window.parent.closeCurrentTab({openTime:this.openTime,exit:!0})}},watch:{},created:function(){this.loadBuyer(),this.loadProductType(),this.loadSuppliers(),this.loadSytleCategory(),this.loadGeneralList(),this.loadColour(),this.loadPurchasingList()},mounted:function(){this.openTime=window.parent.params.openTime}});