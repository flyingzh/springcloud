"use strict";var _extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var o=arguments[e];for(var i in o)Object.prototype.hasOwnProperty.call(o,i)&&(t[i]=o[i])}return t};function _defineProperty(t,e,o){return e in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}var purchaseRequisition=new Vue({el:"#purchaseRequisition",data:function(){var t;return _defineProperty(t={value10:3,checkListData:{applyWeight:{name:"重量",type:"number",floor:2,plus:!0},applyCount:{name:"数量",type:"number",floor:0,empty:!0},price:{name:"预计采购单价",type:"number",floor:2}},paramsMap:{"商品类型":"","申请部门":"","申请人":""},commodityList:[],productDetailModal:{showModal:!1,dataSourceType:!1,dataSource:null,ids:{goodsId:"",commodityId:"",documentType:"P_APPLY_ORDER"},specialAttr:{stone:{},gold:{},part:{}}},boeType:"P_APPLY_ORDER",modalTrigger:!1,modalType:"",steplist:[],approvalTableData:[],isHint:!0,organName:layui.data("user").currentOrganization.orgName,productTypeList:[],productDetailList:[],applyOrder:{goodList:[],applyCount:"",applyWeight:"",orderStatus:1,remark:"",applyUserId:"",delGoodIds:[],organizationId:"",updateId:"",applyDeptId:"",limit:"",startTime:"",id:"",orderNo:"",estimatePurchaseMoney:"",estimatePurchaseDate:(new Date).format("yyyy-MM-dd hh:mm:ss"),auditor:"",updateTime:"",updateName:"",version:"",goodsType:"",applyUserName:"",auditorId:"",createTime:"",goodsTypeId:"",applyDeptName:"",auditTime:"",createId:"",endTime:"",applyDate:(new Date).format("yyyy-MM-dd hh:mm:ss"),isDel:1,createName:"",goodsGroupPath:""},selectedIndex:0,isSearchHide:!0,isTabulationHide:!0,deptList:[],unitMap:{},needReload:!1,showProductProperty:!1,approveComment:!1,rejectComment:!1,approvement:{receiptsId:"",approvalResult:"1",approvalInfo:""},rejectement:{receiptsId:"",approvalResult:"0",approvalInfo:""}},"steplist",[]),_defineProperty(t,"currentStep",""),_defineProperty(t,"nextStep",""),_defineProperty(t,"showDepartmentModal",!1),_defineProperty(t,"treeNode1",""),_defineProperty(t,"buyers",[]),_defineProperty(t,"setting2",{data:{simpleData:{enable:!0,idKey:"id",pIdKey:"parentId"},key:{name:"depName"}},callback:{beforeClick:function(t,e,o){return!e.isParent},beforeDblClick:function(t,e){return!e.isParent},onClick:this.clickEvent1}}),t},methods:{isEdit:function(t,e){eventHub.$emit("isEdit",t)},saveAccess:function(t,e,o){eventHub.$emit("saveFile",t,e)},getAccess:function(t,e,o){eventHub.$emit("queryFile",t,e)},approvalOrRejectCallBack:function(t){var e=this;if("100100"==t.result.code){var o=t.result.data;e.applyOrder.orderStatus=o.orderStatus,e.applyOrder.version=o.version,4===e.applyOrder.orderStatus&&(e.applyOrder.auditor=o.auditor,e.applyOrder.auditorId=o.auditorId,e.applyOrder.auditTime=o.auditTime),e.isEdit(1==e.applyOrder.orderStatus?"Y":"N")}else this.$Modal.warning({content:t.result.msg,title:"警告"})},approval:function(){var t=this;t.modalType="approve",t.modalTrigger=!t.modalTrigger},reject:function(){var t=this;t.modalType="reject",t.modalTrigger=!t.modalTrigger},isHintShow:function(t){var e=this;t&&this.typeValue&&this.isHint&&this.productDetailList&&0<this.productDetailList.length&&this.$Modal.warning({content:"温馨提示：改变商品类型将删除所有商品信息!",onOk:function(){e.isHint=!1,console.log("温馨提示：改变商品类型将删除所有商品信息！")}})},clearNoNum:function(t,e,o){return htInputNumber(t,e,o)},iconPopup:function(){1==this.applyOrder.orderStatus&&(this.showDepartmentModal=!0)},clickEvent1:function(t,e,o){this.treeNode1=o},ok1:function(){var t=this.treeNode1;if(null!=t){if(console.log(t.depName),this.applyOrder.applyDeptId==t.id)return!1;this.applyOrder.applyDeptName=t.depName;var e=t.id;this.applyOrder.applyDeptId=t.id,this.applyOrder.applyUserId="",this.applyOrder.applyUserName="",this.getbuyers(e)}},getbuyers:function(t){var e=this;$.ajax({type:"post",url:contextPath+"/tbasecommodity/queryAllEmpByDeptId?id="+t,contentType:"application/json",dataType:"json",async:!1,success:function(t){"100100"===t.code?(console.log(t.data),e.buyers=t.data):this.$Modal.error({content:t.msg})},error:function(t){this.$Modal.error({content:"网络异常,请联系技术人员！"})}})},changeApplyUser:function(t){if(console.log(t),!t)return!1;this.applyOrder.applyUserId=t.value;var e=t.label.split("-");2==e.length&&(this.applyOrder.applyUserName=e[1].replace(/(\s*$)/g,"")),console.log(this.applyOrder)},initUnit:function(){var i=this;$.ajax({type:"post",url:contextPath+"/tbaseunit/list",contentType:"application/json",dataType:"json",async:!1,success:function(t){"100100"===t.code?(t.data.map(function(t){var e=t.id,o=t.name;i.unitMap[e]=o}),console.log(i.unitMap)):this.$Modal.error({content:t.msg})},error:function(t){this.$Modal.error({content:"网络异常,请联系技术人员！"})}})},initDept:function(){var e=this;$.ajax({type:"post",url:contextPath+"/dept/findByDepartment",contentType:"application/json",dataType:"json",async:!1,success:function(t){"100100"===t.code?e.deptList=t.data:this.$Modal.error({content:t.msg})},error:function(t){this.$Modal.error({content:"网络异常,请联系技术人员！"})}})},add:function(){},cancel:function(){window.parent.closeCurrentTab({exit:!0,openTime:this.openTime})},getApproveInfo:function(){},getRejectInfo:function(){},initGoodCategory:function(t){var r=this,n=[];return t.forEach(function(t){var e=t.customCode,o=t.name,i=t.cateLists,a=t.code;i&&(i=r.initGoodCategory(i)),n.push({value:e,label:o,children:i,code:a})}),n.forEach(function(t){t.children||delete t.children}),n},getProductType:function(){var e=this;$.ajax({type:"post",url:contextPath+"/tbasecommoditycategory/listByAll?parentId=0",dataType:"json",success:function(t){"100100"===t.code?e.productTypeList=e.initGoodCategory(t.data.cateLists):this.$Modal.error({content:t.msg})},error:function(){this.$Modal.error({content:"网络异常,请联系技术人员！"})}})},getPurchaseDetail:function(){},getCommodityList:function(){var e=this,t={categoryCustomCode:e.applyOrder.goodsGroupPath,field:"",limit:""};$.ajax({type:"post",async:!1,url:contextPath+"/tbasecommodity/findByType",data:t,dataType:"json",success:function(t){if("100100"!=t.code)return this.$Modal.error({content:t.msg}),void(e.commodityList=[]);e.commodityList=t.data},error:function(){this.$Modal.error({content:"网络异常,请联系技术人员！"})}})},changeProductType:function(t,e){var o=this;if(t==this.typeValue)return!1;this.applyOrder.id&&(this.applyOrder.delGoodIds||(this.applyOrder.delGoodIds=[]),this.productDetailList.map(function(t){t.goodsId&&o.applyOrder.delGoodIds.push(t.goodsId)})),this.productDetailList=[];var i=e[e.length-1];this.applyOrder.goodsType=i.label,this.applyOrder.goodsGroupPath=i.value,this.getCommodityList()},getSelectedItem:function(t,i){var a=this;$.ajax({type:"post",url:contextPath+"/tbasecommodity/getBriefById/"+t.id,dataType:"json",success:function(t){if("100100"==t.code){a.order=t.data;var e=t.data;e.countUnitId=a.unitMap[e.countUnitId],e.weightUnitId=a.unitMap[e.weightUnitId];var o={};Object.assign(o,{goodsNo:e.code,goodsName:e.name,commodityId:e.id,pictureUrl:e.frontPic&&e.frontPic.fdUrl,goodsType:e.categoryName,goodsTypePath:e.categoryCustomCode,custStyleCode:e.styleCustomCode,goodsMainType:e.mainType,goodsSpecifications:e.specification,countingUnit:e.countUnitId,weightUnit:e.weightUnitId,pricingMethod:e.pricingType}),a.productDetailList[a.selectedIndex].goodsId&&(a.applyOrder.delGoodIds||(a.applyOrder.delGoodIds=[]),a.applyOrder.delGoodIds.push(a.productDetailList[a.selectedIndex].goodsId)),Vue.set(a.productDetailList,i,o),"attr_ranges_gold"===e.mainType&&(a.productDetailList[i].goldColor=e.certificateType),a.$forceUpdate()}else this.$Modal.error({content:t.msg})},error:function(){this.$Modal.error({content:"网络异常,请联系技术人员！"})}})},getInputValue:function(t,e){console.log(t,e,this.applyOrder.goodsGroupPath);var o=this,i={categoryCustomCode:o.applyOrder.goodsGroupPath,field:t,limit:""};$.ajax({type:"post",url:contextPath+"/tbasecommodity/findByType",data:i,dataType:"json",success:function(t){"100100"==t.code?(Object.assign(o.productDetailList[e],{options:t.data}),o.$forceUpdate()):this.$Modal.error({content:t.msg})},error:function(){this.$Modal.error({content:"网络异常,请联系技术人员！"})}})},selectProductDetail:function(t){this.selectedIndex=t},modalSure:function(t){this.productDetailModalClick(t)},modalCancel:function(t){},productDetailModalClick:function(t){console.log(t),"attr_ranges_goods"===this.productDetailList[this.selectedIndex].goodsMainType?Object.assign(this.productDetailList[this.selectedIndex],{tBaseBomEntity:t,assistAttrs:null,overEdit:!0}):Object.assign(this.productDetailList[this.selectedIndex],{assistAttrs:t,tBaseBomEntity:null,overEdit:!0})},showProductDetail:function(t){var e=this;if(this.selectedIndex=t,!this.productDetailList[t].commodityId)return this.$Modal.error({content:"还未选择商品，请先选择商品，再选择明细！"}),!1;var o={goodsId:this.productDetailList[t].goodsId,commodityId:this.productDetailList[t].commodityId,documentType:"P_APPLY_ORDER"};Object.assign(this.productDetailModal,{showModal:!0,ids:o}),this.$nextTick(function(){e.$refs.modalRef.getProductDetail()})},validateProduct:function(){var o=!0,i=this;return $.each(i.productDetailList,function(t,e){if(e.goodsId)return!0;if("attr_ranges_goods"==e.goodsMainType){if(!e.tBaseBomEntity)return o=!1,i.$Modal.error({content:"第"+(t+1)+"行商品明细未选择，请先选择商品明细！"}),!1}else if(!e.assistAttrs)return o=!1,i.$Modal.error({content:"第"+(t+1)+"行商品明细未选择，请先选择商品明细！"}),!1}),o},getInitDataById:function(){var e=this,t=window.parent.params.params.code;t&&$.ajax({type:"POST",url:contextPath+"/tpurchaseapply/info/"+t,dataType:"json",success:function(t){"100100"===t.code?(e.initOrder(t.data),e.isEdit(1==e.applyOrder.orderStatus?"Y":"N"),e.getAccess(e.applyOrder.id,e.boeType)):this.$Modal.warning({content:"服务器出错"})},error:function(){this.$Modal.error({content:"网络异常,请联系技术人员！"})}})},initOrder:function(t){Object.assign(this.applyOrder,_extends({},t)),this.productDetailList=t.goodList,t.applyDeptId&&this.getbuyers(t.applyDeptId)},submitAllData:function(t){if(1===this.applyOrder.orderStatus){if("submit"==t){if(this.paramsMap={"商品类型":this.applyOrder.goodsGroupPath,"申请部门":this.applyOrder.applyDeptId,"申请人":this.applyOrder.applyUserId},!this.checkData(!0))return;if(htValidateRow(this.productDetailList,this.checkListData))return!1}if(!this.validateProduct())return!1;var e="/tpurchaseapply/save";this.applyOrder.id&&(e="/tpurchaseapply/update");var o=this.handlerDataToPost();"save"==t?o.orderStatus=1:"submit"==t&&(o.orderStatus=2);var i=this;$.ajax({type:"POST",contentType:"application/json",url:contextPath+e,data:JSON.stringify(o),dataType:"json",success:function(t){window.top.home.loading("hide"),"100100"===t.code?(i.$Modal.success({content:"提交成功"}),Object.assign(i.applyOrder,_extends({},t.data)),i.productDetailList=t.data.goodList,i.saveAccess(t.data.id,i.boeType),i.isEdit(1==i.applyOrder.orderStatus?"Y":"N")):i.$Modal.warning({content:"提交失败"})},error:function(){window.top.home.loading("hide"),i.$Modal.error({content:"服务器出错啦!"})}})}},checkData:function(t){for(var e in this.paramsMap)if(null==this.paramsMap[e]||""===this.paramsMap[e]||"null"===this.paramsMap[e])return t&&this.$Modal.warning({title:"提示",okText:"确定",content:e+"不能为空"}),!1;return!0},handlerDataToPost:function(){var t={amount:"",applyCount:"",applyWeight:"",countingUnit:"",createTime:"",custStyleCode:"",goldColor:"",goldWeight:"",goodsId:"",goodsLineNo:"",goodsMainType:"",goodsName:"",goodsNo:"",goodsSpecifications:"",goodsType:"",goodsTypePath:"",mainStoneWeight:"",orderNo:"",orderStatus:"",pictureUrl:"",price:"",pricingMethod:"",remark:null,stoneClarity:null,stoneColor:null,stoneSection:null,updateId:null,updateName:null,updateTime:null,viceStoneWeight:null,weightUnit:"",stonesParts:[],materialParts:[],partParts:[],goldParts:[]},o=this.applyOrder;return 0<this.productDetailList.length&&(o.goodList=[JSON.parse(JSON.stringify(t))]),htHandlerProductDetail(this.productDetailList,o,t),this.productDetailList.map(function(t,e){o.goodList[e]||(o.goodList[e]={}),Object.assign(o.goodList[e],{commodityId:t.commodityId,pictureUrl:t.pictureUrl,goodsNo:t.goodsNo,goodsName:t.goodsName,goodsMainType:t.goodsMainType,goodsSpecifications:t.goodsSpecifications,countingUnit:t.countingUnit,applyCount:t.applyCount,weightUnit:t.weightUnit,applyWeight:t.applyWeight,pricingMethod:t.pricingMethod,price:t.price,amount:t.amount,remark:t.remark,goodsId:t.goodsId,goodsType:t.goodsType,goodsTypePath:t.goodsTypePath,custStyleCode:t.custStyleCode,stoneSection:t.stoneSection,stoneClarity:t.stoneClarity,stoneColor:t.stoneColor,viceStoneWeight:t.viceStoneWeight,mainStoneWeight:t.mainStoneWeight,goldColor:t.goldColor,goldWeight:t.goldWeight})}),o},rowClick:function(t){1===this.applyOrder.orderStatus&&(this.applyOrder.goodsGroupPath?"add"===t&&this.validateProduct()?(0==this.commodityList.length&&this.getCommodityList(),this.productDetailList.push({options:this.commodityList})):"del"===t&&(this.productDetailList[this.selectedIndex].goodsId&&(this.applyOrder.delGoodIds||(this.applyOrder.delGoodIds=[]),this.applyOrder.delGoodIds.push(this.productDetailList[this.selectedIndex].goodsId)),this.productDetailList.splice(this.selectedIndex,1)):this.$Modal.error({content:"商品类型未选择，请先选择商品类型！"}))},typeInit:function(t,e,o){for(var i=0;i<t.length;i++){if(t[i].value==o)return e.push(t[i].value),!0;if(t[i].children&&0<t[i].children.length&&this.typeInit(t[i].children,e,o))return e.push(t[i].value),!0}},repositionDropdown:function(){return repositionDropdownOnSroll("testTableWrap","goods")}},watch:{productDetailList:{handler:function(t,e){var o=this;console.log(t),console.log(e);var i=0,a=0,r=0;t.map(function(t){t.applyCount&&!isNaN(t.applyCount)&&(i=math.eval(Number(i)+Number(t.applyCount))),t.applyWeight&&!isNaN(t.applyWeight)&&(a=math.eval((Number(a)+Number(t.applyWeight)).toFixed(2))),t.price&&(1==t.pricingMethod&&t.applyWeight?t.amount=parseFloat(math.eval(Number(t.price)*Number(t.applyWeight)).toFixed(3)):2==t.pricingMethod&&t.applyCount?t.amount=parseFloat(math.eval(Number(t.price)*Number(t.applyCount)).toFixed(3)):t.amount=0,r=parseFloat(math.eval(Number(r)+Number(t.amount)).toFixed(2))),o.applyOrder.applyCount=i,o.applyOrder.applyWeight=a,o.applyOrder.estimatePurchaseMoney=r})},deep:!0}},computed:{tempSave:function(){return"1"!=this.applyOrder.orderStatus},typeValue:function(){var t=this.applyOrder.goodsGroupPath,e=[];return this.typeInit(this.productTypeList,e,t),e.reverse()}},created:function(){this.getProductType(),this.getPurchaseDetail(),this.initDept(),this.initUnit()},mounted:function(){if(this.param=window.parent.params.params,console.log(this.param),this.param){this.openTime=window.parent.params.openTime;var t=window.parent.params.params;"update"===t.type?(console.log("进入修改状态！"),this.getInitDataById()):"query"===t.type?(console.log("进入查看状态"),this.isEdit("N"),this.getInitDataById()):"add"===t.type&&(this.isEdit("Y"),console.log("进入新增状态"))}this.repositionDropdown()}});