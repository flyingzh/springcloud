"use strict";var customer=new Vue({el:"#customer-come",data:function(){return{isHideSearch:!0,isHideList:!0,modalTrigger:!1,modalType:"",stepList:[],comeInfo:"",openTime:"",body:{materialOrderNo:"",custNo:"",startTime:"",endTime:"",isDel:1},TSaleMaterialOrderEntity:{materialOrderNo:"",documentStatus:""},isHide:!0,confirmConfig:{showConfirm:!1,title:"提示",content:"请点击确认",onlySure:!0,success:!0},dataValue:[],isSearchHide:!0,reload:!1,selected:[],data_user_list:{url:contextPath+"/tsaleMaterialOrder/quarylist",colNames:["id","日期","单据编号","单据状态","客户","关联客户订单","业务员","备注"],colModel:[{name:"id",index:"id",hidden:!0},{name:"inTime",index:"inTime",width:100,align:"center",formatter:function(t,e,a,n){return t?(Date.prototype.Format=function(t){var e={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};for(var a in/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),e)new RegExp("("+a+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?e[a]:("00"+e[a]).substr((""+e[a]).length)));return t},new Date(t).Format("yyyy-MM-dd")):""}},{name:"materialOrderNo",index:"materialOrderNo",width:100,align:"center",formatter:function(t,e,a,n){return $(document).off("click",".updateDetail"+t).on("click",".updateDetail"+t,function(){customer.updateDetailClick({value:t,grid:e,rows:a,state:n})}),'<a class="updateDetail'+t+'">'+t+"</a>"}},{name:"documentStatus",index:"documentStatus",width:100,align:"center",formatter:function(t,e,a,n){return 1==t?"暂存":2==t?"待审核":3==t?"审核中":4==t?"已审核":"驳回"}},{name:"customerName",index:"customerName",width:100,align:"center"},{name:"saleOrderNo",index:"saleOrderNo",width:100,align:"center",formatter:function(t,e,a,n){return $(document).off("click",".detail"+t).on("click",".detail"+t,function(){customer.detail({value:t,grid:e,rows:a,state:n})}),'<a class="detail'+t+'">'+t+"</a>"}},{name:"saleMenName",index:"saleMenName",width:100,align:"center"},{name:"remark",index:"remark",width:100,align:"center"}],gridComplete:function(){console.log(11111111)}}}},methods:{updateDetailClick:function(t){var e=t.value;console.log(e),$.ajax({type:"POST",url:contextPath+"/tsaleMaterialOrder/quaryAllInformation",data:{materialOrderNo:e},success:function(t){console.log(t),window.parent.activeEvent({name:"客户来料单-详情",url:contextPath+"/sale/material-order/sale-material-add.html",params:{allInfo:t,type:"query"}})},error:function(){console.log("请求失败")}})},detail:function(t){var e=t.value;console.log(e),window.parent.activeEvent({name:"客户订单",url:contextPath+"/sale/customer-order/customer-order-add.html",params:{type:"view",saleOrderNo:e}})},changeDate:function(t){this.body.startTime=""==t[0]?"":t[0].replace(/\//g,"-")+" 00:00:00",this.body.endTime=""==t[1]?"":t[1].replace(/\//g,"-")+" 23:59:59"},add:function(){$.ajax({type:"POST",url:contextPath+"/tsaleMaterialOrder/addTSaleMaterialOrder",contentType:"application/json; charset=utf-8",dataType:"json",success:function(t){window.parent.activeEvent({name:"客户来料-新增",url:contextPath+"/sale/material-order/sale-material-add.html",params:{allInfo:t,type:"add"}})},error:function(){console.log("请求失败")}})},submit:function(){console.log(this.selected);var a=this;if(!ht.util.hasValue(this.selected,"array"))return this.$Modal.warning({title:"提示",content:"请先选择一条记录"}),!1;if(1<this.selected.length)return this.$Modal.warning({title:"提示",content:"最多只能选择一条记录"}),!1;var t=$("#myTable").jqGrid("getRowData",this.selected);if(console.log(t),"暂存"!==t.documentStatus)return this.$Modal.warning({title:"提示",content:"该单据之前已经提交过了,不能再提交!"}),!1;console.log(t.id);var e=t.materialOrderNo;e=e.split(">")[1].split("<")[0],console.log(e),$.ajax({type:"POST",url:contextPath+"/tsaleMaterialOrder/quaryAllInformation",data:{materialOrderNo:e},success:function(t){if(console.log(t),""==t.data.custNo||""==t.data.saleMenName)return a.$Modal.warning({content:"提交失败,请输入完整基本资料！"}),!1;if(null==t.data.goodList)return a.$Modal.warning({content:"提交失败,请新增来料明细！"}),!1;if(t.data.goodList){console.log(t.data.goodList);for(var e=0;e<t.data.goodList.length;e++){if("attr_ranges_gold"==t.data.goodList[e].goodsMainType){if(""==t.data.goodList[e].totalWeight||null==t.data.goodList[e].totalWeight)return a.$Modal.info({content:"第"+(e+1)+"行金料总重没填"}),!1;if(""==t.data.goodList[e].processNature||null==t.data.goodList[e].processNature)return a.$Modal.warning({content:"第"+(e+1)+"行来料性质没填"}),!1;""==t.data.goodList[e].num&&(t.data.goodList[e].num=0)}if("attr_ranges_gold"!=t.data.goodList[e].goodsMainType){if(""==t.data.goodList[e].num||null==t.data.goodList[e].num)return a.$Modal.warning({content:"提交失败,第"+(e+1)+"行数量没填！"}),!1;if(""==t.data.goodList[e].totalWeight||null==t.data.goodList[e].totalWeight)return a.$Modal.warning({content:"提交失败,第"+(e+1)+"行总重没填！"}),!1;if(t.data.goodList[e].totalWeight<=0||t.data.goodList[e].num<=0)return void a.$Modal.warning({content:"提交失败,第"+(e+1)+"行总重数量必须大于0！"})}}}t.data.documentStatus=2,t.data.inTime=new Date,a.updateData(t.data,"提交")},error:function(){console.log("12313")}})},cancel:function(){window.parent.closeCurrentTab({name:"客户来料-列表",exit:!0,openTime:customer.openTime})},search:function(){console.log(this.body),this.reload=!this.reload},clear:function(){this.body={materialOrderNo:"",custNo:"",startTime:"",endTime:"",isDel:1},this.dataValue=[],console.log(this.body)},refresh:function(){this.clear(),this.reload=!this.reload,this.selected=[]},detailClick:function(t){var e=t.rows.materialOrderNo;console.log(e)},modify:function(){if(!ht.util.hasValue(this.selected,"array"))return this.$Modal.warning({title:"提示",content:"请先选择一条记录"}),!1;if(1<this.selected.length)return this.$Modal.warning({title:"提示",content:"最多只能选择一条记录"}),!1;var t=$("#myTable").jqGrid("getRowData",this.selected);if("暂存"!==t.documentStatus)return this.$Modal.info({content:"<p>只有暂存状态下才能修改数据，请重新选择！</p>"}),!1;var e=t.materialOrderNo;e=e.split(">")[1].split("<")[0],$.isEmptyObject(e)||null==e||$.ajax({type:"POST",url:contextPath+"/tsaleMaterialOrder/quaryAllInformation",data:{materialOrderNo:e},success:function(t){console.log(t),window.parent.activeEvent({name:"客户来料-修改",url:contextPath+"/sale/material-order/sale-material-add.html",params:{allInfo:t,type:"updata"}})},error:function(){console.log("请求失败")}})},remove:function(){if(0!==this.selected.length){for(var t=this.selected,e=[],a=!0,n=0;n<t.length;n++)"暂存"!==$("#myTable").jqGrid("getRowData",this.selected[n]).documentStatus?(a=!1,this.$Modal.info({content:"单据不是暂存状态不能删除"})):e.push(t[n]);a&&$.ajax({type:"post",url:contextPath+"/tsaleMaterialOrder/delete",contentType:"application/json",data:JSON.stringify(e),dataType:"json",success:function(t){"100100"===t.code?customer.$Modal.info({title:"提示",content:"删除成功",okText:"确定",onOk:function(){customer.reload=!customer.reload}}):customer.$Modal.info({title:"提示",content:"删除!",okText:"确定"})},error:function(t){console.log("服务器出错")}})}else this.$Modal.info({title:"提示",okText:"确定",content:"请选中想要删除的行!"})},transDocStatus:function(t){return"暂存"===t?1:"待审核"===t?2:"审核中"===t?3:"已审核"===t?4:5},approval:function(t){var e=this;if(!ht.util.hasValue(this.selected,"array"))return this.$Modal.warning({title:"提示",content:"请先选择一条记录"}),!1;if(1<this.selected.length)return this.$Modal.warning({title:"提示",content:"最多只能选择一条记录"}),!1;var a=$("#myTable").jqGrid("getRowData",this.selected);if("已审核"===a.documentStatus)return this.$Modal.warning({title:"提示",content:"该单据已审核通过!"}),!1;if("暂存"===a.documentStatus)return e.$Modal.warning({title:"提示",content:"请先提交!"}),!1;var n=a.materialOrderNo.split(">");a.materialOrderNo=n[1].split("<")[0],e.TSaleMaterialOrderEntity.materialOrderNo=a.materialOrderNo,e.TSaleMaterialOrderEntity.documentStatus=e.transDocStatus(a.documentStatus),e.modalType="approve",e.modalTrigger=!e.modalTrigger},reject:function(t){var e=this;if(!ht.util.hasValue(this.selected,"array"))return this.$Modal.warning({title:"提示",content:"请先选择一条记录"}),!1;if(1<this.selected.length)return this.$Modal.warning({title:"提示",content:"最多只能选择一条记录"}),!1;var a=$("#myTable").jqGrid("getRowData",this.selected);if("已审核"===a.documentStatus)return this.$Modal.warning({title:"提示",content:"该单据已审核通过,不能驳回"}),!1;if("暂存"===a.documentStatus)return this.$Modal.warning({title:"提示",content:"请先提交!"}),!1;var n=a.materialOrderNo.split(">");a.materialOrderNo=n[1].split("<")[0],e.TSaleMaterialOrderEntity.materialOrderNo=a.materialOrderNo,e.TSaleMaterialOrderEntity.inTime=new Date,e.TSaleMaterialOrderEntity.documentStatus=e.transDocStatus(a.documentStatus),e.modalType="reject",e.modalTrigger=!e.modalTrigger},approvalOrRejectCallBack:function(t){console.log(t);var e=this;if("100515"==t.result.code){var a=$("#myTable").jqGrid("getRowData",e.TSaleMaterialOrderEntity.id);"approve"==e.modalType&&(a.documentStatus=4,e.updateData(a,"审核")),"reject"==e.modalType&&(a.documentStatus=1,e.updateData(a,"驳回"))}e.refresh()},updateData:function(t,e){var a=this;$.ajax({type:"POST",url:contextPath+"/tsaleMaterialOrder/update",contentType:"application/json",data:JSON.stringify(t),dataType:"json",success:function(t){"100100"===t.code?a.$Modal.success({title:"提示",content:e+"成功!"}):a.$Modal.success({title:"提示",content:e+"失败!"}),a.refresh()},error:function(t){a.$Modal.warning({title:"提示",content:"服务器出错"})}})}},mounted:function(){this.openTime=window.parent.params.openTime}});