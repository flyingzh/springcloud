"use strict";var vm=new Vue({el:"#app",data:{isShow:!1,openTime:"",isEdit:!1,reload:!1,modalTrigger:!1,modalType:"",documentNo:"",documentStatus:"",id:"",isSearchHide:!0,isTabulationHide:!0,docTypeCode:"W_MATERIAL_USED",stepList:[],dateArr:[],supplierList:[],documentStatusArr:[{value:1,name:"暂存"},{value:2,name:"待审核"},{value:3,name:"审核中"},{value:4,name:"已审核"},{value:5,name:"驳回"}],selectPickingUse:[{value:"W_MATERIAL_USED_01",label:"采购送料"},{value:"W_MATERIAL_USED_02",label:"采购料结"},{value:"W_MATERIAL_USED_03",label:"受托加工送料"},{value:"W_MATERIAL_USED_04",label:"受托加工退料"}],approveComment:!1,rejectComment:!1,steplist:[],stepData:[],selected:[],currentStep:"",nextStep:"",body:{purpose:"",date:"",documentNo:"",supplierId:""},data_config:{url:contextPath+"/rawapplication/list",datatype:"json",colNames:["id","日期","单据编号","单据状态","领料用途","供应商","客户","申请部门","申请人","备注"],colModel:[{name:"id",hidden:!0},{name:"documentTime",width:210,align:"left",formatter:function(t,e,n,a){return Date.prototype.Format=function(t){var e={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};for(var n in/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),e)new RegExp("("+n+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?e[n]:("00"+e[n]).substr((""+e[n]).length)));return t},new Date(t).Format("yyyy-MM-dd")}},{name:"documentNo",width:350,align:"left",formatter:function(t,e,n,a){return $(document).off("click",".detail"+t).on("click",".detail"+t,function(){vm.documentCodeClick(n.documentNo)}),'<a class="detail'+t+'">'+t+"</a>"},unformat:function(t,e,n){return t.replace(/(<\/?a.*?>)/g,"")}},{name:"documentStatus",width:210,align:"left",formatter:function(t,e,n,a){return vm.formatterDocumentStatus(t)},unformat:function(t,e,n){return vm.unformatDocumentStatus(t)}},{name:"purpose",width:210,align:"left",formatter:function(t,e,n,a){return vm.formatterPurpose(t)},unformat:function(t,e,n){return vm.unformatterPurpose(t)}},{name:"supplierName",align:"left",width:210},{name:"custName",align:"left",width:210},{name:"applicationDepartmentName",align:"left",width:210},{name:"applicantName",align:";left",width:210},{name:"remark",align:";left",width:210}],rowNum:5,rowList:[10,20,30],mtype:"post",viewrecords:!0}},methods:{approvalOrRejectCallBack:function(t){"100100"===t.result.code&&this.reloadAgain()},autoApproveOrReject:function(){var e=this;$.ajax({url:contextPath+"/rawapplication/submitapproval?submitType=1",method:"post",contentType:"application/json;charset=utf-8",data:JSON.stringify({receiptsId:e.documentNo,approvalResult:"reject"==e.modalType?1:0}),success:function(t){"100100"===t.code?e.reloadAgain():e.$Modal.warning({content:t.msg})}})},add:function(){window.parent.activeEvent({name:"新增原料领用申请单",url:contextPath+"/warehouse/raw-application/raw-application-info.html",params:{openTime:this.openTime}})},documentCodeClick:function(t){window.parent.activeEvent({name:"查看原料领用申请单",url:contextPath+"/warehouse/raw-application/raw-application-info.html",params:{data:t,type:"query"}})},update:function(){var t=this,e=t.selected;1<e.length?t.$Modal.warning({title:"提示信息",content:"只能选择一条数据！"}):e.length<1?t.$Modal.warning({title:"提示信息",content:"请选择选择一条数据！"}):window.parent.activeEvent({name:"修改原料领用申请单",url:contextPath+"/warehouse/raw-application/raw-application-info.html",params:{data:e[0],type:"update"}})},del:function(){var t=this,e=this.selected,n=[],a=t.getSelectedData(e);if(console.log("选中的数据：",a),1<a.length)a.forEach(function(t){1!=t.documentStatus&&n.push(t.documentNo)});else if(1===a.length&&1!=a[0].documentStatus)return t.$Modal.warning({title:"提示信息",content:"单据"+a[0].documentNo+"已启用审批流不能删除！"}),!1;1<n.length?t.$Modal.warning({title:"提示信息",content:n.map(function(t){return"单据"+t})+"已启用审批流不能删除！"}):0<e.length?(console.log(e),$.ajax({type:"POST",url:contextPath+"/rawapplication/delete",data:JSON.stringify(e),contentType:"application/json",success:function(){t.$Modal.warning({title:"提示信息",content:"删除成功！！"}),t.reloadAgain(),t.selected=[]}})):t.$Modal.warning({title:"提示信息",content:"请至少选择一条数据！"})},updateStatus:function(t,e){var n=this;$.ajax({type:"post",url:contextPath+"/rawapplication/update",data:JSON.stringify({id:t,documentStatus:e}),contentType:"application/json",dataType:"json",success:function(t){n.reloadAgain()}})},approval:function(){var t=this,e=this.selected,n=$("#myTable").jqGrid("getRowData",this.selected[0]);1<e.length?this.$Modal.warning({title:"提示信息",content:"只能选择一条数据！"}):e.length<1?this.$Modal.warning({title:"提示信息",content:"请至少选择一条数据！"}):(t.id=n.id,t.documentStatus=n.documentStatus,t.documentNo=n.documentNo,t.modalType="approve",t.modalTrigger=!t.modalTrigger)},reject:function(){var t=this.selected,e=$("#myTable").jqGrid("getRowData",this.selected[0]);if(1<t.length)this.$Modal.warning({title:"提示信息",content:"请至少选择一条数据！"});else if(t.length<1)this.$Modal.warning({title:"提示信息",content:"请至少选择一条数据！"});else if(2===e.documentStatus||3===e.documentStatus||5===e.documentStatus){var n=this;n.id=e.id,n.documentStatus=e.documentStatus,n.documentNo=e.documentNo,n.modalType="reject",n.modalTrigger=!n.modalTrigger}else this.$Modal.warning({title:"提示信息",content:"该单状态不能驳回！"})},getSppliers:function(){var e=this;$.ajax({type:"post",url:contextPath+"/rawapplication/getSuppliers",dataType:"json",success:function(t){e.supplierList=t.data}})},clear:function(){var t=this;this.body.documentNo="",this.body.startTime="",this.body.endTime="",this.body.supplierName="",this.body.purpose&&(this.$refs.purpose.reset(),this.$nextTick(function(){t.body.purpose=""})),this.body.supplierId&&(this.$refs.supplier.reset(),this.$nextTick(function(){t.body.supplierId=""})),this.dateArr=[]},formatterDocumentStatus:function(t){return t?this.documentStatusArr.length<1?t:this.documentStatusArr[this.documentStatusArr.map(function(t){return t.value}).indexOf(t)]?this.documentStatusArr[this.documentStatusArr.map(function(t){return t.value}).indexOf(t)].name:t:""},formatterPurpose:function(t){return t?this.selectPickingUse.length<1?t:this.selectPickingUse[this.selectPickingUse.map(function(t){return t.value}).indexOf(t)]?this.selectPickingUse[this.selectPickingUse.map(function(t){return t.value}).indexOf(t)].label:t:""},unformatDocumentStatus:function(t){return t?this.documentStatusArr.length<1?t:this.documentStatusArr[this.documentStatusArr.map(function(t){return t.name}).indexOf(t)]?this.documentStatusArr[this.documentStatusArr.map(function(t){return t.name}).indexOf(t)].value:t:""},unformatterPurpose:function(t){return t?this.selectPickingUse.length<1?t:this.selectPickingUse[this.selectPickingUse.map(function(t){return t.label}).indexOf(t)]?this.selectPickingUse[this.selectPickingUse.map(function(t){return t.label}).indexOf(t)].value:t:""},search:function(){0<this.dateArr.length&&this.dateArr[0]&&this.dateArr[1]?(this.body.startTime=this.dateArr[0].format("yyyy-MM-dd HH:mm:ss"),this.body.endTime=this.dateArr[1].format("yyyy-MM-dd HH:mm:ss")):(this.body.startTime="",this.body.endTime=""),console.log(this.body),this.reload=!this.reload},submit:function(){var e=this,t=this.selected,n=$("#myTable").jqGrid("getRowData",this.selected[0]);return 1<t.length?(this.$Modal.warning({title:"提示信息",content:"只能选择一条数据！"}),$("#myTable").jqGrid("resetSelection"),void(t=[])):t.length<1?(this.$Modal.warning({title:"提示信息",content:"至少选择一条数据！"}),$("#myTable").jqGrid("resetSelection"),void(t=[])):void(1==n.documentStatus?(window.top.home.loading("show"),$.ajax({type:"post",url:contextPath+"/rawapplication/submit",data:JSON.stringify({id:n.id,documentNo:n.documentNo}),contentType:"application/json;charset=utf-8",dataType:"json",success:function(t){"100100"===t.code?e.$Modal.success({title:"提示信息",content:"提交成功！"}):e.$Modal.warning({content:t.msg}),e.reloadAgain(),window.top.home.loading("hide")},error:function(){window.top.home.loading("hide")}})):this.$Modal.warning({title:"提示信息",content:"该单的单据状态不能提交！"}))},getSelectedData:function(t){var e=[],n=!0,a=!1,i=void 0;try{for(var o,r=this.selected[Symbol.iterator]();!(n=(o=r.next()).done);n=!0){var s=o.value;e.push($("#myTable").jqGrid("getRowData",s))}}catch(t){a=!0,i=t}finally{try{!n&&r.return&&r.return()}finally{if(a)throw i}}return e},reloadAgain:function(){this.clear(),this.reload=!this.reload},getSelectRowData:function(){var t=[],e=!0,n=!1,a=void 0;try{for(var i,o=this.selected[Symbol.iterator]();!(e=(i=o.next()).done);e=!0){var r=i.value,s=$("#myTable").jqGrid("getRowData",r);t.push(s)}}catch(t){n=!0,a=t}finally{try{!e&&o.return&&o.return()}finally{if(n)throw a}}return t},exit:function(){window.parent.closeCurrentTab({name:"原料领用申请单列表",openTime:this.openTime,exit:!0})}},mounted:function(){this.openTime=window.parent.params.openTime,this.getSppliers()}});