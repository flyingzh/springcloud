"use strict";var vm=new Vue({el:"#entrustMaterialInInfo",data:{openTime:"",params:{},isShow:!1,reload:!1,isSearchHide:!0,isDisable:!1,isEditTable:!1,isTabulationHide:!0,isEditInput:!1,isEditDate:!1,isEditRemark:!1,isEditSalesman:!1,isMenu:!0,isUpdate:!1,isStampShow:!1,isEditNumber:!1,businessType:"",productId:"",isClearable:!0,isOpened:!1,boeType:"W_EMATERIAL_IN",categoryType:[],defWareHouse:"",entrustMaterialInInfo:{createId:"",updateId:"",createName:"",updateName:"",remark:"",createTime:"",updateTime:"",organizationId:"",organizationName:"",id:"",idList:"",documentNo:"",documentTime:new Date,salesmanId:"",salesmanName:"",customCode:"",goodsTypeName:"",groupPath:"",custId:"",custCode:"",custName:"",name:"",phone:"",email:"",postalcode:"",weChartNo:"",region:"",address:"",documentStatus:1,examineVerifyId:"",examineVerifyName:"",examineVerifyTime:"",isDel:1,goodList:[]},goodsInfo:{goodsNo:"",goodsName:"",number:""},productDetailList:[],productDetailModal:{showModal:!1,ids:{goodsId:"",commodityId:"",documentType:"W_EMATERIAL_IN"}},barCodeDetailList:[],barCodeDetailModal:{showModal:!1,ids:{goodsId:"",commodityId:"",documentType:"W_STOCK_IN"}},barCodeSelectedIndex:null,isCustId:"",salesmanList:[],custList:[],warehouseList:[],reservoirPositionList:[],countingUnitList:[],weightUnitList:[],unitList:[],goodsDetails:[],certifiTypes:[],goodsIndex:"",selectedIndex:null,tabVal:"name1",ctrlMark:!0,showProductProperty:!1,modalTrigger:!1,modalType:"",stepList:[],approvalTableData:[]},methods:{getSelect:function(t,e){return repositionDropdownOnSroll(t,e)},modalSure:function(t){this.productDetailModalClick(t),this.productDetailModal.showModal=!1},modalCancel:function(t){this.productDetailModal.showModal=!1},barCodeModalSure:function(t){this.barCodeDetailModalClick(t),this.barCodeDetailModal.showModal=!1},barCodeModalCancel:function(t){this.barCodeDetailModal.showModal=!1},barCodeModalNo:function(t){this.barCodeDetailModal.showModal=!1},barCodeDetailModalClick:function(t){"attr_ranges_goods"===this.productDetailList[this.selectedIndex].barCodeDetailList[this.barCodeSelectedIndex].goodsMainType?Object.assign(this.productDetailList[this.selectedIndex].barCodeDetailList[this.barCodeSelectedIndex],{tBaseBomEntity:t,assistAttrs:null,overEdit:!0}):Object.assign(this.productDetailList[this.selectedIndex].barCodeDetailList[this.barCodeSelectedIndex],{assistAttrs:t,tBaseBomEntity:null,overEdit:!0})},showBarCodeDetail:function(t){console.log("当前下标：",t);var e=this;if(this.barCodeSelectedIndex=t,console.log(e.barCodeDetailList),!e.productDetailList[e.selectedIndex].barCodeDetailList[t].commodityId)return e.$Modal.warning({title:"提示信息",content:"请先选择商品"}),!1;var o={goodsId:e.productDetailList[e.selectedIndex].barCodeDetailList[t].id,commodityId:e.productDetailList[e.selectedIndex].barCodeDetailList[t].commodityId,documentType:"W_STOCK_IN"};Object.assign(e.barCodeDetailModal,{showModal:!0,ids:o}),this.$nextTick(function(){e.$refs.barCodeModalRef.getProductDetail()})},barCodeHandlerDataToPost:function(){var i=this,a={id:"",goodsBarcode:"",goodsNo:"",goodsName:"",number:1,commodityId:"",countingUnitId:"",countingUnitName:"",weightUnitId:"",weightUnitName:"",goodsMainType:"",totalWeight:"",certificateType:"",certificateNo:"",warehouseId:"",goodsNorm:"",batchNum:"",isDel:"",stonesParts:[],materialParts:[],partParts:[],goldParts:[]},n=i.entrustMaterialInInfo.goodList;if(console.log("处理前的数据结构:",n),console.log(i.barCodeDetailList),i.productDetailList){for(var t=function(o){if(i.productDetailList[o].barCodeDetailList)for(var t=0;t<i.productDetailList[o].barCodeDetailList.length;t++){n[o].goodList=[JSON.parse(JSON.stringify(a))];var e=htHandlerProductDetail(i.productDetailList[o].barCodeDetailList,n[o],a);console.log("经过处理后的数据结构为：",e),i.productDetailList[o].barCodeDetailList.map(function(t,e){n[o].goodList[e]||(n[o].goodList[e]={}),Object.assign(n[o].goodList[e],{id:t.id,goodsBarcode:t.goodsBarcode,goodsNo:t.goodsNo,goodsName:t.goodsName,number:1,commodityId:t.commodityId,countingUnitId:t.countingUnitId,countingUnitName:t.countingUnitName,weightUnitId:t.weightUnitId,weightUnitName:t.weightUnitName,goodsMainType:t.goodsMainType,totalWeight:t.totalWeight,certificateType:t.certificateType,certificateNo:t.certificateNo,warehouseId:t.warehouseId,goodsNorm:t.goodsNorm,batchNum:t.batchNum,isDel:t.isDel})})}},e=0;e<i.productDetailList.length;e++)t(e);return n}},productDetailModalClick:function(t){"attr_ranges_goods"===this.productDetailList[this.selectedIndex].goodsMainType?Object.assign(this.productDetailList[this.selectedIndex],{tBaseBomEntity:t,assistAttrs:null,overEdit:!0}):Object.assign(this.productDetailList[this.selectedIndex],{assistAttrs:t,tBaseBomEntity:null,overEdit:!0})},showProductDetail:function(t){console.log("当前下标：",t);var e=this;if(this.selectedIndex=t,console.log(e.productDetailList),e.productDetailList[t].goodsMainType&&"attr_ranges_gold"!==e.productDetailList[t].goodsMainType)return e.$Modal.warning({title:"提示信息",content:"请点击明细进入商品明细页签填写信息!"}),!1;if(!e.productDetailList[t].commodityId)return e.$Modal.warning({title:"提示信息",content:"请先选择商品"}),!1;var o={goodsId:this.productDetailList[t].id,commodityId:this.productDetailList[t].commodityId,documentType:"W_EMATERIAL_IN"};Object.assign(this.productDetailModal,{showModal:!0,ids:o}),this.$nextTick(function(){e.$refs.modalRef.getProductDetail()})},handlerDataToPost:function(){var t=this,e={id:"",goodsNo:"",collectGoodId:"",countingUnit:"",countingUnitName:"",pictureUrl:"",weight:"",commodityId:"",goodsNorm:"",number:"",batchNum:"",reservoirPositionId:"",warehouseId:"",goodsName:"",weightUnit:"",weightUnitName:"",goodList:[],isDel:"",sourceNo:"",sourceType:"",organizationId:"",stonesParts:[],materialParts:[],partParts:[],goldParts:[]},o=t.entrustMaterialInInfo;if(console.log("处理前的数据结构:",o),console.log(t.productDetailList),ht.util.hasValue(t.productDetailList,"array")){o.goodList=[JSON.parse(JSON.stringify(e))];var i=htHandlerProductDetail(t.productDetailList,o,e);return console.log("经过处理后的数据结构为：",i),this.productDetailList.map(function(t,e){o.goodList[e]||(o.goodList[e]={}),Object.assign(o.goodList[e],{goodsNo:t.goodsNo,collectGoodId:t.collectGoodId,countingUnit:t.countingUnit,countingUnitName:t.countingUnitName,pictureUrl:t.pictureUrl,weight:t.weight,commodityId:t.commodityId,goodsNorm:t.goodsNorm,number:t.number,batchNum:t.batchNum,reservoirPositionId:t.reservoirPositionId,warehouseId:t.warehouseId,goodsName:t.goodsName,weightUnit:t.weightUnit,weightUnitName:t.weightUnitName,goodsMainType:t.goodsMainType,goodList:t.goodList,id:t.id,isDel:t.isDel,organizationId:t.organazationId,sourceNo:t.sourceNo,sourceType:t.sourceType,lineNo:e+1})}),o}},rowClick:function(t){var e=this;if("add"===t){if(!this.entrustMaterialInInfo.custId)return this.$Modal.warning({title:"提示",content:"请选择客户"}),!1;if(!this.entrustMaterialInInfo.customCode)return this.$Modal.warning({title:"提示",content:"请选择商品类型"}),!1;var o=Object.assign({},{id:"",goodsNo:"",countingUnit:"",countingUnitName:"",pictureUrl:"",weight:"",commodityId:"",goodsNorm:"",number:"",batchNum:"",reservoirPositionId:"",warehouseId:this.defWareHouse,goodsName:"",weightUnit:"",weightUnitName:"",goodsMainType:"",goodList:[],organizationId:"",barCodeDetailList:[],isDel:1});this.productDetailList.push(o),this.$nextTick(function(){e.getSelect("table-responsive","goods")})}else if("copy"===t){if(null===this.selectedIndex)this.$Message.warning({title:"提示信息",content:"请选择一条数据！"});else{var i=Object.assign({},this.productDetailList[this.selectedIndex]);for(var a in i.barCodeDetailList=[],console.log(i),i)i.id="";i.barCodeDetailList.forEach(function(t){t.goodsBarcode="",t.id=""}),console.log(i),console.log(this.productDetailList),this.$nextTick(function(){e.productDetailList.push(i)}),this.selectedIndex=null}this.$nextTick(function(){e.getSelect("table-responsive","goods")})}this.getInputValue("",this.productDetailList.length-1)},validateProduct:function(){var o=!0,i=this;return i.productDetailList=i.productDetailList.filter(function(t){return 1===t.isDel}),$.each(i.productDetailList,function(t,e){return!!e.id||("attr_ranges_goods"==e.goodsMainType||"attr_ranges_stone"===e.goodsMainType||(e.assistAttrs?void 0:(o=!1,i.$Modal.error({content:"第"+(t+1)+"行商品明细未选择，请先选择商品明细！"}),!1)))}),o},validateBarcodeProduct:function(){var i=!0,a=this;return a.productDetailList=a.productDetailList.filter(function(t){return 1===t.isDel}),$.each(a.productDetailList,function(o,t){t.barCodeDetailList&&i&&$.each(t.barCodeDetailList,function(t,e){if(1===e.isDel&&i){if(e.id)return!0;if("attr_ranges_goods"==e.goodsMainType){if(!e.tBaseBomEntity)return i=!1,a.$Modal.error({content:"第"+(o+1)+"行商品简述的第"+(t+1)+"行商品明细未选择，请先选择商品明细！"}),!1}else if(!e.assistAttrs)return i=!1,a.$Modal.error({content:"第"+(o+1)+"行商品简述的第"+(t+1)+"行商品明细未选择，请先选择商品明细！"}),!1}})}),i},checkBarcodeInfo:function(){var i=this,a=!0;return i.productDetailList.filter(function(t){return 1===t.isDel}).forEach(function(t,o){t.barCodeDetailList&&t.barCodeDetailList.filter(function(t){return 1===t.isDel}).forEach(function(t,e){if(!t.totalWeight&&a)return a=!1,i.$Modal.error({content:"第"+(o+1)+"行商品简述的第"+(e+1)+"行未填写完善，请填写信息！"}),!1})}),a},isEdit:function(t,e){eventHub.$emit("isEdit",t)},saveAccess:function(t,e,o){eventHub.$emit("saveFile",t,e)},getAccess:function(t,e,o){eventHub.$emit("queryFile",t,e)},approval:function(t){this.modalType="approve",this.modalTrigger=!this.modalTrigger},reject:function(t){this.modalType="reject",this.modalTrigger=!this.modalTrigger},approvalOrRejectCallBack:function(t){"100100"==t.result.code&&(this.entrustMaterialInInfo.documentStatus=parseInt(t.result.data),this.getEntrustMaterialIn())},autoSubmitOrReject:function(){var e=this;$.ajax({url:contextPath+"/entrustMaterialInController/submitApproval?submitType=1",method:"post",contentType:"application/json;charset=utf-8",data:JSON.stringify({receiptsId:e.entrustMaterialInInfo.documentNo,approvalResult:"reject"===e.modalType?1:0}),success:function(t){"100100"===t.code?e.entrustMaterialInInfo.documentStatus=parseInt(t.data):e.$Modal.warning({content:t.msg}),e.getEntrustMaterialIn()}})},updateStatus:function(t,e){var o=this;$.ajax({type:"post",url:contextPath+"/entrustMaterialInController/update",contentType:"application/json;charset=utf-8",data:JSON.stringify({id:t,documentStatus:e,documentNo:o.entrustMaterialInInfo.documentNo}),dataType:"json",success:function(t){"100100"===t.code&&(o.entrustMaterialInInfo.documentStatus=e,o.getEntrustMaterialIn(),console.log("修改成功"))},error:function(){o.$Message.error("服务器出错啦")}})},barCodeAction1:function(t){this.barCodeSelectedIndex=t},action1:function(t){this.selectedIndex=t},action2:function(){if(null===this.selectedIndex)this.$Message.warning("请选择一条数据！");else{if(this.productDetailList[this.selectedIndex].id){this.productDetailList[this.selectedIndex].isDel=0;var t=this.productDetailList[this.selectedIndex].barCodeDetailList;t&&(t.forEach(function(t){return t.isDel=0}),t=t.filter(function(t){return t.id}))}else this.productDetailList.splice(this.selectedIndex,1);this.$forceUpdate(),this.selectedIndex=null}},detailAction:function(a,t){var n=this,r=this;if(!a.goodsNo)return r.$Modal.warning({title:"提示",content:"请输入商品编码"}),!1;if("attr_ranges_gold"===r.productDetailList[t].goodsMainType)return r.$Modal.warning({title:"提示",content:"商品为金料，请选择商品简述中的商品明细填写"}),!1;if(!a.number||a.number&&Number(a.number)<=0)return r.$Modal.warning({title:"提示",content:"请输入数量"}),!1;r.goodsInfo.goodsNo=a.goodsNo,r.goodsInfo.goodsName=a.goodsName,r.goodsInfo.number=a.number,r.goodsIndex=t;var e=r.unitList[a.countingUnit],o=r.unitList[a.weightUnit];a.sourceNo&&(e=a.countingUnitName,o=a.weightUnitName);var s=$.extend(!0,{},{id:"",goodsBarcode:"",goodsNo:a.goodsNo,goodsName:a.goodsName,number:1,commodityId:a.commodityId,countingUnitId:Number(a.countingUnit),countingUnitName:e,weightUnitId:Number(a.weightUnit),weightUnitName:o,goodsMainType:a.goodsMainType,totalWeight:"",certificateType:"",certificateNo:"",warehouseId:a.warehouseId,goodsNorm:a.goodsNorm,batchNum:a.batchNum,goodList:[],isDel:1,certifiTypes:this.certifiTypes.map(function(t){return $.extend(!0,{},{name:t.name,value:t.value})})}),d=r.productDetailList[t];d.barCodeDetailList||r.$set(d,"barCodeDetailList",[]),d.barCodeDetailList.forEach(function(t,e){if(t.goodsNo!==a.goodsNo){var o=d.barCodeDetailList[e].id;console.log(o),o?t.isDel=0:($.extend(!0,t,s),r.$nextTick(function(){n.$refs["certificateType"+e][0].reset()}))}});var c=0;if(d.barCodeDetailList.forEach(function(t,e){0===t.isDel&&c++}),d.barCodeDetailList&&0==d.barCodeDetailList.length)for(var i=function(t){d.barCodeDetailList.push($.extend(!0,{},s)),r.$nextTick(function(){n.$refs["certificateType"+t][0].reset()})},u=0;u<parseInt(a.number);u++)i(u);Number(a.number)>d.barCodeDetailList.length-c&&function(){for(var t=Number(a.number)-(d.barCodeDetailList.length-c),e=d.barCodeDetailList.length-c,o=function(t){d.barCodeDetailList.push($.extend(!0,{},s)),r.$nextTick(function(){n.$refs["certificateType"+(t+e)][0].reset()})},i=0;i<t;i++)o(i)}(),Number(a.number)<d.barCodeDetailList.length-c&&(d.barCodeDetailList.filter(function(t,e){return e>=Number(a.number)}).forEach(function(t){return t.isDel=0}),d.barCodeDetailList=d.barCodeDetailList.filter(function(t){return t.goodsBarcode})),console.log(d.barCodeDetailList),r.tabVal="name2",r.$forceUpdate()},tabsSwitch:function(t){var e=this,o=this;if("name1"===(o.tabVal=t)&&"attr_ranges_gold"!==o.productDetailList[o.selectedIndex].goodsMainType){var i=0;o.productDetailList[o.selectedIndex].barCodeDetailList.forEach(function(t){i+=Number(t.totalWeight)}),o.productDetailList[o.selectedIndex].weight=i}this.$nextTick(function(){e.getSelect("table-responsive","goods")})},countWeight:function(){ht.util.hasValue(this.productDetailList,"array")&&this.productDetailList.filter(function(t){return"attr_ranges_gold"!==t.goodsMainType}).forEach(function(t){if(ht.util.hasValue(t.barCodeDetailList,"array")){var e=0;t.barCodeDetailList.forEach(function(t){e+=Number(t.totalWeight)}),t.weight=e}})},loadProductType:function(){var e=this;$.ajax({type:"post",url:contextPath+"/entrustMaterialInController/queryStyleCategory",dataType:"json",success:function(t){e.categoryType=e.initGoodCategory(t.data.cateLists)},error:function(){e.$Message.error("服务器出错啦")}})},changeproductTypeName:function(t,e){var o=this;t&&(o.entrustMaterialInInfo.customCode="0."+t.join(".")+".",o.entrustMaterialInInfo.groupPath="0."+t.join(".")+"."),ht.util.hasValue(e,"array")&&(o.entrustMaterialInInfo.goodsTypeName=e[e.length-1].label),ht.util.hasValue(o.productId,"array")&&o.$Modal.confirm({content:"修改商品类型会清空商品简述和商品明细列表的所有数据，是否确定修改？",onOk:function(){ht.util.hasValue(o.productDetailList,"array")&&(o.productDetailList.forEach(function(t,e){t.isDel=0,t.barCodeDetailList&&t.barCodeDetailList.forEach(function(t){t.isDel=0})}),o.productDetailList=o.productDetailList.filter(function(t){return t.id}).map(function(t){return t.barCodeDetailList.filter(function(t){return t.id})}))}})},initGoodCategory:function(t){var a=this,n=[];return t.forEach(function(t){var e=t.id,o=t.name,i=t.cateLists;i&&(i=a.initGoodCategory(i)),n.push({value:e,label:o,children:i})}),n.forEach(function(t){t.children||delete t.children}),n},getSelectedItem:function(t,o){var i=this;$.ajax({type:"post",url:contextPath+"/tbasecommodity/info/"+t.id,dataType:"json",success:function(t){var e=t.data;console.log(i.unitList[e.countUnitId]),e.countingUnit=i.unitList[e.countUnitId],e.weightUnit=i.unitList[e.weightUnitId],$.extend(!0,i.productDetailList[o],{goodsNo:e.code,goodsName:e.name,commodityId:e.id,goodsNorm:e.specification,countingUnit:e.countUnitId,weightUnit:e.weightUnitId,goodsMainType:e.mainType,barCodeDetailList:[]}),i.productDetailList[o].countingUnitName=e.countingUnit,i.productDetailList[o].weightUnitName=e.weightUnit,e.frontPic?i.productDetailList[o].pictureUrl=e.frontPic.fdUrl:i.productDetailList[o].pictureUrl=null,"attr_ranges_gold"===e.mainType?(i.productDetailList[o].number="",i.isEditNumber=!0):i.isEditNumber=!1,i.$forceUpdate()},error:function(){i.$Message.error("服务器出错啦")}})},getInputValue:function(t,e){var o=this,i={categoryCustomCode:o.entrustMaterialInInfo.customCode,field:t,limit:""};$.ajax({type:"post",url:contextPath+"/tbasecommodity/findByType",data:i,dataType:"json",success:function(t){Object.assign(o.productDetailList[e],{options:t.data}),o.$forceUpdate()},error:function(){layer.alert("服务器出错啦")}})},getCust:function(){var e=this;$.ajax({type:"post",url:contextPath+"/entrustMaterialInController/queryAllCustomer",contentType:"application/json",dataType:"json",success:function(t){console.log("客户",t),e.custList=t.data},error:function(){e.$Message.error("服务器出错啦")}})},getSalesman:function(){var e=this;$.ajax({type:"post",url:contextPath+"/entrustMaterialInController/queryAllEmpByOrganId",contentType:"application/json",dataType:"json",success:function(t){console.log("业务员",t),e.salesmanList=t.data},error:function(){e.$Message.error("服务器出错啦")}})},getUnitGroup:function(){var i=this;$.ajax({type:"post",url:contextPath+"/tbaseunit/list",dataType:"json",success:function(t){"100100"===t.code&&t.data.map(function(t){var e=t.id,o=t.name;i.unitList[e]=o})},error:function(){i.$Message.error("服务器出错啦")}})},getWareHouseGroup:function(){var e=this;$.ajax({type:"post",url:contextPath+"/wareHouse/listByTypeAndOrganizationId",data:{type:4},dataType:"json",success:function(t){"100100"===t.code&&(console.log("仓库组",t.data),e.warehouseList=t.data,e.getRepertoryPositionGroup(1))},error:function(){layer.alert("服务器出错啦")}})},getRepertoryPositionGroup:function(t){var e=this;$.ajax({type:"post",url:contextPath+"/tbaserepertoryposition/listbygroup/"+t,dataType:"json",success:function(t){"100100"===t.code&&(console.log("库位组",t.data),e.reservoirPositionList=t.data)},error:function(){layer.alert("服务器出错啦")}})},getAttrToName:function(){var e=this;this.salesmanList&&this.salesmanList.forEach(function(t){t.id==e.entrustMaterialInInfo.salesmanId&&(e.entrustMaterialInInfo.salesmanName=t.empName)}),this.custList&&this.custList.forEach(function(t){t.id==e.entrustMaterialInInfo.custId&&(e.entrustMaterialInInfo.custName=t.name,e.entrustMaterialInInfo.custCode=t.code)})},getCustName:function(t){console.log(t);var o=this;$.ajax({type:"post",url:contextPath+"/entrustMaterialInController/info/"+t,contentType:"application/json",dataType:"json",success:function(t){console.log("客户信息",t);var e=t.data;o.defWareHouse=e.wareHouse,o.productDetailList&&o.productDetailList.forEach(function(t){t.warehouseId=e.wareHouse}),o.isCustId||(e.contacts.forEach(function(t){1===t.isDefault&&1===t.type&&(o.entrustMaterialInInfo.email=t.email,o.entrustMaterialInInfo.name=t.name,o.entrustMaterialInInfo.phone=t.phone,o.entrustMaterialInInfo.weChartNo=t.wechat)}),o.entrustMaterialInInfo.postalcode=e.zipCode,o.entrustMaterialInInfo.address=e.concreteAddress,o.entrustMaterialInInfo.region=o.getAreaName(e.area))},error:function(){o.$Message.error("服务器出错啦")}})},getAreaName:function(t){switch(t){case"1":return"东北";case"2":return"华北";case"3":return"华中";case"4":return"华东";case"5":return"华南";case"6":return"西北";case"7":return"西南";default:return""}},add:function(){window.parent.activeEvent({name:"新增受托加工材料入库单",url:contextPath+"/warehouse/entrust-material-in/entrust-material-in-info.html",params:{type:0}})},save:function(){var e=this;if(!e.validateProduct())return!1;if(!e.validateBarcodeProduct())return!1;e.getAttrToName(),e.countWeight();var t=e.handlerDataToPost();console.log("要传入后台的数据结构：",t);var o=e.barCodeHandlerDataToPost();if(console.log("要传入后台的条码数据结构：",o),2===e.entrustMaterialInInfo.documentStatus||4===e.entrustMaterialInInfo.documentStatus||3===e.entrustMaterialInInfo.documentStatus)return e.$Modal.warning({content:"受托加工材料入库单已提交!",title:"提示"}),!1;var i="";i=e.entrustMaterialInInfo.documentNo?contextPath+"/entrustMaterialInController/updateToExistCode":(e.entrustMaterialInInfo.documentStatus=1,contextPath+"/entrustMaterialInController/saveToExistCode"),window.top.home.loading("show"),$.ajax({type:"POST",url:i,contentType:"application/json;charset=utf-8",data:JSON.stringify(e.entrustMaterialInInfo),dataType:"json",success:function(t){if("100100"===t.code&&t.data)return e.entrustMaterialInInfo.documentNo=t.data.documentNo,e.saveAccess(t.data.documentNo,e.boeType),e.getEntrustMaterialIn(),e.$Modal.info({content:"保存成功!",title:"提示"}),window.top.home.loading("hide"),!1;e.$Modal.warning({content:"保存失败!",title:"提示"}),window.top.home.loading("hide")},error:function(t){window.top.home.loading("hide"),e.$Message.error("服务器出错")}})},clearNoNumber:function(t,e,o){return console.log(t,e,o),htInputNumber(t,e,o)},checkHasBarcodeInfo:function(){var o=this,i=!0;return o.productDetailList.forEach(function(t,e){if(t.barCodeDetailList&&0===t.barCodeDetailList.length&&"attr_ranges_gold"!==t.goodsMainType)return i=!1,o.$Modal.error({title:"提示",content:"请填写第"+(e+1)+"行商品简述的商品条码明细页签信息!"}),!1}),i},submit:function(){var e=this;if(!$("form").valid())return!1;if(!e.productDetailList)return e.$Modal.error({title:"提示",content:"请填写商品简述信息!"}),!1;if(e.tableValidate())return!1;if(!e.validateProduct())return!1;if(console.log(!e.checkHasBarcodeInfo()),!e.checkHasBarcodeInfo())return!1;if(!e.checkBarcodeInfo())return!1;if(!e.validateBarcodeProduct())return!1;e.getAttrToName(),e.countWeight();var t=e.handlerDataToPost();console.log("要传入后台的数据结构：",t);var o=e.barCodeHandlerDataToPost();if(console.log("要传入后台的条码数据结构：",o),2===e.entrustMaterialInInfo.documentStatus||4===e.entrustMaterialInInfo.documentStatus||3===e.entrustMaterialInInfo.documentStatus)return e.$Modal.warning({content:"受托加工材料入库单已提交!",title:"提示"}),!1;window.top.home.loading("show");var i=[];if(e.entrustMaterialInInfo.goodList&&e.entrustMaterialInInfo.goodList.filter(function(t){return t.collectGoodId}).forEach(function(t){i.push(t.collectGoodId)}),ht.util.hasValue(i,"array")){$.ajax({type:"post",url:contextPath+"/entrustMaterialInController/queryStorageStatus",data:JSON.stringify(i),contentType:"application/json",dataType:"json",error:function(){e.$Message.error("服务器出错啦")}}).then(function(t){"100100"===t.code&&(0===t.data?e.submitHandler():e.$Modal.info({content:"商品已提交，请勿重复提交!",title:"提示"}),window.top.home.loading("hide"))});return!1}e.submitHandler()},submitHandler:function(){var e=this;e.entrustMaterialInInfo.documentStatus=2;var t="";t=e.entrustMaterialInInfo.documentNo?contextPath+"/entrustMaterialInController/updateToExistCode":contextPath+"/entrustMaterialInController/saveToExistCode",$.ajax({type:"POST",url:t,contentType:"application/json",data:JSON.stringify(e.entrustMaterialInInfo),dataType:"json",success:function(t){if("100100"===t.code)return e.entrustMaterialInInfo.documentNo=t.data.documentNo,e.saveAccess(t.data.documentNo,e.boeType),e.getEntrustMaterialIn(),e.$Modal.info({content:"提交成功!",title:"提示"}),window.top.home.loading("hide"),!1;e.$Modal.warning({content:"提交失败!",title:"提示"}),window.top.home.loading("hide")},error:function(t){window.top.home.loading("hide"),e.$Message.error("服务器出错")}})},getOrgan:function(){var e=this;window.top.home.loading("show"),$.ajax({type:"post",url:contextPath+"/entrustMaterialInController/getOrgName",dataType:"json",success:function(t){if(window.top.home.loading("hide"),"100100"===t.code)e.entrustMaterialInInfo.organizationName=t.data.name,e.entrustMaterialInInfo.organizationId=t.data.id,e.$forceUpdate();else if("-1"===t.code)return e.$Modal.warning({title:"提示信息",content:"服务器出错啦!"}),!1},error:function(){window.top.home.loading("hide"),alert("服务器出错啦")}})},getDetailBySourceNo:function(t){var n=this;$.ajax({type:"POST",url:contextPath+"/entrustMaterialInController/getPengdingGoods",contentType:"application/json;charset=utf-8",data:JSON.stringify(t),dataType:"json",success:function(t){if("100100"===t.code&&t.data){var e=t.data[0],o=[];t.data.forEach(function(e){e.collectGoods.forEach(function(t){t.orderId=e.orderNo,o.push(t)})}),console.log(o);var i=$.extend(!0,n.entrustMaterialInInfo,{customCode:e.goodsTypePath,goodsTypeName:e.goodsTypeName,custId:e.customerId,custCode:"",custName:e.customerName,documentStatus:1,isDel:1,goodList:o.map(function(t){return $.extend(!0,{},{collectGoodId:t.goodsId,sourceNo:t.orderNo,sourceType:"P_RECEIPT",commodityId:t.commodityId,goodsNo:t.goodsCode,goodsMainType:t.goodsMainType,goodsName:t.goodsName,pictureUrl:t.pictureUrl,batchNum:t.batchNumber,countingUnitName:t.countingUnit,number:t.qualifiedNumber+t.releaseNumber,weightUnitName:t.weightUnit,warehouseId:n.defWareHouse,goodsNorm:t.specification,goodList:[],isDel:1})})});if(console.log(i),e.goodsTypePath){n.entrustMaterialInInfo.groupPath=e.goodsTypePath;var a=e.goodsTypePath.substr(2).replace(/.$/gi,"").split(".");n.productId=a.map(function(t){return parseInt(t)})}n.entrustMaterialInInfo=i,n.getOrgan(),i.goodList?(n.productDetailList=i.goodList,i.goodList.forEach(function(t,e){n.productDetailList[e].barCodeDetailList=t.goodList})):n.productDetailList=[],n.isEditInput=!0,n.isClearable=!1,n.isMenu=!1,n.isUpdate=!0,n.isDisable=!0,n.isEditNumber=!0}},error:function(t){n.$Message.error("服务器出错")}})},getEntrustMaterialIn:function(){var o=this,i=o.params,t={};if(!$.isEmptyObject(i)){if(0===i.params.type){if(0!==i.params.type||!o.entrustMaterialInInfo.documentNo)return o.getOrgan(),o.isEdit("Y"),!1;t={documentNo:o.entrustMaterialInInfo.documentNo}}if(1===i.params.type&&(t={id:i.params.data}),2===i.params.type&&(t={documentNo:i.params.data}),3===i.params.type&&!o.entrustMaterialInInfo.documentNo)return o.getDetailBySourceNo(i.params.data),o.isEdit("Y"),!1;3===i.params.type&&o.entrustMaterialInInfo.documentNo&&(t={documentNo:o.entrustMaterialInInfo.documentNo})}$.ajax({type:"POST",url:contextPath+"/entrustMaterialInController/getEntrustMaterialIn",contentType:"application/json;charset=utf-8",data:JSON.stringify(t),dataType:"json",success:function(t){if("100100"===t.code){if(t.data.goodList||(t.data.goodList=[]),t.data.goodList&&t.data.goodList.forEach(function(t){t.goodList?t.goodList.forEach(function(t){return t.number=1}):t.goodList=[]}),o.entrustMaterialInInfo=t.data,t.data.goodList?(o.productDetailList=t.data.goodList,t.data.goodList.forEach(function(t,e){o.productDetailList[e].barCodeDetailList=t.goodList})):o.productDetailList=[],o.getAccess(t.data.documentNo,o.boeType),o.isEdit("Y"),o.isCustId=t.data.custId,t.data.customCode){var e=t.data.customCode.substr(2).replace(/.$/gi,"").split(".");o.productId=e.map(function(t){return parseInt(t)})}1===t.data.documentStatus&&(o.isEditInput=!1,o.isEditDate=!1,o.isOpened=!1,o.isClearable=!0,o.isEditRemark=!1,o.isEditSalesman=!1,o.isMenu=!0,o.isUpdate=!1,o.isEditTable=!1,o.isDisable=!1,o.isEditNumber=!1,o.isEdit("Y"),$(".is-disabled:gt(0):lt(2)").css("pointer-events","auto").css({color:"#495060"})),1===t.data.documentStatus&&2!==i.params.type||(o.isEditInput=!0,o.isEditDate=!0,o.isOpened=!0,o.isClearable=!1,o.isEditRemark=!0,o.isEditSalesman=!0,o.isMenu=!1,o.isUpdate=!0,o.isEditTable=!0,o.isDisable=!0,o.isEditNumber=!0,o.isEdit("N"),$(".is-disabled:gt(0):lt(2)").css("pointer-events","none").css({color:"#bbbec4"})),2===i.params.type&&$(".is-disabled").css("pointer-events","none").css({color:"#bbbec4"}),4===t.data.documentStatus?o.isStampShow=!0:o.isStampShow=!1,t.data.goodList&&0<t.data.goodList.length&&t.data.goodList[0].sourceNo&&(o.isEditInput=!0,o.isMenu=!1,o.isUpdate=!0,o.isDisable=!0,o.isEditNumber=!0),o.getOrgan()}},error:function(t){o.$Message.error("服务器出错")}})},list:function(){window.parent.activeEvent({name:"受托加工材料入库单-列表",url:contextPath+"/warehouse/entrust-material-in/entrust-material-in-list.html"})},exit:function(){var t=this;$.isEmptyObject(t.params)||(0!==t.params.params.type&&3!==t.params.params.type||window.parent.closeCurrentTab({name:"新增受托加工材料入库单",exit:!0,openTime:this.openTime}),1===t.params.params.type&&window.parent.closeCurrentTab({name:"修改受托加工材料入库单",exit:!0,openTime:this.openTime}),2===t.params.params.type&&window.parent.closeCurrentTab({name:"查看受托加工材料入库单",exit:!0,openTime:this.openTime}))},tableValidate:function(){return htValidateRow(this.productDetailList,{goodsNo:{name:"商品编码",type:"string"},number:{name:"数量",type:"number",empty:!0},weight:{name:"总量",type:"number",floor:3},warehouseId:{name:"仓库",type:"number"}})}},mounted:function(){this.getSelect("table-responsive","goods"),this.loadProductType(),this.getCust(),this.getSalesman(),this.getWareHouseGroup(),this.getUnitGroup(),this.getEntrustMaterialIn(),this.openTime=window.parent.params.openTime,$("form").validate()},created:function(){var t=window.parent.params;this.params=t,this.certifiTypes=getCodeList("base_certificate_type")},watch:{"entrustMaterialInInfo.custId":function(){console.log(this.entrustMaterialInInfo.custId,this.isCustId),this.entrustMaterialInInfo.custId&&this.getCustName(this.entrustMaterialInInfo.custId)}}});