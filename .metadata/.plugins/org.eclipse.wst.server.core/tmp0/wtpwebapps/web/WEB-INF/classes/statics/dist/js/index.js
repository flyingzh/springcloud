"use strict";function getCodeList(e){return layui.data("dict")[e]}window.home=new Vue({el:"#ht-index",data:function(){return{isLoading:!1,nowTime:(new Date).getTime(),isCollapsed:!1,activeIndex:null,activeLevelOne:"",activeLevelTwo:[],activeLevelTwoChild:"",activeName:"",activatedMenuItem:"",orgArray:[],selectedOrg:"",selectedOrgObj:{id:"",username:"",organId:"",organizationEntityList:[]},data:{one:[]},menuMapByUrl:{},menuMapById:{},menuMapByLevel:{},menuMapCache:{},scrollPosition:{},two:[],three:[],contents:[],user:{}}},methods:{collapsedSider:function(){this.$refs.side.toggleCollapse()},levelClick:function(e,t){e&&(this.activeLevelOne=e.name),this.two=[],this.data.one[t]&&this.data.one[t].childMenuList&&0<this.data.one[t].childMenuList.length?(this.two=[],this.two=this.data.one[t].childMenuList):(this.two=[],this.three=[]),this.activeLevelTwo=[],this.$nextTick(function(){this.$refs.level2.updateOpened()}),this.activatedMenuItem="",this.activeIndex=null},initMenuData:function(){var t=this;$.ajax({url:"sysShiroMenu/queryByMenuTree",type:"post",data:"",dataType:"json",success:function(e){t.data.one=e.data,t.levelClick(null,0),t.toggleClick(null,0),t.activeLevelOne=t.data.one[0].name,t.activeLevelTwoChild=t.three&&t.three[0]&&t.three[0].url.toString(),t.activeLevelTwo=[t.two[0]&&t.two[0].url.toString()],t.activeName=0;var i={},a={},o={};!function n(e){$.each(e,function(e,t){a[t.id]=t,void 0===o[t.parentId]&&(o[t.parentId]=[]),o[t.parentId].push(t.id),""!=t.url&&(i[t.url]=t),"array"==$.type(t.childMenuList)&&0<t.childMenuList.length&&n(t.childMenuList)})}(e.data),t.menuMapByUrl=i,t.menuMapById=a,t.menuMapByLevel=o,t.hashTrigger()},error:function(e,t,n){console.log(arguments)}})},toggleClick:function(e,t){e&&e.childMenuList&&0<e.childMenuList.length?(this.three=[],this.three=e.childMenuList,this.activeIndex=null):(this.three=[],this.activeEvent(e))},activeEvent:function(e,t){var n=this,i=this;if(this.$Message.config({top:17}),"number"==typeof t&&(this.activeIndex=t),e){var a=Object.assign({},e);a.openTime=(new Date).getTime(),a.close=!1,i.updateHash(e.url),this.findAlreadyMenu(a)||setTimeout(function(){if(1==n.isLoading&&e.url==window.location.hash.replace("#",""))return!1;n.$Message.destroy(),1!=n.isLoading?(n.isLoading=!0,n.$Message.info({duration:6,closable:!0,content:"加载中，请稍候~",onClose:function(){i.isLoading=!1}}),n.nowTime=(new Date).getTime(),n.contents.push(a),n.activeName=n.contents.length-1,window.parent.params=a):n.$Message.info({closable:!0,content:"请慢点操作~",onClose:function(){i.isLoading=!1}})})}},findAlreadyMenu:function(n){var i=this;return this.contents.some(function(e,t){if(n.id&&n.id===e.id&&!e.close)return i.activeName=t,n.id&&n.id===e.id&&!e.close})},closeCurrentTab:function(n){var i=this;n&&this.contents.forEach(function(e,t){n.openTime===e.openTime&&n.exit&&(i.contents[t].close=!0,i.findCloseIndex(t,n.exit))})},handleTabRemove:function(e){var t=this;this.contents[e].close=!0,this.$nextTick(function(){t.findCloseIndex(e)})},findCloseIndex:function(t,n){var i=this,a=this;if(t===this.activeName)if(0===t)this.contents.some(function(e,t){return!1===e.close&&(i.activeName=t),a.$nextTick(function(){a.updateHash(e.url,n)}),!1===e.close});else if(t===this.contents.length-1&&n){for(var e=this.contents.length,o=[],s=0;s<e;s++)o.push(Object.assign({},this.contents[s]));o.reverse().some(function(e,t){return!1===e.close&&(i.activeName=i.contents.length-t-1),a.$nextTick(function(){a.updateHash(e.url,n)}),!1===e.close})}else{for(var c=!1,r=function(e,t){if(!1===i.contents[e].close)return i.activeName=e,c=!0,a.$nextTick(function(){a.updateHash(a.contents[e].url,n)}),"break"},u=t,l=this.contents.length;u<l;u++){if("break"===r(u))break}if(!c)for(var d=function(e){if(!1===i.contents[t-e].close)return i.activeName=t-e,a.$nextTick(function(){a.updateHash(a.contents[t-e].url,n)}),"break"},h=0;h<t;h++){if("break"===d(h))break}}},tabClick:function(e){var t=this,n=$("iframe:visible"),i=n.attr("src"),a=this.contents[e].url;this.scrollPosition[i]=n.contents().scrollTop(),this.activeName=e,this.$nextTick(function(){$('iframe[src="'+a+'"]').contents().scrollTop(t.scrollPosition[a]||0)}),window.location.hash=a},getUser:function(){var t=this;$.getJSON("shiroUser/info?_"+$.now(),function(e){t.user=e,t.selectedOrg=t.user.userCurrentOrganId,t.selectedOrgObj=t.user,t.orgArray.map(function(e){e.id===t.user.organId&&(t.selectedOrgObj.orgName=e.orgName)}),window.userInfo=t.selectedOrgObj;layui.data("user");$.each(e,function(e,t){layui.data("user",{key:e,value:t})}),layui.data("user",{key:"currentOrgName",value:e.orgName})})},getCode:function(){$.ajax({url:"shiroCode/queryByBaseCodeAll",dataType:"json",type:"post",success:function(e){for(var t in e){var n=e[t];n&&layui.data("dict",{key:t,value:n})}}})},getCodeList:function(e){return layui.data("dict")[e]},fetchOrg:function(){var t=this;$.ajax({type:"POST",url:"public/getUserOragnList",data:"",dataType:"json",success:function(e){"100100"===e.code&&(t.orgArray=e.data)},error:function(){}})},orgChange:function(t){var n=this;$.ajax({type:"POST",url:"public/organChange",data:{id:t},dataType:"json",success:function(e){"100100"===e.code&&(n.selectedOrgObj.organId=t,$.each(e.data,function(e,t){layui.data("user",{key:e,value:t})}),n.orgArray.map(function(e){e.id===t&&(n.selectedOrgObj.orgName=e.orgName,layui.data("user",{key:"currentOrgName",value:e.orgName}))}),window.userInfo=n.selectedOrgObj,n.contents=[])},error:function(){}})},logout:function(){$.ajax({url:"logout",type:"get",success:function(){parent.location.href="logOut"}})},loading:function(e,t){if("show"==e){t=$.extend({iconClass:"spin-icon-load",iconType:"load-c",iconSize:18,text:"处理中，请稍候"},t||{});this.$Spin.show({render:function(e){return e("div",[e("Icon",{class:t.iconClass,props:{type:t.iconType,size:t.iconSize}}),e("div",t.text)])}})}"hide"==e&&this.$Spin.hide()},updateHash:function(e){1<arguments.length&&void 0!==arguments[1]&&arguments[1]&&!this.calculateLength()||(window.location.hash=e)},calculateLength:function(){return this.contents.reduce(function(e,t){if(!t.close)return e+1},0)},iframeLoaded:function(e){this.$Message.destroy(),this.isLoading=!1,setTimeout(function(){$("iframe").contents().find(".foot_copyright").fadeIn()},1e3)},hashTrigger:function(){var i=this,e=window.location.hash||"",t=window.location.pathname.split("/")[1],n=new RegExp("^#/"+t+"/","i"),a=[],o=this.menuMapById,s=this.menuMapByLevel;if(n.test(e)){var c=e.replace("#","");if(c in this.menuMapByUrl){var r=this.menuMapByUrl[c];this.activeEvent(r),$("title").text(r.name+" - 金大祥管理系统"),function e(t){if(t in i.menuMapCache)return a=i.menuMapCache[t],!1;var n=o[t];if(a.push({id:n.id,name:n.name,idx:s[n.parentId].indexOf(n.id)}),!(0<n.parentId))return!1;e(n.parentId)}(r.id),void 0===i.menuMapCache[r.id]&&(i.menuMapCache[r.id]=a.reverse()),this.activeLevelOne=a[0].name,this.two=this.menuMapById[a[0].id].childMenuList,this.activeLevelTwo=[a[1].idx],this.$nextTick(function(){this.$refs.level2.updateOpened(),this.activatedMenuItem=a[2].name}),this.$nextTick(function(){this.three=this.menuMapById[a[2].id].childMenuList,void 0!==a[3]&&(this.activeIndex=a[3].idx)})}}}},created:function(){var t=this;window.activeEvent=function(e){return t.activeEvent(e)},window.closeCurrentTab=function(e){return t.closeCurrentTab(e)}},mounted:function(){var e=this;this.initMenuData(),this.fetchOrg(),this.getUser(),this.getCode(),window.onhashchange=function(){e.hashTrigger()}}});