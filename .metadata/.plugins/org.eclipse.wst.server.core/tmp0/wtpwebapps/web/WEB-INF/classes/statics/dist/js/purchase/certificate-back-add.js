"use strict";var retrieveReport=new Vue({el:"#retrieveReport",data:function(){return{openTime:"",isSearchHide:!0,isTabulationHide:!0,isHide:!0,selected:[],isFromList:!1,showOrgan:!1,needReload:!1,categoryType:[],commodityCategoty:[],supplierList:[],wareHouseList:[],locationList:[],selectedRowIndex:0,isGenerate:!1,isView:!1,isAdd:!1,employees:{},readDate:!1,P_CERTIBACK_APPREVAL:"P_CERTIBACK_APPREVAL",isSave:!1,isSub:!1,isApprovel:!1,isReback:!1,modalTrigger:!1,modalType:"",steplist:[],approvalTableData:[],param:{},productDetailList:[],productTypeList:[],saveCertiBackVo:{id:"",businessType:"",orderStatus:"",orderNo:"",receiptDate:"",goodsTypeName:"",goodsTypePath:"",organizationId:"",organizationName:"",salesmanId:"",salesman:"",certificateType:"",supplierId:"",supplier:"",remark:"",createName:"",createTime:"",updateName:"",updateTime:"",auditor:"",auditTime:"",dataSource:"",certificateDetailList:[]},showSupplierModal:!1}},methods:{rcv:function(e,t,a){console.log(e,t,a),this.saveCertiBackVo.supplier=a,this.saveCertiBackVo.supplierId=e},closeSupplierModal:function(){this.showSupplierModal=!1},selectSupplier:function(e){!0!==e&&(this.showSupplierModal=!0)},approvalOrRejectCallBack:function(e){if("100100"==e.result.code){var t=e.result.data;retrieveReport.saveCertiBackVo.createName=t.createName,retrieveReport.saveCertiBackVo.createTime=t.createTime,retrieveReport.saveCertiBackVo.updateName=t.updateName,retrieveReport.saveCertiBackVo.updateTime=t.updateTime,retrieveReport.saveCertiBackVo.auditor=t.auditor,retrieveReport.saveCertiBackVo.auditTime=t.auditTime,retrieveReport.saveCertiBackVo.dataSource=t.dataSource,retrieveReport.saveCertiBackVo.orderStatus=t.orderStatus,1==retrieveReport.saveCertiBackVo.orderStatus?(2==retrieveReport.saveCertiBackVo.dataSource?(retrieveReport.isView=!1,retrieveReport.isGenerate=!0,retrieveReport.isAdd=!1):(retrieveReport.isView=!1,retrieveReport.isGenerate=!1,retrieveReport.isAdd=!0),retrieveReport.isSave=!1,retrieveReport.isSub=!1,retrieveReport.isApprovel=!0,retrieveReport.isReback=!0,retrieveReport.isEdit("Y")):(4==retrieveReport.saveCertiBackVo.orderStatus?(retrieveReport.isApprovel=!0,retrieveReport.isReback=!0):(retrieveReport.isApprovel=!1,retrieveReport.isReback=!1),retrieveReport.isView=!0,retrieveReport.isGenerate=!1,retrieveReport.isAdd=!1,retrieveReport.isSave=!0,retrieveReport.isSub=!0)}else this.$Modal.warning({content:e.result.msg,title:"警告"})},approval:function(){var e=this;e.modalType="approve",e.modalTrigger=!e.modalTrigger},reject:function(){var e=this;e.modalType="reject",e.modalTrigger=!e.modalTrigger},changeCategory:function(e){this.saveCertiBackVo.goodsTypePath=e[e.length-1]},changeProductType:function(e,t){if(e==this.typeValue)return!1;this.productDetailList=[];var a=t[t.length-1];if(null==a||""==a)return this.saveCertiBackVo.goodsTypeName="",this.saveCertiBackVo.goodsTypePath="",!1;this.saveCertiBackVo.goodsTypeName=a.label,this.saveCertiBackVo.goodsTypePath=a.value},typeInit:function(e,t,a){for(var i=0;i<e.length;i++){if(e[i].value==a)return t.push(e[i].value),!0;if(e[i].children&&0<e[i].children.length&&this.typeInit(e[i].children,t,a))return t.push(e[i].value),!0}},isHintShow:function(e){var t=this;e&&this.typeValue&&this.isHint&&this.productDetailList&&0<this.productDetailList.length&&this.$Modal.warning({content:"温馨提示：改变商品类型将删除所有商品信息!",onOk:function(){t.isHint=!1,console.log("温馨提示：改变商品类型将删除所有商品信息！")}})},getProductType:function(){var t=this;$.ajax({type:"post",url:contextPath+"/tbasecommoditycategory/listByAll?parentId=0",dataType:"json",success:function(e){"100100"===e.code?t.productTypeList=t.initGoodCategory(e.data.cateLists):t.$Modal.error({content:e.msg})},error:function(){t.$Modal.error({content:"网络异常,请联系技术人员！"})}})},initGoodCategory:function(e){var o=this,s=[];return e.forEach(function(e){var t=e.customCode,a=e.name,i=e.cateLists,r=e.code;i&&(i=o.initGoodCategory(i)),s.push({value:t,label:a,children:i,code:r})}),s.forEach(function(e){e.children||delete e.children}),s},changeEmp:function(e){if(1==this.isView)return!1;this.saveCertiBackVo.salesmanId=e.value,this.saveCertiBackVo.salesman=e.label.substr(e.label.lastIndexOf("-")+1,e.label.length)},getSaleMan:function(){var t=this;$.ajax({type:"post",url:contextPath+"/tpurchasecollectgoods/data",dataType:"json",success:function(e){t.employees=e.data.employees},error:function(){console.log("服务器出错啦")}})},add:function(){window.parent.activeEvent({name:"新增证书商品收回单",url:contextPath+"/purchase/certificate-back-report/certificate-back-add.html",params:{type:"add",organizationId:retrieveReport.saveCertiBackVo.organizationId,organizationName:retrieveReport.saveCertiBackVo.organizationName}})},save:function(e){var t=this;t.saveCertiBackVo.orderStatus=1,$.ajax({type:"post",url:contextPath+"/certiBackDetail/saveOrUpdateCertiBackDetail",contentType:"application/json",data:JSON.stringify(e),dataType:"json",success:function(e){"100100"==e.code?(t.$Modal.success({content:"保存成功",duration:1.5,closable:!0}),t.saveAccess(e.data.id,t.P_CERTIBACK_APPREVAL),retrieveReport.isSave=!1,t.isApprovel=!0,t.isReback=!0,t.saveCertiBackVo.certificateDetailList=e.data.certificateDetailList,t.saveCertiBackVo.id=e.data.id,t.saveCertiBackVo.businessType=e.data.businessType,t.saveCertiBackVo.orderNo=e.data.orderNo,t.saveCertiBackVo.orderStatus=e.data.orderStatus,t.saveCertiBackVo.receiptDate=e.data.receiptDate,t.saveCertiBackVo.remark=e.data.remark,t.saveCertiBackVo.organizationId=e.data.organizationId,t.saveCertiBackVo.organizationName=e.data.organizationName,t.saveCertiBackVo.supplier=e.data.supplier,t.saveCertiBackVo.supplierId=e.data.supplierId,t.saveCertiBackVo.goodsTypePath=e.data.goodsTypePath,t.saveCertiBackVo.goodsTypeName=e.data.goodsTypeName,t.saveCertiBackVo.salesman=e.data.salesman,t.saveCertiBackVo.salesmanId=e.data.salesmanId,t.saveCertiBackVo.certificateType=e.data.certificateType,t.saveCertiBackVo.createName=e.data.createName,t.saveCertiBackVo.createTime=e.data.createTime,t.saveCertiBackVo.updateName=e.data.updateName,t.saveCertiBackVo.updateTime=e.data.updateTime,t.saveCertiBackVo.auditor=e.data.auditor,t.saveCertiBackVo.auditTime=e.data.auditTime):("100101"===e.code&&"1"===e.msg?t.$Modal.warning({content:"该单据已生成,请刷新列表",duration:1.5,closable:!0}):t.$Modal.warning({content:"保存失败",duration:1.5,closable:!0}),retrieveReport.isSave=!1)},error:function(e){t.$Modal.error({content:"服务器错误",duration:1.5,closable:!0}),retrieveReport.isSave=!1}})},changeStatus:function(e){retrieveReport.isSub=""==e||null==e||1==e?retrieveReport.isSave=!1:retrieveReport.isSave=!0},submit:function(e){var t=this;if(this.validateForm()){var a,i=t.saveCertiBackVo.certificateDetailList;if(0==(a=t.saveCertiBackVo.certificateDetailList.length))return t.$Modal.warning({content:"请填写订单明细信息",duration:1.5,closable:!0}),t.changeStatus(t.saveCertiBackVo.orderStatus),!1;for(var r=0;r<a;r++){if(""===i[r].certificateNumber||void 0===i[r].certificateNumber||null===i[r].certificateNumber)return t.$Modal.warning({content:"请填写第"+(r+1)+"行的证书数量",duration:1.5,closable:!0}),t.changeStatus(t.saveCertiBackVo.orderStatus),!1;if(""==i[r].certificateCost||null==i[r].certificateCost||null==i[r].certificateCost)return t.$Modal.warning({content:"请填写第"+(r+1)+"行的证书费用",duration:1.5,closable:!0}),t.changeStatus(t.saveCertiBackVo.orderStatus),!1;if(!(""!=i[r].receiverWeight&&null!=i[r].receiverWeight&&null!=i[r].receiverWeight||""!=i[r].receiverGoodsNumber&&null!=i[r].receiverGoodsNumber&&null!=i[r].receiverGoodsNumber))return t.$Modal.warning({content:"第"+(r+1)+"行的收货数量和收货重量至少填一个",duration:1.5,closable:!0}),t.changeStatus(t.saveCertiBackVo.orderStatus),!1}t.saveCertiBackVo.orderStatus=2,$.ajax({type:"post",url:contextPath+"/certiBackDetail/saveOrUpdateCertiBackDetail",contentType:"application/json",data:JSON.stringify(e),dataType:"json",success:function(e){"100100"==e.code?(t.$Modal.success({content:"提交成功",duration:1.5,closable:!0}),t.saveAccess(e.data.id,t.P_CERTIBACK_APPREVAL),t.isApprovel=!1,t.isReback=!1,t.isView=!0,t.isGenerate=!1,t.isAdd=!1,t.saveCertiBackVo.certificateDetailList=e.data.certificateDetailList,t.saveCertiBackVo.id=e.data.id,t.saveCertiBackVo.businessType=e.data.businessType,t.saveCertiBackVo.orderNo=e.data.orderNo,t.saveCertiBackVo.orderStatus=e.data.orderStatus,t.saveCertiBackVo.receiptDate=e.data.receiptDate,t.saveCertiBackVo.remark=e.data.remark,t.saveCertiBackVo.organizationId=e.data.organizationId,t.saveCertiBackVo.organizationName=e.data.organizationName,t.saveCertiBackVo.supplier=e.data.supplier,t.saveCertiBackVo.supplierId=e.data.supplierId,t.saveCertiBackVo.goodsTypePath=e.data.goodsTypePath,t.saveCertiBackVo.goodsTypeName=e.data.goodsTypeName,t.saveCertiBackVo.salesman=e.data.salesman,t.saveCertiBackVo.salesmanId=e.data.salesmanId,t.saveCertiBackVo.certificateType=e.data.certificateType,t.saveCertiBackVo.createName=e.data.createName,t.saveCertiBackVo.createTime=e.data.createTime,t.saveCertiBackVo.updateName=e.data.updateName,t.saveCertiBackVo.updateTime=e.data.updateTime,t.saveCertiBackVo.auditor=e.data.auditor,t.saveCertiBackVo.auditTime=e.data.auditTime,t.isEdit("N"),t.getInitDataById()):"100101"===e.code&&"2"===e.msg&&(t.$Modal.warning({content:"该单据已生成,请刷新列表",duration:1.5,closable:!0}),t.isSave=!1,t.isSub=!1)},error:function(e){t.$Modal.error({content:"服务器错误",duration:1.5,closable:!0}),t.isSave=!1,t.isSub=!1}})}else t.changeStatus(t.saveCertiBackVo.orderStatus)},saveClick:function(e){var t=this;"save"==e?(retrieveReport.isSave=!0,t.save(t.saveCertiBackVo)):"submit"==e&&(t.isSub=!0,t.isSave=!0,t.submit(t.saveCertiBackVo))},validateForm:function(){var e=!0,t={"业务类型":this.saveCertiBackVo.businessType,"商品类型":this.saveCertiBackVo.goodsTypePath,"证书类型":this.saveCertiBackVo.certificateType,"供应商":this.saveCertiBackVo.supplier};for(var a in t)if(!t[a]){e=!1,this.$Modal.warning({content:"您还没有填写"+a});break}return e},cancel:function(){window.parent.closeCurrentTab({exit:!0,openTime:this.openTime})},getApproveInfo:function(){},getRejectInfo:function(){},addOrDel:function(e){"add"===e?this.saveCertiBackVo.certificateDetailList.push({sourceType:"",sourceNumber:"",certificateNumber:"",receiverGoodsNumber:"",receiverWeight:"",certificateCost:"",totalCost:"",remark:""}):this.saveCertiBackVo.certificateDetailList.splice(this.selectedRowIndex,1)},selectOneRow:function(e){this.selectedRowIndex=e},showCertiBackDetail:function(e){var t=this;$.ajax({type:"post",url:contextPath+"/certificateBackInfo/viewCertiBackDetailById",data:{id:e},success:function(e){if("100100"!=e.code)return t.$Modal.warning({content:"显示失败",duration:1.5,closable:!0}),!1;2==e.data.orderStatus||3==e.data.orderStatus||5==e.data.orderStatus?(t.isSave=!0,t.isSub=!0,t.isApprovel=!1,t.isReback=!1):4==e.data.orderStatus?(t.isSave=!0,t.isSub=!0,t.isApprovel=!0,t.isReback=!0):1==e.data.orderStatus?(t.isSave=!1,t.isSub=!1,t.isApprovel=!0,t.isReback=!0):(t.isSave=!1,t.isSub=!1,t.isApprovel=!1,t.isReback=!1),1!=e.data.orderStatus?(t.readDate=!0,t.isView=!0,t.isGenerate=!1,t.isAdd=!1):1==e.data.dataSource?(t.readDate=!1,t.isAdd=!0,t.isView=!1,t.isGenerate=!1):(t.readDate=!1,t.isGenerate=!0,t.isAdd=!1,t.isView=!1),t.saveCertiBackVo.certificateDetailList=e.data.certificateDetailList,t.saveCertiBackVo.id=e.data.id,t.saveCertiBackVo.businessType=e.data.businessType.toString(),t.saveCertiBackVo.orderNo=e.data.orderNo,t.saveCertiBackVo.dataSource=e.data.dataSource,t.saveCertiBackVo.orderStatus=e.data.orderStatus,t.saveCertiBackVo.receiptDate=e.data.receiptDate,t.saveCertiBackVo.remark=e.data.remark,t.saveCertiBackVo.organizationId=e.data.organizationId,t.saveCertiBackVo.organizationName=e.data.organizationName,t.saveCertiBackVo.supplier=e.data.supplier,t.saveCertiBackVo.supplierId=e.data.supplierId,t.saveCertiBackVo.goodsTypePath=e.data.goodsTypePath,t.saveCertiBackVo.goodsTypeName=e.data.goodsTypeName,t.saveCertiBackVo.salesman=e.data.salesman,t.saveCertiBackVo.salesmanId=e.data.salesmanId,t.saveCertiBackVo.certificateType=e.data.certificateType,t.saveCertiBackVo.createName=e.data.createName,t.saveCertiBackVo.createTime=e.data.createTime,t.saveCertiBackVo.updateName=e.data.updateName,t.saveCertiBackVo.updateTime=e.data.updateTime,t.saveCertiBackVo.auditor=e.data.auditor,t.saveCertiBackVo.auditTime=e.data.auditTime},error:function(e){t.$Modal.error({content:"服务器出错",duration:1.5,closable:!0})}})},getSupplierList:function(){$.ajax({type:"post",url:contextPath+"/waitCertiBackInfo/getSupplierList",data:{},success:function(e){if(""!=e.data)for(var t=0;t<e.data.length;t++)retrieveReport.supplierList.push({id:e.data[t].id,supplier:e.data[t].supplierName})}})},loadListData:function(e){var i=this;$.ajax({type:"post",url:contextPath+"/waitCertiBackInfo/getCerByIds",contentType:"application/json",dataType:"json",data:JSON.stringify(e),success:function(e){if("100100"!=e.code)return i.$Modal.warning({content:"生成失败",closable:!0}),!1;for(var t=[],a=0;a<e.data.length;a++)t.push(Object.assign(e.data[a],{id:"",sourceNumber:e.data[a].orderNo,sourceId:e.data[a].id,certificateType:e.data[a].certificateType,certificateNumber:e.data[a].certificateNumber,certificateCost:e.data[a].certificateCost,remark:e.data[a].remark,receiverGoodsNumber:e.data[a].deliverGoodsNumber,receiverWeight:e.data[a].deliverWeight}));i.saveCertiBackVo.certificateDetailList=t,i.saveCertiBackVo.receiptDate=new Date,i.saveCertiBackVo.goodsTypeName=e.data[0].goodsTypeName,i.saveCertiBackVo.goodsTypePath=e.data[0].goodsTypePath,i.saveCertiBackVo.businessType=e.data[0].businessType.toString(),i.saveCertiBackVo.organizationId=e.data[0].organizationId,i.saveCertiBackVo.organizationName=e.data[0].organizationName,i.saveCertiBackVo.supplierId=e.data[0].supplierId,i.saveCertiBackVo.supplier=e.data[0].supplier,i.saveCertiBackVo.certificateType=e.data[0].certificateType,i.saveCertiBackVo.createName=e.data[0].createName,i.saveCertiBackVo.createTime=e.data[0].createTime,i.saveCertiBackVo.updateName=e.data[0].updateName,i.saveCertiBackVo.updateTime=e.data[0].updateTime,i.saveCertiBackVo.auditor=e.data[0].auditor,i.saveCertiBackVo.auditTime=e.data[0].auditTime},error:function(e){i.$Modal.error({content:"生成失败",closable:!0})}})},isEdit:function(e,t){eventHub.$emit("isEdit",e)},saveAccess:function(e,t,a){eventHub.$emit("saveFile",e,t)},getAccess:function(e,t,a){eventHub.$emit("queryFile",e,t)},getInitDataById:function(){var t=this,e=window.parent.params.params.id;e&&$.ajax({type:"post",url:contextPath+"/certificateBackInfo/viewCertiBackDetailById",data:{id:e},success:function(e){"100100"===e.code?(t.isEdit(1==e.data.orderStatus?"Y":"N"),t.getAccess(e.data.id,t.P_CERTIBACK_APPREVAL)):this.$Modal.warning({content:"服务器出错"})},error:function(){layer.alert("服务器出错啦")}})},clearNoNum:function(e,t,a){return htInputNumber(e,t,a)},remarkNumber:function(e){if(console.log(e),e&&200<e.length)return this.$Modal.warning({content:"备注不能操作100个汉字"}),!1},checkNumber:function(e){return""==e?"":new RegExp(/^\d+$/).test(e)?e:(this.$Modal.warning({content:"请输入整数"}),e="")},sum:function(e,a){return e.reduce(function(e,t){return""===t[a]||null===t[a]||void 0===t[a]?0+e:parseFloat(t[a])+e},0)}},computed:{totalCertificateNumber:function(){return this.sum(this.saveCertiBackVo.certificateDetailList,"certificateNumber")},totalReceiverGoodsNumber:function(){return this.sum(this.saveCertiBackVo.certificateDetailList,"receiverGoodsNumber")},totalReceiverWeight:function(){return this.sum(this.saveCertiBackVo.certificateDetailList,"receiverWeight").toFixed(2)},totalCertificateCost:function(){return this.sum(this.saveCertiBackVo.certificateDetailList,"certificateCost").toFixed(2)},finalCost:function(){return this.sum(this.saveCertiBackVo.certificateDetailList,"totalCost").toFixed(2)},typeValue:function(){var e=this.saveCertiBackVo.goodsTypePath,t=[];return this.typeInit(this.productTypeList,t,e),t.reverse()}},watch:{},created:function(){this.getSaleMan(),this.getProductType()},mounted:function(){this.getSupplierList(),this.param=window.parent.params.params,this.openTime=window.parent.params.openTime;var e=window.parent.params.params;if(e.type)if("generate"===e.type){this.isApprovel=!0,this.isReback=!0;var t;t=e.ids,this.isGenerate=!0,this.isView=!1,this.isAdd=!1,this.readDate=!1,this.isEdit("Y"),this.loadListData(t)}else"update"===e.type?(this.getInitDataById(),this.showCertiBackDetail(e.id)):"view"===e.type?(this.readDate=!0,this.isView=!0,this.isGenerate=!1,this.isAdd=!1,this.isEdit("N"),this.getInitDataById(),this.showCertiBackDetail(e.id)):"add"===e.type&&(this.saveCertiBackVo.organizationName=layui.data("user").currentOrganization.orgName,this.saveCertiBackVo.dataSource=1,this.saveCertiBackVo.receiptDate=new Date,this.isApprovel=!0,this.isReback=!0,this.readDate=!1,this.isView=!1,this.isGenerate=!1,this.isAdd=!0,this.isEdit("Y"))}});