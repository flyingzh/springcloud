"use strict";var vm=new Vue({el:"#customer-info",data:function(){var s=this;return{isSearchHide:!0,isTabulationHide:!0,isHide:!0,showUpload:!1,saveDisable:!0,is_update:!1,showModal:!1,selectOrginId:[],imgList:[],columns:[{type:"selection",width:60,align:"center"},{title:"组织名称",key:"orgName"}],colContent:[],openTime:"",isEdit:!1,isView:!1,is_lock:!1,name:"",is_search:!0,cpisEdit:!1,reload:!1,selected:[],levels:[],currencys:[],wares:[],area:{},areaInit:{isInit:!1,province:"",city:"",county:"",detail:"",disabled:!1},clientType:[],body:{name:"",beforetime:"",aftertime:"",ids:[],status:-1},order:{startDate:"",endDate:""},receiptName:"",showStoneList:!1,customer:{id:"",code:"",name:"",abbreviation:"",pricingMethod:"",level:"",nature:"",zipCode:"",payWay:"",settlementDays:"",prepaymentRatio:"",billingCurrency:"",billingMethod:"",companyFax:"",corporate:"",registratDate:"",businessNumber:"",taxNumber:"",taxCategory:"",vatrate:"",interestFreeDays:"",dailyRate:"",credits:"",wareHouse:"",status:1,remark:"",stonePriceCode:"",sysFile:{fileId:"",fileType:"",fileDetails:[]},contacts:[],backCards:[]},status:[{label:"所有",value:-1},{label:"有效",value:1},{label:"无效",value:0}],payMethod:[],billing:[],taxType:[],cusStatus:[{label:"有效",value:1},{label:"无效",value:0}],pricingMethod:[{label:"标签价折扣",value:1},{label:"金工石计价",value:2}],change_log:{colNames:["变更信息","变更前","变更后","变更日期","变更人"],colModel:[{name:"changeInfo",index:"",width:250,align:"center"},{name:"operationBefore",index:"",width:250,align:"center"},{name:"operationAfter",index:"",width:250,align:"center"},{name:"operationTime",index:"",width:250,align:"center"},{name:"userName",index:"",width:250,align:"center"}]},logUrl:contextPath+"/tbasecustomer/changeLog?type=customer&id=-1",data_config:{url:contextPath+"/tbasecustomer/list",colNames:["客户编码","客户名称","等级","地址","默认联系人","默认联系方式","备注","创建人","创建时间"],colModel:[{name:"code",index:"",width:350,align:"left",formatter:function(e,t,a,i){var n=".detail"+e;return $(document).off("click",n).on("click",n,function(){s.show(a)}),'<a class="detail'+e+'">'+e+"</a>"}},{name:"name",index:"",width:350,align:"left"},{name:"level ",index:"",width:350,align:"left",formatter:function(e,t,a){for(var i="",n=0;n<vm.levels.length;n++)if(a.level==vm.levels[n].id){i=vm.levels[n].name;break}return i}},{name:"concreteAddress",index:"address",width:550,align:"left"},{name:"contactName",index:"",width:350,align:"left"},{name:"contactPhone",index:"",width:350,align:"left"},{name:"remark",width:350,align:"left"},{name:"createName",width:350,align:"left"},{name:"createTime",width:600,align:"left"}]},stoneNo:"",stoneName:"",stoneReload:!0,tabId:"tabId",stoneSelected:[],stone_data_config:{url:contextPath+"/saleStonePriceController/listByPage",colNames:["选择","石价表编号","石价表名称","创建日期","创建人"],colModel:[{name:"id",index:"id",hidden:!1,width:50,align:"left",formatter:function(e,t,a,i){var n=".detail"+e;return $(document).off("click",n).on("click",n,function(){s.detailClick({value:e,grid:t,rows:a,state:i})}),'<a class="detail'+e+'">选择</a>'}},{name:"stonePriceNo",index:"stonePriceNo",width:250,align:"left"},{name:"name",index:"name",width:250,align:"left"},{name:"createTime",index:"createTime",width:250,align:"left",formatter:function(e,t,a,i){return new Date(e).format("yyyy-MM-dd")}},{name:"createName",index:"createName",width:250,align:"left"}],multiselect:!1}}},created:function(){this.loadData()},methods:{detailClick:function(e){e.value,e.grid;var t=e.rows;e.state;this.customer.stonePriceCode=t.stonePriceNo,this.showStoneList=!1},searchCut:function(){var e={postData:{stonePriceNo:this.stoneNo,name:this.stoneName}};$("#"+this.tabId).jqGrid("setGridParam",e).trigger("reloadGrid")},searchClear:function(){this.stoneNo="",this.stoneName="";var e={postData:{stonePriceNo:this.stoneNo,name:this.stoneName}};$("#"+this.tabId).jqGrid("clearGridData"),$("#"+this.tabId).jqGrid("setGridParam",e).trigger("reloadGrid")},loadData:function(){var s=this;s.taxType=getCodeList("base_tax_type"),s.billing=getCodeList("base_billing_method"),s.payMethod=getCodeList("base_pay_method"),s.clientType=getCodeList("base_clientType"),$.ajax({type:"POST",url:contextPath+"/tbasecustomer/data",contentType:"application/json",dataType:"json",async:!1,success:function(e){if("100100"===e.code){s.levels=e.data.clientLevel,s.currencys=e.data.currency,s.wares=e.data.wareHouse;for(var t=e.data.organList,a=e.data.organId,i=-1,n=0;n<t.length;n++)if(a==t[n].id){i=n;break}t.splice(i,1),s.colContent=t}else layer.alert("服务器异常，请联系技术人员",{icon:0})},error:function(e){layer.alert("服务器异常，请联系技术人员",{icon:0})}})},search:function(){var e=this,t=[].concat(this.body.ids);this.body.ids=0<this.body.ids.length?this.body.ids.join(","):"",this.reload=!this.reload,setTimeout(function(){e.body.ids=t},10)},clearbody:function(){this.$refs.start.date="",this.$refs.end.date="",vm.body={name:"",beforetime:"",aftertime:"",ids:[],status:-1}},clear:function(){this.$refs.startTime.date="",this.customer={id:"",code:"",name:"",abbreviation:"",level:"",nature:"",zipCode:"",payWay:"",settlementDays:"",prepaymentRatio:"",billingCurrency:"",billingMethod:"",companyFax:"",corporate:"",registratDate:"",businessNumber:"",taxNumber:"",taxCategory:"",vatrate:"",interestFreeDays:"",dailyRate:"",credits:"",wareHouse:0,status:1,remark:"",pricingMethod:"",stonePriceId:"",sysFile:{fileId:"",fileType:"",fileDetails:[]},contacts:[],backCards:[]},this.area={},this.areaInit={isInit:!1,province:"",city:"",county:"",detail:"",disabled:!1},this.logUrl=contextPath+"/tbasecustomer/changeLog?type=customer&id=-1"},show:function(e){var t=this;vm.logUrl=contextPath+"/tbasecustomer/changeLog?type=customer&id="+e.id+"&newDate="+new Date,t.saveDisable=!1,t.isEdit=!0,t.isView=!0,t.is_lock=!0,$.ajax({type:"post",url:contextPath+"/tbasecustomer/info/"+e.id,success:function(e){100100==e.code&&(t.customer=e.data,t.customer.registratDate=e.data.registratDate,e.data.province&&(t.areaInit={isInit:!0,province:e.data.province,city:e.data.city,county:e.data.county,detail:e.data.detail,disabled:!0}))}})},addData:function(){this.isEdit=!0,this.isView=!1,this.is_lock=!1,this.clear()},del:function(){var t=this;0!=t.selected.length?layer.confirm(" 当前数据有可能被引用，会影响数据准确性，确认是否删除?",{btn:["确定","取消"],btn1:function(e){0<t.selected.length?$.ajax({type:"post",url:contextPath+"/tbasecustomer/delete",data:JSON.stringify(t.selected),contentType:"application/json",success:function(e){t.selected=[],"100100"==e.code&&(layer.alert("删除成功",{icon:1}),t.reload=!t.reload)}}):layer.alert("请选择一条数据"),layer.close(e)},btn2:function(e){layer.close(e)}}):layer.alert("请选择要删除的数据")},modify:function(){var t=this;t.is_update=!0,1==this.selected.length?(this.isEdit=!0,this.isView=!1,this.is_lock=!1,$.ajax({type:"post",url:contextPath+"/tbasecustomer/info/"+vm.selected[0],contentType:"application/json",success:function(e){"100100"==e.code&&(t.customer=e.data,e.data.registratDate&&(t.$refs.startTime.date=e.data.registratDate.substr(0,10)),e.data.province&&(t.areaInit={isInit:!0,province:e.data.province,city:e.data.city,county:e.data.county,detail:e.data.detail,disabled:!1}))}})):layer.alert("请选择一条数据进行更新")},view:function(){if(1==this.selected.length){var e={};e.id=this.selected[0],this.show(e)}else layer.alert("请选择一条数据")},save:function(){var t=this;if(t.saveDisable){var e="";if(e=t.customer.id?contextPath+"/tbasecustomer/update":contextPath+"/tbasecustomer/save",0!=$("form").valid())if(t.customer.code)if(t.customer.name)if(t.customer.abbreviation)if(t.customer.level)if(t.customer.nature)if(t.customer.payWay)if(t.customer.pricingMethod)if(t.customer.billingCurrency)if(t.customer.billingCurrency)if(2!=t.customer.pricingMethod||t.customer.stonePriceCode)if(0<t.customer.contacts.length){for(var a=t.customer.contacts,i=!1,n=0;n<a.length;n++){if(1==a[n].isDefault&&(i=!0),!a[n].name)return void layer.alert("请填写联系人姓名！");if(!a[n].phone)return void layer.alert("请填写联系人手机号");if(!/^1(3|4|5|7|8)\d{9}$/.test(a[n].phone))return void layer.alert("请检查你的手机号是否正确");if(!a[n].email)return void layer.alert("请填写联系人邮箱");if(!/^[a-z0-9]+([._\-]*[a-z0-9])*@([a-z0-9]+[-a-z0-9]*[a-z0-9]+.){1,63}[a-z0-9]+$/.test(a[n].email))return void layer.alert("请请检查你的邮箱是否正确")}if(i){if(0<vm.customer.backCards.length&&vm.customer.backCards&&0<vm.customer.backCards.length)for(n=0;n<vm.customer.backCards.length;n++){if(!vm.customer.backCards[n].name)return void layer.alert("请填写银行信息");if(!vm.customer.backCards[n].account)return void layer.alert("请填写账户信息");if(!vm.customer.backCards[n].holder)return void layer.alert("请填写开户人信息")}t.saveDisable=!1,$("form").valid()&&(ht.util.hasValue(vm.area,"object")&&Object.assign(vm.customer,vm.area),$.ajax({type:"post",url:e,data:JSON.stringify(vm.customer),contentType:"application/json",success:function(e){"100100"==e.code?layer.alert(e.data,{icon:1,end:function(){t.saveDisable=!0,t.exit(),t.reload=!t.reload}}):"100101"==e.code&&(layer.alert("保存失败,请检查你的参数是否重复",{icon:0}),t.saveDisable=!0)},error:function(e){layer.alert("服务器出错,请联系技术人员",{icon:0}),t.saveDisable=!0}}))}else layer.alert("请选择一个默认的联系人")}else layer.alert("请至少填写一位联系人的信息");else layer.alert("请选择石价表！");else layer.alert("请选择结算方式",{icon:0});else layer.alert("请选择结算币种",{icon:0});else layer.alert("请选择计价方式",{icon:0});else layer.alert("请选择付款方式",{icon:0});else layer.alert("请选择客户性质",{icon:0});else layer.alert("请选择客户等级",{icon:0});else layer.alert("请填写客户简称",{icon:0});else layer.alert("请填写客户名称",{icon:0});else layer.alert("请填写客户编码",{icon:0})}else t.saveDisable=!0},hideSearch:function(){this.isSearchHide=!this.isSearchHide,$(".chevron").css("top","")},openReceipt:function(){this.isView||(this.showStoneList=!0)},ok1:function(){},cancel1:function(){},exit:function(){this.$refs.upload.clearFiles(),this.saveDisable=!0,this.is_update=!1,this.isEdit=!1,this.isView=!1,this.is_lock=!1,this.areaInit.disabled=!1,$("form").validate().resetForm(),this.clear();var e=$("#tabs"),t=e.find(".layui-tab-title > li"),a=e.find(".layui-tab-content .layui-tab-item");$.each(t,function(e,t){0==e?($(this).addClass("layui-this"),a.eq(0).addClass("layui-show")):($(this).removeClass("layui-this"),a.eq(e).removeClass("layui-show"))})},copy:function(){var t=this;1==t.selected.length?(t.isEdit=!0,t.isView=!1,t.is_lock=!1,$.ajax({type:"post",url:contextPath+"/tbasecustomer/info/"+t.selected[0],success:function(e){100100==e.code&&(t.customer=e.data,t.customer.id="",t.customer.code="",t.customer.name="",t.customer.abbreviation="",t.customer.sysFile={fileId:"",fileType:"",fileDetails:[]},t.customer.fileId&&(t.customer.fileId=""),e.data.registratDate&&(t.$refs.startTime.date=e.data.registratDate.substr(0,10)),e.data.province&&(t.areaInit={isInit:!0,province:e.data.province,city:e.data.city,county:e.data.county,detail:e.data.detail,disabled:!1}))},error:function(e){layer.alert("服务器出错,请联系技术人员",{icon:0})}})):layer.alert("请选择一条数据进行复制")},contactChecked:function(a){$.each(this.customer.contacts,function(e,t){t.isDefault=a==e?1:0})},backCardChecked:function(a){$.each(this.customer.backCards,function(e,t){t.isDefault=a==e?1:0})},modifyContact:function(){},addContact:function(){this.customer.contacts.push({id:"",name:"",phone:"",landline:"",wechat:"",isDefault:0,email:"",isDel:"1"})},addbackcard:function(){vm.customer.backCards.push({id:"",name:"",account:"",holder:"",isDefault:0,isDel:"1"})},delContact:function(t,e){layer.confirm("确认删除本条记录吗?",{btn:["确定","取消"],btn1:function(e){vm.customer.contacts.splice(t,1),layer.close(e)},btn2:function(e){layer.close(e)}})},delBackCard:function(t){layer.confirm("确认删除本条记录吗?",{btn:["确定","取消"],btn1:function(e){vm.customer.backCards.splice(t,1),layer.close(e)},btn2:function(e){layer.close(e)}})},delfileDetails:function(t,e){var a=this;layer.confirm("确认删除本条记录吗?",{btn:["确定","取消"],btn1:function(e){a.customer.sysFile.fileDetails[t].del=!0,layer.close(e)},btn2:function(e){layer.close(e)}})},findLevel:function(){$.ajax({type:"POST",url:contextPath+"/tclientlevel/listForApply?apply=0",success:function(e){"100100"===e.code&&(vm.levels=e.data.splice(0,10))}})},showOrgin:function(){this.selectOrginId=[],0!=this.selected.length?this.showModal=!0:layer.alert("请选择行!")},okModel:function(){if(0!=this.selectOrginId.length){var e={ids:{},orginIds:{}};e.ids=this.selected.join(","),e.orginIds=this.selectOrginId.join(","),this.cancelModel();var t=this;$.ajax({type:"POST",url:contextPath+"/tbasecustomer/allot",traditional:!0,datatype:"json",data:e,success:function(e){"100100"===e.code?(layer.alert("分配成功",{icon:1}),t.selectOrginId=[]):layer.alert(e.msg,{icon:0})},error:function(e){layer.alert("服务器出错,请联系技术人员",{icon:0})}})}else layer.alert("请选择分配组织!")},cancelModel:function(){this.selectOrginId=[],this.$refs.test.selectAll(!1),this.showModal=!1},changeselect:function(e){for(var t=0;t<e.length;t++)this.selectOrginId.push(e[t].id)},uploadfile:function(){var s=this;layui.use("upload",function(){var e=layui.upload;s.imgList=[];var t=e.render({elem:"#uploadfile",url:contextPath+"/tbasecustomer/img",accept:"file",multiple:!0,auto:!1,choose:function(e){e.preview(function(e,t,a){if(2097152<t.size)return layer.alert("请上传小于2M的文件"),void layer.close(n);var i=!0;if(0<s.imgList.length)for(e=0;e<s.imgList.length;e++)s.imgList[e]==t.name&&(i=!1);i&&s.imgList.push(t.name)})},done:function(e){if(100100==e.code){if(layer.alert("上传成功"),null!=e.data){var t=e.data;vm.customer.sysFile.fileDetails||(vm.customer.sysFile={fileId:"",fileType:"",fileDetails:[]}),s.customer.sysFile.fileDetails.push(t),layer.close(n)}}else layer.alert("上传失败，请联系人员")},error:function(){layer.alert("上传失败，请检查文件的大小")}}),n=layer.open({title:"上传文件",type:1,area:["420px","230px"],btn:["确认","取消"],yes:function(){t.upload()},btn2:function(){},content:$("#uploadConfirm")})})},cancle:function(){window.parent.closeCurrentTab({exit:!0,openTime:this.openTime})},validatephone:function(e){if(""!=e){/^1(3|4|5|7|8)\d{9}$/.test(e)||layer.alert("请填写正确手机号")}},validatemail:function(e){if(""!=e){/^[a-z0-9]+([._\-]*[a-z0-9])*@([a-z0-9]+[-a-z0-9]*[a-z0-9]+.){1,63}[a-z0-9]+$/.test(e)||layer.alert("请填写正确的邮箱")}},handleSuccess:function(e,t){if("100100"==e.code){var a=e.data;vm.customer.sysFile.fileDetails||(vm.customer.sysFile={fileId:"",fileType:"",fileDetails:[]}),vm.customer.sysFile.fileDetails.push(a)}else layer.alert("上传失败")},handleFormatError:function(e){this.$Notice.warning({title:"提示",desc:"文件上传失败，请联系技术人员"})},handleMaxSize:function(e){this.$Notice.warning({title:"提示",desc:"文件: "+e.name+" 的大小超过2M,请上传小于2M的文件"})},handleBeforeUpload:function(){},modalOk:function(){this.showUpload=!1},modalCancel:function(){},initFormValidate:function(){var e={onfocusout:function(e){$(e).valid()},onkeyup:!1,rules:{customerCode:{required:!0,remote:{url:contextPath+"/tbasecustomer/findByName",type:"post",dataType:"json",data:{id:function(){return vm.customer.id}},dataFilter:function(e,t){return"100100"!==JSON.parse(e).code}}},name:{required:!0,remote:{url:contextPath+"/tbasecustomer/findByName",type:"post",dataType:"json",data:{id:function(){return vm.customer.id}},dataFilter:function(e,t){return"100100"!==JSON.parse(e).code}}},abbreviation:{required:!0,remote:{url:contextPath+"/tbasecustomer/findByName",type:"post",dataType:"json",data:{id:function(){return vm.customer.id}},dataFilter:function(e,t){return"100100"!==JSON.parse(e).code}}},vatrate:{maxlength:50},credits:{maxlength:50},billingMethod:{required:!0},remark:{maxlength:255}},messages:{customerCode:{required:"请填写编码!",remote:"该编码已存在!"},name:{required:"请填写名称!",remote:"该名称已存在!"},abbreviation:{required:"请填写简称!",remote:"该简称已存在!"}}};$.validator.addMethod("pattern",function(e,t,a){return!!a.test(e)}),$.validator.addMethod("isPositiveInteger",function(e,t){return this.optional(t)||/^([0-9]*[1-9][0-9]*)$/.test(e)},"请输入正整数"),$.validator.addMethod("isDecimal",function(e,t){return this.optional(t)||/^(\d{1,2}(\.\d{1,2})?|100)$/.test(e)},"0-100之间的数据，支持2位小数!"),$.validator.addMethod("onlyDecimal",function(e,t){return this.optional(t)||/(([0]\.\d{1,2}|[1-9][0-9]*\.\d{1,2}))$/.test(e)},"只能填写小数,不能超过2位小数!"),$.validator.addMethod("isBlank",function(e,t){return this.optional(t)||/^\s+$/.test(e)},"请输入正确的值，禁止全部空格!"),$("form").validate(e)}},mounted:function(){this.initFormValidate(),this.openTime=window.parent.params.openTime}});