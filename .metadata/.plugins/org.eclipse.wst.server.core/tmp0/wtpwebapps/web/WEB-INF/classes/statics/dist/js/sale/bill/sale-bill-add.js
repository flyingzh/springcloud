"use strict";new Vue({el:"#sale-settlement",data:function(){return{openName:"",openTime:"",organ:{currentOrganization:{orgName:""},userCurrentOrganId:""},modalTrigger:!1,modalType:"",stepList:[],approvalTableData:[],inParams:{},boeType:"S_STATEMENT",isDisable:!0,isDetailTabShow:!1,isTabShow:!1,isUpdateDisable:!1,otherDisable:!0,outStockTotalAmount:0,goodsInfoTotalNum:0,goodsInfoTotalWeight:0,goodsInfoTotalAmount:0,goldInfoTotalWeight:0,updateFlag:2,goodList:[],productDetailModal:{showModal:!1,dataSourceType:!1,dataSource:null,ids:{goodsId:"",commodityId:"",documentType:"W_STOCK_IN"},overEdit:!1,specialAttr:{stone:{},gold:{},part:{}}},showProductDetails:!1,selectedIndex:0,saleBillVo:{id:"",documentNo:"",organizationId:"",organizationName:"",customerId:"",custNo:"",custName:"",documentStatus:1,billTime:"",remark:"",pricingMethod:{},totalLaborCost:0,totalGoldAmount:0,totalStoneAmount:0,totalAccessoryAmount:0,inspectionCost:"",postalCost:"",totalInsurancePrice:"",totalOtherAmount:0,currentReceiptAmount:0,lastReceiptAmount:0,currentOtherAmount:0,totalReceiptAmount:0,createId:"",createName:"",createTime:"",updateId:"",updateName:"",updateTime:"",auditId:"",auditName:"",auditTime:"",isDel:1,saleBillOutStockCollectList:[],saleBillGoodsInfoList:[],saleBillGoodsDetailList:[],saleBillGoldInfoList:[],saleBillStoneInfoList:[],saleBillAccessoryInfoList:null,saleBillInventoryList:[]}}},methods:{isEdit:function(t,e){eventHub.$emit("isEdit",t)},saveAccess:function(t,e,l){eventHub.$emit("saveFile",t,e)},getAccess:function(t,e,l){eventHub.$emit("queryFile",t,e)},saveOfUpdate:function(){var e=this;$.ajax({type:"POST",url:contextPath+"/saleBillController/editSaleBill",data:JSON.stringify(e.saleBillVo),contentType:"application/json;charset=utf-8",dataType:"json",success:function(t){"100100"===t.code?(e.$Modal.success({title:"提示",content:"保存成功!"}),e.saveAccess(t.data.id,e.boeType),e.saleBillVo.updateId=t.data.updateId,e.saleBillVo.updateName=t.data.updateName,e.saleBillVo.updateTime=t.data.updateTime):e.$Modal.warning({title:"提示",content:"保存失败!"})},error:function(t){e.$Modal.warning({title:"提示",content:"服务器出错!"}),e.saleBillVo.documentStatus=1}})},saveOfAdd:function(){var e=this;e.saleBillVo.documentStatus=1,$.ajax({type:"POST",url:contextPath+"/saleBillController/saveAll",data:JSON.stringify(e.saleBillVo),contentType:"application/json;charset=utf-8",dataType:"json",success:function(t){"100100"===t.code?(e.$Modal.success({title:"提示",content:"保存成功!"}),e.saveAccess(t.data.id,e.boeType),e.saleBillVo.id=t.data.id,e.saleBillVo.createId=t.data.createId,e.saleBillVo.createName=t.data.createName,e.saleBillVo.createTime=t.data.createTime):(e.$Modal.warning({title:"提示",content:"保存失败!"}),e.saleBillVo.documentStatus=1)},error:function(t){e.$Modal.warning({title:"提示",content:"服务器出错!"})}})},save:function(){this.saleBillVo.id?this.saveOfUpdate():this.saveOfAdd()},submit:function(){this.saleBillVo.id?this.submitOfUpdate():this.submitOfAdd()},submitOfUpdate:function(){var e=this;e.saleBillVo.documentStatus=2,$.ajax({type:"POST",url:contextPath+"/saleBillController/editSaleBill",data:JSON.stringify(e.saleBillVo),contentType:"application/json;charset=utf-8",dataType:"json",success:function(t){"100100"===t.code?(e.$Modal.success({title:"提示",content:"提交成功!"}),e.saveAccess(t.data.id,e.boeType),e.isEdit("N"),e.isUpdateDisable=!0,e.setValueZero(),e.saleBillVo.updateId=t.data.updateId,e.saleBillVo.updateName=t.data.updateName,e.saleBillVo.updateTime=t.data.updateTime):(e.$Modal.warning({title:"提示",content:"提交失败!"}),e.saleBillVo.documentStatus=1)},error:function(t){e.$Modal.warning({title:"提示",content:"服务器出错!"})}})},submitOfAdd:function(){var e=this;e.saleBillVo.documentStatus=2,$.ajax({type:"POST",url:contextPath+"/saleBillController/saveAll",data:JSON.stringify(e.saleBillVo),contentType:"application/json;charset=utf-8",dataType:"json",success:function(t){"100100"===t.code?(e.$Modal.success({title:"提示",content:"提交成功!"}),e.saveAccess(t.data.id,e.boeType),e.isEdit(1===e.saleBillVo.documentStatus?"Y":"N"),e.saleBillVo.id=t.data.id,e.isUpdateDisable=!0,e.setValueZero(),e.saleBillVo.createId=t.data.createId,e.saleBillVo.createName=t.data.createName,e.saleBillVo.createTime=t.data.createTime):(e.$Modal.warning({title:"提示",content:"提交失败!"}),e.saleBillVo.documentStatus=1)},error:function(t){e.$Modal.warning({title:"提示",content:"服务器出错!"})}})},setValueZero:function(){null!==this.saleBillVo.inspectionCost&&""!==this.saleBillVo.inspectionCost||(this.saleBillVo.inspectionCost=0),null!==this.saleBillVo.postalCost&&""!==this.saleBillVo.postalCost||(this.saleBillVo.postalCost=0),null!==this.saleBillVo.totalInsurancePrice&&""!==this.saleBillVo.totalInsurancePrice||(this.saleBillVo.totalInsurancePrice=0)},setValueNull:function(){null===this.saleBillVo.inspectionCost&&(this.saleBillVo.inspectionCost=""),null===this.saleBillVo.postalCost&&(this.saleBillVo.postalCost=""),null===this.saleBillVo.totalInsurancePrice&&(this.saleBillVo.totalInsurancePrice="")},approve:function(){var t=this;t.modalType="approve",t.modalTrigger=!t.modalTrigger},reject:function(){var t=this;t.modalType="reject",t.modalTrigger=!t.modalTrigger},approvalOrRejectCallBack:function(t){"100515"===t.result.code&&("approve"===this.modalType&&this.updateData(this.saleBillVo.documentNo,4),"reject"===this.modalType&&this.updateData(this.saleBillVo.documentNo,1)),"100100"===t.result.code&&(this.saleBillVo.documentStatus=t.result.data.documentStatus,this.saleBillVo.updateName=t.result.data.updateName,this.saleBillVo.updateTime=t.result.data.updateTime,4===this.saleBillVo.documentStatus&&(this.saleBillVo.auditName=t.result.data.auditName,this.saleBillVo.auditTime=t.result.data.auditTime),1===this.saleBillVo.documentStatus&&(this.isUpdateDisable=!1,this.setValueNull())),this.isEdit(1===this.saleBillVo.documentStatus?"Y":"N")},exit:function(){window.parent.closeCurrentTab({name:this.openName,exit:!0,openTime:this.openTime})},updateData:function(t,l){var a=this;$.ajax({type:"POST",contentType:"application/json",url:contextPath+"/saleBillController/update",data:JSON.stringify({documentNo:t,documentStatus:l}),dataType:"json",success:function(t){var e="审核";1===l&&(e="驳回"),"100100"===t.code?(a.$Modal.success({title:"提示",content:e+"成功!"}),a.saleBillVo.documentStatus=t.data.documentStatus,a.saleBillVo.updateName=t.data.updateName,a.saleBillVo.updateTime=t.data.updateTime,a.saleBillVo.auditName=t.data.auditName,a.saleBillVo.auditTime=t.data.auditTime,1===a.saleBillVo.documentStatus&&(a.isEdit("Y"),a.isUpdateDisable=!1,a.setValueNull())):a.$Modal.success({title:"提示",content:e+"失败!"})},error:function(t){a.$Modal.warning({title:"提示",content:"服务器出错"})}})},getFieldCode:function(){var e=this;$.ajax({type:"POST",url:contextPath+"/saleBillController/getFieldCode",contentType:"application/json",dataType:"json",success:function(t){"100100"===t.code?e.saleBillVo.documentNo=t.data:e.$Modal.warning({title:"提示",content:"自动生成单据编号异常,请联系管理员!"})},error:function(t){e.$Modal.warning({title:"提示",content:"服务器出错!"})}})},initOrder:function(t){this.goodList=t.saleBillGoodsDetailList},showProductDetail:function(t){var e=this;this.selectedIndex=t;var l={goodsId:this.goodList[t].goodsId,documentType:"W_STOCK_IN"};Object.assign(this.productDetailModal,{showModal:!0,ids:l}),this.$nextTick(function(){e.$refs.modalRef.getProductDetail()})},modalSure:function(t){console.log(t)},modalCancel:function(t){},productDetailModalClick:function(t){console.log(t),"attr_ranges_goods"===this.goodList[this.selectedIndex].goodsMainType?Object.assign(this.goodList[this.selectedIndex],{tBaseBomEntity:t,assistAttrs:null,overEdit:!0}):Object.assign(this.goodList[this.selectedIndex],{assistAttrs:t,tBaseBomEntity:null,overEdit:!0})},isHintShow:function(){},getOrganization:function(){var e=this;$.ajax({type:"POST",async:!1,url:contextPath+"/saleBillController/getOrganization",contentType:"application/json",dataType:"json",success:function(t){"100100"===t.code?e.organ=t.data:e.$Modal.warning({title:"提示",content:"获取组织信息异常,请联系管理员!"})},error:function(t){e.$Modal.warning({title:"提示",content:"服务器出错!"})}})},jumpOutStock:function(t){window.parent.activeEvent({name:"销售出库单-查看",url:contextPath+"/sale/saleoutstock/saleoutstock-add.html",params:{type:"other",data:t}})},getSaleBillInfo:function(t){var e=this,l={};return $.ajax({type:"POST",async:!1,url:contextPath+"/saleBillController/getSaleBillVoInfo",data:JSON.stringify({documentNo:t}),contentType:"application/json",dataType:"json",success:function(t){console.log(t.data),"100100"===t.code?(1!==(l=t.data).documentStatus&&(null===l.inspectionCost&&(l.inspectionCost=0),null===l.postalCost&&(l.postalCost=0),null===l.totalInsurancePrice&&(l.totalInsurancePrice=0)),null===l.totalOtherAmount&&(l.totalOtherAmount=0),null===l.currentReceiptAmount&&(l.currentReceiptAmount=0),null===l.lastReceiptAmount&&(l.lastReceiptAmount=0),null===l.currentOtherAmount&&(l.currentOtherAmount=0),null===l.totalReceiptAmount&&(l.totalReceiptAmount=0),null===l.saleBillGoodsInfoList&&(l.saleBillGoodsInfoList=[]),null===l.saleBillGoodsDetailList&&(l.saleBillGoodsDetailList=[]),null===l.saleBillGoldInfoList&&(l.saleBillGoldInfoList=[]),null===l.saleBillStoneInfoList&&(l.saleBillStoneInfoList=[]),null===l.saleBillAccessoryInfoList&&(l.saleBillAccessoryInfoList=[]),null===l.saleBillInventoryList&&(l.saleBillInventoryList=[])):e.$Modal.warning({title:"提示",content:"系统繁忙，请稍后再试!"})},error:function(t){e.$Modal.warning({title:"提示",content:"服务器出错!"})}}),l},setLineInfoAmount:function(){var e=this;this.saleBillVo.saleBillOutStockCollectList.forEach(function(t){e.outStockTotalAmount+=t.totalAmount}),this.saleBillVo.saleBillGoodsInfoList.forEach(function(t){e.goodsInfoTotalNum+=t.num,e.goodsInfoTotalWeight+=t.totalWeight,e.goodsInfoTotalAmount+=t.totalAmount}),null!==this.saleBillVo.saleBillGoldInfoList&&this.saleBillVo.saleBillGoldInfoList.forEach(function(t){e.goldInfoTotalWeight+=t.consumptionWeight})},setLineInfo:function(){var t=this.getSaleBillInfo(this.inParams.documentNo);this.saleBillVo=t,this.setLineInfoAmount()},getSaleBillOtherInfo:function(){var e=this;$.ajax({type:"POST",async:!1,url:contextPath+"/saleBillController/getSaleBillOtherInfo",data:JSON.stringify(e.saleBillVo.saleBillOutStockCollectList),contentType:"application/json",dataType:"json",success:function(t){console.log(t.data),"100100"===t.code?(null!==t.data.saleBillGoodsInfoList&&(e.saleBillVo.saleBillGoodsInfoList=t.data.saleBillGoodsInfoList),null!==t.data.saleBillGoodsDetailList&&(e.saleBillVo.saleBillGoodsDetailList=t.data.saleBillGoodsDetailList),null!==t.data.saleBillGoldInfoList&&(e.saleBillVo.saleBillGoldInfoList=t.data.saleBillGoldInfoList),null!==t.data.saleBillStoneInfoList&&(e.saleBillVo.saleBillStoneInfoList=t.data.saleBillStoneInfoList),null!==t.data.saleBillAccessoryInfoList&&(e.saleBillVo.saleBillAccessoryInfoList=t.data.saleBillAccessoryInfoList),null!==t.data.saleBillInventoryList&&(e.saleBillVo.saleBillInventoryList=t.data.saleBillInventoryList)):e.$Modal.warning({title:"提示",content:"系统繁忙，请稍后再试!"})},error:function(t){e.$Modal.warning({title:"提示",content:"服务器出错!"})}})},setAmount:function(){var e=this;this.inParams.data.forEach(function(t){e.saleBillVo.totalLaborCost+=t.totalLaborCost,e.saleBillVo.totalGoldAmount+=t.goldAmount,e.saleBillVo.totalStoneAmount+=t.stoneAmount,e.saleBillVo.totalAccessoryAmount+=t.accessoryAmount,e.saleBillVo.totalOtherAmount+=t.totalOtherAmount})},checkNum:function(t,e,l){htInputNumber(t,e,l),this.setCurrentReceiptAmount()},setCurrentReceiptAmount:function(){var t=this.getCurrentReceiptAmount();this.saleBillVo.currentReceiptAmount=(parseFloat(t)+parseFloat(null===this.saleBillVo.inspectionCost?0:""===this.saleBillVo.inspectionCost?0:this.saleBillVo.inspectionCost)+parseFloat(null===this.saleBillVo.postalCost?0:""===this.saleBillVo.postalCost?0:this.saleBillVo.postalCost)+parseFloat(null===this.saleBillVo.totalInsurancePrice?0:""===this.saleBillVo.totalInsurancePrice?0:this.saleBillVo.totalInsurancePrice)).toFixed(2),this.setTotalReceiptAmount()},setTotalReceiptAmount:function(){this.saleBillVo.totalReceiptAmount=parseFloat(null===this.saleBillVo.lastReceiptAmount?0:""===this.saleBillVo.lastReceiptAmount?0:this.saleBillVo.lastReceiptAmount)+parseFloat(null===this.saleBillVo.currentReceiptAmount?0:""===this.saleBillVo.currentReceiptAmount?0:this.saleBillVo.currentReceiptAmount)-parseFloat(null===this.saleBillVo.currentOtherAmount?0:""===this.saleBillVo.currentOtherAmount?0:this.saleBillVo.currentOtherAmount)},getCurrentReceiptAmount:function(){var e=0;return null!=this.inParams.data?this.inParams.data.forEach(function(t){e+=t.totalActualAmount}):e=this.outStockTotalAmount,this.saleBillVo.currentReceiptAmount=e},getLastReceiptAmount:function(){var e=this;$.ajax({type:"POST",async:!1,url:contextPath+"/saleBillController/getLastReceiptAmount",data:{custName:e.saleBillVo.custName},dataType:"json",success:function(t){"100100"===t.code&&(null!==t.data?e.saleBillVo.lastReceiptAmount=t.data:e.saleBillVo.lastReceiptAmount=0)},error:function(t){e.$Modal.warning({title:"提示",content:"服务器出错!"})}})},getCurrentOtherAmount:function(){var e=this;$.ajax({type:"POST",async:!1,url:contextPath+"/saleBillController/getCurrentOtherAmount",data:{customerId:e.saleBillVo.customerId},dataType:"json",success:function(t){"100100"===t.code&&(null!==t.data?e.saleBillVo.currentOtherAmount=t.data:e.saleBillVo.currentOtherAmount=0)},error:function(t){e.$Modal.warning({title:"提示",content:"服务器出错!"})}})},pricingMethodDeal:function(){var e=this;"1"===this.saleBillVo.pricingMethod?(this.isTabShow=!0,this.saleBillVo.totalLaborCost=0,this.saleBillVo.totalGoldAmount=0,this.saleBillVo.totalStoneAmount=0,this.saleBillVo.totalAccessoryAmount=0,this.inParams.data.forEach(function(t){e.saleBillVo.totalOtherAmount+=t.totalOtherAmount})):this.setAmount()},getInputParams:function(){this.inParams=window.parent.params.params,this.openName=window.parent.params.name,this.openTime=window.parent.params.openTime},setOutStockList:function(){var l=[];this.inParams.data.forEach(function(t){var e={};e.sourceDocumentNo=t.outStockNo,e.outStockTime=t.createTime,e.totalNum=t.totalNum,e.totalWeight=t.totalWeight,e.totalAmount=t.totalActualAmount,e.pricingMethod=t.pricingMethod,l.push(e)}),this.saleBillVo.saleBillOutStockCollectList=l},setCustomerInfo:function(){this.saleBillVo.custNo=this.inParams.data[0].custNo,this.saleBillVo.customerId=this.inParams.data[0].customerId,this.saleBillVo.custName=this.inParams.data[0].custName}},mounted:function(){this.getInputParams(),this.getOrganization(),"update"===this.inParams.type&&(this.setLineInfo(),1!==this.saleBillVo.documentStatus&&(this.isUpdateDisable=!0),this.isEdit(1===this.saleBillVo.documentStatus?"Y":"N"),this.getAccess(this.saleBillVo.id,this.boeType),"1"===this.saleBillVo.pricingMethod&&(this.isTabShow=!0)),"add"===this.inParams.type&&(this.getFieldCode(),this.isEdit("Y"),this.setOutStockList(),this.getSaleBillOtherInfo(),this.setLineInfoAmount(),this.saleBillVo.billTime=(new Date).format("yyyy-MM-dd HH:mm:ss"),this.setCustomerInfo(),this.saleBillVo.pricingMethod=this.inParams.data[0].pricingMethod,this.pricingMethodDeal(),this.getCurrentReceiptAmount(),this.getLastReceiptAmount(),this.getCurrentOtherAmount(),this.setTotalReceiptAmount()),null!==this.saleBillVo.saleBillGoodsDetailList&&0===this.saleBillVo.saleBillGoodsDetailList.length&&(this.isDetailTabShow=!0),this.initOrder(this.saleBillVo),this.saleBillVo.organizationName=this.organ.currentOrganization.orgName,this.saleBillVo.organizationId=this.organ.userCurrentOrganId}});