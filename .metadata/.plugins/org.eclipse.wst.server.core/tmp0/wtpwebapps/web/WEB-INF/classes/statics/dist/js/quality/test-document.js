"use strict";var _extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i])}return t};function _defineProperty(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var vm=new Vue({el:"#imcomingReport",data:function(){var t;return _defineProperty(t={isLook:!0,isEdit:!1,reload:!1,showSourceModal:!1,testMessagePane:"first",showHighSearch:!1,showDepartment:!1,uploadShow:!0,resultSelectedIndex:null,otherSearch:[],styleResultArray:[],body:{report_type:"",report_code:"",date_start:"",date_end:""},testOrgTypeChild:[],queryStyleCategoryChild:[],testResultChild:[],documentStatusChild:"",inspectorChild:[],badReasonsChild:[],productType:"",testedOrganizationNameChild:[],commodityCategoty:[],productData:[],categoryType:[],testedOrganizationIdTemp:"",productGroupTemp:"",canInput:!0,testWayDisabled:!1,showAll:!1,showTestedOrganizationId:!1,showCategoryType:!1,documentCode:"",openTime:"",params:"",treeSetting:{callback:{onClick:this.treeClickCallBack,beforeClick:this.treeBeforeClick}},imcoming:{tQcTestDocumentEntity:{id:"",testTotalAmount:"",qualifiedPercent:"",documentCode:"",documentType:"",businessType:"",documentTime:(new Date).format("yyyy-MM-dd")||"",documentStatus:"",qualifiedTotalAmount:"",testResult:"",testedOrganizationName:"",testedOrganizationId:"",testedOrganizationType:"",productTypeName:"",testDepartmentName:"",testDepartmentId:"",inspectorId:"",inspectorName:"",testFinishTime:"",unqualifiedTotalAmount:"",totalTestConclusion:"",supplierOrCustomerCode:"",organizationId:"",secondProductTypeId:"",createName:"",createTime:"",updateName:"",updateTime:"",examineVerifyName:"",examineVerifyTime:"",productGroup:[],correctPreventId:"",testReportId:"",sysFile:{fileDetails:[]}},tqcStyleTestInfoVo:{id:"",index:"",productStyleId:"",productTypeId:"",productCode:"",testDocumentId:"",testStatus:"",testWay:"",qualifiedAmount:"",testAmount:"",qualifiedPercent:"",unqualifiedAmount:"",testResult:"",resultDescribeSuggest:"",hasSourceTestWay:0,name:"",styleTestItems:[]},styleInput:{}},testWays:[],testStatusArr:[],testResultArr:[]},"documentStatusChild",[{value:"1",label:"暂存"},{value:"2",label:"待审核"},{value:"3",label:"审核中"},{value:"4",label:"已审核"},{value:"5",label:"驳回"}]),_defineProperty(t,"needReload",!1),_defineProperty(t,"isStampShow",!1),_defineProperty(t,"stepList",[]),_defineProperty(t,"modalTrigger",!1),_defineProperty(t,"modalType",""),_defineProperty(t,"approvalTableData",[]),_defineProperty(t,"treeUrl",contextPath+"/documentAllController/getDeptInfoByCurrentUserOrgId"),_defineProperty(t,"showUpload",!1),t},methods:{isFilled:function(t,e){""!==t?$("#"+e+"-error").css("display","none"):$("#"+e+"-error").css("display","block")},treeClickCallBack:function(t,e,n){var i=this;console.log(111,i.imcoming.tQcTestDocumentEntity.testDepartmentName),i.imcoming.tQcTestDocumentEntity.inspectorId="",i.imcoming.tQcTestDocumentEntity.testDepartmentName===n.name?(i.imcoming.tQcTestDocumentEntity.testDepartmentName=n.name,i.imcoming.tQcTestDocumentEntity.testDepartmentId=n.id,console.log(1111)):(i.imcoming.tQcTestDocumentEntity.testDepartmentId=n.id,i.imcoming.tQcTestDocumentEntity.testDepartmentName=n.name,i.inspectorAsk(i.imcoming.tQcTestDocumentEntity.testDepartmentId),console.log(222)),i.showDepartment=!1},treeBeforeClick:function(t,e,n){return!e.isParent},showDepartmentTree:function(t){"1"!=this.imcoming.tQcTestDocumentEntity.documentStatus&&(this.showDepartment=!0),!0!==this.showDepartment?this.showDepartment=t:this.showDepartment=!1},highSearch:function(){this.showHighSearch=!this.showHighSearch},addSearch:function(){this.otherSearch.push({name:"",include:"",key:""})},deleteSearch:function(t){this.otherSearch.splice(t,1)},commonTransferData:function(){var n=this,i=this;if(i.imcoming.tqcStyleTestInfoVo.styleTestItems){var o={};i.badReasonsChild.map(function(t){o[t.value.toString()]=t.name}),i.styleResultArray.map(function(t,e){t.styleTestItems&&t.styleTestItems.map(function(t,e){t.badReasonName=o[t.badReasonId];var n=t.testItemEntity.id;t.testItemId=n})});for(var t=0,e=this.styleResultArray.length;t<e;t++){var s=Object.assign({},{testStatus:"jihua"});Object.assign(i.styleResultArray[t],_extends({},s))}i.productData.map(function(t,e){t.id===i.imcoming.tQcTestDocumentEntity.productTypeId&&(i.imcoming.tQcTestDocumentEntity.productTypeName=t.name)}),this.testedOrganizationNameChild.map(function(t,e){t.id==n.imcoming.tQcTestDocumentEntity.testedOrganizationId&&(n.imcoming.tQcTestDocumentEntity.testedOrganizationName=t.name)}),this.inspectorChild.forEach(function(t){t.id==n.imcoming.tQcTestDocumentEntity.inspectorId&&(n.imcoming.tQcTestDocumentEntity.inspectorName=t.empName)})}},verify:function(t){var e=this;if("1"!==e.imcoming.tQcTestDocumentEntity.documentStatus)return layer.alert("单据状态不为暂存不能进行此操作！"),!1;if("submit"===t&&!1===$("form").valid())return layer.alert("请输入必填项！"),!1;for(var n=0;n<e.styleResultArray.length;n++){if(!e.styleResultArray[n].testResult)return e.$Modal.warning({title:"提示信息",content:"款式检测结果汇总列表第 "+(n+1)+" 行的检验结果为空!"}),!1;if(!e.styleResultArray[n].resultDescribeSuggest)return e.$Modal.warning({title:"提示信息",content:"款式检测结果汇总列表第 "+(n+1)+" 行的结果描述/建议为空!"}),!1;if(null===e.styleResultArray[n].unqualifiedAmount||""===e.styleResultArray[n].unqualifiedAmount)return e.$Modal.warning({title:"提示信息",content:"款式检测结果汇总列表第 "+(n+1)+" 行的不合格为空!"}),!1;if(!e.styleResultArray[n].testWay)return e.$Modal.warning({title:"提示信息",content:"款式检测结果汇总列表第 "+(n+1)+" 行的质检方式为空!"}),!1}return!0},save:function(e){var n=this;if(!n.verify(e))return!1;var t,i={type:e};n.imcoming.tQcTestDocumentEntity.id||(n.imcoming.tQcTestDocumentEntity.documentCode=n.documentCode,n.receiptsId=n.documentCode),n.commonTransferData(),t=Object.assign({},n.imcoming,{tqcStyleTestInfoVo:n.styleResultArray},i),window.top.home.loading("show"),$.ajax({type:"POST",url:contextPath+"/documentAllController/save",contentType:"application/json;charset=utf-8",dataType:"json",data:JSON.stringify(t),success:function(t){100100==t.code?(n.imcoming.tQcTestDocumentEntity.testedOrganizationName&&(n.showTestedOrganizationId=!0),n.imcoming.tQcTestDocumentEntity.productTypeId&&(n.showCategoryType=!0),"submit"===e&&(n.imcoming.tQcTestDocumentEntity.documentStatus="2",n.BannedClick(),n._isEdit("N"),$(".is-submit-disabled").css("pointer-events","none").css({color:"#bbbec4"})),n.changeTestOrgType(t.data.tQcTestDocumentEntity.documentType),n.styleResultArray=t.data.tqcStyleTestInfoVo,n.imcoming.tQcTestDocumentEntity=t.data.tQcTestDocumentEntity,n.styleResultArray.map(function(t){Object.assign(t,{overEdit:!0})}),console.log(n.styleResultArray,344523),n.imcoming.tQcTestDocumentEntity.documentTime=n.imcoming.tQcTestDocumentEntity.documentTime?new Date(n.imcoming.tQcTestDocumentEntity.documentTime).format("yyyy-MM-dd"):"",n.changeTestOrgType(t.data.tQcTestDocumentEntity.documentType),n.editTestResult(),n.saveAccess(n.imcoming.tQcTestDocumentEntity.documentCode,"Q_INVENTORY"),n.$forceUpdate(),layer.alert("操作成功！")):(n.imcoming.tQcTestDocumentEntity.documentStatus="1",layer.alert("操作失败")),window.top.home.loading("hide")},error:function(t){n.imcoming.tQcTestDocumentEntity.documentStatus="1",window.top.home.loading("hide"),console.log("服务器出错")}})},exit:function(){window.parent.closeCurrentTab({openTime:this.openTime,exit:!0})},_isEdit:function(t){eventHub.$emit("isEdit",t)},saveAccess:function(t,e){eventHub.$emit("saveFile",t,e)},getAccess:function(t,e){eventHub.$emit("queryFile",t,e)},toProductDetail:function(t){window.parent.activeEvent({name:"商品",url:contextPath+"/base-data/commodity/commodity-info.html",params:{id:t.rows.productId,type:"skip"}})},listClick:function(){window.parent.activeEvent({name:this.imcoming.tQcTestDocumentEntity.documentName,url:contextPath+"/quality/inventory/test-document-list.html",params:{name:this.imcoming.tQcTestDocumentEntity.documentName}})},changeTestOrgType:function(t){console.log("value",t);var e=this;if("kcjyd"===t)return e.imcoming.tQcTestDocumentEntity.testedOrganizationType="kc",e.imcoming.tQcTestDocumentEntity.documentType="kcjyd",e.imcoming.tQcTestDocumentEntity.businessType="kcjy",e.imcoming.tQcTestDocumentEntity.testedOrganizationTypeName="库存",e.imcoming.tQcTestDocumentEntity.documentName="库存检验单",void(e.imcoming.tQcTestDocumentEntity.businessName="库存检验");"mdjyd"===t&&(e.imcoming.tQcTestDocumentEntity.testedOrganizationType="md",e.imcoming.tQcTestDocumentEntity.documentType="mdjyd",e.imcoming.tQcTestDocumentEntity.businessType="mdjy",e.imcoming.tQcTestDocumentEntity.testedOrganizationTypeName="门店",e.imcoming.tQcTestDocumentEntity.documentName="门店检验单",e.imcoming.tQcTestDocumentEntity.businessName="门店检验",$.ajax({type:"POST",url:contextPath+"documentAllController/getOrgName",contentType:"application/json",dataType:"json",success:function(t){e.testedOrganizationNameChild=t.data,e.documentCode=t.data[0].documentCode},error:function(t){console.log("服务器出错")}}))},getCommodityTypeId:function(t){var e=this;$.ajax({type:"POST",url:contextPath+"/documentAllController/queryCategoryIdByInfoId",dataType:"json",data:{id:t},success:function(t){if(e.imcoming.tQcTestDocumentEntity.secondProductTypeId=t.data[0].id,e.resultSelectedIndex=1,0===e.styleResultArray.length)return e.styleResultArray=[],e.reInitStyleResult(),void(e.imcoming.tqcStyleTestInfoVo={id:"",index:"",productStyleId:"",productTypeId:"",productCode:"",testDocumentId:"",testStatus:"",testWay:"",qualifiedAmount:"",testAmount:"",qualifiedPercent:"",unqualifiedAmount:"",resultDescribeSuggest:"",hasSourceTestWay:0,name:"",styleTestItems:[]});e.editTestResult()},error:function(t){e.$Spin.hide(),console.log("服务器出错")}})},changeTestedOrganizationName:function(t){var e=this,n=this;if(!n.testedOrganizationIdTemp)return n.testedOrganizationIdTemp=n.imcoming.tQcTestDocumentEntity.testedOrganizationId,n.imcoming.tQcTestDocumentEntity.productTypeId&&this.getStyleInfoList(),!1;n.$Modal.confirm({title:"提示信息",content:"修改被检组织会清空下方款式检测信息的所有数据，是否确定修改？",onOk:function(){n.testedOrganizationIdTemp=n.imcoming.tQcTestDocumentEntity.testedOrganizationId,n.imcoming.tQcTestDocumentEntity.productTypeId&&e.getStyleInfoList()},onCancel:function(){n.imcoming.tQcTestDocumentEntity.testedOrganizationId=n.testedOrganizationIdTemp}})},changeproductTypeName:function(t,e){var n=this;if(!n.imcoming.tQcTestDocumentEntity.productTypeId)return n.imcoming.tQcTestDocumentEntity.productGroup=t,n.imcoming.tQcTestDocumentEntity.productTypeId=t[t.length-1],n.imcoming.tQcTestDocumentEntity.productTypeName=e[e.length-1].label,n.productGroupTemp=t,n.imcoming.tQcTestDocumentEntity.testedOrganizationId&&""!=n.imcoming.tQcTestDocumentEntity.testedOrganizationId&&n.getStyleInfoList(),!1;n.$Modal.confirm({title:"提示信息",content:"修改被检组织会清空下方款式检测信息的所有数据，是否确定修改？",onOk:function(){n.imcoming.tQcTestDocumentEntity.productGroup=t,n.imcoming.tQcTestDocumentEntity.productTypeId=t[t.length-1],n.imcoming.tQcTestDocumentEntity.productTypeName=e[e.length-1].label,n.productGroupTemp=t,n.imcoming.tQcTestDocumentEntity.testedOrganizationId&&""!=n.imcoming.tQcTestDocumentEntity.testedOrganizationId&&n.getStyleInfoList()},onCancel:function(){n.imcoming.tQcTestDocumentEntity.productGroup=n.productGroupTemp}})},getStyleInfoList:function(){var o=this;$.ajax({type:"POST",url:contextPath+"/documentAllController/queryCollect",data:JSON.stringify({warehouseId:o.imcoming.tQcTestDocumentEntity.testedOrganizationId,productTypeId:o.imcoming.tQcTestDocumentEntity.productTypeId}),contentType:"application/json",dataType:"json",success:function(t){if(100100==t.code){o.styleResultArray=t.data;for(var e=0,n=o.styleResultArray.length;e<n;e++){var i=Object.assign({},{productId:o.styleResultArray[e].productId,productName:o.styleResultArray[e].productName,testWay:o.styleResultArray[e].testWay,countUnit:o.styleResultArray[e].countUnit,weight:o.styleResultArray[e].weight,testAmount:o.styleResultArray[e].testAmount,weightUnit:o.styleResultArray[e].weightUnit,pictureUrl:o.styleResultArray[e].pictureUrl,testResult:"jyjghg"});o.styleResultArray[e].id="",Object.assign(o.styleResultArray[e],_extends({},i))}o.reInitStyleResult(),o.getCommodityTypeId(o.imcoming.tQcTestDocumentEntity.productTypeId),o.$forceUpdate()}},error:function(t){o.$Spin.hide(),console.log("服务器出错")}})},loadBadResons:function(){var c=this;$.ajax({type:"POST",url:contextPath+"/documentAllController/queryBaseDataList",data:JSON.stringify({datatypeId:5}),contentType:"application/json",dataType:"json",success:function(t){if(c.badReasonsChild=[],"100100"===t.code&&0<t.data.length){var e=!0,n=!1,i=void 0;try{for(var o,s=t.data[Symbol.iterator]();!(e=(o=s.next()).done);e=!0){var a=o.value;c.badReasonsChild.push({name:a.name,value:a.id})}}catch(t){n=!0,i=t}finally{try{!e&&s.return&&s.return()}finally{if(n)throw i}}}},error:function(t){c.$Spin.hide(),console.log("服务器出错")}})},initGoodCategory:function(t){var o=this,s=[];return t.forEach(function(t){var e=t.id,n=t.name,i=t.cateLists;i&&(i=o.initGoodCategory(i)),s.push({value:e,label:n,children:i})}),s.forEach(function(t){t.children||delete t.children}),s},initDetailData:function(){this.initStyleResult()},documentStatusAsk:function(){this.imcoming.tQcTestDocumentEntity.documentStatus="1"},testResultAsk:function(){var t=getCodeList("zj_jyjg"),e=!0,n=!1,i=void 0;try{for(var o,s=t[Symbol.iterator]();!(e=(o=s.next()).done);e=!0){var a=o.value;"jyjgtbfx"!==a.value&&(console.log("检验结果",t),this.testResultChild.push({name:a.name,value:a.value}),this.testResultArr.push({name:a.name,value:a.value}))}}catch(t){n=!0,i=t}finally{try{!e&&s.return&&s.return()}finally{if(n)throw i}}this.imcoming.tQcTestDocumentEntity.testResult="jyjghg",this.imcoming.tqcStyleTestInfoVo.testResult="jyjghg"},productTypeAsk:function(o){var s=this;$.ajax({type:"POST",url:contextPath+"/documentAllController/queryStyleCategory?parentId=0",contentType:"application/json",dataType:"json",success:function(t){if("100100"===t.code){console.log("商品类型数据：",t),s.productData=t.data.cateLists,s.categoryType=s.initGoodCategory(t.data.cateLists);var e=new Array;if(o){var n=o.substring(1,o.length-1).split(",");for(var i in n)e.push(Number(n[i]))}s.$nextTick(function(){s.imcoming.tQcTestDocumentEntity.productGroup=e})}},error:function(t){s.$Spin.hide(),console.log("服务器出错")}})},getOrgNameAsk:function(){var e=this;$.ajax({type:"POST",url:contextPath+"/documentAllController/getOrgName",contentType:"application/json",dataType:"json",success:function(t){"100100"===t.code&&(console.log("当前组织",t.data),e.imcoming.tQcTestDocumentEntity.testOrganizationName=t.data[0].name,e.documentCode=t.data[0].documentCode)},error:function(t){console.log("服务器出错")}})},inspectorAsk:function(t,e){var n=this;$.ajax({type:"POST",url:contextPath+"/documentAllController/getEmployeesByDeptId?deptId="+t,contentType:"application/json",dataType:"json",success:function(t){n.inspectorChild=[],n.$refs.insp.reset(),n.$nextTick(function(){n.inspectorChild=t.data}),n.$forceUpdate()},error:function(t){console.log("服务器出错")}})},warehouseAsk:function(e){var n=this;$.ajax({type:"POST",url:contextPath+"/documentAllController/listByOrganizationId",contentType:"application/json",dataType:"json",success:function(t){n.testedOrganizationNameChild=t.data,console.log("仓库",e),e&&(n.imcoming.tQcTestDocumentEntity.testedOrganizationId=e)},error:function(t){n.$Spin.hide(),console.log("服务器出错")}})},BannedClick:function(){var t=this;t.showAll=!0,t.canInput=!1,t.showTestedOrganizationId=!0,t.showCategoryType=!0,t.testWayDisabled=!0},allowClick:function(){var t=this;t.showAll=!1,t.canInput=!0,t.showTestedOrganizationId=!1,t.showCategoryType=!1,t.testWayDisabled=!1},editTestResult:function(){var t=this,e=this.resultSelectedIndex;this.testMessagePane="first";var n=this.styleResultArray[this.resultSelectedIndex-1];if(!n)return!1;if("cj"===n.testWay||"qj"===n.testWay||"mj"===n.testWay?this.$nextTick(function(){t.imcoming.tqcStyleTestInfoVo.testWay=n.testWay,t.testWayDisabled=!0}):this.testWayDisabled=!1,this.imcoming.tqcStyleTestInfoVo=Object.assign(this.imcoming.tqcStyleTestInfoVo,{index:e},_extends({},this.styleResultArray[this.resultSelectedIndex-1])),console.log(this.imcoming.tqcStyleTestInfoVo,11),this.styleResultArray[this.resultSelectedIndex-1].overEdit)return!1;var i=this;"add"===i.params.activeType&&$.ajax({type:"POST",url:contextPath+"/documentAllController/getTestItemByProductId",contentType:"application/json",dataType:"json",data:JSON.stringify({productId:i.imcoming.tQcTestDocumentEntity.secondProductTypeId,testNum:i.imcoming.tqcStyleTestInfoVo.testAmount}),success:function(t){if("100100"===t.code){if(t.data.length<1)return void layer.alert("请先维护商品编码为 ["+i.imcoming.tqcStyleTestInfoVo.productCode+"] 的对应检验项目");for(var e=0;e<t.data.length;e++)if(!t.data[e].samplePlanEntity)return layer.alert("请先维护 ["+t.data[e].testItemEntity.name+"] 检验项目对应检验数量："+i.imcoming.tqcStyleTestInfoVo.testAmount+" 的抽检比例 ！"),void(t.data.showTestTable=!1);t.data.map(function(t,e){var n=Object.assign({},{overEdit:!0,showTestTable:!0,allowNumber:t.samplePlanEntity&&t.samplePlanEntity.allowNumber||0,randomTestProportion:(t.samplePlanEntity&&t.samplePlanEntity.randomTestProportion||0)+"%",rejectNumber:t.samplePlanEntity&&t.samplePlanEntity.rejectNumber||0,defaultDomTestProportion:(t.samplePlanEntity&&t.samplePlanEntity.randomTestProportion||0)+"%",sampleAmount:parseInt((Number(t.samplePlanEntity&&t.samplePlanEntity.randomTestProportion)/100||0)*Number(i.imcoming.tqcStyleTestInfoVo.testAmount),10),testResult:"jyjghg",sampleUnqualifiedAmount:0});Object.assign(t,_extends({},n))}),i.imcoming.tqcStyleTestInfoVo.styleTestItems=t.data,Object.assign(i.styleResultArray[i.resultSelectedIndex-1],{overEdit:!0}),i.imcoming.tqcStyleTestInfoVo.styleTestItems.map(function(t){t.testResultTemp="jyjghg",t.testValueTemp=t.testValue,t.sampleAmountTemp=t.sampleAmount,t.sampleUnqualifiedAmountTemp=t.sampleUnqualifiedAmount,t.sampleQualifiedAmountTemp=t.sampleQualifiedAmount,t.allowNumberTemp=t.allowNumber,t.rejectNumberTemp=t.rejectNumber}),i.styleResultArray[i.resultSelectedIndex-1]=Object.assign({},i.styleResultArray[i.resultSelectedIndex-1],_extends({},i.imcoming.tqcStyleTestInfoVo)),i.$forceUpdate()}},error:function(t){i.$Spin.hide(),console.log("服务器出错")}})},changeStyleName:function(t){this.testMessagePane=t},rowClick:function(t){null!==this.resultSelectedIndex&&(this.styleResultArray[this.resultSelectedIndex-1]=Object.assign({},this.styleResultArray[this.resultSelectedIndex-1],_extends({},this.imcoming.tqcStyleTestInfoVo)),1===this.styleResultArray.length&&this.reInitStyleResult(),"first"===t?(this.resultSelectedIndex=1,this.editTestResult()):"previous"===t?(this.calculateQualifiedAmount(this.resultSelectedIndex-1),this.styleResultArray[this.resultSelectedIndex-1].testWay=this.imcoming.tqcStyleTestInfoVo.testWay,1==this.resultSelectedIndex?(this.resultSelectedIndex=1,layer.alert("已是第一条")):this.resultSelectedIndex--,this.editTestResult()):"next"===t?(this.styleResultArray[this.resultSelectedIndex-1].testWay=this.imcoming.tqcStyleTestInfoVo.testWay,this.calculateQualifiedAmount(this.resultSelectedIndex-1),this.resultSelectedIndex==this.styleResultArray.length?(this.resultSelectedIndex=this.styleResultArray.length,layer.alert("已是最后一条")):this.resultSelectedIndex++,this.editTestResult(),this.$forceUpdate()):"last"===t&&(this.resultSelectedIndex=this.styleResultArray.length,this.editTestResult()),this.imcoming.tqcStyleTestInfoVo=Object.assign({},_extends({},this.styleResultArray[this.resultSelectedIndex-1])),this.reInitStyleResult(),this.imcoming.tqcStyleTestInfoVo.index=this.resultSelectedIndex,this.$forceUpdate())},calculateQualifiedAmount:function(t){if(""!=this.imcoming.tqcStyleTestInfoVo.unqualifiedAmount&&null!=this.imcoming.tqcStyleTestInfoVo.unqualifiedAmount&&!/^[0-9]*$/.test(this.imcoming.tqcStyleTestInfoVo.unqualifiedAmount))return layer.alert("请输入正确的不合格数"),!1;if(Number(this.imcoming.tqcStyleTestInfoVo.unqualifiedAmount)>Number(this.imcoming.tqcStyleTestInfoVo.testAmount))return this.imcoming.tqcStyleTestInfoVo.unqualifiedAmount="",void layer.alert("不合格数不能大于检验数量");this.imcoming.tqcStyleTestInfoVo.qualifiedAmount=Number(this.imcoming.tqcStyleTestInfoVo.testAmount)-(Number(this.imcoming.tqcStyleTestInfoVo.unqualifiedAmount)?Number(this.imcoming.tqcStyleTestInfoVo.unqualifiedAmount):0),this.imcoming.tqcStyleTestInfoVo.qualifiedPercent=(Number(this.imcoming.tqcStyleTestInfoVo.qualifiedAmount)/Number(this.imcoming.tqcStyleTestInfoVo.testAmount)*100).toFixed(2)+"%";var e={testAmount:this.imcoming.tqcStyleTestInfoVo.testAmount,qualifiedAmount:this.imcoming.tqcStyleTestInfoVo.qualifiedAmount,unqualifiedAmount:Number(this.imcoming.tqcStyleTestInfoVo.unqualifiedAmount),qualifiedPercent:this.imcoming.tqcStyleTestInfoVo.qualifiedPercent};this.styleResultArray[t]&&(this.styleResultArray[t]=Object.assign({},this.styleResultArray[t],_extends({},e))),this.$forceUpdate(),"no"!==t&&this.calculateTotal()},calculateTotal:function(){this.imcoming.tQcTestDocumentEntity.testTotalAmount=0,this.imcoming.tQcTestDocumentEntity.unqualifiedTotalAmount=0;for(var t=this.styleResultArray.length,e=0;e<t;e++)console.log(this.styleResultArray[e].testTotalAmount),isNaN(Number(this.styleResultArray[e].testAmount))||(this.imcoming.tQcTestDocumentEntity.testTotalAmount+=Number(this.styleResultArray[e].testAmount)),isNaN(Number(this.styleResultArray[e].unqualifiedAmount))||(this.imcoming.tQcTestDocumentEntity.unqualifiedTotalAmount+=Number(this.styleResultArray[e].unqualifiedAmount));this.imcoming.tQcTestDocumentEntity.qualifiedTotalAmount=this.imcoming.tQcTestDocumentEntity.testTotalAmount-this.imcoming.tQcTestDocumentEntity.unqualifiedTotalAmount,this.imcoming.tQcTestDocumentEntity.qualifiedPercent=(this.imcoming.tQcTestDocumentEntity.qualifiedTotalAmount/this.imcoming.tQcTestDocumentEntity.testTotalAmount*100).toFixed(2)+"%"},sampleUnqualifiedAmountBlur:function(t,e){if(parseInt(t.sampleAmount)<parseInt(t.sampleUnqualifiedAmount))return t.sampleUnqualifiedAmount="",layer.alert("取样不合格数不能大于取样数"),!1;t.sampleQualifiedAmount=parseInt(t.sampleAmount)-parseInt(t.sampleUnqualifiedAmount),$(".sampleQualifiedAmount"+e).html(parseInt(t.sampleAmount)-parseInt(t.sampleUnqualifiedAmount)),parseInt(t.sampleUnqualifiedAmount,10)<=parseInt(t.allowNumber,10)?t.testResult="jyjghg":parseInt(t.sampleUnqualifiedAmount,10)>=parseInt(t.rejectNumber,10)&&(t.testResult="jyjgbhg"),this.$forceUpdate()},initStyleResult:function(){var o=this;$("#styleResult_table").jqGrid({dataType:"local",styleUI:"Bootstrap",rownumbers:!0,multiselect:!0,colNames:["检验结果","结果描述/建议","图片","商品编码","商品名称","批号","质检方式","检验数量","计数单位","总重","计重单位","合格数","不合格数","合格率","质检状态"],colModel:[{name:"testResult",index:"testResult",width:100,align:"left",formatter:function(t,e,n,i){return"jyjghg"===t?"合格":"jyjgbhg"===t?"不合格":""}},{name:"resultDescribeSuggest",index:"resultDescribeSuggest",width:120,align:"left"},{name:"pictureUrl",index:"pictureUrl",width:80,align:"center",formatter:function(t,e,n){var i=guid();$(document).on("mouseout",".can",function(){vm.hideMirror(i)}),$(document).on("mouseenter",".select"+i,function(){vm.showMirror(i)});var o=n.pictureUrl;return o?'<div class="select'+i+' can">\n                                    <img height="50px" width="50px" src="'+o+'"/>\n                                    <div class="mirror"><img class="bigimg" src="'+o+'"></div>\n                                </div>':'<div class="select${random}"></div>'}},{name:"productCode",width:80,align:"left",formatter:function(t,e,n,i){return $(document).on("click",".detail"+t,function(){o.toProductDetail({value:t,grid:e,rows:n,state:i})}),'<a class="detail'+t+'">'+t+"</a>"}},{name:"productName",width:80,align:"left"},{name:"batchNumber",width:200,align:"left"},{name:"testWay",index:"id",width:80,align:"left",formatter:function(t,e,n,i){return"cj"===t?"抽检":"mj"===t?"免检":"qj"===t?"全检":""}},{name:"testAmount",width:80,align:"right"},{name:"countingUnit",width:80,align:"right"},{name:"weight",width:80,align:"right"},{name:"weightUnit",width:80,align:"right"},{name:"qualifiedAmount",width:80,align:"right"},{name:"unqualifiedAmount",width:80,align:"right"},{name:"qualifiedPercent",width:80,align:"right"},{name:"testStatus",width:80,align:"left",formatter:function(t,e,n,i){return"jihua"===t?"计划":"zjwc"===t?"质检完成":"计划"}}],pager:!1,autoHeight:!0,onSelectRow:function(t,e){console.log("index==",t),o.resultSelectedIndex=t},beforeSelectRow:function(){$("#styleResult_table").jqGrid("resetSelection")},gridComplete:function(){var t=$("#styleResult_table");$("#cb_"+t[0].id).hide()}});for(var t=0;t<o.styleResultArray.length;t++)$("#styleResult_table").jqGrid("addRowData",t+1,o.styleResultArray[t])},reInitStyleResult:function(){$("#styleResult_table").jqGrid("clearGridData"),$("#styleResult_table").jqGrid("setGridParam",{data:this.styleResultArray}).trigger("reloadGrid"),this.initStyleResult()},showMirror:function(t){$(".select"+t+" .mirror").show()},hideMirror:function(t){$(".select"+t+" .mirror").hide()},testValueBlur:function(t){var e=t.testItemEntity.goalValueName,n=t.testValue,i=parseInt(t.testItemEntity.upperLimitValue),o=parseInt(t.testItemEntity.lowerLimitValue);console.log("target: "+e,"test: "+n,"upperLimitValue: "+i,"lowerLimitValue: "+o),"dxfx"===t.testItemEntity.analyseMethod&&"="===t.testItemEntity.compareSymbolName&&(e===n?t.testResult="jyjghg":e!==n&&(t.testResult="jyjgbhg")),"dlfx"===t.testItemEntity.analyseMethod&&("=="===t.testItemEntity.compareSymbolName&&(e===n?t.testResult="jyjghg":n<=o&&(t.testResult="jyjgbhg")),"between"===t.testItemEntity.compareSymbolName&&(console.log(334552,t.testItemEntity.compareSymbolName),t.testResult=n<=i&&o<=n?"jyjghg":"jyjgbhg"),">="===t.testItemEntity.compareSymbolName&&(e<=n?t.testResult="jyjghg":n<=e&&(t.testResult="jyjgbhg")),"<="===t.testItemEntity.compareSymbolName&&(n<=e?t.testResult="jyjghg":n<=e&&(t.testResult="jyjgbhg")),"<>"===t.testItemEntity.compareSymbolName&&(n!==e?t.testResult="jyjghg":n===e&&(t.testResult="jyjgbhg")),">"===t.testItemEntity.compareSymbolName&&(e<n?t.testResult="jyjghg":n<e&&(t.testResult="jyjgbhg")),"<"===t.testItemEntity.compareSymbolName&&(n<e?t.testResult="jyjghg":e<n&&(t.testResult="jyjgbhg"))),this.$forceUpdate()},randomTestProportionBlur:function(t){parseFloat(t.randomTestProportion)<parseFloat(t.defaultDomTestProportion)?(layer.alert("抽检比例不能低于默认值"),t.randomTestProportion=parseFloat(t.defaultDomTestProportion)+"%"):t.sampleAmount=parseInt(parseInt(t.randomTestProportion,10)*this.imcoming.tqcStyleTestInfoVo.testAmount/100,10),this.$forceUpdate()},testWayChange:function(t){var e=this;"qj"===t?(this.canInput=!0,this.imcoming.tqcStyleTestInfoVo.styleTestItems.map(function(t){t.testResult="jyjghg",t.randomTestProportion="100%",t.testValue=t.testValueTemp,t.sampleAmount=e.imcoming.tqcStyleTestInfoVo.testAmount,t.sampleUnqualifiedAmount=0,t.sampleQualifiedAmount=e.imcoming.tqcStyleTestInfoVo.testAmount,t.allowNumber="",t.rejectNumber=""})):"mj"===t?this.imcoming.tqcStyleTestInfoVo.styleTestItems.map(function(t){t.testResult="jyjghg",t.randomTestProportion="100%",t.sampleAmount=e.imcoming.tqcStyleTestInfoVo.testAmount,t.sampleUnqualifiedAmount=0,t.sampleQualifiedAmount=e.imcoming.tqcStyleTestInfoVo.testAmount,t.allowNumber="",t.rejectNumber=""}):"cj"===t&&(this.imcoming.tqcStyleTestInfoVo.styleTestItems.map(function(t){t.testResult="jyjghg",t.testValue=t.testValueTemp,t.randomTestProportion=t.defaultDomTestProportion,t.sampleAmount=t.sampleAmountTemp,t.sampleUnqualifiedAmount=0,t.sampleQualifiedAmount=t.sampleQualifiedAmountTemp,t.allowNumber=t.allowNumberTemp,t.rejectNumber=t.rejectNumberTemp}),this.canInput=!0)},htPrint:function(t){function e(){return t.apply(this,arguments)}return e.toString=function(){return t.toString()},e}(function(){htPrint()}),reGetApprovalMessage:function(){$("#approvalList").jqGrid("clearGridData"),$("#approvalList").jqGrid("setGridParam",{postData:{receiptsId:this.receiptsId}}).trigger("reloadGrid")},createReport:function(){"4"===this.imcoming.tQcTestDocumentEntity.documentStatus?window.parent.activeEvent({name:"生成报告单",url:contextPath+"/quality/quality/inspection-report2.html",params:{testDocumentId:this.imcoming.tQcTestDocumentEntity.id,code:this.imcoming.tQcTestDocumentEntity.documentCode}}):layer.alert("该单未完成审核，不能生成报告单")},approval:function(){var t=this;if("1"==t.imcoming.tQcTestDocumentEntity.documentStatus||!t.imcoming.tQcTestDocumentEntity.documentCode)return t.$Modal.error({title:"警告!",content:"请先提交单据!"}),!1;t.modalType="approve",t.modalTrigger=!t.modalTrigger},reject:function(){var t=this;if(1===t.imcoming.tQcTestDocumentEntity.documentStatus||!t.imcoming.tQcTestDocumentEntity.documentCode)return t.$Modal.error({title:"警告!",content:"请先提交单据!"}),!1;t.imcoming.tQcTestDocumentEntity.correctPreventId?layer.alert("已生成纠正预防单，不可驳回！"):t.imcoming.tQcTestDocumentEntity.testReportId?layer.alert("已生成检验报告单，不可驳回！"):(t.modalType="reject",t.modalTrigger=!t.modalTrigger)},approvalOrRejectCallBack:function(t){var e=this;if("100100"==t.result.code)if(e.imcoming.tQcTestDocumentEntity.documentStatus=t.result.data+"",console.log(e.imcoming.tQcTestDocumentEntity.documentStatus,t),1==e.imcoming.tQcTestDocumentEntity.documentStatus)e.isStampShow=!1,e.allowClick(),e.imcoming.tQcTestDocumentEntity.examineVerifyName="",e.imcoming.tQcTestDocumentEntity.examineVerifyTime="",e._isEdit("Y"),$(".is-submit-disabled").css({"pointer-events":"auto "}).css({color:"#495060"});else if("2"==e.imcoming.tQcTestDocumentEntity.documentStatus);else if("3"==e.imcoming.tQcTestDocumentEntity.documentStatus);else if("4"==e.imcoming.tQcTestDocumentEntity.documentStatus){e.isStampShow=!0,e.imcoming.tQcTestDocumentEntity.testFinishTime=(new Date).format("yyyy-MM-dd HH:mm:ss")||"",e.imcoming.tQcTestDocumentEntity.examineVerifyName=layui.data("user").username,e.imcoming.tQcTestDocumentEntity.examineVerifyTime=(new Date).format("yyyy-MM-dd HH:mm:ss")||"",$(".is-htPrint").css({"pointer-events":"auto "}).css({color:"#495060"});for(var n=0,i=e.styleResultArray.length;n<i;n++){var o=Object.assign({},{testStatus:"zjwc"});Object.assign(e.styleResultArray[n],_extends({},o))}e.reInitStyleResult()}else{if("5"!=e.imcoming.tQcTestDocumentEntity.documentStatus)return e.$Modal.warning({content:"审核异常!",title:"警告"}),!1;e.isStampShow=!1,e.imcoming.tQcTestDocumentEntity.testFinishTime="",e.imcoming.tQcTestDocumentEntity.examineVerifyName="",e.imcoming.tQcTestDocumentEntity.examineVerifyTime="";for(var s=0,a=e.styleResultArray.length;s<a;s++){var c=Object.assign({},{testStatus:"jihua"});Object.assign(e.styleResultArray[s],_extends({},c))}e.reInitStyleResult()}},autoSubmitOrReject:function(t){var c=this;$.ajax({url:contextPath+"/entrustOut/submitapproval?submitType=1",method:"post",contentType:"application/json;charset=utf-8",data:JSON.stringify({receiptsId:c.imcoming.tQcTestDocumentEntity,approvalResult:"reject"==c.modalType?1:0}),success:function(t){if("100100"===t.code){if(c.imcoming.tQcTestDocumentEntity.documentStatus=parseInt(t.data),1==c.imcoming.tQcTestDocumentEntity.documentStatus){c.isStampShow=!1,c.imcoming.tQcTestDocumentEntity.testFinishTime="",c.imcoming.tQcTestDocumentEntity.examineVerifyName="",c.imcoming.tQcTestDocumentEntity.examineVerifyTime="";for(var e=0,n=c.styleResultArray.length;e<n;e++){var i=Object.assign({},{testStatus:"jihua"});Object.assign(c.styleResultArray[e],_extends({},i))}c.reInitStyleResult()}else if(4==c.imcoming.tQcTestDocumentEntity.documentStatus){c.isStampShow=!0,c.imcoming.tQcTestDocumentEntity.testFinishTime=(new Date).format("yyyy-MM-dd HH:mm:ss")||"",c.imcoming.tQcTestDocumentEntity.examineVerifyName=layui.data("user").username,c.imcoming.tQcTestDocumentEntity.examineVerifyTime=(new Date).format("yyyy-MM-dd HH:mm:ss")||"";for(var o=0,s=c.styleResultArray.length;o<s;o++){var a=Object.assign({},{testStatus:"zjwc"});Object.assign(c.styleResultArray[o],_extends({},a))}c.reInitStyleResult()}}else c.$Modal.warning({content:t.msg})}})},updateStatus:function(t,e){var n=this;$.ajax({type:"POST",url:contextPath+"/documentAllController/updateByTestDocumentIdAndStatus",data:{testDocumentId:t,documentStatus:e},dataType:"json",success:function(t){"100100"===t.code&&n.refresh()},error:function(t){n.$Spin.hide(),console.log("服务器出错")}})},echo:function(t,e){var n=this,i=contextPath+"/documentAllController/"+t+"/"+e;console.log("url",i),$.ajax({type:"POST",url:i,contentType:"application/json",dataType:"json",success:function(t){100100==t.code?(n.inspectorAsk(t.data.tQcTestDocumentEntity.testDepartmentId,t.data.tQcTestDocumentEntity.inspectorId),n.warehouseAsk(t.data.tQcTestDocumentEntity.testedOrganizationId),n.imcoming.tQcTestDocumentEntity=t.data.tQcTestDocumentEntity,n.productTypeAsk(n.imcoming.tQcTestDocumentEntity.productGroup),n.changeTestOrgType(t.data.tQcTestDocumentEntity.documentType),n.styleResultArray=t.data.tqcStyleTestInfoVo,n.initStyleResult(),n.imcoming.tqcStyleTestInfoVo=Object.assign({},n.styleResultArray[0],{index:1}),n.resultSelectedIndex=1,"query"===n.params.activeType&&($(".is-disabled").css("pointer-events","none").css({color:"#bbbec4"}),$(".is-submit-disabled").css("pointer-events","none").css({color:"#bbbec4"}),n.BannedClick(),n.isEdit("N")),"1"!=n.imcoming.tQcTestDocumentEntity.documentStatus?(n.BannedClick(),$(".is-submit-disabled").css("pointer-events","none").css({color:"#bbbec4"}),n._isEdit("N")):($(".is-submit-disabled").css({"pointer-events":"auto "}).css({color:"#495060"}),n._isEdit("Y")),n.imcoming.tQcTestDocumentEntity.testedOrganizationName&&(n.showTestedOrganizationId=!0),n.imcoming.tQcTestDocumentEntity.productTypeId&&(n.showCategoryType=!0),"4"==n.imcoming.tQcTestDocumentEntity.documentStatus&&(n.isStampShow=!0),n.imcoming.tQcTestDocumentEntity.documentTime=n.imcoming.tQcTestDocumentEntity.documentTime?new Date(n.imcoming.tQcTestDocumentEntity.documentTime).format("yyyy-MM-dd"):"",n.getAccess(n.imcoming.tQcTestDocumentEntity.documentCode,"Q_INVENTORY")):n.$Modal.warning({title:"提示！",content:"系统异常"})},error:function(t){console.log("服务器出错")}})}},created:function(){this.openTime=window.parent.params.openTime;var t=this;this.imcoming.tQcTestDocumentEntity.documentStatus="1",$(".is-htPrint").css("pointer-events","none").css({color:"#bbbec4"}),t.testResultAsk(),t.productTypeAsk(),t.getOrgNameAsk(),t.warehouseAsk(),t.loadBadResons(),t.resultSelectedIndex=1},mounted:function(){var t=this;t.params=window.parent.params.params,"add"===t.params.activeType?(this.initDetailData(),t.changeTestOrgType(t.params.documentType)):"update"===t.params.activeType?t.echo("info",t.params.docCode):"query"===t.params.activeType&&t.echo("infoByDocumentCode",t.params.docCode),"1"==t.imcoming.tQcTestDocumentEntity.documentStatus&&(t._isEdit("Y"),t.allowClick())}});