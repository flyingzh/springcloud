"use strict";var vm=new Vue({el:"#sale-settlement",data:function(){var d=this;return{options:[],isSaveDisable:!1,isSubmitDisable:!1,isQualityDisable:!0,updateFlag:2,productDetailModal:{showModal:!1,ids:{goodsId:"",commodityId:"",documentType:"W_STOCK_IN"},overEdit:!1},isHint:!0,isBusType:!0,showProductDetails:!1,selectedIndex:0,modalTrigger:!1,modalType:"",documentType:"S_RETURN",stepList:[],approvalTableData:[],employees:[],isShow:!1,qualityShow:!0,isDisable:!0,isSearchHide:!0,isView:!1,otherDisable:!0,productTypeList:[],selectedRow:"",unitList:[],unitListObj:{},emp:{businessManId:"",businessManName:""},returnGoodsType:[{value:"S_RETURN_TOWSALE",label:"二次销售"},{value:"S_RETURN_REPAIR",label:"维修"},{value:"S_RETURN_OLD_MATERIAL",label:"旧料处理"}],qualityWay:[{value:"S_RETURN_QUALITY_PASS",label:"放行"},{value:"S_RETURN_QUALITY_NO_PASS",label:"检查结果不符"}],markOrder:"",saleOrderShow:!1,orderSearchNum:{outStockNo:""},jumpParam:{},parentPramas:{},customer:{name:"",custNo:""},user:{userId:"",username:"",createName:"",organizationId:"",organizationName:""},area:{},areaInit:{isInit:!1,province:"",city:"",county:"",detail:"",disabled:!1},addBody:{id:"",documentNo:"",documentStatus:1,businessStatus:0,organizationId:"",organizationName:"",customerId:"",custNo:"",custName:"",returnDate:"",businessType:"",reason:"",saleOutStockNo:"",businessManId:"",businessManName:"",goodsType:"",goodsTypeName:"",groupPath:"",totalNum:0,totalWeight:0,createName:"",createTime:"",updateName:"",updateTime:"",auditId:"",auditName:"",auditTime:"",saleCustInfoEntity:{custNo:"",name:"",phone:"",email:"",weChatNo:"",zipCode:"",detail:"",concreteAddress:"",area:"",province:"",city:"",county:""},goodList:[]},oneinfo:{id:"",inpTrue:"true",organizationId:"",goodsId:"",goodsBarcode:"",pictureUrl:"",goodsCode:"",goodsType:"",goodsTypeName:"",groupPath:"",goodsMainType:"",commodityId:"",goodsNo:"",goodsName:"",goodsInfo:"",goodsNorm:"",goodsLineNo:"",batchNum:"",countingUnit:"",num:"",weightUnit:"",weight:"",goldWeight:"",mainStoneWeight:"",viceStoneWeight:"",certificateType:"",certificateNo:"",returnDate:"",amount:"",documentType:"",sourceType:"",sourceNo:"",reProcessMethod:"",qualityResult:""},goodList:[],businessTypeList:[{value:"S_CUST_ORDER_01",label:"普通销售退货"},{value:"S_CUST_ORDER_02",label:"受托加工销售退货"}],return_goods_list:{url:contextPath+"/tbasecustomer/list",colNames:["操作","客户名称","客户编码"],colModel:[{name:"id",index:"invdate",width:80,align:"center",formatter:function(t,e,o,i){return $(document).off("click",".select"+o.id).on("click",".select"+o.id,function(){d.confirm(t,e,o,i)}),'<a type="primary" class="select'+o.id+'">选取</a>'}},{name:"name",index:"name",width:300,align:"center"},{name:"code",index:"code",width:300,align:"center"}],multiselect:!1},returnReload:!1,returnCutId:"returnCutId",returnSelected:[],custShow:!0,orderShow:!1,wordShow:"商品明细",data_order_list:{url:contextPath+"/tSaleReturnNotice/getOutStockGoods",datatype:"json",colNames:["条形码","商品编码","商品名称","商品明细","批号","计数单位","数量","计重单位","重量","金重","主石重(ct)","副石重(ct)","标配证书类型","证书编号","销售金额","goodsId","图片","商品分录","商品规格","源单类型","出库单源单类型","源单编号","商品编码id","商品主类型","商品类型","商品类型名称"],colModel:[{name:"goodsBarcode",index:"goodsBarcode",width:110,align:"center"},{name:"goodsCode",index:"goodsCode",width:110,align:"center"},{name:"goodsName",index:"goodsName",width:110,align:"center"},{name:"goodsInfo",index:"goodsInfo",width:110,align:"center",formatter:function(t,e,o,i){return $(document).off("click",".select"+o.id).on("click",".select"+o.id,function(){d.showProduct(t,e,o,i)}),'<a type="primary" class="select'+o.id+'">商品明细</a>'}},{name:"batchNum",index:"batchNum",width:110,align:"center"},{name:"countingUnit",index:"countingUnit",width:110,align:"center"},{name:"num",index:"num",width:110,align:"center",formatter:function(t,e,o,i){return 1}},{name:"weightUnit",index:"weightUnit",width:110,align:"center"},{name:"weight",index:"weight",width:110,align:"center"},{name:"goldWeight",index:"goldWeight",width:110,align:"center"},{name:"mainStoneWeight",index:"mainStoneWeight",width:110,align:"center"},{name:"viceStoneWeight",index:"viceStoneWeight",width:110,align:"center"},{name:"certificateType",index:"certificateType",width:110,align:"center"},{name:"certificateNo",index:"certificateNo",width:110,align:"center"},{name:"amount",index:"amount",width:110,align:"center"},{name:"goodsId",index:"goodsId",width:110,align:"center",hidden:"true"},{name:"pictureUrl",index:"pictureUrl",width:110,align:"center",hidden:"true"},{name:"goodsLineNo",index:"goodsLineNo",width:110,align:"center",hidden:"true"},{name:"goodsNorm",index:"goodsNorm",width:110,align:"center",hidden:"true"},{name:"sourceType",index:"sourceType",width:110,align:"center",hidden:"true"},{name:"documentType",index:"documentType",width:110,align:"center",hidden:"true"},{name:"sourceNo",index:"sourceNo",width:110,align:"center",hidden:"true"},{name:"commodityId",index:"commodityId",width:110,align:"center",hidden:"true"},{name:"goodsMainType",index:"goodsMainType",width:110,align:"center",hidden:"true"},{name:"goodsType",index:"goodsType",width:110,align:"center",hidden:"true"},{name:"goodsTypeName",index:"goodsTypeName",width:110,align:"center",hidden:"true"}]},tabId:"customerTab",selected:[],reload:!1,orderId:"orderId",treeSetting:{view:{showLine:!0,selectedMulti:!1,dblClickExpand:!1},callback:{onClick:this.treeClickCallBack,beforeClick:this.treeBeforeClick}}}},methods:{showProduct:function(t,e,o,i){var d=this,a={goodsId:o.goodsId,documentType:"W_STOCK_IN"};Object.assign(this.productDetailModal,{showModal:!0,ids:a}),this.$nextTick(function(){d.$refs.modalRef.getProductDetail()})},checkWeChat:function(){var t=this.addBody.saleCustInfoEntity.weChatNo;if(t){/^[a-zA-Z]([-_a-zA-Z0-9]{5,19})+$/.test(t)||(this.$Modal.info({title:"提示",okText:"确定",content:"格式不正确,请重新输入!"}),this.addBody.saleCustInfoEntity.weChatNo="")}},checkPhone:function(){var t=this.addBody.saleCustInfoEntity.phone;if(t){/^[1][3,4,5,7,8][0-9]{9}$/.test(t)||(this.$Modal.info({title:"提示",okText:"确定",content:"格式不正确,请重新输入!"}),this.addBody.saleCustInfoEntity.phone="")}},checkEmail:function(){var t=this.addBody.saleCustInfoEntity.email;t&&(new RegExp("^[a-z0-9]+([._\\-]*[a-z0-9])*@([a-z0-9]+[-a-z0-9]*[a-z0-9]+.){1,63}[a-z0-9]+$").test(t)||(this.$Modal.info({title:"提示",okText:"确定",content:"格式不正确,请重新输入!"}),this.addBody.saleCustInfoEntity.email=""))},clearNum:function(t,e,o){return console.log(t,e,o),htInputNumber(t,e,o)},cancelModal:function(){this.orderShow=!1},isEdit:function(t,e){eventHub.$emit("isEdit",t)},saveAccess:function(t,e,o){eventHub.$emit("saveFile",t,e)},getAccess:function(t,e,o){eventHub.$emit("queryFile",t,e)},selectedTr:function(t){this.selected=t,console.log(this.selected)},delInfo:function(t,e){console.log(e),""!==e?(t.splice(e,1),this.selected=""):this.$Modal.warning({content:"请选中一行数据！"})},addInfo:function(t,e){if(1==this.addBody.documentStatus){if(!this.addBody.goodsType)return void this.$Modal.info({title:"提示",okText:"确定",content:"请选择商品类型!"});if(0<t.length&&(""===t[t.length-1].goodsBarcode||""===t[t.length-1].goodsCode))return void this.$Modal.info({content:"不能连续新增多条"});t.push(Object.assign({},e)),console.log(this.goodList)}},hideSearch:function(){this.isSearchHide=!this.isSearchHide},saleOrder:function(){this.saleOrderShow=!0},changeCustm:function(t){var e=this;if(""!==t.custNo){this.$Modal.confirm({content:"修改客户将会清空分录行，是否修改客户？",onOk:function(){t.custNo="",e.isShow=!0,e.goodList=[]}})}},returnCut:function(){this.isView||(""==this.addBody.custNo?this.isShow=!0:this.changeCustm(this.addBody))},orderSearch:function(){if(this.addBody.custNo&&this.addBody.goodsType&&this.addBody.businessType){var t={postData:{outStockNo:this.orderSearchNum.outStockNo,custNo:this.addBody.custNo,goodsType:this.addBody.goodsType,businessType:this.addBody.businessType}};console.log(t),$("#"+this.orderId).jqGrid("setGridParam",t).trigger("reloadGrid"),this.orderShow=!0}else this.addBody.custNo?this.addBody.businessType?this.addBody.goodsType||this.$Modal.info({content:"请选择商品类型"}):this.$Modal.info({content:"请选择业务类型"}):this.$Modal.info({content:"请选择退货客户"})},changeEmp:function(t){console.log(t),this.addBody.businessManId=t.value;var e=t.label;this.addBody.businessManName=e.substring(e.lastIndexOf("-")+1,e.length)},returnOrder:function(){for(var e=this,o=[],t=0;t<this.selected.length;t++){var i=$("#"+this.orderId).jqGrid("getRowData",this.selected[t]);console.log(i),i.organizationId=this.addBody.organizationId,i.groupPath=this.addBody.groupPath,i.returnDate=(new Date).format("yyyy-MM-dd HH:mm:ss"),i.goodsId=Number(i.goodsId),i.commodityId=Number(i.commodityId),o.push(i)}console.log(o),this.goodList.map(function(t){for(var e=0;e<o.length;e++)o[e].goodsBarcode==t.goodsBarcode&&o.splice(e,1)}),o.map(function(t){e.goodList.push(t)}),this.addBody.goodList=this.goodList,console.log(this.goodList),this.orderShow=!1,this.saleOrderShow=!1},exitOrder:function(){this.orderShow=!1,this.saleOrderShow=!1},confirm:function(t,e,o,i){console.log(t),console.log(o),this.addBody.customerId=o.id,this.addBody.custNo=o.code,this.addBody.custName=o.name,this.addBody.saleCustInfoEntity.zipCode=o.zipCode,this.addBody.saleCustInfoEntity.custNo=o.code;var d=o.contacts&&0<o.contacts.length?o.contacts[0]:{};this.addBody.saleCustInfoEntity.email=d.email,this.addBody.saleCustInfoEntity.name=d.name,this.addBody.saleCustInfoEntity.phone=d.phone,this.addBody.saleCustInfoEntity.weChatNo=d.wechat,this.isShow=!1,this.getBarcodeList()},jump:function(){window.parent.activeEvent({name:"销售退货通知单列表",url:contextPath+"/sale/return-notice/sale-reject-list.html"})},typeInit:function(t,e,o){for(var i=0;i<t.length;i++){if(t[i].value==o)return e.push(t[i].value),!0;if(t[i].children&&0<t[i].children.length&&this.typeInit(t[i].children,e,o))return e.push(t[i].value),!0}},showProductDetail:function(t){var e=this;if(this.selectedIndex=t,null!=this.goodList[t].goodsCode&&""!=this.goodList[t].goodsCode){var o={goodsId:this.goodList[t].goodsId,documentType:"W_STOCK_IN"};Object.assign(this.productDetailModal,{showModal:!0,ids:o}),this.$nextTick(function(){e.$refs.modalRef.getProductDetail()})}},modalSure:function(t){},modalCancel:function(t){},isHintShow:function(){var t=this;this.addBody.goodsType&&this.isHint&&this.goodList&&0<this.goodList.length&&this.$Modal.warning({content:"温馨提示：改变商品类型将删除所有商品信息!",onOk:function(){t.isHint=!1}})},changeBusType:function(t){var e=this;console.log(t),this.addBody.businessType&&this.isBusType&&this.goodList&&0<this.goodList.length&&this.$Modal.warning({content:"温馨提示：改变类业务类型将删除所有商品信息!",onOk:function(){e.isBusType=!1}}),this.goodList=[],this.getBarcodeList()},getBarcodeList:function(){var e=this,t={custNo:this.addBody.custNo,goodsType:this.addBody.goodsType,goodsBarcode:"",businessType:this.addBody.businessType,limit:10,page:1};$.ajax({type:"post",url:contextPath+"/tSaleReturnNotice/getOutStockGoods",data:t,dataType:"json",success:function(t){"100100"===t.code&&(e.options=t.data.list.map(function(t){return $.extend(!0,{},{code:t.goodsBarcode,name:t.goodsName,id:t.id})}),console.log(e.options))},error:function(){layer.alert("服务器出错啦")}})},changeProductType:function(t,e){if(t==this.typeValue)return!1;this.goodList=[];var o=e[e.length-1];console.log(o.value),this.addBody.goodsType=o.value,this.addBody.goodsTypeName=o.label,this.addBody.groupPath=t.join("-"),this.oneinfo.groupPath=t.join("-"),this.oneinfo.goodsTypeName=o.label,this.getBarcodeList()},sendAjax:function(t){var e=this;this.handleGoodList(),this.sumBodyTotal(),ht.util.hasValue(this.area,"object")&&Object.assign(this.addBody.saleCustInfoEntity,this.area),console.log(this.addBody),$.ajax({type:"post",url:contextPath+t,contentType:"application/json",data:JSON.stringify(this.addBody),dataType:"json",success:function(t){"100100"===t.code?(vm.$Modal.info({title:"提示",okText:"确定",content:"操作成功",onOk:function(){console.log(t),1<vm.addBody.documentStatus&&(vm.isView=!0),e.copyList(t.data),2==t.data.documentStatus&&(vm.isSaveDisable=!0,vm.isSubmitDisable=!0,vm.qualityShow=!0,vm.isEdit("N"))}}),e.saveAccess(t.data.documentNo,e.documentType)):vm.$Modal.info({title:"提示",okText:"确定",content:t.msg,onOk:function(){e.addBody.documentStatus=1}})},error:function(t){console.log("服务器出错"),e.addBody.documentStatus=1}})},save:function(){if(2<this.addBody.documentStatus)return this.$Modal.warning({title:"提示",content:"该单据不能更新操作操作!"}),!1;var t="/tSaleReturnNotice/save";this.addBody.id&&(t="/tSaleReturnNotice/update"),this.sendAjax(t)},submit:function(){if(1!=this.addBody.documentStatus)return this.$Modal.warning({title:"提示",content:"该单据之前已经提交过了,不能再提交!"}),!1;if(""!=this.checkParam())return!1;var t="/tSaleReturnNotice/save";this.addBody.id&&(t="/tSaleReturnNotice/update"),this.addBody.documentStatus=2,this.sendAjax(t)},handleGoodList:function(){var o=this,i=!1;0<o.goodList.length&&(o.goodList.map(function(t,e){""===t.goodsBarcode&&o.goodList.splice(e,1),""!=t.qualityResult&&null!=t.qualityResult||(i=!0)}),i&&2==o.addBody.documentStatus?o.addBody.businessStatus=1:i||2!=o.addBody.documentStatus||(o.addBody.businessStatus=2)),o.addBody.goodList=o.goodList},sumBodyTotal:function(){this.addBody.totalNum=this.sum(this.goodList,"num"),this.addBody.totalWeight=this.sum(this.goodList,"weight")},sum:function(t,o){var i=this;return t.reduce(function(t,e){return""===e[o]||null===e[o]||null==e[o]?0+t:isNaN(e[o])?(i.$Modal.warning({content:"请输入数字"}),e[o]="",0+t):parseFloat(e[o])+t},0)},checkParam:function(){var t="",e=!1;return""===this.addBody.documentNo&&(t="请输入单据编号"),""===this.addBody.organizationId&&(t="请输入组织id"),""===this.addBody.custNo&&(t="请输入客户"),""===this.addBody.businessType&&(t="请输入业务类型"),0==this.goodList.length&&(t="请输入商品分录信息"),0<this.goodList.length&&(this.goodList.map(function(t){""!=t.reProcessMethod&&null!=t.reProcessMethod||(e=!0)}),e&&(t="请输入完退货处理方式")),this.$Modal.info({content:t}),t},quality:function(){2==this.addBody.documentStatus&&1==this.addBody.businessStatus&&(this.qualityShow=!1,this.isSaveDisable=!1)},chcekQuality:function(t){var e=!1;return t.map(function(t){""!=t.qualityResult&&null!=t.qualityResult||(e=!0)}),e},approve:function(t){var e=this;1==e.addBody.documentStatus?e.$Modal.warning({content:"请先提交单据！"}):2==e.addBody.documentStatus?$.ajax({type:"POST",url:contextPath+"/tSaleReturnNotice/info",data:{documentNo:e.addBody.documentNo},success:function(t){(console.log(t),"100100"==t.code)?e.chcekQuality(t.data.goodList)?e.$Modal.info({content:"请完成质检判定保存后再审核单据！"}):(e.modalType="approve",e.modalTrigger=!e.modalTrigger,e.qualityShow=!0):e.$Modal.warning({content:t.msg})}}):(e.modalType="approve",e.modalTrigger=!e.modalTrigger,e.qualityShow=!0)},reject:function(t){this.modalType="reject",this.modalTrigger=!this.modalTrigger},approvalOrRejectCallBack:function(t){var e=this;1==t.result.data.documentStatus&&(e.isView=!1,vm.areaInit.disabled=!1,e.isSaveDisable=!1,e.isSubmitDisable=!1,e.isEdit("Y")),"100515"==t.result.code&&("approve"==e.modalType&&e.ajaxUpdateDocStatusById(e.addBody.id,4),"reject"==e.modalType&&e.ajaxUpdateDocStatusById(e.addBody.id,1)),"100100"==t.result.code&&(e.addBody.documentStatus=t.result.data.documentStatus,e.addBody.auditId=t.result.data.auditId,e.addBody.auditName=t.result.data.auditName,e.addBody.auditTime=t.result.data.auditTime,1==e.addBody.documentStatus&&e.goodList.map(function(t){t.qualityResult=""}),console.log(e.goodList))},ajaxUpdateDocStatusById:function(t,e){var o=this;$.ajax({url:contextPath+"/tSaleReturnNotice/update",method:"POST",dataType:"json",contentType:"application/json;charset=utf-8",data:JSON.stringify({id:t,documentStatus:e}),success:function(t){"100100"==t.code&&(o.addBody.documentStatus=e)}})},exit:function(){window.parent.closeCurrentTab({exit:!0,openTime:this.openTime})},copyList:function(t){this.addBody=Object.assign({},t),1<this.addBody.documentStatus&&(this.isView=!0,this.areaInit.disabled=!0);var e=this.addBody.saleCustInfoEntity;e.province&&(this.areaInit={isInit:!0,province:e.province||"",city:e.city||"",county:e.county,detail:e.detail,disabled:this.isView}),this.goodList=t.goodList.concat()},loadProductType:function(){var e=this;$.ajax({type:"post",url:contextPath+"/tbasecommoditycategory/listByAll?parentId=0",contentType:"application/json",dataType:"json",success:function(t){console.log(t),e.productTypeList=e.initGoodCategory(t.data.cateLists)},error:function(t){console.log("服务器出错")}})},initGoodCategory:function(t){var a=this,n=[];return t.forEach(function(t){var e=t.customCode,o=t.name,i=t.cateLists,d=t.code;i&&(i=a.initGoodCategory(i)),n.push({value:e,label:o,children:i,code:d})}),n.forEach(function(t){t.children||delete t.children}),n},getData:function(){var e=this;$.ajax({type:"post",async:!1,url:contextPath+"/tpurchasecollectgoods/data",dataType:"json",success:function(t){e.user.organizationId=t.data.orgId,e.user.organizationName=t.data.orgName,e.addBody.organizationId=t.data.orgId,e.addBody.organizationName=t.data.orgName,e.employees=t.data.employees},error:function(){console.log("服务器出错啦")}})},getUserInfo:function(){},getDocumentNo:function(){var o=this;$.ajax({type:"POST",url:contextPath+"/tSaleReturnNotice/getFieldCode",success:function(t){var e=t.data;o.addBody.documentNo=e,o.addBody.saleCustInfoEntity.documentNo=e}})},searchCut:function(){var t={postData:{code:this.customer.custNo,name:this.customer.name}};console.log(t),$("#"+this.returnCutId).jqGrid("setGridParam",t).trigger("reloadGrid"),this.custShow=!0},getGoodsItem:function(e,o){var i=this;console.log(e,o);var t=this.goodList,d=!0;if(t.map(function(t){if(t.goodsBarcode==e.code)return i.$Modal.info({content:"请输入不同条码号"}),d=!1,void i.goodList.splice(o,1)}),d){var a=this,n={id:e.id,limit:1,page:1};$.ajax({type:"post",url:contextPath+"/tSaleReturnNotice/getOutStockGoods",data:n,dataType:"json",success:function(t){console.log("明细",t),"100100"===t.code&&(console.log(t.data),t.data.list[0].id="",t.data.list[0].returnDate=(new Date).format("yyyy-MM-dd HH:mm:ss"),t.data.list[0].num=1,t.data.list[0].groupPath=a.addBody.groupPath,console.log(a.goodList),a.$set(a.goodList,o,t.data.list[0]),console.log(a.goodList))},error:function(){layer.alert("服务器出错啦")}})}},getGoodsBarcodeValue:function(t,e){var o=this,i={custNo:this.addBody.custNo,goodsType:this.addBody.goodsType,goodsBarcode:t,businessType:this.addBody.businessType,limit:10,page:1};$.ajax({type:"post",url:contextPath+"/tSaleReturnNotice/getOutStockGoods",data:i,dataType:"json",success:function(t){"100100"===t.code&&(console.log(t),o.options=t.data.list.map(function(t){return $.extend(!0,{},{code:t.goodsBarcode,name:t.goodsName,id:t.id})}),o.$forceUpdate())},error:function(){layer.alert("服务器出错啦")}})}},computed:{typeValue:function(){var t=this.addBody.goodsType,e=[];return this.typeInit(this.productTypeList,e,t),e.reverse()}},created:function(){},watch:{},mounted:function(){$("form").validate(),this.getData(),this.loadProductType(),this.jumpParam=window.parent.params.params,console.log(this.jumpParam.type),"update"===this.jumpParam.type?(this.copyList(this.jumpParam.data),this.isEdit("Y"),this.getAccess(this.addBody.documentNo,this.documentType)):"query"===this.jumpParam.type?(this.copyList(this.jumpParam.data),1!=this.addBody.documentStatus&&(this.isView=!0,this.isSaveDisable=!0,this.isSubmitDisable=!0),this.isEdit(1==this.addBody.documentStatus?"Y":"N"),this.getAccess(this.addBody.documentNo,this.documentType)):"add"===this.jumpParam.type&&(this.getDocumentNo(),this.addBody.returnDate=new Date,this.isEdit("Y")),this.openTime=window.parent.params.openTime}});