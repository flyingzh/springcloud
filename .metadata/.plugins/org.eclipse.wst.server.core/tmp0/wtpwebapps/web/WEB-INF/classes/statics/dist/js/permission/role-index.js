"use strict";var ztree,setting={data:{simpleData:{enable:!0,idKey:"id",pIdKey:"parentId",rootPId:0,type:"type"},key:{url:"nourl"}},check:{enable:!0},view:{fontCss:{color:"blue","font-family":"微软雅黑","font-size":"16px"}}};function zTreeOnClick(e,t,n){var o="../../menu/queryMenuTree"+n.id;$.get(o,function(e){vm.role=e.data})}var RoleVM=new Vue({el:"#role-info",data:function(){return{isShow:!1,isEdit:!1,isView:!1,reload:!1,menus:{id:"",parentId:"",name:"",status:"",type:""},treeNode:[],Constant:{SUCCESS_CODE:"100100"},selected:[],confirmConfig:{showConfirm:!1,title:"提示",content:"请点击确认",onlySure:!0,success:!0},status:[{label:"有效",value:1},{label:"无效",value:0}],body:{name:"",status:""},addBody:{id:"",code:"",name:"",remark:"",status:"",menuTreeList:"",roleButtonList:"",menuList:""},viewMenuData:new Map,viewButtonData:new Map,data_config:{url:contextPath+"/role/roleListPage",colNames:["序号","角色名称","角色状态"],colModel:[{name:"id",index:"id",width:200,align:"center"},{name:"name",index:"name",width:200,align:"center"},{name:"status",index:"status",width:80,align:"center",formatter:function(e,t,n,o){return 1===e?"有效":"无效"}}]}}},methods:{search:function(){this.reload=!this.reload},clear:function(){RoleVM.body={id:"",code:"",name:"",remark:"",status:"",menuTreeList:"",selected:[]}},view:function(){if(!ht.util.hasValue(this.selected,"array"))return layer.alert("请先选择一条记录!"),!1;if(1<this.selected.length)return layer.alert("最多只能选择一条记录!"),!1;var e=this.selected[0];e=String(this.selected[0]);$.isEmptyObject(e)||(RoleVM.isShow=!0,this.modifyTree(e))},viewData:function(e){$.ajax({type:"POST",url:contextPath+"/role/roleInfo/"+e,data:"",dataType:"json",success:function(e){if(e.code===RoleVM.Constant.SUCCESS_CODE){var t=e.data,n=(RoleVM.addBody=t).menuList;null!=n&&0<n.length&&RoleVM.menuSelectInit(n),RoleVM.isShow=!0,RoleVM.isEdit=!0}},error:function(e){console.log("服务器出错")}})},add:function(){if(0<this.selected.length)return layer.alert("新增不需要选择记录!"),!1;this.isShow=!0,this.initTree()},initTree:function(){$.get(contextPath+"/menu/queryAllMenuTree",function(e){ztree=$.fn.zTree.init($("#menuTree"),setting,e.data)})},modifyTree:function(t){$.get(contextPath+"/menu/queryAllMenuTree",function(e){RoleVM.treeNode=e.data,ztree=$.fn.zTree.init($("#menuTree"),setting,RoleVM.treeNode),e.code===RoleVM.Constant.SUCCESS_CODE&&RoleVM.modifyInfo(t)})},viewTree:function(t){$.get(contextPath+"/menu/queryAllMenuTree",function(e){RoleVM.treeNode=e.data,ztree=$.fn.zTree.init($("#menuTree"),setting,RoleVM.treeNode),e.code===RoleVM.Constant.SUCCESS_CODE&&RoleVM.viewData(t)})},save:function(){if(!$("form").valid())return!1;var e=RoleVM.addBody,t=[],n=ztree.getCheckedNodes();for(var o in n){var a=n[o],r={};r.id=a.id,r.parentId=a.parentId,r.type=a.type,t.push(r)}e.menuTreeList=t,$.isEmptyObject(String(e.id))?this.addInstance(e):this.update(e)},modify:function(){if(!ht.util.hasValue(this.selected,"array"))return layer.alert("请先选择一条记录!"),!1;if(1<this.selected.length)return layer.alert("最多只能选择一条记录!"),!1;var e=String(this.selected[0]);$.isEmptyObject(e)||(RoleVM.isShow=!0,this.modifyTree(e))},modifyInfo:function(e){$.ajax({type:"POST",url:contextPath+"/role/roleInfo/"+e,data:"",dataType:"json",success:function(e){if(e.code===RoleVM.Constant.SUCCESS_CODE){var t=e.data,n=t.menuList;null!=n&&0<n.length&&RoleVM.menuSelectInit(n),RoleVM.addBody=t}},error:function(){}})},menuSelectInit:function(e){var t=ztree.getNodes(),n=ztree.transformToArray(t);for(var o in e){var a=e[o],r=a.id;for(var i in n){var l=n[i],s=l.id;String(r)===s&&(ztree.checkNode(l,!0,!1),RoleVM.viewMenuData.set(r,a))}var d=a.buttonList;null!=d&&0<d.length&&this.buttonSelectInit(d,n,r)}},buttonSelectInit:function(e,t,n){for(var o in e){var a=e[o],r=a.buttonId;for(var i in t){var l=t[i],s=l.id,d=l.parentId;String("B"+r)===s&&String(n)===d&&(ztree.checkNode(l,!0,!1),RoleVM.viewButtonData.set(String("M"+n+"B"+r),a))}}},update:function(e){this.isShow=!1,$.ajax({type:"POST",url:contextPath+"/role/updateRole",data:JSON.stringify(e),dataType:"json",contentType:"application/json;charset=utf-8",success:function(e){e.code===RoleVM.Constant.SUCCESS_CODE?(layer.alert("修改角色成功"),RoleVM.cancel(),RoleVM.reload=!RoleVM.reload):layer.alert(e.msg)},error:function(e){console.log("服务器出错")}})},addInstance:function(e){this.isShow=!1,$.ajax({type:"POST",url:contextPath+"/role/addRole",data:JSON.stringify(e),dataType:"json",contentType:"application/json;charset=utf-8",success:function(e){e.code===RoleVM.Constant.SUCCESS_CODE?(layer.alert("添加角色成功"),RoleVM.cancel(),RoleVM.reload=!RoleVM.reload):layer.alert(e.msg)},error:function(e){console.log("服务器出错")}})},del:function(){if(0!==this.selected.length)if(1<this.selected.length)layer.alert("只能选择一条记录进行删除");else{var e=this.selected[0];$.ajax({url:contextPath+"/role/delRoleById/"+e,method:"post",dataType:"json",data:"",contentType:"application/json;charset=utf-8",success:function(e){e.code===RoleVM.Constant.SUCCESS_CODE?(layer.alert("删除成功"),RoleVM.reload=!RoleVM.reload):console.log(e.msg)},error:function(e){console.log(e)}})}else layer.alert("请选择一条记录进行删除")},cancel:function(){this.isShow=!1,this.isEdit=!1,this.selected.length=0,this.clear()},paramsValidate:function(){},initFormValidate:function(){var e={onfocusout:function(e){$(e).valid()},onkeyup:!1,rules:{znumber:{isnumber:!0,required:!0},code:{iscode:!0,required:!0}},messages:{znumber:{required:"请输入角色编号"},code:{required:"请输入角色名称"}}};$("#form").validate(e)}},mounted:function(){this.initFormValidate(),jQuery.validator.addMethod("isnumber",function(e,t){return/^[a-zA-Z0-9]+$/.test(e)},"请使用英文和数字"),jQuery.validator.addMethod("iscode",function(e,t){return/^[\u4e00-\u9fa5]+$/.test(e)},"请使用中文")}});