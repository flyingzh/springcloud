"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},purchaseOrderList=new Vue({el:"#receiptReport",data:function(){return{showSourceModal:!1,selectSourceDoc:[],showSave:!1,showModify:!1,userShow:!1,showUserInfo:!1,deleteShowOne:!1,pOrder:!0,commodityList:[],sCust:!0,isHint:!0,pDeliver:!0,addShowOne:!1,wareHouse:[],orgName:"",tab:"tab1",opentype:null,isShowGoodsCode:!1,unitMap:{},isAddRow:!1,materialTypeMap:{P_ORDER_01:"采购订单一标准采购",P_ORDER_02:"采购订单一受托加工采购",S_CUST_MATERIAL:"客户来料单",P_APPLY_DELIVER:"采购送料单"},sourceUrl:"/tpurchaseorder/list",data_user_list:{url:contextPath+"/deposit/findCustomerCode",colNames:["客户名称","客户编码"],colModel:[{name:"name",index:"name",width:300,align:"center"},{name:"code",index:"code",width:300,align:"center"}],multiselect:!0,multiboxonly:!0},employees:[],reload:!1,tabId:"tabId1",selected:[],cuSelected:[],customerName:"",customer:{name:"",num:""},source:{type:"",no:""},suppliers:[],openTime:"",isSearchHide:!0,isTabulationHide:!0,isShow:!1,isHide:!0,needReload:!1,showSupplierModal:!1,supplierCode:"",isFromList:!1,optionList:[],selectedRowIndex:"",approveComment:!1,rejectComment:!1,categoryType:[],storageList:[],locationMap:[],sourceType:"",otherInfo:{goodsCode:"",goodsName:"",actualCount:"",checkNumber:"",qualifiedNumber:"",backNumber:"",releaseNumber:"",grandStorageNumber:"",grandOutboundNumber:""},sourceNo:"",receive:{id:"",businessType:"",sourceType:"",orderNo:"",receiptDate:(new Date).format("yyyy-MM-dd"),goodsTypeName:"",goodsTypePath:"",receiptNature:"",dataSource:"",remark:"",createName:"",createTime:"",updateName:"",updateTime:"",auditor:"",auditTime:"",orderStatus:"",customerId:"",customerName:"",organizationId:"",salesmanId:"",salesmanName:"",supplierId:"",totalCost:"",totalAmount:"",takeDeliveryWeight:"",takeDeliveryCount:"",collectGoods:[]},showCustomer:!1,selectCustomer:"",showSupplier:!1,selectSupplier:"",supplierName:"",showReceive:!1,showSource:!1,unit:[],modalTrigger:!1,modalType:"",steplist:[],approvalTableData:[]}},created:function(){this.loadProductType(),this.loadData(),this.loadPosition(),this.getUnitList(),this.initUnit()},methods:{loadPosition:function(){var o=this;$.ajax({url:contextPath+"/tpurchasecollectgoods/findByAllPosition",method:"POST",dataType:"json",contentType:"application/json;charset=utf-8",success:function(e){if("100100"==e.code){var t={};e.data.map(function(e){void 0===t[e.groupId]&&(t[e.groupId]=[]),t[e.groupId].push(e)}),o.locationMap=t}},error:function(){This.$Modal.error({content:"系统异常,请联系技术人员！"})}})},approvalOrRejectCallBack:function(e){this.receive.orderStatus=e.result.data,1==this.receive.orderStatus&&(this.showSave=!1,this.showModify=!1,this.showSource=!1,this.isFromList=!1,1==this.receive.dataSource?(this.showReceive=!1,this.isShowGoodsCode=!1):this.showReceive=!0)},getUnitList:function(){var t=this;$.ajax({type:"POST",url:contextPath+"/tbaseunit/list",success:function(e){t.unit=e.data},error:function(){t.$Modal.error({content:"系统异常,请联系技术人员！"})}})},approval:function(){if(4!=this.receive.orderStatus){var e=this;e.modalType="approve",e.modalTrigger=!e.modalTrigger}else this.$Modal.warning({content:"该单据已审核"})},reject:function(){var e=this;e.modalType="reject",e.modalTrigger=!e.modalTrigger},loadData:function(t){var o=this;$.ajax({type:"post",url:contextPath+"/tpurchasecollectgoods/data",dataType:"json",success:function(e){o.receive.organizationId=e.data.orgId,o.orgName=e.data.orgName,o.wareHouse=e.data.wareHouse,o.employees=e.data.employees},error:function(){o.$Modal.error({content:"系统异常,请联系技术人员！"})}}).then(function(e){t&&o.initLocationData(t)})},onCustomer:function(){this.showReceive||this.showUserInfo||(this.showCustomer=!0)},closeCustomer:function(){this.showCustomer=!1,this.receive.customerId=this.selectCustomer.id,this.receive.customerName=this.selectCustomer.name,this.customerName=this.selectCustomer.name},onSupplier:function(){this.showReceive||this.showUserInfo||(this.showSupplier=!0)},closeSupplier:function(){this.receive.supplierId=this.selectSupplier.id,this.supplierName=this.selectSupplier.supplierName,this.showSupplier=!1},changeEmp:function(e){this.receive.salesmanId=e.value;var t=e.label;this.receive.salesmanName=t.substring(t.lastIndexOf("-")+1,t.length)},searchCut:function(){},confirm:function(){this.userShow=!1},addOneRow:function(){if(this.receive.goodsTypePath){if(0<this.receive.collectGoods.length)for(var e=0;e<this.receive.collectGoods.length;e++){if(!this.receive.collectGoods[e].goodsCode)return void this.$Modal.warning({content:"请先选择商品编码"});if(!this.receive.collectGoods[e].warehouseId)return void this.$Modal.warning({content:"请先选择仓库"});if("attr_ranges_gold"==this.receive.collectGoods[e].goodsMainType){if(!this.receive.collectGoods[e].actualWeight)return void this.$Modal.warning({content:"请填写收货重量"})}else{if(!this.receive.collectGoods[e].actualWeight)return void this.$Modal.warning({content:"请填写收货重量"});if(!this.receive.collectGoods[e].actualCount)return void this.$Modal.warning({content:"请填写收获数量"})}}this.receive.collectGoods.push({goodsId:"",resourceType:"",resourceNumber:"",pictureUrl:"",goodsTypeName:"",goodsTypePath:"",goodsMainType:"",goodsName:"",goodsCode:"",custStyleCode:"",weightUnit:"",batchNumber:"",options:this.commodityList||[],countingUnit:"",actualCount:"",pricingMethod:"",purchasePrice:"",purchaseAmount:"",purchaseCost:"",warehouseId:"",reservoirPositionId:"",goodsLineNo:"",certificateType:"",receivableWeight:"",actualWeight:"",receivableCount:"",remark:"",checkNumber:"",qualifiedNumber:"",backNumber:"",releaseNumber:"",grandStorageNumber:"",grandOutboundNumber:"",commodityId:""})}else this.$Modal.warning({content:"请先选择商品类型"})},switchTab:function(){"tab2"==this.tab&&(this.tab="tab1")},showOtherInfo:function(e){this.tab="tab2",this.otherInfo.goodsCode=e.goodsCode,this.otherInfo.goodsName=e.goodsName,this.otherInfo.actualCount=e.actualCount,this.otherInfo.checkNumber=e.checkNumber,this.otherInfo.qualifiedNumber=e.qualifiedNumber,this.otherInfo.backNumber=e.backNumber,this.otherInfo.releaseNumber=e.releaseNumber,this.otherInfo.grandStorageNumber=e.grandStorageNumber,this.otherInfo.grandOutboundNumber=e.grandOutboundNumber},deleteOneRow:function(e){this.receive.collectGoods.splice(e,1),this.$refs.sourceList.alReadySelectedData=this.receive.collectGoods,0==this.receive.collectGoods.length&&(this.sourceType="",this.supplierName="",this.receive.supplierId="",this.receive.customerId="",this.customerName="",this.isFromList=!1,this.addShowOne=!1,this.showReceive=!1,this.showUserInfo=!1,this.isShowGoodsCode=!1)},selectOneRow:function(e){this.selectedRowIndex=e},loadProductType:function(){var t=this;$.ajax({type:"post",url:contextPath+"/tbasecommoditycategory/listByAll?parentId=0",contentType:"application/json",dataType:"json",success:function(e){t.categoryType=t.initGoodCategory(e.data.cateLists)},error:function(e){t.$Modal.error({content:"系统出现异常,请联系管理人员"})}})},initGoodCategory:function(e){var s=this,r=[];return e.forEach(function(e){var t=e.customCode,o=e.name,i=e.cateLists;i&&(i=s.initGoodCategory(i)),r.push({value:t,label:o,children:i})}),r.forEach(function(e){e.children||delete e.children}),r},changeBusinessType:function(){var e=this.receive.businessType;this.receive.sourceType="",this.receive.collectGoods=[],this.receive.customerId="",this.receive.supplierId="",this.customerName="",this.supplierName="",this.isFromList=!1,this.showReceive=!1,this.showUserInfo=!1,this.addShowOne=!1,this.typeValue=[],"P_RECEIPT_02"==e||"P_RECEIPT_03"==e?(this.receive.receiptNature="P_RECEIPT_02"==e?"公司料":"客来料",this.pOrder=!0,this.sCust=!1,this.pDeliver=!1):"P_RECEIPT_01"==e?(this.receive.receiptNature="客来料",this.pOrder=!1,this.sCust=!0,this.pDeliver=!1):"P_RECEIPT_04"==e&&(this.receive.receiptNature="公司料",this.pOrder=!1,this.sCust=!1,this.pDeliver=!0)},changeSourceType:function(e){this.receive.collectGoods=[],this.isFromList=!1,this.showReceive=!1,this.showUserInfo=!1,this.addShowOne=!1,this.typeValue=[],"P_ORDER_01"==e||"P_ORDER_02"==e?this.sourceUrl="/tpurchaseorder/findByReceipt?businessTypeId="+e:"S_CUST_MATERIAL"==e?this.sourceUrl="/tsaleMaterialOrder/quarylist?documentStatus=4&isReceive=1":"P_APPLY_DELIVER"==e&&(this.sourceUrl="/purchaseDeliverController/list?orderStatus=4&isReceive=1")},closeSourceModal:function(e){var t=this;if(t.showSourceModal=!1,e){t.receive.goodsTypeName=e[0].goodsTypeName||"",t.receive.goodsTypePath=e[0].goodsTypePath||"",t.receive.supplierId=e[0].supplierId,t.supplierName=e[0].supplierName,t.receive.customerId=e[0].customerId,t.receive.customerName=e[0].customerName,t.customerName=e[0].customerName,t.sourceChangeType(e[0].resourceType),t.isFromList=!0,t.showUserInfo=!0,t.addShowOne=!0,t.isShowGoodsCode=!0,e.map(function(e){t.receive.collectGoods.push(e)});for(var o=0;o<t.receive.collectGoods.length;o++)t.receive.collectGoods[o].resourceType}},loadCollectGoods:function(e){var t=this;e&&$.ajax({type:"post",url:contextPath+"/tpurchasecollectgoods/findByTypeId?type="+t.receive.sourceType+"&id="+e,dataType:"json",success:function(e){e.code},error:function(){t.$Modal.error({content:"系统异常,请联系技术人员！"})}})},locatorChange:function(e,t){if(e){var o=e;"object"===(void 0===e?"undefined":_typeof(e))&&(o=e.target.value);for(var i="",s=0;s<this.wareHouse.length;s++)if(o==this.wareHouse[s].id){i=this.wareHouse[s].groupId;break}this.$set(this.storageList,t,this.locationMap[i])}},add:function(){},saveClick:function(t){var e,o=this;if(2==t){if(!o.receive.businessType)return void this.$Modal.confirm({content:"请选择业务类型!"});if("P_RECEIPT_01"==o.receive.businessType){if(!o.receive.customerId)return void this.$Modal.confirm({content:"请选择客户!"})}else if(!o.receive.supplierId)return void this.$Modal.confirm({content:"请选择供应商!"});if(!o.receive.salesmanId)return void this.$Modal.confirm({content:"请选择业务员!"});if(0==o.receive.collectGoods.length)return void this.$Modal.confirm({content:"单据无效,请选择商品进行添加!"});for(var i=0;i<o.receive.collectGoods.length;i++){var s=o.receive.collectGoods[i];if(!s.goodsCode)return void this.$Modal.warning({content:"请先选择商品编码"});if("attr_ranges_gold"==s.goodsMainType){if(!s.actualWeight)return void this.$Modal.confirm({content:"您的收货重量还没有填写!"});if(s.actualWeight<=0)return void this.$Modal.confirm({content:"收货重量必须大于0!"})}else{if(!s.actualWeight)return void this.$Modal.confirm({content:"您的收货重量还没有填写!"});if(s.actualWeight<=0)return void this.$Modal.confirm({content:"收货重量必须大于0!"});if(!s.actualCount)return void this.$Modal.confirm({content:"您的收货数量还没有填写!"});if(s.actualCount<=0)return void this.$Modal.confirm({content:"收货数量必须大于0!"})}if(!s.warehouseId)return void this.$Modal.warning({content:"请先选择仓库"})}}o.receive.collectGoods[0].resourceType?o.receive.dataSource=2:o.receive.dataSource=1,1==t?e="/tpurchasecollectgoods/saveOrUpdate":2==t&&(o.showSave=!0,o.showModify=!0,o.deleteShowOne=!0,e="/tpurchasecollectgoods/commit"),$.ajax({type:"post",url:contextPath+e,data:JSON.stringify(o.receive),contentType:"application/json",success:function(e){100100==e.code?(o.$Modal.success({content:e.msg}),o.saveAccess(e.data.id,"P_RECEIPT"),o.receive.id=e.data.id,o.receive.orderStatus=e.data.orderStatus,o.receive.orderNo=e.data.orderNo,o.receive.createName=e.data.createName,o.receive.createTime=e.data.createTime,o.receive.updateName=e.data.updateName,o.receive.updateTime=e.data.updateTime,o.receive.auditor=e.data.auditor,o.receive.auditTime=e.data.auditTime,2==t&&(o.showSource=!0,o.isFromList=!0,o.showReceive=!0,o.isShowGoodsCode=!0),o.isEdit(1==o.receive.orderStatus?"Y":"N")):100101==e.code&&(o.$Modal.info({content:e.msg}),o.showSave=!1,o.showModify=!1,o.showSource=!1,o.isFromList=!1)},error:function(){o.$Modal.error({content:"系统异常,请联系技术人员！"})}})},cancel:function(){},isHintShow:function(e){var t=this;e&&this.typeValue&&this.isHint&&this.categoryType&&0<this.receive.collectGoods.length&&this.$Modal.warning({content:"温馨提示：改变商品类型将删除所有商品信息!",onOk:function(){t.isHint=!1}})},changeCategory:function(e,t){if(e!=this.typeValue){this.receive.collectGoods=[];var o=t[t.length-1];o&&(this.receive.goodsTypePath=o.value,this.receive.goodsTypeName=o.label,this.getCommodityList())}},initLocationData:function(e){var o=this;e.map(function(e,t){o.locatorChange(e.warehouseId,t)})},getCommodityList:function(){var t=this,e={categoryCustomCode:t.receive.goodsTypePath,field:"",limit:""};$.ajax({type:"post",url:contextPath+"/tbasecommodity/findByType",data:e,dataType:"json",success:function(e){"100100"==e.code?t.commodityList=e.data:t.$Modal.error({content:e.msg})},error:function(){t.$Modal.error({content:"系统异常,请联系技术人员！"})}})},showDate:function(e){var t=this,o=e.params,i=[];if(1==e.type){t.isEdit("Y");var s=o[0];"P_ORDER_01"==s.businessTypeId?(t.receive.businessType="P_RECEIPT_02",this.changeBusinessType(),t.receive.sourceType="P_ORDER_01"):"P_ORDER_02"==s.businessTypeId&&(t.receive.businessType="P_RECEIPT_03",this.changeBusinessType(),t.receive.sourceType="P_ORDER_02"),t.receive.goodsTypeName=s.goodsTypeName,t.receive.goodsTypePath=s.goodsGroupPath,t.receive.supplierId=s.supplierId,t.supplierName=s.supplierName,t.showReceive=!0,t.addShowOne=!0,t.isAddRowDisable=!0,t.isShowGoodsCode=!0;for(var r=0;r<o.length;r++)for(var a=o[r],c=0;c<a.goodList.length;c++){var n=a.goodList[c];if("attr_ranges_gold"==n.goodsMainType){if(n.purchaseWeight==n.alreadyCollectWeight)continue}else if(n.purchaseCount==n.alreadyCollectCount)continue;var u={};u.resourceType=a.businessTypeId,t.sourceChangeType(u.resourceType),u.resourceNumber=a.orderNo,u.pictureUrl=n.pictureUrl||"",u.streamId=n.goodsId,u.goodsMainType=n.goodsMainType||"",u.goodsTypeName=n.goodsTypeName,u.goodsTypePath=n.goodsTypePath,u.custStyleCode=n.custStyleCode||"",u.goodsCode=n.goodsCode,u.goodsName=n.goodsName,u.certificateType=n.certificateType||"",u.weightUnit=n.weightUnit||"",u.countingUnit=n.digitUnit||"",u.pricingMethod=n.chargeUnit||"",u.goodsLineNo=n.goodsLineNo||"",u.purchasePrice=n.price||"",u.commodityId=n.commodityId||"",u.receivableCount=n.purchaseCount||"",u.receivableWeight=n.purchaseWeight||"",u.documentType=n.documentType||"",u.specification=n.goodsSpecifications||"",u.productFlag=n.productFlag||"",u.actualWeight=n.purchaseWeight-n.alreadyCollectWeight,u.actualCount=n.purchaseCount-n.alreadyCollectCount,u.purchaseCost="",u.purchaseAmount="",i.push(u)}this.receive.collectGoods=i,t.isFromList=!0}else{if(2==e.type)return void t.isEdit("Y");if(3==e.type){var d=e.params;this.assignment(d)}else 4==e.type&&this.assignment(e.params)}},assignment:function(e){var t=this,o=this;o.getAccess(e.id,"P_RECEIPT"),1==e.orderStatus?(o.isEdit("Y"),1==e.dataSource?(o.isFromList=!1,o.showReceive=!1,o.showSource=!1,o.addShowOne=!1,o.isShowGoodsCode=!1):(o.isFromList=!0,o.showReceive=!0,o.showSource=!1,o.addShowOne=!0,o.isShowGoodsCode=!0)):(o.isEdit("N"),o.showModify=!0,o.showSave=!0,o.showSource=!0,o.isFromList=!0,o.showReceive=!0,o.addShowOne=!0,o.deleteShowOne=!0,o.isShowGoodsCode=!0),Object.assign(this.receive,e),this.getCommodityList(),this.receive.customerId&&(this.customerName=this.receive.customerName),this.receive.supplierId&&(this.supplierName=this.receive.supplierName),this.receive.collectGoods.map(function(e){t.sourceChangeType(e.resourceType)}),0==this.wareHouse.length?this.loadData(this.receive.collectGoods):this.initLocationData(this.receive.collectGoods)},changeSourceNo:function(){this.showReceive||(!this.addShowOne&&0<this.receive.collectGoods.length?this.$Modal.warning({content:"已新增行,不能选取源单数据！"}):this.receive.businessType?this.receive.sourceType?(this.$refs.sourceList.alReadySelectedData=this.receive.collectGoods||[],this.showSourceModal=!0):this.$Modal.info({content:"请选择源单类型"}):this.$Modal.info({content:"请选择业务类型"}))},exit:function(){window.parent.closeCurrentTab({exit:!0,openTime:this.openTime})},isEdit:function(e){eventHub.$emit("isEdit",e)},saveAccess:function(e,t){eventHub.$emit("saveFile",e,t)},getAccess:function(e,t){eventHub.$emit("queryFile",e,t)},sourceChangeType:function(e){this.sourceType=this.materialTypeMap[e]},initUnit:function(){var i=this;$.ajax({type:"post",url:contextPath+"/tbaseunit/list",contentType:"application/json",dataType:"json",async:!1,success:function(e){"100100"===e.code?e.data.map(function(e){var t=e.id,o=e.name;i.unitMap[t]=o}):i.$Modal.error({content:"系统异常,请联系技术人员！"})},error:function(e){i.$Modal.error({content:"系统异常,请联系技术人员！"})}})},getSelectedItem:function(e,o){var i=this;$.ajax({type:"post",url:contextPath+"/tbasecommodity/getBriefById/"+e.id,dataType:"json",success:function(e){var t=e.data;t.countUnitId=i.unitMap[t.countUnitId],t.weightUnitId=i.unitMap[t.weightUnitId],Object.assign(i.receive.collectGoods[o],{goodsCode:t.code,goodsName:t.name,commodityId:t.id,pictureUrl:t.frontPic&&t.frontPic.fdUrl,goodsTypeName:t.categoryName,goodsTypePath:t.categoryCustomCode,custStyleCode:t.styleCustomCode,goodsMainType:t.mainType,specification:t.specification,countingUnit:t.countUnitId,weightUnit:t.weightUnitId,pricingMethod:t.pricingType}),i.$forceUpdate()},error:function(){_this.$Modal.error({content:"系统异常,请联系技术人员！"})}})},getInputValue:function(e,t){var o=this,i={categoryCustomCode:o.receive.goodsTypePath,field:e,limit:""};$.ajax({type:"post",url:contextPath+"/tbasecommodity/findByType",data:i,dataType:"json",success:function(e){Object.assign(o.receive.collectGoods[t],{options:e.data}),o.$forceUpdate()},error:function(){o.$Modal.error({content:"系统异常,请联系技术人员！"})}})},sum:function(e,o){return e.reduce(function(e,t){return""===t[o]||null===t[o]||void 0===t[o]?0+e:(isNaN(t[o])&&(t[o]=""),parseFloat(t[o])+e)},0)},clearNoNum:function(e,t,o){return htInputNumber(e,t,o)},typeInit:function(e,t,o){for(var i=0;i<e.length;i++){if(e[i].value==o)return t.push(e[i].value),!0;if(e[i].children&&0<e[i].children.length&&this.typeInit(e[i].children,t,o))return t.push(e[i].value),!0}}},computed:{totalActualWeight:function(){return this.receive.takeDeliveryWeight=this.sum(this.receive.collectGoods,"actualWeight").toFixed(3)},totalActualCount:function(){return this.receive.takeDeliveryCount=this.sum(this.receive.collectGoods,"actualCount").toFixed(0)},totalActualAmount:function(){return this.receive.totalAmount=this.sum(this.receive.collectGoods,"purchaseAmount").toFixed(2)},totalPurchaseCost:function(){return this.receive.totalCost=this.sum(this.receive.collectGoods,"purchaseCost").toFixed(2)},typeValue:function(){var e=this.receive.goodsTypePath,t=[];return this.typeInit(this.categoryType,t,e),t.reverse()}},filters:{capitalize:function(e){return 1==e?"重量计价":2==e?"数量计价":" "}},watch:{"receive.collectGoods":{handler:function(e,t){e.map(function(e){e.purchasePrice&&"attr_ranges_gold"!=e.goodsMainType&&(2==e.pricingMethod&&e.actualCount&&(e.purchaseAmount=parseFloat(math.eval(Number(e.actualCount)*Number(e.purchasePrice)).toFixed(3))),1==e.pricingMethod&&e.actualWeight&&(e.purchaseAmount=parseFloat(math.eval(Number(e.actualWeight)*Number(e.purchasePrice)).toFixed(3))))})},deep:!0}},mounted:function(){this.openTime=window.parent.params.openTime,this.opentype=window.parent.params.type;var e=window.parent.params;this.showDate(e)}});