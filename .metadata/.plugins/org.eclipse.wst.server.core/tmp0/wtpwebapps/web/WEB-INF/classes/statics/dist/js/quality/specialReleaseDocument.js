"use strict";var specialReleaseDocument=new Vue({el:"#SRDocument",data:function(){var n=this;return{isSearchHide:!0,isTabulationHide:!0,isHide:!0,getDocumentTypeList:{},approveComment:!1,rejectComment:!1,approvement:{receiptsId:"",approvalResult:1,approvalInfo:"",boeId:""},dataValue:[],rejectement:{receiptsId:"",approvalResult:"0",approvalInfo:"",boeId:""},stepData:[{currentLevel:0,subtitle:"开始"},{currentLevel:1,subtitle:"一级审批"},{currentLevel:2,subtitle:"二级审批"},{currentLevel:3,subtitle:"三级审批"},{currentLevel:4,subtitle:"四级审批"},{currentLevel:5,subtitle:"五级审批"},{currentLevel:6,subtitle:"六级审批"},{currentLevel:7,subtitle:"结束"}],currentStep:"",nextStep:"",reportDocument:{id:"",code:"",documentStatus:"",delStatus:"",organizationId:"",startTime:"",endTime:"",qcDocumentCode:"",applicantName:"",sourceDocumentCode:"",documentType:"",qcConclusion:"",departmentName:"",applyReason:"",confirmer:"",examineVerifyDate:"",riskEstimate:""},isShow:!1,isEdit:!1,reload:!1,selected:[],openTime:"",documentStatusList:[],applicantNameList:[],body:{code:"",startTime:"",endTime:"",qcDocumentCode:"",applicantName:"",sourceDocumentCode:"",documentStatus:""},data_config:{url:contextPath+"/specialReleaseDocument/listByPage",colNames:["单据编号","单据日期","单据状态","源单类型","源单单号","送检编号","检验单号","检验结论","申请部门","申请人","申请原因","确认人","确认日期","风险评估"],colModel:[{name:"code",index:"code",width:300,align:"lift"},{name:"documentTime",index:"documentTime",align:"lift",width:180,formatter:function(e,t,a,o){return Date.prototype.Format=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};for(var a in/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),t)new RegExp("("+a+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?t[a]:("00"+t[a]).substr((""+t[a]).length)));return e},new Date(e).Format("yyyy-MM-dd")}},{name:"documentStatus",index:"documentStatus",align:"lift",width:180},{name:"documentType",index:"documentType",align:"lift",width:180,formatter:function(e,t,a,o){return n.getDocumentTypeList[e]||e}},{name:"upstreamSourceCode",index:"upstreamSourceCode",align:"lift",width:280},{name:"sourceDocumentCode",index:"sourceDocumentCode",align:"lift",width:180},{name:"qcDocumentCode",index:"qcDocumentCode",align:"lift",width:380,formatter:function(e,t,a,o){return $(document).off("click",".detail"+e).on("click",".detail"+e,function(){n.documentDetail({value:e,grid:t,rows:a,state:o})}),'<a class="detail'+e+'">'+e+"</a>"}},{name:"qcConclusion",index:"qcConclusion",width:180,align:"lift"},{name:"departmentName",index:"departmentName",width:180,align:"lift"},{name:"applicantName",index:"applicantName",align:"lift",width:180},{name:"applyReason",index:"applyReason",align:"lift",width:180},{name:"examineVerifyName",index:"examineVerifyName",align:"lift",width:180},{name:"examineVerifyDate",index:"examineVerifyDate",align:"lift",width:180},{name:"riskEstimate",index:"riskEstimate",align:"lift",width:180}]}}},methods:{changeDate:function(e){this.body.startTime=e[0].replace(/\//g,"-")+" 00:00:00",this.body.endTime=e[1].replace(/\//g,"-")+" 23:59:59"},search:function(){this.reload=!this.reload},clear:function(){this.body={code:"",startTime:"",endTime:"",qcDocumentCode:"",applicantName:"",sourceDocumentCode:"",documentStatus:""},this.dataValue=[],this.$refs.inspect.clearSingleSelect()},add:function(){window.parent.activeEvent({name:"新增特别放行单",url:contextPath+"/quality/quality/specialReleaseDocumentInfo.html?type=2"})},documentDetail:function(e){var t=e.rows.qcDocumentCode;t&&this.queryDocument1(t,!0)},queryDocument1:function(e,t){$.ajax({type:"POST",data:{documentCode:e},url:contextPath+"/testReportDocumentController/findTestDocumentByDocumentCode",dataType:"json",success:function(e){if("100100"===e.code){console.log(e);var t=e.data.documentType,a=e.data.documentCode;e.data,e.data.id;"kcjyd"==t||"mdjyd"==t?window.parent.activeEvent({name:"查看检验单",url:contextPath+"/quality/inventory/test-document.html",params:a}):window.parent.activeEvent({name:"查看检验单",url:contextPath+"/quality/test-document/test-document.html",params:{code:a,type:1}})}},error:function(e){console.log("服务器出错")}})},del:function(){var e=this.selected;0!=this.selected.length?$.ajax({url:contextPath+"/specialReleaseDocument/delete",method:"post",dataType:"json",data:{ids:e.join(",")},success:function(e){"100100"===e.code?(specialReleaseDocument.reload=!specialReleaseDocument.reload,layer.alert(e.msg)):layer.alert("服务器出错，请联系技术人员！")},error:function(e){console.log(e)}}):alert("请选择至少一条数据!")},modify:function(){var e=this.selected[0];if(0!=this.selected.length)if(1<this.selected.length)layer.alert("只能对一条数据修改哦!");else{jQuery("#myTable").jqGrid("getRowData",e);window.parent.activeEvent({name:"修改特别放行单",url:contextPath+"/quality/quality/specialReleaseDocumentInfo.html?type=3&id="+e})}else layer.alert("请选择一条数据修改!")},view:function(){},save:function(){var e=this.selected;0!=this.selected.length?$.ajax({url:contextPath+"/specialReleaseDocument/updateBatchDocumentStatus",method:"post",dataType:"json",data:{ids:e.join(",")},success:function(e){"100100"===e.code?(layer.alert("提交成功！"),specialReleaseDocument.reload=!specialReleaseDocument.reload):layer.alert("请选择单据状态为 暂存的 单据。\n若提交的单据有漏填项，请前往补充，谢谢！")},error:function(e){console.log(e)}}):layer.alert("请选择至少一条数据!")},reloadAgain:function(){specialReleaseDocument.isShow=!1,specialReleaseDocument.reload=!specialReleaseDocument.reload},cancel:function(){window.parent.closeCurrentTab({name:"特别放行单",openTime:this.openTime,exit:!0})},approval:function(){var a=this;if(0==this.selected.length)return layer.alert("请选择一条数据!"),!1;if(1<this.selected.length)return layer.alert("只能选择一条记录!"),!1;var e=jQuery("#myTable").jqGrid("getRowData",a.selected[0]);return a.reportDocument.documentStatus=e.documentStatus,a.reportDocument.code=e.code,a.reportDocument.id=a.selected[0],""===a.reportDocument.code?(layer.alert("请提交放行单!"),!1):(specialReleaseDocument.initApproval(a.reportDocument.code),"暂存"==a.reportDocument.documentStatus?(layer.alert("请先提交放行单!"),!1):void $.ajax({type:"POST",url:contextPath+"/testReportDocumentController/findUserOperation",contentType:"application/json",data:JSON.stringify({receiptsId:a.reportDocument.code,docTypeCode:"fxd"}),dataType:"json",success:function(e){if(console.log(e.code),"100515"===e.code&&(layer.alert("审核成功"),a.reportDocument.documentStatus="已审核",a.saveMethod(),a.reloadAgain()),"100514"===e.code){var t=1===e.data?"【一级审核】":2===e.data?"【二级审核】":3===e.data?"【三级审核】":4===e.data?"【四级审核】":5===e.data?"【五级审核】":6===e.data?"【六级审核】":e.msg;layer.alert(0===e.data?"该单据已被驳回到申请人，待申请人提交!":"您没有"+t+"的审核权限")}if("100100"===e.code){if("已审核"===a.reportDocument.documentStatus)return layer.alert("此单已审核"),!1;a.approveComment=!0}},error:function(e){layer.alert("服务器出错")}}))},reject:function(){var a=this;if(0==this.selected.length)return layer.alert("请选择一条数据!"),!1;if(1<this.selected.length)return layer.alert("只能选择一条记录!"),!1;var e=jQuery("#myTable").jqGrid("getRowData",a.selected[0]);return a.reportDocument.documentStatus=e.documentStatus,a.reportDocument.code=e.code,a.reportDocument.id=a.selected[0],""===a.reportDocument.code?(layer.alert("请提交放行单!"),!1):"暂存"==a.reportDocument.documentStatus?(layer.alert("请先提交放行单!"),!1):"已审核"==a.reportDocument.documentStatus?(layer.alert(" 单据已经审核完成!"),!1):void $.ajax({type:"POST",url:contextPath+"/testReportDocumentController/findUserOperation",contentType:"application/json",data:JSON.stringify({receiptsId:a.reportDocument.code,docTypeCode:"fxd"}),dataType:"json",success:function(e){if("100100"===e.code&&(a.rejectComment=!0),"100514"===e.code){var t=1===e.data?"【一级审核】":2===e.data?"【二级审核】":3===e.data?"【三级审核】":4===e.data?"【四级审核】":5===e.data?"【五级审核】":6===e.data?"【六级审核】":e.msg;layer.alert(0===e.data?"该单据已被驳回到申请人，待申请人提交!":"您没有"+t+"的驳回权限")}"100515"===e.code&&(layer.alert("驳回成功"),a.reportDocument.documentStatus="驳回",a.saveMethod(),a.reloadAgain())},error:function(e){layer.alert("服务器出错")}})},getApproveInfo:function(){var t=this,a=jQuery("#myTable").jqGrid("getRowData",t.selected[0]);t.approvement.receiptsId=a.code,t.reportDocument.id=t.selected[0],t.approvement.boeId=t.selected[0],$.ajax({type:"POST",url:contextPath+"/testReportDocumentController/submitapproval",contentType:"application/json",data:JSON.stringify(this.approvement),dataType:"json",success:function(e){if(console.log(e.data),"100100"===e.code){if(layer.alert("审核成功"),0===e.data.approvalStatus){if("审核中"===t.reportDocument.documentStatus)return!1;t.reportDocument.documentStatus="审核中"}1===e.data.approvalStatus&&(t.reportDocument.documentStatus="已审核",a.documentStatus="已审核"),t.saveMethod()}else layer.alert("审核失败");t.approvement={receiptsId:"",approvalResult:1,approvalInfo:"",boeId:""},specialReleaseDocument.initApproval(t.approvement.receiptsId)},error:function(e){layer.alert("服务器出错")}})},getRejectInfo:function(){var t=this,a=jQuery("#myTable").jqGrid("getRowData",t.selected[0]);t.rejectement.receiptsId=a.code,t.reportDocument.id=t.selected[0],t.rejectement.boeId=t.selected[0],$.ajax({type:"POST",url:contextPath+"/testReportDocumentController/submitapproval",contentType:"application/json",data:JSON.stringify(t.rejectement),dataType:"json",success:function(e){console.log(e.data),"100100"===e.code?(layer.alert("驳回成功"),-2===e.data.approvalStatus?(t.reportDocument.documentStatus="暂存",a.documentStatus="暂存"):(t.reportDocument.documentStatus="驳回",a.documentStatus="驳回"),t.saveMethod()):layer.alert("驳回失败"),t.rejectement={receiptsId:"",approvalResult:"0",approvalInfo:"",boeId:""},specialReleaseDocument.initApproval(t.rejectement.receiptsId)},error:function(e){layer.alert("服务器出错")}})},saveMethod:function(){var t=this;$.ajax({type:"POST",url:contextPath+"/specialReleaseDocument/updateStatusByApproval",contentType:"application/json",data:JSON.stringify(t.reportDocument),dataType:"json",success:function(e){console.log("修改成功"),t.reloadAgain()},error:function(e){layer.alert("服务器出错")}})},initApproval:function(e){var c=this;$.ajax({type:"post",url:contextPath+"/specialReleaseDocument/queryProcessInfoByReceiptsId",data:JSON.stringify({receiptsId:e}),contentType:"application/json",dataType:"json",success:function(e){var t=e.data&&e.data.list;if(t){for(var a=0;a<t.length;a++)switch(t[a].processLevel){case 1:t[a].processLevel="一级审核";break;case 2:t[a].processLevel="二级审核";break;case 3:t[a].processLevel="三级审核";break;case 4:t[a].processLevel="四级审核";break;case 5:t[a].processLevel="五级审核";break;case 6:t[a].processLevel="六级审核"}if(t.unshift({processLevel:"开始"}),t.push({processLevel:"结束"}),(c.steplist=t)[1].currentLevel===e.data.levelLength){for(var o=0;o<t.length;o++)t[o].currentLevel=t.length-1;return!1}for(var n=t[1].currentLevel,r=0;r<c.stepData.length;r++)n===c.stepData[r].currentLevel&&(c.currentStep=c.stepData[r+1].subtitle,c.stepData[r+1].currentLevel===e.data.levelLength?c.nextStep=c.stepData[c.stepData.length-1].subtitle:c.nextStep=c.stepData[r+2].subtitle)}},error:function(){alert("服务器出错啦")}})},hideSearch:function(){this.isHide=!this.isHide,this.isSearchHide=!this.isSearchHide,$(".chevron").css("top","")},hidTabulation:function(){this.isHide=!this.isHide,this.isTabulationHide=!this.isTabulationHide,this.isTabulationHide?$(".chevron").css("top",""):$(".chevron").css("top","90%")},_ajaxgetDocumentType:function(){var t=this,e=contextPath+"/specialReleaseDocument/getDocumentType?";$.ajax({type:"post",url:e,dataType:"json",success:function(e){console.log(e),"100100"===e.code&&e.data.map(function(e){t.getDocumentTypeList[e.value.toString()]=e.name})},error:function(){}})}},watch:{"body.applicantName":function(e){void 0===e&&(this.body.applicantName="")},"body.documentStatus":function(e){void 0===e&&(this.body.documentStatus="")}},created:function(){this._ajaxgetDocumentType()},mounted:function(){this.openTime=window.parent.params.openTime,$.ajax({type:"post",url:contextPath+"/specialReleaseDocument/getDocumentStatus",dataType:"json",success:function(e){specialReleaseDocument.documentStatusList=e.data},error:function(){alert("服务器出错啦")}}),$.ajax({type:"post",url:contextPath+"/specialReleaseDocument/queryallempbyorganid",dataType:"json",success:function(e){specialReleaseDocument.applicantNameList=e.data,console.log(specialReleaseDocument.applicantNameList)},error:function(){alert("服务器出错啦")}})}});