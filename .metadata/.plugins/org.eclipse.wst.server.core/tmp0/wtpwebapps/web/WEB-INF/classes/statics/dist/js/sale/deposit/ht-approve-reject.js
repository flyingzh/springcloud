"use strict";Vue.component("ht-approve-reject",{props:{trigger:Boolean,modalType:String,receiptId:String,receiptStatus:String,stepList:Array,urlInitApprove:String,urlCheck:String,urlApprove:String,statusMap:{require:!1,type:Object,default:function(){return{tmp_save:"1",await_check:"2",checking:"3",auditing:"4",reject:"5"}}},urlTableData:{require:!1,type:String,default:function(){return""}},tableData:{require:!1,type:Array,default:function(){return[]}}},data:function(){return{isVisible:!1,dataInfo:{},currentStep:"",nextStep:"",stepsMap:{0:"开始",1:"一级审核",2:"二级审核",3:"三级审核",4:"四级审核",5:"五级审核",6:"六级审核",7:"结束"},showApprove:!1,showReject:!1}},template:'<div v-clock>\n    <modal\n    title="审核"\n    v-model="showApprove"\n    :closable="false"\n    @on-ok="getApproveInfo"\n    @on-cancel="isVisible = false"\n    >\n        <div>\n        <p class="mg-bm-md">\n        <span>当前节点：{{currentStep}}</span>\n        <span class="mg-lf-sbg">下级节点：{{nextStep}}</span>\n        </p>\n        <span>审核意见</span>\n        <i-input type="textarea" :rows="4" v-model="dataInfo.approvalInfo" placeholder="请输入审核意见"></i-input>\n        </div>\n    </modal>\n    <modal\n    title="驳回"\n    v-model="showReject"\n    :closable="false"\n    @on-ok="getRejectInfo"\n    @on-cancel="isVisible = false">\n        <div>\n        <radio-group v-model="dataInfo.approvalResult" class="mg-bm-md" >\n        <radio label="0">驳回上一级</radio>\n        <radio label="-1" class="mg-lf-sbg">驳回到开始级次</radio>\n        </radio-group>\n        <p style="font-weight: 600" class="mg-bm-md">驳回意见</p>\n        <i-input  type="textarea" :rows="4" v-model="dataInfo.approvalInfo" placeholder="请输入驳回意见"></i-input>\n        </div>\n    </modal>\n    </div>',methods:{checkRight:function(){var e=this;console.log("receiptStatus:"+e.receiptStatus);var t=e.statusMap.auditing;if(e.receiptStatus==t)return e.$Modal.warning({title:"提示",content:"reject"==e.modalType?"已审核的单据不能驳回!":"单据已审核"}),!1;var a=e.statusMap.tmp_save;if(!e.receiptId||e.receiptStatus==a)return e.$Modal.warning({title:"提示",content:"请先提交单据!"}),!1;$.ajax({type:"POST",url:e.urlCheck,contentType:"application/json",data:JSON.stringify({receiptsId:e.receiptId}),dataType:"json",success:function(t){"approve"==e.modalType&&e.approvalHandler(t),"reject"==e.modalType&&e.rejectHandler(t)},error:function(t){e.$Modal.error({title:"提示",content:"服务器出错"})}})},rejectHandler:function(t){var e=this;"100515"===t.code&&(e.$Modal.error({title:"提示",content:"驳回成功"}),e.$emit("on-auto-approve",{result:t})),"100514"===t.code&&(e.isVisible=!1,e.$Modal.error({title:"提示",content:0===t.data?"该单据已被驳回到申请人，待申请人提交!":"您没有【"+e.stepsMap[t.data]+"】的驳回权限"})),"100100"===t.code&&(e.initApproval(),e.isVisible=!0)},approvalHandler:function(t){var e=this;"100515"===t.code&&(e.$Modal.success({title:"提示",content:"审核成功"}),e.$emit("on-auto-approve",{result:t})),"100514"===t.code&&(e.isVisible=!1,e.$Modal.error({title:"提示",content:0===t.data?"该单据已被驳回到申请人，待申请人提交!":"您没有【"+e.stepsMap[t.data]+"】的审核权限"})),"100100"===t.code&&(e.initApproval(),e.isVisible=!0)},initApproval:function(){var l=this;$.ajax({type:"post",url:l.urlInitApprove,data:JSON.stringify({receiptsId:l.receiptId}),dataType:"json",contentType:"application/json",success:function(t){if(console.log("执行了"),$.isEmptyObject(t.data))return!1;for(var e=t.data.list,a=l.stepsMap,n=0;n<e.length;n++){var i=e[n].processLevel;e[n].processLevel=a[i]}e.unshift({processLevel:"开始"}),e.push({processLevel:"结束"}),l.stepList=e,l.$emit("update:stepList",e);var r=e[1].currentLevel,o=r===t.data.levelLength,p=t.data.levelLength;if(o){for(var s=0;s<e.length;s++)e[s].currentLevel=e.length-1;l.$emit("step-info",{currentStep:l.currentStep,nextStep:l.nextStep}),l.$emit("update:stepList",e)}else l.currentStep=l.stepsMap[r+1],l.nextStep=r+1==p?l.stepsMap[7]:l.stepsMap[r+2],l.$emit("step-info",{currentStep:l.currentStep,nextStep:l.nextStep})},error:function(){alert("服务器出错啦")}})},getApproveInfo:function(){var e=this;e.dataInfo.receiptsId=e.receiptId,e.dataInfo.approvalResult="1",$.ajax({type:"POST",url:this.urlApprove,contentType:"application/json",data:JSON.stringify(e.dataInfo),dataType:"json",success:function(t){"100100"===t.code?(e.$Modal.success({title:"提示",content:"审核成功!"}),e.loadTableData()):e.$Modal.warning({title:"提示",content:"审核失败!"}),e.isVisible=!1,e.$emit("on-approve",{action:"approve",result:t})},error:function(t){e.$Modal.warning({title:"提示",content:"服务器出错!"})}})},getRejectInfo:function(){var e=this;e.dataInfo.receiptsId=e.receiptId,$.ajax({type:"POST",url:this.urlApprove,contentType:"application/json",data:JSON.stringify(e.dataInfo),dataType:"json",success:function(t){"100100"===t.code?(e.$Modal.success({title:"提示",content:"驳回成功!"}),e.loadTableData()):e.$Modal.warning({title:"提示",content:"驳回失败!"}),e.isVisible=!1,e.$emit("on-reject",{action:"reject",result:t})},error:function(t){e.$Modal.warning({title:"提示",content:"服务器出错!"})}})},loadTableData:function(){var a=this,n=a.stepsMap;if(!a.urlTableData)return!1;$.ajax({type:"POST",url:this.urlTableData,data:{receiptsId:a.receiptId},dataType:"json",success:function(t){if("100100"===t.code&&0<t.data.length){var e=t.data.map(function(t){return Object.assign({},{approvalResult:1===t.approvalResult?"审核":"驳回",currentLevel:n[t.currentLevel],nextLevel:n[t.nextLevel],createName:t.createName,approvalInfo:t.approvalInfo,createTime:t.createTime})});a.$emit("update:tableData",e)}},error:function(t){}})}},computed:{},watch:{trigger:function(){this.checkRight(),"approve"==this.modalType&&(this.dataInfo.approvalInfo=""),"reject"==this.modalType&&(this.dataInfo.approvalInfo="",this.dataInfo.approvalResult="0")},isVisible:function(){"approve"==this.modalType?this.showApprove="approve"==this.modalType&&1==this.isVisible:this.showApprove=!1,"reject"==this.modalType?this.showReject="reject"==this.modalType&&1==this.isVisible:this.showReject=!1},receiptStatus:function(){var t=this;console.log(t.receiptId,t.receiptStatus);var e=t.statusMap.await_check,a=t.statusMap.checking,n=t.statusMap.auditing,i=t.statusMap.reject;t.receiptId&&t.receiptStatus==e&&(setTimeout(function(){t.initApproval()},1e3),t.loadTableData()),!t.receiptId||t.receiptStatus!=a&&t.receiptStatus!=n&&t.receiptStatus!=i||(t.initApproval(),t.loadTableData())}},mounted:function(){}});