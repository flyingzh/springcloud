"use strict";var parvm=new Vue({el:"#unit-info",data:function(){return{isShow:!1,reload:!1,isLook:!1,isBubbling:!0,codeFlag:!1,buttonFlag:!0,isSearchHide:!0,selected:[],nodeData:[],unitGroup:[],user:{id:"",username:""},setting1:{data:{simpleData:{idKey:"id",enable:!0},key:{name:"name"}},callback:{onClick:this.clickEvent}},tmpUnit:"",tmpGroupId:"",unitGroupName:"",openTime:"",unitGroupBody:{id:"",name:""},body:{name:"",code:"",groupId:""},unitInfo:{id:"",code:"",name:"",groupId:"",conversionRate:"",isDefault:!1,createTime:"",createName:"",createId:""},data_config:{url:contextPath+"/tbaseunit/list",colNames:["代码","单位名称","换算率","是否默认","创建人","创建时间","单位组"],colModel:[{name:"code",align:"left",width:120,formatter:function(e,t){return $(document).off("click",".detail"+e).on("click",".detail"+e,function(){parvm.unitInfo.code=e,parvm.detailClick()}),'<a class="detail'+e+'">'+e+"</a>"}},{name:"name",index:"",width:120,align:"left"},{name:"conversionRate",index:"amount",width:80,align:"right"},{name:"isDefault",index:"tax",width:80,align:"left",formatter:function(e){return 1==e?"是":"否"}},{name:"createName",index:"total",width:120,align:"left"},{name:"createTime",index:"note",width:120,sortable:!1},{name:"groupId",index:"note",width:120,sortable:!1,hidden:!0}]},treeUrl:contextPath+"/tbaseunitgroup/list"}},methods:{hideSearch:function(){this.isSearchHide=!this.isSearchHide,$(".chevron").css("top","")},addUnitGroup:function(){this.unitGroupName="";var t=layer.open({type:1,title:"新增单位组",content:$("#addUnitGroup"),btn:["保存","取消"],area:"400px",btn1:function(){$("#groupFrom").valid()&&$.ajax({type:"POST",url:contextPath+"/tbaseunitgroup/save?name=",contentType:"application/json",data:JSON.stringify(parvm.unitGroupName),success:function(e){console.log(e),layer.close(t),"100100"===e.code?layer.alert(e.msg,{icon:1,end:function(){location.reload()}}):layer.alert(e.msg)}})},btn2:function(e,t){$("#groupFrom").validate().resetForm(),layer.close(e)}})},modifyUnitGroup:function(){var e=this;if(""!=parvm.tmpGroupId)var t=layer.open({type:1,title:"修改单位组",content:$("#modifyUnitGroup"),btn:["保存","取消"],area:"400px",btn1:function(){console.log("调用了修改按钮函数"),e.unitGroupBody.id=e.tmpUnit,e.unitGroupBody.name=e.unitGroupName,$.ajax({type:"POST",url:contextPath+"/tbaseunitgroup/update",contentType:"application/json",data:JSON.stringify(e.unitGroupBody),success:function(e){"100100"===e.code?layer.alert(e.msg,{icon:1,end:function(){location.reload()}}):layer.alert(e.msg)}}),layer.close(t)},btn2:function(e,t){$("#groupFrom").validate().resetForm(),layer.close(e)}});else layer.alert("请先选择单位组!")},clickEvent:function(e,t,n){var o=this.$ztree.getSelectedNodes();console.log(n),parvm.body.groupId=n.id,parvm.tmpGroupId=n.id,parvm.tmpUnit=n.id,parvm.unitGroupName=n.name,console.log(o),this.reload=!this.reload},initAddBody:function(){this.body={name:"",code:"",groupId:""}},search:function(){console.log("搜索"),this.reload=!this.reload},delUnitGroup:function(){var n=this,o=n.tmpUnit;console.log(o),0!=o.length?layer.confirm("当前数据有可能被引用，会影响数据准确性，确认是否删除？",{btn:["确定","取消"]},function(e,t){$.ajax({type:"POST",url:contextPath+"/tbaseunitgroup/delete?id="+o,dataType:"json",success:function(e){"100100"==e.code?(layer.closeAll("dialog"),layer.msg(e.msg,{icon:1,time:1e3}),location.reload(),n.tmpUnit=""):layer.alert(e.msg)},error:function(e){console.log("error")}})}):layer.alert("请先选择单位组!")},clear:function(){this.body={name:"",code:""},console.log("清空"),this.reload=!this.reload},clearUnitInfo:function(){this.unitInfo={id:"",code:"",name:"",groupId:"",conversionRate:"",isDefault:!1,createTime:"",createId:""}},add:function(){console.log("这是新增"),""!==parvm.tmpUnit?(parvm.clearUnitInfo(),this.unitInfo.createName=this.user.username,parvm.codeFlag=!1,this.isLook=!1,this.isShow=!0,parvm.unitInfo.createTime=(new Date).Format("yyyy-MM-dd hh:mm:ss")):layer.alert("请选择单位组")},del:function(){console.log("这是删除");var n=this,e=n.selected;if(console.log(n.selected),!ht.util.hasValue(e,"array"))return layer.alert("请先选择一条删除记录!"),!1;layer.confirm("当前数据有可能被引用，会影响数据准确性，确认是否删除？",{btn:["确定","取消"]},function(e,t){$.ajax({type:"POST",url:contextPath+"/tbaseunit/delete",contentType:"application/json",data:JSON.stringify(n.selected),dataType:"json",success:function(e){"100100"==e.code?(layer.closeAll("dialog"),layer.alert(e.data),n.reload=!n.reload,n.selected=[]):layer.msg(e.msg)}})})},modify:function(){if(1<this.selected.length)layer.alert("修改只能对单条数据进行操作！");else{this.unitGroupBody.id=this.selected[0],parvm.buttonFlag=!0,console.log(this.selected[0]);var e=parvm.selected;if(!ht.util.hasValue(e,"array"))return layer.alert("请选择单位！"),!1;this.unitInfo.createName=this.user.username,parvm.codeFlag=!0,$.ajax({type:"POST",url:contextPath+"/tbaseunit/infoUnitById",data:{id:parvm.unitGroupBody.id},success:function(e){parvm.unitInfo=e.data,console.log(parvm.unitInfo),parvm.unitGroupBody.id=parvm.unitInfo.groupId}}),this.isShow=!0}},detailClick:function(e){parvm.codeFlag=!0,console.log(parvm.unitInfo.code),$.ajax({type:"POST",url:contextPath+"/tbaseunit/infoUnitByCode",data:{code:parvm.unitInfo.code},success:function(e){console.log(e),parvm.unitInfo=e.data}}),this.isShow=!0,this.isLook=!0},type:function(){this.isShow=!0,this.isLook=!0},save:function(){console.log("这是保存");var t=this;console.log($("#my_from").valid()),$("#my_from").valid()&&(t.buttonFlag=!1,""==this.unitGroupBody.id?(parvm.unitInfo.groupId=parvm.tmpUnit,$.ajax({type:"POST",url:contextPath+"/tbaseunit/save",contentType:"application/json",data:JSON.stringify(parvm.unitInfo),success:function(e){t.buttonFlag=!0,console.log(e),"100100"==e.code?(parvm.unitInfo.createName=parvm.user.username,layer.alert(e.msg),t.isShow=!1,t.clearUnitInfo(),t.reload=!t.reload):layer.alert(e.msg)},error:function(e){layer.alert(e.message)}})):(parvm.unitInfo.groupId=parvm.tmpUnit,parvm.unitInfo.groupId=parvm.unitGroupBody.id,console.log(JSON.stringify(parvm.unitInfo)),$.ajax({type:"POST",url:contextPath+"/tbaseunit/update",contentType:"application/json",data:JSON.stringify(parvm.unitInfo),success:function(e){t.buttonFlag=!0,"100100"==e.code?(parvm.unitInfo.createName=parvm.user.username,layer.alert(e.msg),t.isShow=!1,t.clearUnitInfo(),t.reload=!t.reload):layer.alert(e.msg)},error:function(e){console.log("error")}})))},cancel:function(){console.log("这是取消"),this.unitGroupName="",this.tmpUnit="",this.initAddBody(),this.isShow=!1,this.selected=[],this.isEdit=!1,this.isLook=!1,this.buttonFlag=!0,$("form").validate().resetForm(),this.isBubbling=!0},exit:function(){window.parent.closeCurrentTab({exit:!0,openTime:this.openTime})},copy:function(){parvm.buttonFlag=!0,console.log("经复制了。。。");var e=jQuery("#mytable").jqGrid("getRowData",this.selected[0]);console.log(e),this.unitInfo.groupId=e.groupId;var t=this.selected;if(!ht.util.hasValue(t,"array"))return layer.alert("请先选择一条单位!"),!1;parvm.codeFlag=!1,parvm.queryUnit(),parvm.unitInfo.code="",this.isLook=!1,this.isShow=!0},queryUnit:function(){$.ajax({type:"POST",url:contextPath+"/tbaseunit/infoUnitById",data:{id:this.selected[0]},success:function(e){console.log(e),parvm.unitInfo.createTime=(new Date).Format("yyyy-MM-dd hh:mm:ss"),parvm.unitInfo.conversionRate=e.data.conversionRate,parvm.unitInfo.createName=e.data.createName,parvm.unitInfo.isDefault=e.data.isDefault,console.log(parvm.unitInfo)}})},getUser:function(){$.ajax({type:"POST",url:contextPath+"/tbaseunit/findUser",success:function(e){console.log(e),parvm.unitInfo.createName=e.data.username,parvm.unitInfo.createId=e.data.createId,parvm.user.username=e.data.username}})},initFormValidate:function(){var e={onfocusout:function(e){$(e).valid()},onkeyup:!1,rules:{code:{required:!0,remote:{url:contextPath+"/tbaseunit/infoUnitByCode",type:"post",dataType:"json",data:{code:function(){return parvm.unitInfo.code},id:function(){return parvm.unitInfo.id}},dataFilter:function(e,t){return"100100"===JSON.parse(e).code}}},unitName:{required:!0,remote:{url:contextPath+"/tbaseunit/infoUnitByName",type:"post",dataType:"json",data:{name:function(){return parvm.unitInfo.name},id:function(){return parvm.unitInfo.id}},dataFilter:function(e,t){return"100100"===JSON.parse(e).code}}},unitGroupName:{required:!0,remote:{url:contextPath+"/tbaseunitgroup/info",type:"post",dataType:"json",data:{name:function(){return parvm.unitGroupName}},dataFilter:function(e,t){return"100100"!==JSON.parse(e).code}}},remark:{maxlength:255}},messages:{code:{required:"请填写编码!",remote:"该编码已存在!"},unitName:{required:"请填写单位名称!",remote:"该单位名称已存在!"},unitGroupName:{required:"请填写单位组名称!",remote:"该单位组名称已存在!"},remark:{maxlength:"备注最大长度为50!"}}};$("#groupFrom").validate(e),$("#my_from").validate(e)}},created:function(){this.getUser()},mounted:function(){this.initFormValidate(),this.openTime=window.parent.params.openTime}});