"use strict";var vm=new Vue({el:"#app",data:{isShow:!1,isEdit:!1,reload:!1,isSearchHide:!0,isTabulationHide:!0,isHide:!0,selected:[],body:{goodsTypeId:"",docStatus:"",stockNo:"",supplierId:""},data_config:{url:contextPath+"/purchasestock/list",datatype:"json",colNames:["id","单据编号","商品类型","日期","供应商","单据状态","入库重量","入库数量"],colModel:[{name:"id",width:210,align:"left",hidden:!0},{name:"stockNo",width:210,align:"left",formatter:function(e,t,a){return $(document).off("click",".detail"+e).on("click",".detail"+e,function(e){e.preventDefault(),vm.goQuery(a.stockNo)}),'<a class="detail'+e+'">'+e+"</a>"},unformat:function(e,t,a){return e.replace(/(<\/?a.*?>)/g,"")}},{name:"goodsType",width:210,align:"left"},{name:"stockTime",width:210,align:"left"},{name:"supplierName",width:210,align:"left"},{name:"docStatus",align:"left",width:210,formatter:function(e){switch(e){case 1:return"暂存";case 2:return"待审核";case 3:return"审核中";case 4:return"已审核";case 5:return"驳回";default:return""}},unformat:function(e){switch(e){case"暂存":return 1;case"待审核":return 2;case"审核中":return 3;case"已审核":return 4;case"驳回":return 5;default:return""}}},{name:"totalRecWeight",align:"right",width:210},{name:"totalRecNum",align:"right",width:210}]},docStatusArr:[{label:"暂存",value:1},{label:"待审核",value:2},{label:"审核中",value:3},{label:"已审核",value:4},{label:"驳回",value:5}],supplierArr:[],goodsTypeArr:[],selectDates:[],selectedDocStatus:"",categoryType:[],goodsTypes:[],openTime:"",modalTrigger:!0,modalType:"",stepList:[],curStockNo:"",curDocStatus:""},created:function(){this.loadSuppliers(),this.loadCategories(),this.openTime=window.parent.params.openTime},methods:{approvalOrRejectCallBack:function(e){"100100"==e.result.code&&(this.reload=!this.reload)},autoSubmitOrReject:function(e){var t=this;$.ajax({url:contextPath+"/purchasestock/submitapproval?submitType=1",method:"post",contentType:"application/json;charset=utf-8",data:JSON.stringify({receiptsId:t.psiForm.stockNo,approvalResult:"reject"==t.modalType?1:0}),success:function(e){"100100"===e.code?t.reload=!t.reload:t.$Modal.warning({content:e.msg})}})},changeGoodsType:function(e,t){this.body.goodsTypeId=t[t.length-1].value},exit:function(){window.parent.closeCurrentTab({name:"采购入库列表",openTime:this.openTime,exit:!0})},goQuery:function(e){if(!e)return this.$Modal.error({content:"数据异常!"}),!1;window.parent.activeEvent({name:"查看采购入库单",url:contextPath+"/warehouse/purchase-stock-in/purchase-stock-in-info.html",params:{type:"query",stockNo:e}})},add:function(){window.parent.activeEvent({name:"生成采购入库单",url:contextPath+"/warehouse/purchase-stock-in/purchase-stock-in-info.html",params:{type:"add"}})},_approval:function(){var e=this;return!!e.isTableSelected()&&(1<e.selected.length?(e.$Message.warning({content:"只能选择一条数据!",duration:3,closable:!0}),!1):(e.curStockNo=e.selected[0].stockNo,e.curDocStatus=e.selected[0].docStatus,e.modalType="approve",void(e.modalTrigger=!e.modalTrigger)))},_reject:function(){var e=this;return!!e.isTableSelected()&&(1<e.selected.length?(e.$Message.warning({content:"只能选择一条数据!",duration:3,closable:!0}),!1):(e.curStockNo=e.selected[0].stockNo,e.curDocStatus=e.selected[0].docStatus,e.modalType="reject",void(e.modalTrigger=!e.modalTrigger)))},submit:function(){var e=this;return!!e.isTableSelected()&&(1<e.selected.length?(e.$Message.warning({content:"只能选择一条数据!",duration:3,closable:!0}),!1):1!=e.selected[0].docStatus?(e.$Message.warning({content:"选中的单据当前不可提交!",duration:3,closable:!0}),!1):void e.$Modal.confirm({title:"提示",content:"确定提交选中的单据吗?",onOk:function(){e.ajaxSubmit(e.selected[0].id)}}))},ajaxSubmit:function(e){var t=this;$.ajax({url:contextPath+"/purchasestock/submit",method:"POST",dataType:"json",data:{id:e},success:function(e){"100100"===e.code?(t.$Message.info({content:"提交成功!",duration:3,closable:!0}),t.refresh()):t.$Message.warning({content:e.msg,duration:3,closable:!0})}})},clear:function(){var e=this;e.goodsTypes=[],e.body.goodsTypeId="",e.body.startTime="",e.body.endTime="",e.body.stockNo="",e.body.docStatus&&(e.$refs.docStatus.reset(),e.$nextTick(function(){e.body.docStatus=""})),e.body.supplierId&&(e.$refs.supplier.reset(),e.$nextTick(function(){e.body.supplierId=""})),e.selectDates=[]},changeDate:function(e){this.body.startTime=e[0].replace(/\//g,"-")+" 00:00:00",this.body.endTime=e[1].replace(/\//g,"-")+" 23:59:59"},search:function(){this.reload=!this.reload,this.selected=[]},loadSuppliers:function(){var t=this;$.ajax({url:contextPath+"/purchasestock/querySuppliers",method:"POST",dataType:"json",data:{},success:function(e){t.supplierArr=[],"100100"===e.code&&0<e.data.length&&e.data.forEach(function(e){t.supplierArr.push(Object.assign({},{label:e.siShortName,value:e.id,code:e.supplierCode}))})}})},loadCategories:function(){var t=this;$.ajax({type:"post",url:contextPath+"/purchasestock/queryCategories",data:{parentId:0},dataType:"json",success:function(e){"100100"===e.code&&(t.categoryType=t.initGoodCategory(e.data.cateLists))},error:function(){}})},initGoodCategory:function(e){var n=this,s=[];return e.forEach(function(e){var t=e.id,a=e.name,o=e.cateLists;o&&(o=n.initGoodCategory(o)),s.push({value:t,label:a,children:o})}),s.forEach(function(e){e.children||delete e.children}),s},del:function(){var n=this;if(!n.isTableSelected())return!1;n.$Modal.confirm({title:"提示",content:"确定删除选中的数据吗?",onOk:function(){var e=n.selected,t=[],a=[];e.forEach(function(e){1!=e.docStatus&&t.push(e.stockNo),a.push(e.id)});var o="";if(0<t.length)return o="单据编号为["+t.join(",")+"]的单据不可删除!",n.$Message.warning({content:o,duration:3,closable:!0}),$("#myTable").trigger("reloadGrid"),!1;n.ajaxDel(a)}})},getSelectRow:function(){var e=[],t=!0,a=!1,o=void 0;try{for(var n,s=this.selected[Symbol.iterator]();!(t=(n=s.next()).done);t=!0){var r=n.value,c=$("#myTable").jqGrid("getRowData",r);e.push(c)}}catch(e){a=!0,o=e}finally{try{!t&&s.return&&s.return()}finally{if(a)throw o}}return e},ajaxDel:function(e){var t=this;$.ajax({url:contextPath+"/purchasestock/delete",method:"POST",dataType:"json",data:{ids:e.join(",")},success:function(e){"100100"===e.code?(t.$Message.info({content:"删除成功!",duration:3,closable:!0}),t.reload=!t.reload,t.selected=[]):t.$Message.warning({content:e.msg,duration:3,closable:!0})}})},ajaxSubmitApproval:function(){var o=this,e=o.getSelectRow()[0].stockNo;o.approval.receiptsId=e,$.ajax({url:contextPath+"/purchasestock/submitapproval",method:"POST",dataType:"json",contentType:"application/json;charset=utf-8",data:JSON.stringify(o.approval),success:function(e){if("100100"===e.code){o.$Message.info({content:"审核成功!",duration:3,closable:!0});var t=e.data.approvalStatus,a="";if(0===t)a=3;else{if(1!==t)return o.$Message.warning({content:"审核异常!",duration:3,closable:!0}),!1;a=4}o.ajaxUpdateDocStatusById(o.selected[0],a)}else o.$Message.warning({content:e.msg,duration:3,closable:!0});o.approval={receiptsId:"",approvalResult:"1",approvalInfo:""}}})},ajaxSubmitReject:function(){var o=this,e=o.getSelectRow()[0].stockNo;o.reject.receiptsId=e,$.ajax({url:contextPath+"/purchasestock/submitapproval",method:"POST",dataType:"json",contentType:"application/json;charset=utf-8",data:JSON.stringify(o.reject),success:function(e){if("100100"===e.code){o.$Message.info({content:"驳回成功!",duration:3,closable:!0});var t=e.data.approvalStatus,a=5;if(-2===t)a=1;else if(!t)return o.$Message.warning({content:"驳回异常!",duration:3,closable:!0}),!1;o.ajaxUpdateDocStatusById(o.selected[0],a)}else o.$Message.warning({content:e.msg,duration:3,closable:!0});o.reject={receiptsId:"",approvalResult:"0",approvalInfo:""}}})},ajaxUpdateDocStatusById:function(e,t){var a=this;$.ajax({url:contextPath+"/purchasestock/updateDocStatusById",method:"POST",dataType:"json",data:{id:e,docStatus:t},success:function(e){"100100"===e.code?(a.reload=!a.reload,a.selected=[]):a.$Message.warning({content:e.msg,duration:3,closable:!0})}})},refresh:function(){this.clear(),this.reload=!this.reload,this.selected=[]},isTableSelected:function(){return!(this.selected.length<1)||(this.$Message.warning({content:"请先选择一条数据!",duration:3,closable:!0}),!1)},goUpdate:function(){var e=this.selected;return 0==e.length?(this.$Modal.warning({content:"请先选择一条数据!"}),!1):1<e.length?(this.$Modal.warning({content:"只能选择一条数据!"}),!1):1!=e[0].docStatus?(this.$Modal.warning({content:"只有暂存的数据才能修改!"}),!1):void window.parent.activeEvent({name:"采购入库单-修改",url:contextPath+"/warehouse/purchase-stock-in/purchase-stock-in-info.html",params:{type:"update",stockNo:e[0].stockNo}})}},mounted:function(){}});