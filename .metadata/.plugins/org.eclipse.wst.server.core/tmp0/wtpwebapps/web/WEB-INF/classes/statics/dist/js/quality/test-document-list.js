"use strict";var inventory=new Vue({el:"#imcomingReportList",data:function(){var a=this;return{isLook:!0,isEdit:!1,reload:!1,isSearchHide:!0,isTabulationHide:!0,isHide:!0,selected:[],showHighSearch:!1,otherSearch:[],openTime:"",organList:[],dataValue:[],selectDateArr:[],inspectorNameList:[],commodityCategoty:[],categoryType:[],statusList:[],simpleType:"",params:"",body:{documentType:"",testedOrganizationName:"",documentCode:"",documentStatus:"",productTypeName:"",startTime:"",endTime:"",inspectorName:""},documentCode:"",documentStatus:"",modalTrigger:!1,modalType:"",approvalTableData:[],stepList:[],data_config:{url:contextPath+"/documentAllController/list",colNames:["testReportId","correctPreventId","id","单据编号","单据类型","单据日期","单据状态","质检员","被检组织","质检完成时间","商品类型","检验总数量","合格数","不合格数","合格率","检验结果"],colModel:[{name:"testReportId",width:80,align:"center",hidden:!0},{name:"correctPreventId",width:80,align:"center",hidden:!0},{name:"id",width:80,align:"center",hidden:!0},{name:"documentCode",index:"id",width:160,align:"left",formatter:function(t,e,n,o){return $(document).on("click",".detail"+t,function(){a.detailClick({value:t,grid:e,rows:n,state:o})}),'<a class="detail'+t+'">'+t+"</a>"},unformat:function(t,e,n){return t.replace(/(<\/?a.*?>)/g,"")}},{name:"documentType",width:100,align:"left",formatter:function(t,e,n,o){return"kcjyd"===t?"库存检验单":"mdjyd"===t?"门店检验单":""}},{name:"createTime",width:100,align:"left",formatter:function(t,e,n,o){return new Date(t).format("yyyy-MM-dd")}},{name:"documentStatus",width:80,align:"left",formatter:function(t,e,n,o){return 1==t?"暂存":2==t?"待审核":3==t?"审核中":4==t?"已审核":5==t?"驳回":""},unformat:function(t,e,n,o){return"暂存"==t?1:"待审核"==t?2:"审核中"==t?3:"已审核"==t?4:"驳回"==t?5:void 0}},{name:"inspectorName",width:80,sortable:!1,align:"left"},{name:"testedOrganizationName",width:90,align:"left"},{name:"testFinishTime",width:150,sortable:!1,align:"left"},{name:"productTypeName",width:100,sortable:!1,align:"left"},{name:"testTotalAmount",width:80,sortable:!1,align:"right"},{name:"qualifiedTotalAmount",width:80,sortable:!1,align:"right"},{name:"unqualifiedTotalAmount",width:80,sortable:!1,align:"right"},{name:"qualifiedPercent",width:80,sortable:!1,align:"right"},{name:"testResult",width:80,sortable:!1,align:"left",formatter:function(t,e,n,o){return"jyjghg"===t?"合格":"jyjgbhg"===t?"不合格":""}}]}}},created:function(){"门店检验单"==window.parent.params.name&&(this.simpleType="mdjyd",this.body.documentType=this.simpleType),"库存检验单"==window.parent.params.name&&(this.simpleType="kcjyd",this.body.documentType=this.simpleType)},methods:{changeDate:function(t){this.body.startTime=t[0].replace(/\//g,"-")+" 00:00:00",this.body.endTime=t[1].replace(/\//g,"-")+" 23:59:59"},search:function(){0<this.commodityCategoty.length?this.body.productTypeId=this.commodityCategoty[this.commodityCategoty.length-1]:this.body.productTypeId="",this.reload=!this.reload},clear:function(){this.commodityCategoty=[],this.$nextTick(function(){this.body.inspectorName=""}),this.body={testedOrganizationName:"",documentCode:"",documentStatus:"",productTypeName:"",startTime:"",endTime:"",inspectorName:"",documentType:this.simpleType},this.dataValue=[]},detailClick:function(t){var e=t.rows.documentCode;e&&window.parent.activeEvent({name:"查看"+this.params,url:contextPath+"/quality/inventory/test-document.html",params:{docCode:e,activeType:"query"}})},refresh:function(){this.clear(),this.reload=!this.reload},add:function(){window.parent.activeEvent({name:"新增"+this.params,url:contextPath+"/quality/inventory/test-document.html",params:{documentType:this.simpleType,activeType:"add"}})},submit:function(){var e=this.selected;if(console.log("submit",e),e.length<1)layer.alert("请至少选择一条数据");else if(1<e.length)layer.alert("只能选择一条数据");else{var n=this;"1"==e[0].documentStatus?$.ajax({type:"POST",url:contextPath+"/documentAllController/submit",dataType:"json",data:{testDocumentId:e[0].id},success:function(t){console.log(t),"100100"===t.code?(e[0].documentStatus="2",n.updateStatus(e[0].id,"2"),n.refresh(),layer.alert("提交成功")):(e[0].documentStatus="temporary_save",layer.alert(t.msg))},error:function(t){n.$Spin.hide(),console.log("服务器出错")}}):layer.alert("单据状态不为暂存不能提交！")}},createReport:function(){var t=this.selected;console.log("document",t),1<t.length?layer.alert("只能选择一条数据"):t.length<1?layer.alert("请至少选择一条数据"):"4"==t[0].documentStatus?window.parent.activeEvent({name:"生成报告单",url:contextPath+"/quality/quality/inspection-report2.html",params:{testDocumentId:t[0].id,code:t[0].documentCode}}):layer.alert("该单未完成审核，不能生成报告单")},update:function(){var t=this.selected;t.length<1?layer.alert("请至少选择一条数据"):1<t.length?layer.alert("只能选择一条数据"):window.parent.activeEvent({name:"修改"+this.params,url:contextPath+"/quality/inventory/test-document.html",params:{docCode:t[0].id,documentType:this.simpleType,activeType:"update"}})},DeleteOneRow:function(){inventory.selected.length<1?this.$Modal.warning({title:"提示信息",content:"<p>请先选择至少一笔数据！</p>"}):this.$Modal.confirm({title:"提示信息",content:"<p>是否要删除这条信息？</p>",onOk:function(){$.ajax({type:"POST",url:contextPath+"/documentAllController/deleteBatch",contentType:"application/json",data:JSON.stringify(inventory.selected),dataType:"json",success:function(t){if(console.log(t),"100100"==t.code)if(inventory.selected.length=0,inventory.refresh(),$.isEmptyObject(t.data))layer.alert("删除成功！");else{for(var e="单据",n=0;n<t.data.length;n++)e+="["+t.data[n].documentCode+"]、",console.log(t.data[n].documentCode,t.data,11009);e+="删除失败（单据已启用审批流，无法删除！）",layer.alert(e)}},error:function(t){layer.alert(t)}})},onCancel:function(){}})},addReport:function(){},setRows:function(){},attachment:function(){},exit:function(){window.parent.closeCurrentTab({openTime:this.openTime,exit:!0})},hideSearch:function(){this.isHide=!this.isHide,this.isSearchHide=!this.isSearchHide,$(".chevron").css("top","")},hidTabulation:function(){this.isHide=!this.isHide,this.isTabulationHide=!this.isTabulationHide,this.isTabulationHide?$(".chevron").css("top",""):$(".chevron").css("top","90%")},loadTestedOrganizationName:function(t){console.log("name===",t);var e=this;"库存检验单"==t?$.ajax({type:"POST",url:contextPath+"/documentAllController/listByOrganizationId",contentType:"application/json",dataType:"json",success:function(t){e.organList=t.data},error:function(t){e.$Spin.hide(),console.log("服务器出错")}}):"门店检验单"==t&&$.ajax({type:"POST",url:contextPath+"/documentAllController/getOrgName",contentType:"application/json",dataType:"json",success:function(t){e.organList=t.data},error:function(t){console.log("服务器出错")}})},loadCodeType:function(){$.ajax({type:"POST",url:contextPath+"/codeController/getChildNodesByMark?mark=zj_document_status",contentType:"application/json",success:function(t){"100100"===t.code&&(inventory.statusList=t.data)}})},loadProductType:function(){var e=this;$.ajax({type:"post",url:contextPath+"/documentController/getCategory?parentId=0",dataType:"json",success:function(t){console.log(t),e.categoryType=e.initGoodCategory(t.data.cateLists)},error:function(){alert("服务器出错啦")}})},initGoodCategory:function(t){var a=this,i=[];return t.forEach(function(t){var e=t.name,n=t.name,o=t.cateLists;o&&(o=a.initGoodCategory(o)),i.push({value:e,label:n,children:o})}),i.forEach(function(t){t.children||delete t.children}),i},loadInspectorName:function(){$.ajax({type:"post",url:contextPath+"/documentController/queryAllEmpByOrganId",data:{organId:window.parent.userInfo.organId},dataType:"json",success:function(t){inventory.inspectorNameList=t.data},error:function(){alert("服务器出错啦")}})},updateStatus:function(t,e){var n=this;$.ajax({type:"post",dataType:"json",url:contextPath+"/documentAllController/updateByTestDocumentIdAndStatus",data:{testDocumentId:t,documentStatus:e},success:function(t){n.refresh()}})},approval:function(){var t=this,e=this.selected;if(console.log(345464642,e),1<e.length)this.$Modal.warning({title:"提示信息",content:"只能选择一条数据！"});else if(e.length<1)this.$Modal.warning({title:"提示信息",content:"请至少选择一条数据！"});else if(2==e[0].documentStatus||3==e[0].documentStatus||5==e[0].documentStatus)t.id=e[0].id,t.documentStatus=e[0].documentStatus,t.documentCode=e[0].documentCode,t.modalType="approve",t.modalTrigger=!t.modalTrigger,console.log(e[0].documentStatus,e[0].documentCode,77);else{if(1==e[0].documentStatus)return void this.$Modal.warning({title:"提示信息",content:"请提交单据！"});if(4==e[0].documentStatus)return void this.$Modal.warning({title:"提示信息",content:"该单已审核,不能重复审核！"})}},reject:function(){var t=this,e=this.selected;if(1<e.length)t.$Modal.warning({title:"提示信息",content:"请至少选择一条数据！"});else{if(!(e.length<1))return e[0].testReportId?(console.log("This[0].testReportId==",e[0].testReportId),void layer.alert("已生成检验报告单，不可驳回！")):e[0].correctPreventId?(console.log("This[0].correctPreventId==",e[0].correctPreventId),void layer.alert("已生成纠正预防单，不可驳回！")):void(2==e[0].documentStatus||3==e[0].documentStatus||5==e[0].documentStatus?(t.id=e[0].id,t.documentStatus=e[0].documentStatus,t.documentCode=e[0].documentCode,t.modalType="reject",t.modalTrigger=!t.modalTrigger):t.$Modal.warning({title:"提示信息",content:"该单状态不能驳回！"}));t.$Modal.warning({title:"提示信息",content:"请至少选择一条数据！"})}},approvalOrRejectCallBack:function(t){console.log(t,9988788),"100100"===t.result.code&&this.refresh()},autoSubmitOrReject:function(t){var e=this;$.ajax({url:contextPath+"/entrustOut/submitapproval?submitType=1",method:"post",contentType:"application/json;charset=utf-8",data:JSON.stringify({receiptsId:e.documentCode,approvalResult:"reject"==e.modalType?1:0}),success:function(t){console.log(322222,t),"100100"===t.code||e.$Modal.warning({content:t.msg})}})}},watch:{"body.inspectorName":function(t){void 0===t&&(this.body.inspectorName="")}},mounted:function(){this.openTime=window.parent.params.openTime,this.params=window.parent.params.name,this.loadProductType(),this.loadCodeType(),this.loadInspectorName(),this.loadTestedOrganizationName(this.params)}});