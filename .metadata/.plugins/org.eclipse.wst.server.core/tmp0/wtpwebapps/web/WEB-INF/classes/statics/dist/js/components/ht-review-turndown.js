"use strict";Vue.component("ht-review-turndown",{props:{modalType:Number,selected:Array,tabId:String,url:String,approvalUrl:String,startBase:String,updateUrl:String,colId:Number,colStatus:String,colNum:String,auditParams:Object},data:function(){return{approve:!1,reject:!1,stepData:[{currentLevel:0,subtitle:"开始"},{currentLevel:1,subtitle:"一级审批"},{currentLevel:2,subtitle:"二级审批"},{currentLevel:3,subtitle:"三级审批"},{currentLevel:4,subtitle:"四级审批"},{currentLevel:5,subtitle:"五级审批"},{currentLevel:6,subtitle:"六级审批"},{currentLevel:7,subtitle:"结束"}],currentStep:"",nextStep:"",dataInfo:{receiptsId:"",approvalResult:"",approvalInfo:""}}},template:'<div v-clock>\n    <modal\n    title="审核"\n    v-model="approve"\n    :closable="false"\n    @on-ok="getApproveInfo">\n        <div>\n        <p class="mg-bm-md">\n        <span>当前节点：{{currentStep}}</span>\n        <span class="mg-lf-sbg">下级节点：{{nextStep}}</span>\n        </p>\n        <span>审核意见</span>\n        <i-input type="textarea" :rows="4" v-model="auditParams.approvalInfo" placeholder="请输入审批意见"></i-input>\n        </div>\n    </modal>\n    <modal\n        title="驳回"\n        v-model="reject"\n    :closable="false"\n    @on-ok="getRejectInfo">\n        <div>\n        <radio-group v-model="dataInfo.approvalResult" class="mg-bm-md" >\n        <radio label="0">驳回上一级</radio>\n        <radio label="-1" class="mg-lf-sbg">驳回到开始级次</radio>\n        </radio-group>\n        <p style="font-weight: 600" class="mg-bm-md">驳回意见</p>\n        <i-input  type="textarea" :rows="4" v-model="auditParams.approvalInfo" placeholder="请输入驳回意见"></i-input>\n        </div>\n    </modal>\n    </div>',methods:{approval:function(){var e=this;if(!ht.util.hasValue(this.selected,"array"))return this.$Modal.warning({title:"提示",content:"请先选择一条记录"}),!1;if(1<this.selected.length)return this.$Modal.warning({title:"提示",content:"最多只能选择一条记录"}),!1;var n=$("#"+this.tabId).jqGrid("getRowData",this.selected);if("已审核"===n[this.colStatus])return this.$Modal.warning({title:"提示",content:"该单据已审核通过!"}),!1;if("暂存"===n[this.colStatus])return e.$Modal.warning({title:"提示",content:"请先提交!"}),!1;var t=n[this.colNum].split(">");n[this.colNum]=t[1].split("<")[0],e.initApproval(this.auditParams),$.ajax({type:"POST",url:e.approvalUrl,contentType:"application/json;charset=utf-8",data:JSON.stringify(this.auditParams),dataType:"json",success:function(t){if(console.log(t),"100515"===t.code&&(n[e.colStatus]=4,e.updateData("审核成功!")),"100514"===t.code){var a=1===t.data?"【一级审核】":2===t.data?"【二级审核】":3===t.data?"【三级审核】":4===t.data?"【四级审核】":5===t.data?"【五级审核】":6===t.data?"【六级审核】":t.msg;e.$Modal.warning({title:"提示",content:0===t.data?"该单据已被驳回到申请人，待申请人提交!":"您没有"+a+"的审核权限"})}"100100"===t.code&&(e.approve=!0,e.modalType=1)},error:function(t){e.$Modal.warning({title:"提示",content:"服务器出错!"})}})},rejectAact:function(){var e=this;if(!ht.util.hasValue(this.selected,"array"))return this.$Modal.warning({title:"提示",content:"请先选择一条记录"}),!1;if(1<this.selected.length)return this.$Modal.warning({title:"提示",content:"最多只能选择一条记录"}),!1;var n=$("#"+this.tabId).jqGrid("getRowData",this.selected);if("已审核"===n[this.colStatus])return this.$Modal.warning({title:"提示",content:"该单据已审核通过,不能驳回"}),!1;if("暂存"===n[this.colStatus])return this.$Modal.warning({title:"提示",content:"请先提交该销售结算单!"}),!1;var t=n[this.colNum].split(">");n[this.colNum]=t[1].split("<")[0],e.initApproval(n[this.colNum]),$.ajax({type:"POST",url:e.approvalUrl,contentType:"application/json;charset=utf-8",data:JSON.stringify(this.auditParams),dataType:"json",success:function(t){if(console.log(t),"100515"===t.code&&(n[e.colStatus]=1,e.updateData("驳回成功!")),"100514"===t.code){var a=1===t.data?"【一级审核】":2===t.data?"【二级审核】":3===t.data?"【三级审核】":4===t.data?"【四级审核】":5===t.data?"【五级审核】":6===t.data?"【六级审核】":t.msg;e.$Modal.warning({title:"提示",content:0===t.data?"该单据已被驳回到申请人，待申请人提交!":"您没有"+a+"的审核权限"})}"100100"===t.code&&(e.initApproval(n.colNum),e.modalType=2)},error:function(t){e.$Modal.warning({title:"提示",content:"服务器出错"})}})},initApproval:function(t){console.log(t);var n=this;$.ajax({type:"post",url:n.startBase,contentType:"application/json;charset=utf-8",data:JSON.stringify(t),dataType:"json",success:function(t){if($.isEmptyObject(t.data))return console.log("没有流程"),!1;for(var a=t.data.list[1].currentLevel,e=0;e<n.stepData.length;e++)a===n.stepData[e].currentLevel&&(n.currentStep=n.stepData[e+1].subtitle,n.stepData[e+1].currentLevel===t.data.levelLength?n.nextStep=n.stepData[n.stepData.length-1].subtitle:n.nextStep=n.stepData[e+2].subtitle)},error:function(){n.$Modal.warning({title:"提示",content:"服务器出错"})}})},getApproveInfo:function(){var a=this,e=$("#"+this.tabId).jqGrid("getRowData",this.selected),t=e[this.colNum].split(">");e[this.colNum]=t[1].split("<")[0],a.dataInfo.receiptsId=e[this.colNum],a.dataInfo.approvalResult="1",$.ajax({type:"POST",url:a.url,contentType:"application/json;charset=utf-8",data:JSON.stringify(this.auditParams),dataType:"json",success:function(t){"100100"===t.code?(e[a.colStatus]=4,a.updateData("审核成功!")):a.$Modal.warning({title:"提示",content:"审核失败!"}),a.dataInfo={receiptsId:"",approvalResult:1,approvalInfo:""},a.modalType="",a.$parent.refresh()},error:function(t){a.$Modal.warning({title:"提示",content:"服务器出错!"})}})},getRejectInfo:function(){var a=this,t=$("#"+this.tabId).jqGrid("getRowData",this.selected),e=t[this.colNum].split(">");t[this.colNum]=e[1].split("<")[0],a.dataInfo.receiptsId=t[this.colNum],$.ajax({type:"POST",url:a.url,contentType:"application/json;charset=utf-8",data:JSON.stringify(this.auditParams),dataType:"json",success:function(t){console.log(t.data),"100100"===t.code?a.$Modal.success({title:"提示",content:"驳回成功!"}):a.$Modal.warning({title:"提示",content:"驳回失败!"}),a.dataInfo={receiptsId:"",approvalResult:"0",approvalInfo:""},a.modalType="",a.$parent.refresh()},error:function(t){a.$Modal.warning({title:"提示",content:"服务器出错!"})}})},updateData:function(a){var e=this;$.ajax({type:"POST",url:e.updateUrl,contentType:"application/json",data:{id:Number(this.colId[0]),deposit:this.auditParams.receiptsId,status:4},dataType:"json",success:function(t){"100100"==t.code&&(e.$parent.refresh(),e.$Modal.success({title:"提示",content:a}))},error:function(t){e.$Modal.warning({title:"提示",content:"服务器出错"})}})}},watch:{modalType:function(){1==this.modalType?this.approve=!0:2==this.modalType?this.reject=!0:(this.approve=!1,this.reject=!1)}},mounted:function(){}});