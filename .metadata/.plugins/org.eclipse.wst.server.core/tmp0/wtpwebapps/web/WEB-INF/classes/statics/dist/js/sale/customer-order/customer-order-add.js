"use strict";var vm=new Vue({el:"#customer-order",data:function(){var i=this;return{dateOption:{disabledDate:function(t){return t&&t.valueOf()<Date.now()-864e5}},employees:[],productDetailModal:{showModal:!1,ids:{goodsId:"",commodityId:"",documentType:"S_CUST_ORDER"}},selectedIndex:0,checkListData:{num:{name:"数量",type:"number",floor:0,empty:!0},totalWeight:{name:"总重",type:"number",floor:2},deliveryDate:{name:"日期",type:"string"}},isDisable:!0,isHint:!0,isView:!1,isSearchHide:!0,showDepositPopup:!1,selectedRow:"",otherDisable:!0,list:[],unitMap:{},urgencyList:[],shipTypeList:[],productTypeList:[],goldPriceList:[],stonePriceList:[],checked:[],optionList:[],commodityList:[],isShow:!1,reload:!0,selected:[],tabId:"customerTab",customer:{},modalTrigger:!1,modalType:"",stepList:[],approvalTableData:[],tableMark:"detail",openTime:"",body:{code:"",name:""},data_user_list:{url:contextPath+"/tbasecustomer/list",colNames:["操作","客户名称","客户编码"],colModel:[{name:"id",index:"invdate",width:80,align:"center",formatter:function(t,e,o,s){return $(document).off("click",".select"+o.id).on("click",".select"+o.id,function(){i.confirm(t,e,o,s)}),'<a type="primary" class="select'+o.id+'">选取</a>'}},{name:"name",index:"name",width:300,align:"center"},{name:"code",index:"code",width:300,align:"center"}],multiselect:!1},area:{},areaInit:{isInit:!1,province:"",city:"",county:"",detail:"",disabled:!1},logicArea:{},logicAreaInit:{isInit:!1,province:"",city:"",county:"",detail:"",disabled:!1},custPayment:{goldPrice:"",stonePrice:"",custPaid:"",totalAmount:""},addBody:{delGoodIds:[],organizationId:"",id:"",custId:"",custNo:"",custName:"",organName:"",saleOrderNo:"",status:1,source:"",businessType:"",businessStatus:"",goodsType:"",goodsTypeName:"",groupPath:"",goodsNum:"1",urgency:"",insurancePrice:"",insuranceMoney:"",splitShipment:"",invoiceTitile:"",sourceNature:"2",remark:"",totalSaleAmount:0,totalRealSaleAmount:0,depositMethod:"",depositScale:"",receviableDeposit:"",paidDeposit:"",depositStatus:"",totalReceiptAmount:"",pricingMethod:"",orderDate:"",saleMenId:"",saleMenName:"",auditId:"",auditTime:"",goldWeight:"3",totalMainStoneWeight:"4",totalViceStoneWeight:"5",totalStoneWeight:"",totalWeight:"2",saleCustInfoEntity:{custNo:"",name:"",phone:"",email:"",weChatNo:"",zipCode:"",detail:"",concreteAddress:"",area:"",province:"",city:"",county:"",stonePriceCode:""},logisticsInfo:{shipMethod:"",receiptName:"",phone:""},goodList:[]},paramsMap:{"业务类型":"","客户编码":"","商品类型":"","紧急程度":"","是否保价":"","分批发货":"","货源性质":"","下单日期":"","业务员":"","物流要求":""},depositInfo:{depositMethod:"",depositScale:"",receviableDeposit:"",saleOrderNo:""},delGoodIds:[],goodsInfos:[],oneGoodsInfo:{id:"",goodsLineNo:"",pictureUrl:"",commodityId:"",goodsCode:"",goodsName:"",goodsNorm:"",countingUnit:"",num:"",weightUnit:"",totalWeight:"",goldWeight:"",mainStoneWeight:"",viceStoneWeight:"",deliveryDate:"",pricingUnit:"",saleUnitPrice:"",saleAmount:"",discountRate:"",actualSaleAmount:"",printedContent:"",bomNo:"",remark:"",groupPath:"",goodsTypeName:"",custStyleCode:"",goodsMainType:"",goodsType:"",goodsTypeId:"",styleCategoryId:"",salesRate:"",sourceNature:"",pricingMethod:"",stoneWeight:"",goldColor:"",stoneSection:"",stoneColor:"",stoneClarity:"",goldLoss:"",goldPrice:"",stonePrice:"",goldAmount:"",stoneAmount:"",accessoryAmount:"",certificateType:"",certificatePrice:"",laborCharges:"",otherFee:"",goodsOtherInfo:{id:"",goodsId:"",goodsBarcode:"",goodsType:"",goodsName:"",goodsNum:"",totalPurchaseStorageNum:"",mrpAssignedNum:"",transferCheckStatus:"",totalTransferNum:"",transferCheckNum:"",transferCheckPassNum:"",transferCheckFailNum:"",transferCheckReleaseNum:"",pickStatus:"",totalPickNum:"",shipCheckStatus:"",shipCheckNum:"",shipCheckPassNum:"",shipCheckFailNum:"",shipCheckReleaseNum:"",totalOutStockNum:"",totalReturnNum:"",version:""}},goodsOtherInfo:{id:"",goodsId:"",goodsBarcode:"",goodsType:"",goodsName:"",goodsNum:"",totalPurchaseStorageNum:"",mrpAssignedNum:"",transferCheckStatus:"",totalTransferNum:"",transferCheckNum:"",transferCheckPassNum:"",transferCheckFailNum:"",transferCheckReleaseNum:"",pickStatus:"",totalPickNum:"",shipCheckStatus:"",shipCheckNum:"",shipCheckPassNum:"",shipCheckFailNum:"",shipCheckReleaseNum:"",totalOutStockNum:"",totalReturnNum:"",businessStatus:"",version:""}}},methods:{getCommodityList:function(){var e=this,t={categoryCustomCode:e.addBody.goodsType,field:"",limit:""};$.ajax({type:"post",url:contextPath+"/tbasecommodity/findByType",data:t,dataType:"json",success:function(t){"100100"===t.code?e.commodityList=t.data:this.$Modal.error({content:t.msg})},error:function(){this.$Modal.error({content:"网络异常,请联系技术人员！"})}})},repositionDropdown:function(){return repositionDropdownOnSroll("testTableWrap","goods")},checkWeChat:function(){var t=this.addBody.saleCustInfoEntity.weChatNo;if(t){/^[a-zA-Z]([-_a-zA-Z0-9]{5,19})+$/.test(t)||(this.$Modal.info({title:"提示",okText:"确定",content:"格式不正确,请重新输入!"}),this.addBody.saleCustInfoEntity.weChatNo="")}},checkPhone:function(){var t=this.addBody.saleCustInfoEntity.phone;if(t){/^[1][3,4,5,7,8][0-9]{9}$/.test(t)||(this.$Modal.info({title:"提示",okText:"确定",content:"格式不正确,请重新输入!"}),this.addBody.saleCustInfoEntity.phone="")}},checkEmail:function(){var t=this.addBody.saleCustInfoEntity.email;t&&(new RegExp("^[a-z0-9]+([._\\-]*[a-z0-9])*@([a-z0-9]+[-a-z0-9]*[a-z0-9]+.){1,63}[a-z0-9]+$").test(t)||(this.$Modal.info({title:"提示",okText:"确定",content:"格式不正确,请重新输入!"}),this.addBody.saleCustInfoEntity.email=""))},changeEmp:function(t){void 0===t&&(this.addBody.saleMenId="",this.addBody.saleMenName=""),this.addBody.saleMenId=t.value;var e=t.label;this.addBody.saleMenName=e.substring(e.lastIndexOf("-")+1,e.length)},getEmployees:function(){var e=this;$.ajax({type:"post",url:contextPath+"/tpurchasecollectgoods/data",dataType:"json",success:function(t){e.employees=t.data.employees},error:function(t){e.$Modal.error({context:"系统出现异常,请联系管理人员"})}})},custMaterial:function(){if(this.addBody.custName){var t={id:this.addBody.custId,code:this.addBody.custNo,name:this.addBody.custName};window.parent.activeEvent({name:"客户来料-详情",url:contextPath+"/sale/material-order/sale-material-add.html",params:{custInfo:t,allInfo:this.addBody.saleOrderNo,type:"custadd"}})}else this.$Modal.info({title:"提示",okText:"确定",content:"请选择客户!"})},isEdit:function(t,e){eventHub.$emit("isEdit",t)},saveAccess:function(t,e,o){eventHub.$emit("saveFile",t,e)},getAccess:function(t,e,o){eventHub.$emit("queryFile",t,e)},approval:function(t){var e=this;e.modalType="approve",e.modalTrigger=!e.modalTrigger},reject:function(t){this.modalType="reject",this.modalTrigger=!this.modalTrigger},approvalOrRejectCallBack:function(t){var e=this;if("100100"===t.result.code){var o=t.result.data;e.addBody.status=o.status,1===e.addBody.status&&(e.isView=!1),e.addBody.businessStatus=o.businessStatus,e.addBody.auditor=o.auditor,e.addBody.auditorId=o.auditorId,e.addBody.auditTime=o.auditTime,e.addBody.version=o.version}else"100515"===t.result.code?e.modalType:this.$Modal.warning({content:t.result.msg,title:"警告"})},otherInfo:function(t){this.tableMark="other",this.goodsOtherInfo=this.goodsInfos[t].goodsOtherInfo},showTab:function(){"other"===this.tableMark&&(this.tableMark="detail"),this.goodsOtherInfo=this.goodsInfos[0].goodsOtherInfo},addRow:function(t,e){this.addBody.goodsType?this.addBody.custNo?this.validateProduct()&&t.push(Object.assign({},e,{options:this.commodityList})):this.$Modal.info({title:"提示",okText:"确定",content:"请选择客户!"}):this.$Modal.info({title:"提示",okText:"确定",content:"请选择商品类型!"})},delRow:function(t,e){this.goodsInfos[e].id&&this.delGoodIds.push(this.goodsInfos[e].id),t.splice(e,1),this.selectedRow=""},dealDeposit:function(){"1"===this.addBody.depositMethod&&(this.addBody.depositScale="",this.addBody.receviableDeposit="")},setDeposit:function(){this.showDepositPopup=!0;var t={saleOrderNo:this.addBody.saleOrderNo,saleCustInfoEntity:{stonePriceCode:this.addBody.saleCustInfoEntity.stonePriceCode}},e=this;$.ajax({type:"post",url:contextPath+"/tsalecustorder/getCustIncomingInfo",contentType:"application/json",data:JSON.stringify(t),dataType:"json",success:function(t){"100100"===t.code&&(e.custPayment=t.data)},error:function(t){console.log("服务器出错")}})},sureDeposit:function(){var e=this;if(this.addBody.depositMethod&&"null"!==this.addBody.depositMethod){var o=null;if("0"===this.addBody.depositMethod){var t=this.addBody.receviableDeposit;if(!t||"0"===t)return void this.$Message.info({title:"提示",okText:"确定",content:"请正确输入应收定金!"});o="10"}else o="15";Object.assign(this.depositInfo,{depositMethod:this.addBody.depositMethod,depositScale:this.addBody.depositScale,receviableDeposit:this.addBody.receviableDeposit,saleOrderNo:this.addBody.saleOrderNo}),void 0!==o&&4===this.addBody.status&&(this.depositInfo.businessStatus=o,"1"===this.depositInfo.depositMethod&&(this.depositInfo.isUpdate=!0,this.depositInfo.depositStatus="1")),$.ajax({type:"post",url:contextPath+"/tsalecustorder/updateOrderBaseInfo",contentType:"application/json",data:JSON.stringify(e.depositInfo),dataType:"json",success:function(t){"100100"===t.code?(e.$Modal.info({title:"提示",okText:"确定",content:"操作成功!"}),e.showDepositPopup=!1,4===e.addBody.status&&(e.addBody.businessStatus=o)):e.$Modal.info({title:"提示",okText:"确定",content:"操作失败!"})},error:function(t){console.log("服务器出错")}})}else e.showDepositPopup=!1},cancelDeposit:function(){this.showDepositPopup=!1},changeCustm:function(t){var e=this;""!==t.custNo&&this.$Modal.confirm({content:"修改客户将会清空分录行，是否修改客户？",onOk:function(){t.custNo="",e.isShow=!0,e.addBody.id&&(e.delGoodIds||(e.delGoodIds=[]),e.goodsInfos.map(function(t){t.id&&e.delGoodIds.push(t.id)})),e.goodsInfos=[]}})},custPopup:function(){this.isView||(""===this.addBody.custNo?this.isShow=!0:this.changeCustm(this.addBody))},confirm:function(t,e,o,s){this.addBody.custId=o.id,this.addBody.custNo=o.code,this.addBody.custName=o.name,this.addBody.pricingMethod=o.pricingMethod+"",this.addBody.saleCustInfoEntity.custNo=o.code,this.addBody.saleCustInfoEntity.name=o.name,this.addBody.saleCustInfoEntity.zipCode=o.zipCode;var i=o.contacts&&0<o.contacts.length?o.contacts[0]:{};this.addBody.saleCustInfoEntity.email=i.email,this.addBody.saleCustInfoEntity.name=i.name,this.addBody.saleCustInfoEntity.phone=i.phone,this.addBody.saleCustInfoEntity.wechat=i.wechat,this.addBody.saleCustInfoEntity.stonePriceCode=o.stonePriceCode,this.addBody.logisticsInfo.receiptName=i.name,this.addBody.logisticsInfo.phone=i.phone,o.province&&(this.areaInit={isInit:!0,province:o.province||"",city:o.city||"",county:o.county,detail:o.detail},this.logicAreaInit={isInit:!0,province:o.province||"",city:o.city||"",county:o.county,detail:o.detail}),this.initStonePrice(o.stonePriceCode),this.isShow=!1},searchCut:function(){this.reload=!this.reload},clearCut:function(){this.body={code:"",name:""}},popupSure:function(){this.popup_config.show=!1},hideSearch:function(){this.isSearchHide=!this.isSearchHide},save:function(){if(this.paramsMap={"业务类型":this.addBody.businessType,"客户名称":this.addBody.custNo,"商品类型":this.addBody.goodsType,"紧急程度":this.addBody.urgency,"是否保价":this.addBody.insurancePrice,"分批发货":this.addBody.splitShipment,"货源性质":this.addBody.sourceNature,"下单日期":this.addBody.orderDate,"业务员":this.addBody.saleMenName,"物流要求":this.addBody.logisticsInfo.shipMethod},this.checkData(!1)?this.addBody.isCheck="Y":this.addBody.isCheck="N",0===this.goodsInfos.length)this.addBody.isCheck="N";else{if(!this.validateProduct())return;htValidateRow(this.goodsInfos,this.checkListData,!1)?this.addBody.isCheck="N":"N"!==this.addBody.isCheck&&(this.addBody.isCheck="Y")}var t="/tsalecustorder/save";this.addBody.id&&(t="/tsalecustorder/update"),this.sendAjax(t)},sendAjax:function(t){ht.util.hasValue(this.area,"object")&&Object.assign(this.addBody.saleCustInfoEntity,this.area),ht.util.hasValue(this.logicArea,"object")&&Object.assign(this.addBody.logisticsInfo,this.logicArea),"1"===this.addBody.depositMethod&&(this.addBody.isUpdate=!0),this.addBody.delGoodIds=this.delGoodIds,0<this.goodsInfos.length&&this.handlerDataToPost();var o=this;$.ajax({type:"post",url:contextPath+t,contentType:"application/json",data:JSON.stringify(this.addBody),dataType:"json",success:function(e){"100100"===e.code?vm.$Modal.info({title:"提示",okText:"确定",content:"操作成功!",onOk:function(){var t=e.data;o.saveAccess(t.id,"S_CUST_ORDER"),o.renderingData(t)}}):vm.$Modal.info({title:"提示",okText:"确定",content:"操作失败!"})},error:function(t){console.log("服务器出错")}})},isHintShow:function(t){var e=this;t&&this.typeValue&&this.isHint&&this.goodsInfos&&0<this.goodsInfos.length&&this.$Modal.warning({content:"温馨提示：改变商品类型将删除所有商品信息!",onOk:function(){e.isHint=!1,console.log("温馨提示：改变商品类型将删除所有商品信息！")}})},typeInit:function(t,e,o){for(var s=0;s<t.length;s++){if(t[s].value==o)return e.push(t[s].value),!0;if(t[s].children&&0<t[s].children.length&&this.typeInit(t[s].children,e,o))return e.push(t[s].value),!0}},changeProductType:function(t,e){var o=this;if(t==this.typeValue)return!1;this.addBody.id&&(this.delGoodIds||(this.delGoodIds=[]),this.goodsInfos.map(function(t){t.id&&o.delGoodIds.push(t.id)})),this.goodsInfos=[];var s=e[e.length-1];this.addBody.goodsType=s.value,this.addBody.groupPath=t.join("-"),this.addBody.goodsTypeName=s.label,this.oneGoodsInfo.goodsType=s.value,this.oneGoodsInfo.groupPath=t.join("-"),this.oneGoodsInfo.goodsTypeName=s.label,this.getCommodityList()},submit:function(){if(this.paramsMap={"业务类型":this.addBody.businessType,"客户名称":this.addBody.custNo,"商品类型":this.addBody.goodsType,"紧急程度":this.addBody.urgency,"是否保价":this.addBody.insurancePrice,"分批发货":this.addBody.splitShipment,"货源性质":this.addBody.sourceNature,"下单日期":this.addBody.orderDate,"业务员":this.addBody.saleMenName,"物流要求":this.addBody.logisticsInfo.shipMethod},this.checkData(!0))if(0!==this.goodsInfos.length){if(!htValidateRow(this.goodsInfos,this.checkListData)){var t="/tsalecustorder/save";this.addBody.id&&(t="/tsalecustorder/update"),this.addBody.isCheck="Y",this.addBody.status=2,this.sendAjax(t)}}else this.$Modal.warning({content:"必须录入商品明细!"})},getReceviableDeposit:function(){if(this.addBody.depositScale&&this.addBody.totalRealSaleAmount&&"0"!==this.addBody.totalRealSaleAmount){var t=parseFloat(this.addBody.depositScale)/100;this.addBody.receviableDeposit=(this.addBody.totalRealSaleAmount*t).toFixed(2)}},sumBodyTotal:function(){this.addBody.totalSaleAmount=this.sum(this.goodsInfos,"saleAmount"),this.addBody.totalRealSaleAmount=this.sum(this.goodsInfos,"actualSaleAmount")},getSaleAmount:function(t){var e=parseFloat(t.saleUnitPrice),o=0;if(o="attr_ranges_stone"===t.goodsMainType||"attr_ranges_gold"===t.goodsMainType?parseFloat(t.totalWeight):1===t.pricingUnit?parseFloat(t.totalWeight):parseFloat(t.num),isNaN(e)||isNaN(o))return t.saleAmount="",void(t.actualSaleAmount="");if(t.saleAmount=(e*o).toFixed(2),""!=t.discountRate&&null!=t.discountRate){var s=parseFloat(t.discountRate)/100;t.actualSaleAmount=(t.saleAmount*s).toFixed(2)}else t.actualSaleAmount=t.saleAmount},getSaleUnitPrice:function(t){var e=1===t.pricingUnit?parseFloat(t.totalWeight):parseFloat(t.num);if(e&&t.saleAmount)if(t.saleUnitPrice=(parseFloat(t.saleAmount)/parseFloat(e)).toFixed(2),""!=t.discountRate&&null!=t.discountRate){var o=parseFloat(t.discountRate)/100;t.actualSaleAmount=(t.saleAmount*o).toFixed(2)}else t.actualSaleAmount=t.saleAmount;else t.actualSaleAmount=""},getActualSaleAmount:function(t){var e=parseFloat(t.discountRate)/100,o=parseFloat(t.saleAmount);isNaN(e)||isNaN(o)?t.actualSaleAmount=t.saleAmount:t.actualSaleAmount=(o*(1-e)).toFixed(2)},sum:function(t,o){var s=this;return t.reduce(function(t,e){return""===e[o]||null===e[o]||null==e[o]?0+t:isNaN(e[o])?(s.$Modal.warning({content:"请输入数字"}),e[o]="",0+t):parseFloat(e[o])+t},0)},selectedTr:function(t){this.selectedRow=t},initGoodCategory:function(t){var d=this,a=[];return t.forEach(function(t){var e=t.customCode,o=t.name,s=t.cateLists,i=t.code;s&&(s=d.initGoodCategory(s)),a.push({value:e,label:o,children:s,code:i})}),a.forEach(function(t){t.children||delete t.children}),a},getSelectedItem:function(t,i){var d=this;$.ajax({type:"post",url:contextPath+"/tbasecommodity/getBriefById/"+t.id,dataType:"json",success:function(t){if("100100"==t.code){var e=t.data;e.countUnitId=d.unitMap[e.countUnitId],e.weightUnitId=d.unitMap[e.weightUnitId];var o=d.goodsInfos[i].options,s={};Object.assign(s,d.oneGoodsInfo,{goodsNo:e.code,goodsName:e.name,goodsCode:e.code,commodityId:e.id,countingUnit:e.countUnitId,weightUnit:e.weightUnitId,pictureUrl:e.frontPic&&e.frontPic.fdUrl,goodsType:e.categoryName,goodsTypePath:e.categoryCustomCode,custStyleCode:e.styleCustomCode,goodsMainType:e.mainType,goodsTypeId:e.commodityCategotyInfoId,styleCategoryId:e.styleCategoryId,goodsNorm:e.specification,certificatePrice:e.certificatePrice,laborCharges:e.laborCharges,otherFee:e.otherFee,pricingUnit:e.pricingType,salesRate:e.salesRate,options:o}),d.goodsInfos[i].id&&d.delGoodIds.push(d.goodsInfos[i].id),d.$set(d.goodsInfos,i,s),"attr_ranges_gold"===e.mainType&&(d.goodsInfos[i].goldColor=e.certificateType,d.goodsInfos[i].goldPrice=d.goldPriceList[e.certificateType],d.goodsInfos[i].saleUnitPrice=d.goldPriceList[e.certificateType])}else this.$Modal.error({content:t.msg})},error:function(){}})},getInputValue:function(t,e){var o=this,s={categoryCustomCode:o.addBody.goodsType,field:t,limit:""};$.ajax({type:"post",url:contextPath+"/tbasecommodity/findByType",data:s,dataType:"json",success:function(t){o.$set(o.goodsInfos[e],"options",t.data)},error:function(){layer.alert("服务器出错啦")}})},getProductType:function(){var e=this;$.ajax({type:"post",url:contextPath+"/tbasecommoditycategory/listByAll?parentId=0",dataType:"json",success:function(t){e.productTypeList=e.initGoodCategory(t.data.cateLists)},error:function(){layer.alert("服务器出错啦")}})},getOrderNo:function(){var e=this;$.ajax({type:"post",url:contextPath+"/tsalecustorder/generateOrderCode",dataType:"json",success:function(t){console.log(t),e.addBody.saleOrderNo=t.data["t_sale_cust_order-sale_order_no"]},error:function(){console.log("error")}})},getUnit:function(){var s=this;$.ajax({type:"post",url:contextPath+"/tbaseunit/list",dataType:"json",success:function(t){t.data.map(function(t){var e=t.id,o=t.name;s.unitMap[e]=o})},error:function(){s.$Message.warning("服务器报错")}})},initGoldPrice:function(t){var e=this;$.ajax({type:"post",url:contextPath+"/tbasetodygoldprice/queryPrice",data:{type:t},dataType:"json",success:function(t){e.goldPriceList=t.data},error:function(){e.$Message.warning("服务器报错")}})},initStonePrice:function(t){var e=this;$.ajax({type:"post",url:contextPath+"/saleStonePriceController/getStonePrice",dataType:"json",data:JSON.stringify({stonePriceNo:t}),contentType:"application/json",success:function(t){"100100"===t.code?e.stonePriceList=t.data:e.stonePriceList=[]},error:function(){e.$Message.warning("服务器报错")}})},exit:function(){window.parent.closeCurrentTab({exit:!0,openTime:this.openTime})},getFinishedProduct:function(t,e){var o=this,s=0,i=0,d=0;0<t.goldBoms.length&&(t.goldBoms.map(function(t){if(t.checked){d=o.goldPriceList[t.condition]?parseFloat(o.goldPriceList[t.condition]):0,i=t.weightReference?parseFloat(t.weightReference):0;var e=0;e=t.lose?parseFloat(t.lose)/100:0,s=(i*(1+e)*d).toFixed(2)}}),e[this.selectedIndex].goldWeight=i);var a=[],n=0,r=0;if(0<t.stonesBoms.length&&(t.stonesBoms.map(function(t){var e={count:t.count,lose:t.lose,price:"",param:"",weightReference:t.weightReference,partName:t.partName},o="",s="",i="";null!=t.attr&&(t.attr.map(function(t){"净度"===t.name?i=t.model:"分段"===t.name?o=t.model:"颜色"===t.name&&(s=t.model)}),e.param=o+"_"+s+"_"+i),a.push(e)}),a.map(function(t){t.price=o.stonePriceList[t.param],1==t.partName?e[o.selectedIndex].mainStoneWeight=t.weightReference:n+=parseFloat(t.weightReference)}),e[this.selectedIndex].viceStoneWeight=n,r=a.reduce(function(t,e){var o=0;return o=e.lose?parseFloat(e.lose)/100:0,t+(parseFloat(e.price)||0)*(parseFloat(e.weightReference)||0)*(1+o)},0)),"2"===this.addBody.sourceNature){var c=e[this.selectedIndex].certificatePrice?parseFloat(e[this.selectedIndex].certificatePrice):0,l=e[this.selectedIndex].laborCharges?parseFloat(e[this.selectedIndex].laborCharges):0,u=e[this.selectedIndex].otherFee?parseFloat(e[this.selectedIndex].otherFee):0;if(e[this.selectedIndex].goldAmount=s,e[this.selectedIndex].stoneAmount=r,e[this.selectedIndex].goldPrice=d,"2"===this.addBody.pricingMethod)e[this.selectedIndex].saleUnitPrice=(parseFloat(s)+parseFloat(r)+c+l+u).toFixed(2);else if("1"===this.addBody.pricingMethod){var h=e[this.selectedIndex].salesRate?parseFloat(e[this.selectedIndex].salesRate):1;e[this.selectedIndex].saleUnitPrice=((parseFloat(s)+parseFloat(r)+c+l+u)*h).toFixed(2)}}else"1"===this.addBody.sourceNature&&(e[this.selectedIndex].saleUnitPrice=0)},getStoneProduct:function(t,e){var o="",s="",i="";t.assistAttrs.map(function(t){t.attr.map(function(t){"净度"===t.name?i=t.model:"分段"===t.name?o=t.model:"颜色"===t.name&&(s=t.model)})});var d=o+"_"+s+"_"+i;e[this.selectedIndex].saleUnitPrice=this.stonePriceList[d]?this.stonePriceList[d]:""},productDetailModalClick:function(t){console.log(t),"attr_ranges_goods"===this.goodsInfos[this.selectedIndex].goodsMainType?this.getFinishedProduct(t,this.goodsInfos):"attr_ranges_stone"===this.goodsInfos[this.selectedIndex].goodsMainType&&this.getStoneProduct(t,this.goodsInfos),"attr_ranges_goods"===this.goodsInfos[this.selectedIndex].goodsMainType?Object.assign(this.goodsInfos[this.selectedIndex],{tBaseBomEntity:t,assistAttrs:null,overEdit:!0}):Object.assign(this.goodsInfos[this.selectedIndex],{assistAttrs:t,tBaseBomEntity:{},overEdit:!0})},showProductDetail:function(t,e){var o=this;this.productDetailModal.isOrderBom="detail"!==e,this.selectedIndex=t;var s={goodsId:this.goodsInfos[t].id,commodityId:this.goodsInfos[t].commodityId,documentType:"S_CUST_ORDER"};Object.assign(this.productDetailModal,{showModal:!0,ids:s}),this.$nextTick(function(){o.$refs.modalRef.getProductDetail()})},modalSure:function(t){this.productDetailModalClick(t)},modalCancel:function(t){},handlerDataToPost:function(){var o=this,t={stonesParts:[],materialParts:[],partParts:[],goldParts:[]},s=this.addBody;return s.goodList=[JSON.parse(JSON.stringify(t))],htHandlerProductDetail(this.goodsInfos,s,t),this.goodsInfos.map(function(t,e){s.goodList[e]||(s.goodList[e]={}),Object.assign(s.goodList[e],{id:t.id,pictureUrl:t.pictureUrl,commodityId:t.commodityId,goodsCode:t.goodsCode,goodsName:t.goodsName,goodsNorm:t.goodsNorm,countingUnit:t.countingUnit,num:t.num,weightUnit:t.weightUnit,totalWeight:t.totalWeight,goldWeight:t.goldWeight,mainStoneWeight:t.mainStoneWeight,viceStoneWeight:t.viceStoneWeight,deliveryDate:t.deliveryDate,pricingUnit:t.pricingUnit,saleUnitPrice:t.saleUnitPrice,saleAmount:t.saleAmount,discountRate:t.discountRate,actualSaleAmount:t.actualSaleAmount,printedContent:t.printedContent,bomNo:t.bomNo,remark:t.remark,groupPath:t.groupPath,goodsTypeName:t.goodsTypeName,goodsTypeId:t.goodsTypeId,styleCategoryId:t.styleCategoryId,custStyleCode:t.custStyleCode,goodsMainType:t.goodsMainType,goodsType:o.addBody.goodsType,sourceNature:t.sourceNature,stoneWeight:t.stoneWeight,goldColor:t.goldColor,stoneSection:t.stoneSection,stoneColor:t.stoneColor,stoneClarity:t.stoneClarity,goldLoss:t.goldLoss,goldPrice:t.goldPrice,stonePrice:t.stonePrice,goldAmount:t.goldAmount,stoneAmount:t.stoneAmount,accessoryAmount:t.accessoryAmount,certificateType:t.certificateType,certificatePrice:t.certificatePrice,laborCharges:t.laborCharges,otherFee:t.otherFee,salesRate:t.salesRate,goodsOtherInfo:{id:t.goodsOtherInfo.id,goodsId:t.goodsOtherInfo.goodsId,goodsCode:t.goodsCode,goodsType:t.goodsMainType,goodsName:t.goodsName,goodsNum:t.num}})}),s},checkData:function(t){for(var e in this.paramsMap)if(null==this.paramsMap[e]||""===this.paramsMap[e]||"null"===this.paramsMap[e])return t&&this.$Modal.warning({title:"提示",okText:"确定",content:e+"不能为空"}),!1;if("0"===this.addBody.depositMethod){var o=this.addBody.receviableDeposit;if(!o||"0"===o)return t&&this.$Modal.info({title:"提示",okText:"确定",content:"请正确输入应收定金!"}),!1}return!0},checkTwoDecimal:function(t,e){if(null!==this.addBody[t]&&void 0!==this.addBody[t]){this.addBody[t]=this.addBody[t].toString().replace(/[^\d.]/g,""),this.addBody[t]=this.addBody[t].toString().replace(/^\./g,""),this.addBody[t]=this.addBody[t].toString().replace(/\.{2,}/g,"."),this.addBody[t]=this.addBody[t].toString().replace(".","$#$").replace(/\./g,"").replace("$#$",".");var o=this.addBody[t].toString(),s=0===e?-1<o.indexOf(".")?o.indexOf("."):o.length+1:-1<o.indexOf(".")?o.indexOf(".")+e+1:o.length+1;this.addBody[t]=o.substring(0,s)}},clearNoNum:function(t,e,o){return htInputNumber(t,e,o)},validateProduct:function(){var o=this,s=!0;return this.goodsInfos.map(function(t,e){t.id?s=!0:null==t.tBaseBomEntity&&(o.$Modal.error({content:"第"+(e+1)+"行商品明细未选择，请先选择商品明细！"}),s=!1)}),s},renderingData:function(t){vm.addBody=Object.assign({},vm.addBody,t),vm.addBody.insurancePrice=vm.addBody.insurancePrice+"",vm.addBody.splitShipment=vm.addBody.splitShipment+"",vm.addBody.urgency=vm.addBody.urgency+"",vm.addBody.sourceNature=vm.addBody.sourceNature+"",vm.addBody.depositMethod=vm.addBody.depositMethod+"",vm.addBody.pricingMethod=vm.addBody.pricingMethod+"",vm.goodsInfos=t.goodList,1!==vm.addBody.status?(vm.isEdit("N"),vm.isView=!0):vm.isEdit("Y");var e=vm.addBody.saleCustInfoEntity;e.province&&(vm.areaInit={isInit:!0,province:e.province||"",city:e.city||"",county:e.county,detail:e.detail,disabled:vm.isView});var o=vm.addBody.logisticsInfo;o.province&&(vm.logicAreaInit={isInit:!0,province:o.province||"",city:o.city||"",county:o.county,detail:o.detail,disabled:vm.isView}),vm.isView&&(vm.areaInit.disabled=!0,vm.logicAreaInit.disabled=!0),vm.addBody.id&&vm.getAccess(vm.addBody.id,"S_CUST_ORDER"),vm.addBody.id&&1===vm.addBody.status&&vm.addBody.saleCustInfoEntity.stonePriceCode&&vm.initStonePrice()}},computed:{sumGoodsNum:function(){return this.addBody.goodsNum=this.sum(this.goodsInfos,"num")},sumTotalWeight:function(){return this.addBody.totalWeight=this.sum(this.goodsInfos,"totalWeight").toFixed(2)},sumTotalRealSaleAmount:function(){return this.addBody.totalRealSaleAmount=this.sum(this.goodsInfos,"actualSaleAmount").toFixed(2)},sumTotalSaleAmount:function(){return this.addBody.totalSaleAmount=this.sum(this.goodsInfos,"saleAmount").toFixed(2)},typeValue:function(){var t=this.addBody.goodsType,e=[];return this.typeInit(this.productTypeList,e,t),e.reverse()}},mounted:function(){$("form").validate(),this.repositionDropdown(),this.getProductType(),this.getUnit(),this.initGoldPrice(1),this.getCommodityList(),this.getEmployees(),this.shipTypeList=getCodeList("jxc_jxc_wlfs"),this.urgencyList=getCodeList("jxc_khdd_khdd_jjcd");var t=window.parent.params.params,e=t.saleOrderNo;"add"===t.type&&(this.getOrderNo(),this.addBody.organName=layui.data("user").currentOrganization.orgName,this.addBody.orderDate=(new Date).format("yyyy-MM-dd hh:mm:ss"),this.isEdit("Y")),this.openTime=window.parent.params.openTime,e&&$.ajax({type:"POST",url:contextPath+"/tsalecustorder/info/"+e,dataType:"json",success:function(t){"100100"===t.code?t.data.data.status&&vm.renderingData(t.data.data):layer.alert(t.msg,{icon:0})},error:function(t){console.log("服务器出错")}})}});