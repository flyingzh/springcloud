"use strict";var vm=new Vue({el:"#returnGoodsList",data:{isShow:!1,isEdit:!1,reload:!1,isSearchHide:!0,isTabulationHide:!0,selected:"",selectType:[{value:"W_RETURN_01",label:"普通销售退货"},{value:"W_RETURN_02",label:"受托加工销售退货"}],refundGoods:{id:"",documentNo:"",documentStatus:""},documentTimeArr:[],body:{businessType:"",documentNo:"",startTime:"",endTime:"",custId:""},custList:[],modalTrigger:!1,modalType:"",stepList:[],data_config:{url:contextPath+"/refundGoodsController/list",datatype:"json",colNames:["id","日期","单据编号","单据状态","业务类型","退货客户","总数量","总重量","退货原因"],colModel:[{name:"id",index:"id",hidden:!0},{name:"documentTime",width:210,align:"left",formatter:function(t){return t?new Date(t).format("yyyy-MM-dd"):""}},{name:"documentNo",width:210,align:"left",formatter:function(t,e,n,o){return $(document).off("click",".updateDetail"+t).on("click",".updateDetail"+t,function(){vm.updateDetail({value:t,grid:e,rows:n,state:o})}),'<a class="updateDetail'+t+'">'+t+"</a>"},unformat:function(t,e,n){return t.replace(/(<\/?a.*?>)/g,"")}},{name:"documentStatus",width:210,align:"left",formatter:function(t,e,n,o){return 1===t?"暂存":2===t?"待审核":3===t?"审核中":4===t?"已审核":5===t?"驳回":""},unformat:function(t,e,n){return"暂存"===t?1:"待审核"===t?2:"审核中"===t?3:"已审核"===t?4:"驳回"===t?5:0}},{name:"businessType",width:210,align:"left",formatter:function(t,e,n,o){return"W_RETURN_01"===t?"普通销售退货":"W_RETURN_02"===t?"受托加工销售退货":""},unformat:function(t,e,n){return"普通销售退货"===t?"W_RETURN_01":"受托加工销售退货"===t?"W_RETURN_02":""}},{name:"custName",align:"left",width:210},{name:"number",align:"left",width:210},{name:"weight",align:"left",width:210},{name:"returnReason",align:"left",width:210}],rowNum:5,rowList:[10,20,30],mtype:"post",viewrecords:!0}},methods:{clear:function(){var t=this;this.body.documentNo="",this.body.startTime="",this.body.endTime="",this.body.businessType&&(this.$refs.businessType.reset(),this.$nextTick(function(){t.body.businessType=""})),this.body.custId&&(this.$refs.custId.reset(),this.$nextTick(function(){t.body.custId=""})),this.documentTimeArr=[]},refresh:function(){this.reload=!this.reload},search:function(){this.refresh()},changeDate:function(t){this.body.startTime=t[0].replace(/\//g,"-")+" 00:00:00",this.body.endTime=t[1].replace(/\//g,"-")+" 23:59:59"},add:function(){window.parent.activeEvent({name:"新增销售退货单",url:contextPath+"/warehouse/return-goods/return-goods-info.html",params:{type:0}})},submit:function(){var a=this,r=this.getSelectedRows();return ht.util.hasValue(r,"array")?1<r.length?(a.$Message.warning("只能选择一条记录!"),!1):1!==r[0].documentStatus?(a.$Modal.warning({content:"销售退货单已提交!",title:"提示"}),!1):void $.ajax({type:"POST",url:contextPath+"/refundGoodsController/getRefundGoods",data:JSON.stringify({id:r[0].id}),contentType:"application/json;charset=utf-8",dataType:"json",success:function(t){if("100100"===t.code){if(!(t.data.custId&&t.data.documentTime&&t.data.businessType&&t.data.goodsPath))return a.$Modal.warning({content:"请输入必填项!",title:"提示"}),!1;var e=t.data.goodList;if(!ht.util.hasValue(e,"array"))return a.$Modal.warning({content:"请输入必填项!",title:"提示"}),!1;var n=e.filter(function(t){return!(t.goodsNo&&t.num&&t.weight&&t.warehouseId)});if(ht.util.hasValue(n,"array"))return a.$Modal.warning({content:"请输入必填项!",title:"提示"}),!1;var o=[];return t.data.goodList&&(t.data.goodList.filter(function(t){return t.refunedGoodsId}).forEach(function(t){o.push(t.refunedGoodsId)}),ht.util.hasValue(o,"array"))?a.checkIsSubmit(o,r):a.updateStatus(r[0].id,2,r[0].documentNo,1),!1}a.$Message.error("系统异常!")},error:function(t){a.$Message.error("服务器出错")}}):(a.$Message.warning("请先选择一条记录!"),!1)},checkIsSubmit:function(t,e){var n=this;$.ajax({type:"post",url:contextPath+"/entrustMaterialInController/queryStorageStatus",data:JSON.stringify(t),contentType:"application/json",dataType:"json",error:function(){n.$Message.error("服务器出错啦")}}).then(function(t){"100100"===t.code&&(0===t.data?n.updateStatus(e[0].id,2,e[0].documentNo,1):n.$Modal.info({content:"商品已提交，请勿重复提交!",title:"提示"}))})},update:function(){var t=this.getSelectedRows();return ht.util.hasValue(t,"array")?1<t.length?(this.$Message.warning("只能选择一条记录!"),!1):void window.parent.activeEvent({name:"修改销售退货单",url:contextPath+"/warehouse/return-goods/return-goods-info.html",params:{data:t[0].id,type:1}}):(this.$Message.warning("请先选择一条记录!"),!1)},updateDetail:function(t){console.log(t.value),window.parent.activeEvent({name:"查看销售退货单",url:contextPath+"/warehouse/return-goods/return-goods-info.html",params:{data:t.value,type:2}})},del:function(){var o=this,a=this.getSelectedRows();if(!ht.util.hasValue(a,"array"))return this.$Message.warning("请先选择一条记录!"),!1;this.$Modal.confirm({title:"提示",content:"是否删除该条信息？",onOk:function(){var e=[],n=[];a.forEach(function(t){1!=t.documentStatus&&e.push(t.documentNo),n.push(t.id)});var t="";if(0<e.length)return t="单据编号为["+e.join(",")+"]的单据不可删除,已启用审批!",o.$Message.warning({content:t,duration:3,closable:!0}),o.refresh(),!1;$.ajax({type:"POST",url:contextPath+"/refundGoodsController/delete",data:JSON.stringify(n),dataType:"json",contentType:"application/json; charset=utf-8",success:function(t){console.log(t.data),"100100"===t.code&&(0<t.data?o.$Message.info("删除成功!"):o.$Message.info("删除失败!"),o.refresh())},error:function(t){o.$Message.error("服务器出错")}})},onCancel:function(){console.log("点击了取消")}})},approval:function(t){var e=this,n=this.getSelectedRows();return ht.util.hasValue(n,"array")?1<n.length?(e.$Message.warning("只能选择一条记录!"),!1):(e.refundGoods.id=n[0].id,e.refundGoods.documentNo=n[0].documentNo,e.refundGoods.documentStatus=n[0].documentStatus,e.modalType="approve",void(e.modalTrigger=!e.modalTrigger)):(e.$Message.warning("请先选择一条记录!"),!1)},reject:function(t){var e=this,n=this.getSelectedRows();return ht.util.hasValue(n,"array")?1<n.length?(e.$Message.warning("只能选择一条记录!"),!1):(e.refundGoods.id=n[0].id,e.refundGoods.documentNo=n[0].documentNo,e.refundGoods.documentStatus=n[0].documentStatus,e.modalType="reject",void(e.modalTrigger=!e.modalTrigger)):(e.$Message.warning("请先选择一条记录!"),!1)},approvalOrRejectCallBack:function(t){"100100"==t.result.code&&(this.refundGoods.documentStatus=parseInt(t.result.data),this.refresh())},autoSubmitOrReject:function(){var e=this;$.ajax({url:contextPath+"/refundGoodsController/submitApproval?submitType=1",method:"post",contentType:"application/json;charset=utf-8",data:JSON.stringify({receiptsId:e.refundGoods.documentNo,approvalResult:"reject"===e.modalType?1:0}),success:function(t){"100100"===t.code?e.refundGoods.documentStatus=parseInt(t.data):e.$Modal.warning({content:t.msg}),e.refresh()}})},updateStatus:function(t,e,n){var o=this;$.ajax({type:"post",url:contextPath+"/refundGoodsController/update",contentType:"application/json;charset=utf-8",data:JSON.stringify({id:t,documentStatus:e,documentNo:n}),dataType:"json",success:function(t){"100100"===t.code&&(o.refundGoods.documentStatus=e,o.refresh(),console.log("修改成功"))},error:function(){o.$Message.error("服务器出错啦")}})},exit:function(){window.parent.closeCurrentTab({name:"销售退货单",exit:!0,openTime:this.openTime})},getSelectedRows:function(){var t=[],e=!0,n=!1,o=void 0;try{for(var a,r=this.selected[Symbol.iterator]();!(e=(a=r.next()).done);e=!0){var s=a.value,i=$("#myTable").jqGrid("getRowData",s);t.push(i)}}catch(t){n=!0,o=t}finally{try{!e&&r.return&&r.return()}finally{if(n)throw o}}return t},getCust:function(){var e=this;$.ajax({type:"post",url:contextPath+"/refundGoodsController/queryAllCustomer",contentType:"application/json",dataType:"json",success:function(t){console.log("客户",t),e.custList=t.data},error:function(){alert("服务器出错啦")}})}},mounted:function(){this.getCust(),this.openTime=window.parent.params.openTime}});