"use strict";var customerList=new Vue({el:"#customer-countList",data:function(){return{id:"",stockPriceNo:"",status:"",modalTrigger:!1,modalType:"",stepList:[],approvalTableData:[],isHideSearch:!0,isHideList:!0,dataValue:[],businessTypeList:[{value:"ONLY_STORE_MATERIAL",label:"仅存料"},{value:"STORE_MATERIAL_PRICE",label:"存料结价"},{value:"ONLY_PRICE",label:"仅结价"}],body:{businessType:"",stockPriceNo:"",custName:"",startTime:"",endTime:"",isDel:1},myTable:"myTable",data_user_list:{url:contextPath+"/tSaleStockPrice/queryPageList",colNames:["日期","单据编号","单据状态","业务类型","客户","关联客户订单","业务员","备注"],colModel:[{name:"orderDate",index:"orderDate",width:100,align:"center",formatter:function(t,e,o,a){return t.split(" ")[0]}},{name:"stockPriceNo",index:"stockPriceNo",width:100,align:"center",formatter:function(t,e,o,a){return $(document).off("click",".updateDetail"+t).on("click",".updateDetail"+t,function(){customerList.updateDetailClick({value:t,grid:e,rows:o,state:a})}),'<a class="updateDetail'+t+'">'+t+"</a>"}},{name:"status",index:"status",width:100,align:"center",formatter:function(t,e,o,a){return 1==t?"暂存":2==t?"待审核":3==t?"审核中":4==t?"已审核":"驳回"}},{name:"businessType",index:"businessType",width:100,align:"center",formatter:function(t,e,o,a){return"ONLY_STORE_MATERIAL"==t?"仅存料":"STORE_MATERIAL_PRICE"==t?"存料结价":"ONLY_PRICE"==t?"仅结价":" "}},{name:"custName",index:"custName",width:100,align:"center"},{name:"saleOrderNo",index:"saleOrderNo",width:100,align:"center"},{name:"saleMenName",index:"saleMenName",width:100,align:"center"},{name:"remark",index:"remark",width:100,align:"center"}],multiselect:!0},reload:!0,selected:[]}},methods:{changeDate:function(t){this.body.startTime=""==t[0]?"":t[0].replace(/\//g,"-")+" 00:00:00",this.body.endTime=""==t[1]?"":t[1].replace(/\//g,"-")+" 23:59:59"},search:function(){this.reload=!this.reload},clear:function(){this.$refs.mType.reset(),this.$nextTick(function(){this.body.businessType=""}),this.body={businessType:"",stockPriceNo:"",custName:"",startTime:"",endTime:"",isDel:1},this.dataValue=[]},updateDetailClick:function(t){var e=t.value;console.log(e),$.ajax({type:"POST",url:contextPath+"/customerStockMaterial/quaryCustomerStockMateriaByStockPriceNo",data:{stockPriceNo:e},success:function(t){console.log(t),window.parent.activeEvent({name:"存料结价单详情",url:contextPath+"/sale/customer-stockMaterial/customer-countAdd.html",params:{allInfo:t,type:"query"}})},error:function(){console.log("请求失败")}})},add:function(){$.ajax({type:"post",url:contextPath+"/customerStockMaterial/addCustomerStockMateria",dataType:"json",success:function(t){console.log(t),window.parent.activeEvent({name:"存料结价单新增",url:contextPath+"/sale/customer-stockMaterial/customer-countAdd.html",params:{allInfo:t,type:"add"}})},error:function(t){}})},submit:function(){console.log(this.selected);var o=this;if(1===this.selected.length){var t=this.selected[0];if(1===t.status){var e=t.stockPriceNo;console.log(e),$.ajax({type:"POST",url:contextPath+"/customerStockMaterial/quaryCustomerStockMateriaByStockPriceNo",data:{stockPriceNo:e},success:function(t){if(console.log(t),""==t.data.custNo||""==t.data.orderDate||""==t.data.businessType||""==t.data.saleMenName)return o.$Modal.warning({content:"提交失败,请输入完整基本资料！"}),!1;if(null==t.data.goodList)return o.$Modal.warning({content:"提交失败,请新增来料明细！"}),!1;if(t.data.goodList){console.log(t.data.goodList);for(var e=0;e<t.data.goodList.length;e++)if("attr_ranges_gold"==t.data.goodList[e].goodsMainType){if(""==t.data.goodList[e].goldWeight||null==t.data.goodList[e].goldWeight)return o.$Modal.info({content:"第"+(e+1)+"行金料总重没填"}),!1;if(""==t.data.goodList[e].goldPrice||null==t.data.goodList[e].goldPrice)return o.$Modal.info({content:"第"+(e+1)+"行金价没填"}),!1;if(""==t.data.goodList[e].goldAmount||null==t.data.goodList[e].goldAmount)return o.$Modal.info({content:"第"+(e+1)+"行金额没填"}),!1;if(""==t.data.goodList[e].inWarehouseId||null==t.data.goodList[e].inWarehouseId)return o.$Modal.info({content:"第"+(e+1)+"行仓库没填"}),!1}}t.data.status=2,o.updateData(t.data,"提交")},error:function(t){console.log("服务器出错")}})}else this.$Modal.info({title:"提示",okText:"确定",content:"单据已提交!"})}else this.$Modal.info({title:"提示",okText:"确定",content:"只能对单条数据操作!"})},updateData:function(t,e){var o=this;console.log(t),$.ajax({type:"POST",url:contextPath+"/tSaleStockPrice/save",contentType:"application/json; charset=utf-8",data:JSON.stringify(t),dataType:"json",success:function(t){"100100"===t.code?o.$Modal.success({title:"提示",content:e+"成功!"}):o.$Modal.success({title:"提示",content:e+"失败!"}),o.refresh()},error:function(t){o.$Modal.warning({title:"提示",content:"服务器出错"})}})},approval:function(){if(1===this.selected.length){this.stockPriceNo=this.selected[0].stockPriceNo,this.status=this.selected[0].status;this.modalType="approve",this.modalTrigger=!this.modalTrigger}else this.$Modal.info({title:"提示",okText:"确定",content:"只能对单条数据操作!"})},reject:function(){if(1===this.selected.length){this.stockPriceNo=this.selected[0].stockPriceNo,this.status=this.selected[0].status;this.modalType="reject",this.modalTrigger=!this.modalTrigger}else this.$Modal.info({title:"提示",okText:"确定",content:"只能对单条数据操作!"})},refresh:function(){this.clear(),this.reload=!this.reload,this.selected=[]},approvalOrRejectCallBack:function(t){console.log(t.result);var e=this;if("100515"==t.result.code){var o=e.selected[0].id;"approve"==e.modalType&&e.ajaxUpdateDocStatusById(o,4),"reject"==e.modalType&&e.ajaxUpdateDocStatusById(o,1)}e.refresh()},ajaxUpdateDocStatusById:function(t,e){var o=this;$.ajax({url:contextPath+"/tSaleStockPrice/save",method:"POST",dataType:"json",contentType:"application/json;charset=utf-8",data:JSON.stringify({id:t,status:e}),success:function(t){"100100"==t.code&&(o.status=e)}})},update:function(){if(!ht.util.hasValue(this.selected,"array"))return this.$Modal.warning({title:"提示",content:"请先选择一条记录"}),!1;if(1<this.selected.length)return this.$Modal.warning({title:"提示",content:"最多只能选择一条记录"}),!1;console.log(this.selected);var t=this.selected[0];if(1!=t.status)return this.$Modal.info({content:"<p>只有暂存状态下才能修改数据，请重新选择！</p>"}),!1;var e=t.stockPriceNo;$.isEmptyObject(e)||null==e||(console.log(e),$.ajax({type:"POST",url:contextPath+"/customerStockMaterial/quaryCustomerStockMateriaByStockPriceNo",dataType:"json",data:{stockPriceNo:e},success:function(t){console.log(t),window.parent.activeEvent({name:"存料结价单修改",url:contextPath+"/sale/customer-stockMaterial/customer-countAdd.html",params:{allInfo:t,type:"query"}})},error:function(){console.log("请求失败")}}))},del:function(){if(0!==this.selected.length){var t=this.selected,e=[];console.log(t);for(var o=!0,a=0;a<t.length;a++)1!=t[a].status?(o=!1,this.$Modal.info({content:"单据不是暂存状态不能删除"})):(e.push(t[a].id),console.log(e));o&&$.ajax({type:"post",url:contextPath+"/tSaleStockPrice/delete",contentType:"application/json",data:JSON.stringify(e),dataType:"json",success:function(t){"100100"===t.code?customerList.$Modal.info({title:"提示",content:"删除成功",okText:"确定",onOk:function(){customerList.reload=!customerList.reload}}):customerList.$Modal.info({title:"提示",content:"删除!",okText:"确定"})},error:function(t){console.log("服务器出错")}})}else this.$Modal.info({title:"提示",okText:"确定",content:"请选中想要删除的行!"})},exit:function(){window.parent.closeCurrentTab({exit:!0,openTime:this.openTime})}},mounted:function(){this.openTime=window.parent.params.openTime,this.openName=window.parent.params.name}});