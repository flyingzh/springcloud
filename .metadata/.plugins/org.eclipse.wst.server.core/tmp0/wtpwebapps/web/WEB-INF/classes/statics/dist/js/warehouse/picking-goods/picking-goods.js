"use strict";var vm=new Vue({el:"#app",data:function(){var i=this;return{isShow:!1,isEdit:!1,typeValue:"",reload_unpicked:!1,reload_picked:!1,isSearchHide:!0,frameTab:!1,isStart:!0,array:[],productTypeList:[],isTabulationHide:!0,checkedAllData:!1,godsCodes:null,openTime:"",dataValue:[],isHide:!0,selectedPicked:[],selectedUnpicked:[],selectedRow:{},selectedRowNum:0,checkData:[],barcodeProduct:[],selectType:[{value:"客户订单",label:"客户订单"},{value:"原料领用申请单",label:"原料领用申请单"}],body:{goodsType:"",saleOrderNo:"",goodsCode:"",goodsName:"",startTime:"",endTime:"",commodityId:null,productTypeName:"",alreadyTest:2,hasCreateTestDocument:0},data:[{value:"shiliao",label:"石料",children:[{value:"shiliaoyihao",label:"石料一号"},{value:"shiliaoerhao",label:"石料二号"},{value:"shiliaosanhao",label:"石料三号"}]},{value:"kjin",label:"k金"},{value:"suzhou",label:"苏州"}],data_config_unpicked:{url:contextPath+"/examineGoods/queryList",datatype:"json",colNames:["客户订单编号","商品类型","商品图片","商品编码","商品名称","计数单位","订单数量","订单入库数量","拣货数量","未拣货数量","字印内容","字印数量","字印确认","完成数量"],colModel:[{name:"saleOrderNo",index:"saleOrderNo",width:210,align:"left",formatter:function(e,t,o,n){return $(document).off("click",".detail"+e).on("click",".detail"+e,function(){i.detailClick({value:e,grid:t,rows:o,state:n})}),'<a class="detail'+e+'">'+e+"</a>"}},{name:"goodsType",index:"goodsType",width:210,align:"left"},{name:"pictureUrl",index:"pictureUrl",width:210,align:"center",formatter:function(e,t,o){$(document).on("mouseout",".can",function(){i.hideMirror(o.id)}),$(document).on("mouseenter",".select"+o.id,function(){i.showMirror(o.id)});var n=o.pictureUrl;return n?'<div class="select'+o.id+' can">\n                                    <img height="50px" width="50px" src="'+n+'"/>\n                                    <div class="mirror"><img class="bigimg" src="'+n+'"></div>\n                                </div>':'<div class="select${rowObject.id}"></div>'}},{name:"goodsCode",index:"goodsCode",width:210,align:"left",formatter:function(e,t,o,n){return $(document).off("click",".detail"+e).on("click",".detail"+e,function(){i.gooidsId({value:e,grid:t,rows:o,state:n})}),'<a class="detail'+e+'">'+e+"</a>"}},{name:"goodsName",index:"goodsName",align:"left",width:210},{name:"countingUnit",index:"countingUnit",align:"left",width:210},{name:"goodsNum",index:"goodsNum",align:"left",width:210},{name:"totalPurchaseStorageNum",index:"totalPurchaseStorageNum",align:";left",width:210},{name:"totalPickNum",index:"totalPickNum",align:";left",width:210},{name:"noPickNum",index:"noPickNum",align:";left",width:210},{name:"printedContent",index:"printedContent",align:";left",width:210},{name:"printCompNum",index:"printCompNum",align:";left",width:210},{name:"printStatus",index:"printStatus",align:";left",width:210,formatter:function(e){return 1==e?"是":""}},{name:"sentQualiyNum",index:"sentQualiyNum",align:";left",width:210}],rowNum:5,rowList:[10,20,30],mtype:"post",viewrecords:!0,postData:i.body},data_config_picked:{url:contextPath+"/examineGoods/querySentList",datatype:"json",colNames:["客户订单编号","商品类型","商品图片","商品编码","商品名称","计数单位","订单数量","订单入库数量","拣货数量","未拣货数量","字印内容","字印数量","字印确认","完成数量"],colModel:[{name:"saleOrderNo",index:"saleOrderNo",width:210,align:"left",formatter:function(e,t,o,n){return $(document).off("click",".detail"+e).on("click",".detail"+e,function(){i.detailClick({value:e,grid:t,rows:o,state:n})}),'<a class="detail'+e+'">'+e+"</a>"}},{name:"goodsType",index:"goodsType",width:210,align:"left"},{name:"pictureUrl",index:"pictureUrl",width:210,align:"center",formatter:function(e,t,o){$(document).on("mouseout",".can",function(){i.hideMirror(o.id)}),$(document).on("mouseenter",".select"+o.id,function(){i.showMirror(o.id)});var n=o.pictureUrl;return n?'<div class="select'+o.id+' can">\n                                    <img height="50px" width="50px" src="'+n+'"/>\n                                    <div class="mirror"><img class="bigimg" src="'+n+'"></div>\n                                </div>':'<div class="select'+o.id+' can">\n                                    <img height="50px" width="50px" src="http://218.17.157.182:8082/web/images/no_pic.png"/>\n                                    <div class="mirror"><img class="bigimg" src="http://218.17.157.182:8082/web/images/no_pic.png"></div>\n                                </div>'}},{name:"goodsCode",index:"goodsCode",width:210,align:"left",formatter:function(e,t,o,n){return $(document).off("click",".detail"+e).on("click",".detail"+e,function(){i.gooidsId({value:e,grid:t,rows:o,state:n})}),'<a class="detail'+e+'">'+e+"</a>"}},{name:"goodsName",index:"goodsName",align:"left",width:210},{name:"countingUnit",index:"countingUnit",align:"left",width:210},{name:"goodsNum",index:"goodsNum",align:"left",width:210},{name:"totalPurchaseStorageNum",index:"totalPurchaseStorageNum",align:";left",width:210},{name:"totalPickNum",index:"totalPickNum",align:";left",width:210},{name:"noPickNum",index:"noPickNum",align:";left",width:210},{name:"printedContent",index:"printedContent",align:";left",width:210},{name:"printCompNum",index:"printCompNum",align:";left",width:210},{name:"printStatus",index:"printStatus",align:";left",width:210,formatter:function(e){return 1==e?"是":""}},{name:"sentQualiyNum",index:"sentQualiyNum",align:";left",width:210}],rowNum:5,rowList:[10,20,30],mtype:"post",viewrecords:!0,postData:i.body,multiselect:!1}}},watch:{checkData:{handler:function(){2==vm.checkData.length?document.querySelector("#quan").checked=!0:document.querySelector("#quan").checked=!1},deep:!0}},methods:{gooidsId:function(e){window.parent.activeEvent({name:"商品",url:contextPath+"/base-data/commodity/commodity-info.html",params:{id:e.rows.commodityId,type:"skip"}})},detailClick:function(e){var t=e.rows.saleOrderNo;window.parent.activeEvent({name:"查询客户订单",url:contextPath+"/sale/customer-order/customer-order-add.html",params:{type:"view",saleOrderNo:t}})},showMirror:function(e){$(".select"+e+" .mirror").show()},hideMirror:function(e){$(".select"+e+" .mirror").hide()},search:function(){vm.reload_picked=!vm.reload_picked,vm.reload_unpicked=!vm.reload_unpicked},clear:function(){vm.body={goodsType:"",saleOrderNo:"",goodsCode:"",startTime:"",endTime:"",productTypeName:"",goodsName:"",alreadyTest:2,hasCreateTestDocument:0},vm.dataValue=[],vm.$nextTick(function(){vm.typeValue=""})},close:function(){window.parent.closeCurrentTab({name:"销售拣货",openTime:vm.openTime,exit:!0})},productPickConfirm:function(){if(1!=vm.selectedUnpicked.length)return vm.frameTab=!1,vm.$Modal.warning({title:"提示信息",content:"只能针对单个商品进行拣货!"}),!1;var e=$("#tblUnpicked"),t=e.jqGrid("getGridParam","selrow"),o=e.jqGrid("getRowData",t);vm.selectedRow=o,vm.selectedRowNum=t,vm.godsCodes=o.goodsCode,window.top.home.loading("show"),$.ajax({url:contextPath+"/examineGoods/totalPurchaseStorageNum",type:"post",data:JSON.stringify(vm.selectedUnpicked),dataType:"json"}).then(function(e){if(100100==e.code){if(window.top.home.loading("hide"),null==e.data||0==e.data.length)return vm.frameTab=!1,vm.$Modal.warning({title:"提示信息",content:"订单对应商品未入库，不能进行拣货!"}),null}else if("-1"===e.code)return window.top.home.loading("hide"),vm.$Modal.error({title:"提示信息",content:"服务器出错啦!"}),null;return"100101"===e.code?(window.top.home.loading("hide"),vm.$Modal.warning({title:"提示信息",content:e.msg}),null):$.ajax({url:contextPath+"/examineGoods/queryQualityAffirmList",type:"post",data:{id:vm.selectedUnpicked[0]},dataType:"json"})}).done(function(e){if(window.top.home.loading("hide"),null==e)return null;if(100100==e.code)vm.barcodeProduct=e.data,vm.frameTab=!0;else{if("-1"===e.code)return void vm.$Modal.error({title:"提示信息",content:"服务器出错啦!"});"100101"===e.code&&vm.$Modal.warning({title:"提示信息",content:e.msg})}}).fail(function(e){window.top.home.loading("hide"),alert("服务器出错啦")})},print:function(){var e=$("#tblUnpicked"),t=e.jqGrid("getGridParam","selrow");e.jqGrid("getRowData",t);if(0==vm.selectedUnpicked.length)return vm.$Modal.warning({title:"提示信息",content:"请选择商品进行字印!"}),!1;window.top.home.loading("show"),$.ajax({cache:!1,url:contextPath+"/examineGoods/goodsContent",type:"post",data:JSON.stringify(vm.selectedUnpicked),dataType:"json",contentType:"application/json"}).then(function(e){if(100100==e.code){window.top.home.loading("hide");for(var t="",o=0;o<e.data.length;o++)t+=e.data[o].goods_code,o!=e.data.length-1&&(t+=",");if(null==e.data||0!=e.data.length)return vm.$Modal.warning({title:"提示信息",content:"商品编码：（"+t+"）该订单商品不需要字印!"}),null}return"-1"===e.code?(window.top.home.loading("hide"),vm.$Modal.error({title:"提示信息",content:"服务器出错啦!"}),null):"100101"===e.code?(window.top.home.loading("hide"),vm.$Modal.warning({title:"提示信息",content:e.msg}),null):$.ajax({cache:!1,url:contextPath+"/examineGoods/printStatus",type:"post",data:JSON.stringify(vm.selectedUnpicked),dataType:"json",contentType:"application/json"})}).then(function(e){if(null==e)return window.top.home.loading("hide"),null;if(100100==e.code){window.top.home.loading("hide");for(var t="",o=0;o<e.data.length;o++)t+=e.data[o].goods_code,o!=e.data.length-1&&(t+=",");if(0!=e.data.length)return vm.$Modal.warning({title:"提示信息",content:"商品编码：（"+t+"）该订单商品已字印确认!"}),null}return"-1"===e.code?(window.top.home.loading("hide"),vm.$Modal.error({title:"提示信息",content:"服务器出错啦!"}),null):"100101"===e.code?(window.top.home.loading("hide"),vm.$Modal.warning({title:"提示信息",content:e.msg}),null):$.ajax({cache:!1,url:contextPath+"/examineGoods/printAffirm",type:"post",data:JSON.stringify(vm.selectedUnpicked),dataType:"json",contentType:"application/json"})}).done(function(e){return window.top.home.loading("hide"),null==e?null:(100100==e.code&&(vm.$Modal.success({title:"提示信息",content:"字印确认完成!"}),vm.selectedUnpicked=[],vm.search()),"-1"===e.code?(vm.$Modal.error({title:"提示信息",content:"服务器出错啦!"}),null):void("100101"===e.code&&vm.$Modal.warning({title:"提示信息",content:e.msg})))}).fail(function(e){window.top.home.loading("hide"),alert("服务器出错啦")})},entQuality:function(){if(1!=vm.selectedUnpicked.length)return vm.frameTab=!1,vm.$Modal.warning({title:"提示信息",content:"只能针对单个商品进行送检！"}),!1;var e=$("#tblUnpicked"),t=e.jqGrid("getGridParam","selrow"),o=e.jqGrid("getRowData",t);""==o.printedContent||o.totalPickNum==o.printCompNum?o.totalPickNum!=o.sentQualiyNum?(window.top.home.loading("show"),$.ajax({url:contextPath+"/examineGoods/accomplishSentQualiy",type:"post",data:JSON.stringify(vm.selectedUnpicked),dataType:"json",contentType:"application/json",success:function(e){if(window.top.home.loading("hide"),100100==e.code&&(vm.$Modal.success({title:"提示信息",content:"送检完成!"}),vm.selectedUnpicked=[],vm.search()),"-1"===e.code)return vm.$Modal.error({title:"提示信息",content:"服务器出错啦!"}),null;"100101"===e.code&&vm.$Modal.warning({title:"提示信息",content:e.msg})},error:function(e){window.top.home.loading("hide"),alert("服务器出错啦")}})):vm.$Modal.warning({title:"提示信息",content:"没有送检单！请先拣货！"}):vm.$Modal.warning({title:"提示信息",content:"请完成字印!"})},checkedAll:function(e){for(var t=document.querySelectorAll(".checkItem"),o=0;o<vm.barcodeProduct.length;o++)vm.barcodeProduct[o].disabledStatus||(vm.barcodeProduct[o].picked=e.target.checked);if(e.target.checked)for(o=0;o<t.length;o++)t[o].checked=!0;else for(o=0;o<t.length;o++)t[o].disabled?t[o].checked=!0:t[o].checked=!1},changeProductType:function(e,t){if(e==vm.typeValue)return!1;var o=t[t.length-1];vm.body.goodsType=o.value},getProductType:function(){var t=this;$.ajax({type:"post",url:contextPath+"/tbasecommoditycategory/listByAll?parentId=0",dataType:"json",success:function(e){t.productTypeList=t.initGoodCategory(e.data.cateLists)},error:function(){vm.$Modal.error({title:"提示信息",content:"服务器出错啦!"})}})},typeValue:function(){var e=vm.addBody.goodsType,t=[];return vm.typeInit(vm.productTypeList,t,e),t.reverse()},initGoodCategory:function(e){var a=[];return e.forEach(function(e){var t=e.customCode,o=e.name,n=e.cateLists,i=e.code;n&&(n=vm.initGoodCategory(n)),a.push({value:t,label:o,children:n,code:i})}),a.forEach(function(e){e.children||delete e.children}),a},modalPickDone:function(){var e=$("#tblUnpicked"),t=e.jqGrid("getGridParam","selrow"),o=e.jqGrid("getRowData",t),n=$("#barcodeList").find(".checkItem:checked");$("#tblUnpicked").jqGrid("setRowData",vm.selectedRowNum,{pickNumber:n.length});for(var i=new Array,a=0;a<n.length;a++)i[a]=n[a].value;window.top.home.loading("show"),$.ajax({url:contextPath+"/examineGoods/updataAffirm",type:"post",data:JSON.stringify({goodsId:vm.selectedUnpicked[0],goodsBarcodes:i,totalPickNum:o.totalPickNum}),dataType:"json",contentType:"application/json",success:function(e){if(window.top.home.loading("hide"),100100==e.code&&(vm.$Modal.success({title:"提示信息",content:e.msg}),vm.selectedUnpicked=[],vm.search()),"-1"===e.code)return vm.$Modal.error({title:"提示信息",content:"服务器出错啦!"}),null;"100101"===e.code&&vm.$Modal.warning({title:"提示信息",content:e.msg})},error:function(e){window.top.home.loading("hide"),alert("服务器出错啦")}})},modalPickCancel:function(){}},mounted:function(){this.openTime=window.parent.params.openTime,this.getProductType()}});